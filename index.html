<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>FranÃ§ais Quiz Â· æ³•è¯­ç»ƒä¹ </title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0c0a14;
      --card: #16141f;
      --surface: #1e1b28;
      --accent: #8b5cf6;
      --accent-hover: #a78bfa;
      --accent-soft: rgba(139, 92, 246, 0.15);
      --correct: #34d399;
      --wrong: #f87171;
      --option-a: #60a5fa;
      --option-b: #fbbf24;
      --option-c: #4ade80;
      --option-d: #fb923c;
      --text: #f5f3ff;
      --text-muted: #a1a1aa;
      --radius: 16px;
      --radius-sm: 10px;
      --shadow: 0 4px 24px rgba(0,0,0,0.25);
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.15);
    }
    body.theme-light {
      --bg: #f8f7fc;
      --card: #fff;
      --surface: #f0eef8;
      --text: #1c1917;
      --text-muted: #78716c;
      --shadow: 0 4px 20px rgba(124, 58, 237, 0.08);
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
      background: var(--bg);
      background-image: none;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image:
        radial-gradient(ellipse 100% 60% at 50% -15%, rgba(139, 92, 246, 0.2), transparent 50%),
        radial-gradient(ellipse 70% 50% at 100% 80%, rgba(96, 165, 250, 0.12), transparent),
        radial-gradient(ellipse 50% 30% at 0% 60%, rgba(139, 92, 246, 0.08), transparent);
      transition: background 0.3s, color 0.3s;
    }

    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem;
      padding-left: max(1.25rem, env(safe-area-inset-left));
      padding-right: max(1.25rem, env(safe-area-inset-right));
      padding-top: max(1.5rem, env(safe-area-inset-top));
      padding-bottom: max(1.25rem, env(safe-area-inset-bottom));
    }
    @media (min-width: 600px) {
      .container { padding: 2rem 1.5rem; }
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.75rem;
      padding-bottom: 1.25rem;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    body.theme-light header { border-bottom-color: rgba(0,0,0,0.06); }
    header .brand {
      text-align: left;
    }
    header h1 {
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #c4b5fd 0%, #a78bfa 50%, #818cf8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    header p {
      color: var(--text-muted);
      font-size: 0.875rem;
      font-weight: 500;
      margin-top: 0.2rem;
    }
    .theme-toggle {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255,255,255,0.1);
      background: var(--surface);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.2s;
    }
    .theme-toggle:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
    body.theme-light .theme-toggle { border-color: rgba(0,0,0,0.08); background: var(--surface); }
    body.theme-light .question-card,
    body.theme-light .result-card { box-shadow: var(--shadow-sm); }
    body.theme-light .option { border-color: rgba(0,0,0,0.08); }
    body.theme-light .option:hover { background: rgba(0,0,0,0.04); }

    .stats-bar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    .stats-bar span {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.6rem 1rem;
      background: var(--surface);
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255,255,255,0.06);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
    }
    body.theme-light .stats-bar span { border-color: rgba(0,0,0,0.06); background: var(--card); }
    .stats-bar strong {
      color: var(--accent);
      font-weight: 700;
      margin-right: 0.15rem;
    }

    .home-section {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.06);
      padding: 1.5rem;
      margin-bottom: 1.25rem;
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    .home-section:hover {
      border-color: rgba(255,255,255,0.08);
      box-shadow: var(--shadow);
    }
    body.theme-light .home-section { border-color: rgba(0,0,0,0.06); }
    body.theme-light .home-section:hover { border-color: rgba(124, 58, 237, 0.2); box-shadow: var(--shadow); }
    .home-section h2 {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.85rem;
    }

    .screen {
      display: none;
    }
    .screen.active {
      display: block;
      animation: fadeIn 0.35s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #screen-result.active {
      animation: fadeIn 0.4s ease;
    }
    #screen-result .result-card {
      animation: fadeIn 0.5s ease 0.1s both;
    }

    /* Question transitions */
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideOutLeft {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(-30px); }
    }
    .question-card.animate-in { animation: slideInRight 0.3s ease forwards; }
    .question-card.animate-out { animation: slideOutLeft 0.2s ease forwards; }

    /* Answer feedback animations */
    @keyframes bounceIn {
      0% { transform: scale(0.8); opacity: 0; }
      60% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes shakeX {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-6px); }
      40%, 80% { transform: translateX(6px); }
    }
    .answer-feedback.correct-msg { animation: bounceIn 0.4s ease; }
    .answer-feedback.wrong-msg { animation: shakeX 0.4s ease; }

    /* Option click effect */
    @keyframes optionPulse {
      0% { transform: scale(1); }
      50% { transform: scale(0.97); }
      100% { transform: scale(1); }
    }
    .option.just-selected { animation: optionPulse 0.2s ease; }

    /* Stats bar number pop */
    @keyframes countPop {
      0% { transform: scale(1); }
      50% { transform: scale(1.25); color: var(--accent-hover); }
      100% { transform: scale(1); }
    }
    .stats-bar strong { display: inline-block; }
    .stats-bar strong.updated { animation: countPop 0.3s ease; }

    /* Circular timer ring */
    .timer-ring { flex-shrink: 0; }
    .timer-ring-fill { transition: stroke-dashoffset 1s linear, stroke 0.3s; }
    .timer-ring-fill.low { stroke: var(--wrong); }

    .home-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .home-actions .btn { min-height: 52px; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.95rem 1.5rem;
      min-height: 48px;
      font-size: 1rem;
      font-weight: 600;
      font-family: inherit;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(139, 92, 246, 0.35);
    }
    .btn:active { transform: translateY(0); }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, #6366f1 100%);
      color: white;
      box-shadow: 0 4px 14px rgba(139, 92, 246, 0.4);
    }
    .btn-primary:hover { box-shadow: 0 10px 32px rgba(139, 92, 246, 0.45); }
    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .btn-secondary:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
      box-shadow: 0 8px 24px rgba(139, 92, 246, 0.2);
    }
    body.theme-light .btn-secondary { background: var(--card); border-color: rgba(0,0,0,0.1); }
    body.theme-light .btn-secondary:hover { background: var(--surface); border-color: var(--accent); }

    .import-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow-sm);
    }
    body.theme-light .import-section { border-color: rgba(0,0,0,0.06); }
    .import-section h3 {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }
    .import-section textarea {
      width: 100%;
      min-height: 140px;
      padding: 0.85rem;
      font-family: inherit;
      font-size: 0.9rem;
      background: var(--surface);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius-sm);
      color: var(--text);
      resize: vertical;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .import-section textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    body.theme-light .import-section textarea { background: var(--bg); border-color: rgba(0,0,0,0.1); }
    .import-section textarea::placeholder {
      color: var(--text-muted);
    }
    .import-section .hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    /* Quiz */
    .progress-wrap {
      margin-bottom: 1.25rem;
    }
    .progress-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    .progress-estimate {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }
    .progress-bar {
      height: 8px;
      background: var(--surface);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.04);
    }
    body.theme-light .progress-bar { border-color: rgba(0,0,0,0.06); }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #818cf8);
      border-radius: 999px;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 12px rgba(139, 92, 246, 0.5);
    }

    .question-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1.75rem;
      border: 1px solid rgba(255,255,255,0.06);
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .question-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(180deg, var(--accent), #818cf8);
      border-radius: 4px 0 0 4px;
    }
    body.theme-light .question-card::before { opacity: 0.9; }
    .question-meta {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.5rem;
      letter-spacing: 0.03em;
    }
    .question-stem {
      font-size: 1.25rem;
      line-height: 1.65;
      margin-bottom: 1.25rem;
      font-weight: 500;
      letter-spacing: 0.01em;
    }
    @media (min-width: 480px) {
      .question-stem { font-size: 1.35rem; }
    }
    .question-stem .blank {
      display: inline-block;
      min-width: 120px;
      border-bottom: 2px solid var(--accent);
      margin: 0 4px;
      padding: 0 4px;
    }
    .question-stem .blank.filled {
      border-color: var(--correct);
      color: var(--correct);
    }
    .question-stem .blank.wrong {
      border-color: var(--wrong);
      color: var(--wrong);
    }
    .paragraph-blanks {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .paragraph-blanks input {
      width: 120px;
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      background: var(--surface);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    body.theme-light .paragraph-blanks input { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .paragraph-blanks input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .paragraph-blanks input.correct-blank {
      border-color: var(--correct);
      background: rgba(16, 185, 129, 0.15);
    }
    .paragraph-blanks input.wrong-blank {
      border-color: var(--wrong);
      background: rgba(239, 68, 68, 0.15);
    }

    .options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.85rem;
    }
    @media (max-width: 480px) {
      .options { grid-template-columns: 1fr; }
    }
    .option {
      display: flex;
      align-items: center;
      gap: 0.85rem;
      padding: 1rem 1.25rem;
      min-height: 48px;
      background: var(--surface);
      border: 2px solid rgba(255,255,255,0.06);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }
    .option:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
      transform: translateY(-1px);
    }
    .option.selected {
      border-color: var(--accent);
      background: var(--accent-soft);
      box-shadow: 0 0 0 1px var(--accent);
    }
    .option.correct {
      border-color: var(--correct);
      background: rgba(52, 211, 153, 0.12);
    }
    .option.wrong {
      border-color: var(--wrong);
      background: rgba(248, 113, 113, 0.12);
    }
    .option.disabled {
      pointer-events: none;
      opacity: 0.65;
    }
    .option-letter {
      width: 34px;
      height: 34px;
      flex-shrink: 0;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
    }
    .option:nth-child(1) .option-letter { background: var(--option-a); color: #fff; }
    .option:nth-child(2) .option-letter { background: var(--option-b); color: #1a1a1a; }
    .option:nth-child(3) .option-letter { background: var(--option-c); color: #fff; }
    .option:nth-child(4) .option-letter { background: var(--option-d); color: #fff; }
    .option input {
      margin: 0;
      accent-color: var(--accent);
    }
    .option-label {
      flex: 1;
    }

    .fill-input-wrap {
      margin-top: 0.5rem;
    }
    .fill-input-wrap input {
      width: 100%;
      max-width: 280px;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      font-family: inherit;
      background: var(--surface);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .fill-input-wrap input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    body.theme-light .fill-input-wrap input { background: var(--card); border-color: rgba(0,0,0,0.12); }

    .answer-feedback {
      margin-top: 1rem;
      padding: 0.65rem 1rem;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 1rem;
      display: none;
    }
    .answer-feedback.correct-msg { background: rgba(52, 211, 153, 0.15); color: var(--correct); display: block; border: 1px solid rgba(52, 211, 153, 0.3); }
    .answer-feedback.wrong-msg { background: rgba(248, 113, 113, 0.15); color: var(--wrong); display: block; border: 1px solid rgba(248, 113, 113, 0.3); }
    .explanation {
      margin-top: 1.25rem;
      padding: 1rem 1.15rem;
      background: rgba(52, 211, 153, 0.08);
      border: 1px solid rgba(52, 211, 153, 0.25);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      line-height: 1.65;
      color: #6ee7b7;
      white-space: pre-wrap;
    }
    body.theme-light .explanation { background: rgba(52, 211, 153, 0.1); color: #059669; border-color: rgba(52, 211, 153, 0.3); }
    .wrong-book-remove-wrap { margin-top: 0.75rem; }
    .remove-from-set-wrap { margin-top: 0.5rem; }
    .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.85rem; min-height: auto; }

    .quiz-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1.5rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .quiz-actions-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .quiz-actions .btn {
      min-width: 120px;
    }
    .quiz-actions #btn-exit-quiz { min-width: auto; }
    .quiz-shortcut-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      width: 100%;
    }

    .timer-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .timer-wrap label { font-size: 0.9rem; color: var(--text-muted); }
    .timer-wrap input[type="number"] {
      width: 4rem;
      padding: 0.45rem 0.5rem;
      font-size: 0.9rem;
      background: var(--surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
    }
    body.theme-light .timer-wrap input[type="number"] { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .shuffle-wrap { display: flex; align-items: center; gap: 0.4rem; }
    .shuffle-wrap input[type="checkbox"] { accent-color: var(--accent); cursor: pointer; }
    .shuffle-wrap label { font-size: 0.85rem; color: var(--text-muted); cursor: pointer; }
    .type-filter-wrap { margin-top: 0.75rem; }
    .type-filter-wrap .type-filter-label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.4rem; }
    .type-filter-row { display: flex; flex-wrap: wrap; gap: 0.75rem 1.25rem; align-items: center; }
    .type-filter-row label { display: flex; align-items: center; gap: 0.35rem; font-size: 0.9rem; color: var(--text); cursor: pointer; }
    .type-filter-row input[type="checkbox"] { accent-color: var(--accent); cursor: pointer; }
    .start-select-wrap { margin-bottom: 0.75rem; }
    .category-filter-wrap { margin-bottom: 0.75rem; }
    .category-filter-wrap label { display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .category-filter-wrap select {
      width: 100%;
      max-width: 320px;
      padding: 0.65rem 0.85rem;
      font-size: 0.95rem;
      font-family: inherit;
      background: var(--surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
      cursor: pointer;
    }
    body.theme-light .category-filter-wrap select { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .start-select-wrap label { display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .start-select-wrap select {
      width: 100%;
      max-width: 320px;
      padding: 0.65rem 0.85rem;
      font-size: 0.95rem;
      font-family: inherit;
      background: var(--surface);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .start-select-wrap select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }
    body.theme-light .start-select-wrap select { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .quiz-timer {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent);
      min-width: 2.5rem;
    }
    .quiz-timer.low { color: var(--wrong); }
    .question-stem-wrap { position: relative; }
    .btn-read-aloud {
      margin-top: 0.5rem;
      padding: 0.4rem 0.85rem;
      font-size: 0.85rem;
      font-weight: 500;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255,255,255,0.1);
      background: var(--surface);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-read-aloud:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
    body.theme-light .btn-read-aloud { background: var(--card); border-color: rgba(0,0,0,0.1); }
    .result-celebration {
      font-size: 1.35rem;
      margin-top: 0.75rem;
      color: var(--correct);
      font-weight: 700;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.02); }
    }
    .saved-sets-search { margin-bottom: 1rem; }
    .saved-sets-search input {
      width: 100%;
      padding: 0.65rem 1rem 0.65rem 2.25rem;
      font-size: 0.9rem;
      background: var(--bg);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .saved-sets-search input::placeholder { color: var(--text-muted); }
    .saved-sets-search input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    .saved-sets-search-wrap { position: relative; }
    .saved-sets-search-wrap::before {
      content: 'ğŸ”';
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      opacity: 0.6;
      pointer-events: none;
    }
    body.theme-light .saved-sets-search input { border-color: rgba(0,0,0,0.12); }

    /* Result */
    .result-card {
      text-align: center;
      padding: 2.5rem 2rem;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
      position: relative;
      overflow: visible;
    }
    .result-card .result-confetti { border-radius: var(--radius); }
    .result-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), #818cf8);
    }
    .result-score {
      font-size: 3.25rem;
      font-weight: 800;
      letter-spacing: -0.03em;
      background: linear-gradient(135deg, #c4b5fd, #a78bfa 40%, #818cf8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      line-height: 1.1;
    }
    .result-pct {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent);
      margin: -0.25rem 0 0.5rem;
    }
    .result-desc {
      color: var(--text-muted);
      font-size: 1.05rem;
      font-weight: 500;
      margin-bottom: 1.5rem;
    }
    .result-confetti {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      border-radius: inherit;
    }
    .result-confetti span {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: confetti 2.5s ease-out forwards;
      opacity: 0;
    }
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-120px) rotate(720deg); opacity: 0; }
    }
    .result-card .btn {
      margin-top: 0.5rem;
    }
    .result-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
      margin-top: 1.25rem;
    }
    .wrong-book-btn { background: rgba(248, 113, 113, 0.15); color: #fca5a5; border: 1px solid rgba(248, 113, 113, 0.35); }
    .wrong-book-btn:hover { background: rgba(248, 113, 113, 0.25); box-shadow: 0 4px 16px rgba(248, 113, 113, 0.2); }
    .result-recent {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.06);
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    body.theme-light .result-recent { border-top-color: rgba(0,0,0,0.06); }
    .result-recent-title { font-weight: 600; margin-bottom: 0.35rem; }
    .result-recent ul { list-style: none; }
    .result-recent li { padding: 0.2rem 0; }

    .format-doc {
      margin-top: 1.5rem;
      padding: 1.25rem;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.06);
    }
    body.theme-light .format-doc { border-color: rgba(0,0,0,0.06); }
    .format-doc-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .format-doc-title::before { content: 'â–¶'; font-size: 0.7rem; transition: transform 0.2s; }
    .format-doc.open .format-doc-title::before { transform: rotate(90deg); }
    .format-doc-content { display: none; font-size: 0.8rem; line-height: 1.7; color: var(--text-muted); }
    .format-doc.open .format-doc-content { display: block; }
    .format-doc pre {
      background: var(--bg);
      padding: 0.75rem;
      border-radius: 8px;
      overflow-x: auto;
      margin: 0.5rem 0;
      font-size: 0.75rem;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .format-doc .type-tag { color: var(--accent); font-weight: 600; }

    .saved-sets {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow-sm);
    }
    body.theme-light .saved-sets { border-color: rgba(0,0,0,0.06); }
    .saved-sets h3 {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-muted);
      letter-spacing: 0.03em;
      margin-bottom: 0.85rem;
    }
    .saved-sets-list { list-style: none; display: flex; flex-direction: column; gap: 0.65rem; }
    .saved-sets-item {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.15rem;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255,255,255,0.06);
      background: var(--surface);
      flex-wrap: wrap;
      transition: all 0.2s;
    }
    .saved-sets-item:hover {
      border-color: rgba(139, 92, 246, 0.35);
      background: var(--accent-soft);
      box-shadow: var(--shadow-sm);
    }
    body.theme-light .saved-sets-item { border-color: rgba(0,0,0,0.08); background: var(--bg); }
    body.theme-light .saved-sets-item:hover { border-color: var(--accent); background: var(--surface); }
    .saved-sets-item-content { flex: 1; min-width: 0; }
    .saved-sets-item .name {
      display: block;
      font-weight: 600;
      font-size: 1rem;
      color: var(--text);
      margin-bottom: 0.35rem;
      line-height: 1.4;
    }
    .saved-sets-item .meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.35rem;
    }
    .saved-sets-item .meta span { white-space: nowrap; }
    .saved-sets-item .meta .dot { opacity: 0.5; user-select: none; }
    .saved-sets-item .actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
    .saved-sets-item .btn { padding: 0.45rem 0.9rem; font-size: 0.85rem; border-radius: 8px; }
    .saved-sets-item .btn[data-action="rename"] { color: var(--text-muted); border-color: rgba(255,255,255,0.15); }
    .saved-sets-item .btn[data-action="rename"]:hover { color: var(--accent); border-color: var(--accent); }
    .saved-sets-item .btn[data-action="delete"] { color: var(--text-muted); border-color: rgba(255,255,255,0.1); }
    .saved-sets-item .btn[data-action="delete"]:hover { color: #f87171; border-color: rgba(248,113,113,0.5); background: rgba(248,113,113,0.08); }
    .saved-sets-item .btn[data-action="export"] { color: var(--text-muted); border-color: rgba(255,255,255,0.1); }
    .saved-sets-item .btn[data-action="export"]:hover { color: var(--accent); border-color: var(--accent); }
    body.theme-light .saved-sets-item .btn[data-action="rename"] { border-color: rgba(0,0,0,0.15); }
    body.theme-light .saved-sets-item .btn[data-action="delete"] { border-color: rgba(0,0,0,0.1); }
    body.theme-light .saved-sets-item .btn[data-action="export"] { border-color: rgba(0,0,0,0.1); }
    .saved-sets-empty { font-size: 0.9rem; color: var(--text-muted); padding: 1rem 0; text-align: center; }
    .import-name-wrap { margin-top: 0.75rem; }
    .import-name-wrap label { display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .import-name-wrap input { width: 100%; max-width: 320px; padding: 0.5rem 0.75rem; font-size: 0.9rem; background: var(--bg); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; color: var(--text); }
    body.theme-light .import-name-wrap input { background: var(--bg); border-color: rgba(0,0,0,0.12); }
    .storage-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; line-height: 1.5; }
    .storage-desc code { font-size: 0.75em; padding: 0.15em 0.4em; background: var(--bg); border-radius: 4px; }
    .btn-one-save {
      width: 100%;
      margin-bottom: 1rem;
      min-height: 48px;
      font-size: 1rem;
    }
    .storage-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    @media (max-width: 420px) {
      .storage-grid { grid-template-columns: 1fr; }
    }
    .storage-card {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
      padding: 1.1rem 1.2rem;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255,255,255,0.06);
      background: var(--surface);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    body.theme-light .storage-card { border-color: rgba(0,0,0,0.08); background: var(--card); }
    .storage-card:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    body.theme-light .storage-card:hover { background: var(--surface); border-color: var(--accent); }
    .storage-card .title { font-weight: 600; font-size: 0.9rem; color: var(--text); }
    .storage-card .hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.35rem; line-height: 1.4; }
    .save-success-tip {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--surface);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: var(--radius-sm);
    }
    body.theme-light .save-success-tip { border-color: rgba(124, 58, 237, 0.35); background: var(--card); }
    .save-success-tip-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.35rem; }
    .save-success-tip-desc { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; }
    .save-success-tip-cmd-wrap { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    .save-success-tip-cmd {
      flex: 1;
      min-width: 0;
      font-size: 0.8rem;
      padding: 0.5rem 0.6rem;
      background: var(--bg);
      border-radius: 6px;
      word-break: break-all;
    }
    body.theme-light .save-success-tip-cmd { background: var(--surface); }
    .save-success-tip-extra { font-size: 0.8rem; color: var(--text-muted); }
    .storage-fallback { margin-top: 0.75rem; font-size: 0.8rem; color: var(--text-muted); }
    .storage-fallback a { color: var(--accent); text-decoration: none; }
    .storage-fallback a:hover { text-decoration: underline; }
    input[type="file"]#file-import-data { display: none; }

    /* Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <h1>FranÃ§ais Quiz</h1>
        <p>TCF å¡«ç©º Â· æ®µè½å¡«ç©º Â· å•é€‰ Â· å¤šé€‰</p>
      </div>
      <button type="button" class="theme-toggle" id="theme-toggle" title="åˆ‡æ¢æ·±è‰²/æµ…è‰²" aria-label="åˆ‡æ¢æ·±è‰²æˆ–æµ…è‰²ä¸»é¢˜">ğŸŒ“</button>
    </header>

    <div id="screen-home" class="screen active">
      <div class="stats-bar" id="stats-bar">
        <span>ä»Šæ—¥å·²ç»ƒ <strong id="stat-today">0</strong> é¢˜</span>
        <span>è¿ç»­ <strong id="stat-streak">0</strong> å¤©</span>
        <span>é”™é¢˜æœ¬ <strong id="stat-wrong">0</strong> é¢˜</span>
        <span>ä¹ é¢˜é›† <strong id="stat-sets">0</strong> å¥—</span>
      </div>

      <div class="home-section">
        <h2>å¼€å§‹ç»ƒä¹ </h2>
        <div class="timer-wrap">
          <label for="timer-seconds">æ¯é¢˜å€’è®¡æ—¶ï¼ˆç§’ï¼‰</label>
          <input type="number" id="timer-seconds" min="0" max="120" value="10" title="0 è¡¨ç¤ºä¸é™æ—¶" />
          <div class="shuffle-wrap">
            <input type="checkbox" id="shuffle-questions" />
            <label for="shuffle-questions">æ‰“ä¹±é¢˜ç›®é¡ºåº</label>
          </div>
          <div class="shuffle-wrap">
            <input type="checkbox" id="shuffle-options" />
            <label for="shuffle-options">æ‰“ä¹±é€‰é¡¹é¡ºåº</label>
          </div>
        </div>
        <div class="type-filter-wrap">
          <span class="type-filter-label">åªåšä»¥ä¸‹é¢˜å‹ï¼ˆä¸å‹¾é€‰ = å…¨éƒ¨ï¼‰</span>
          <div class="type-filter-row">
            <label><input type="checkbox" id="filter-type-single" checked /> å•é€‰</label>
            <label><input type="checkbox" id="filter-type-multiple" checked /> å¤šé€‰</label>
            <label><input type="checkbox" id="filter-type-fill" checked /> å¡«ç©º</label>
            <label><input type="checkbox" id="filter-type-paragraph" checked /> æ®µè½å¡«ç©º</label>
          </div>
        </div>
        <div class="start-select-wrap">
          <label for="start-practice-select">é€‰æ‹©ä¹ é¢˜é›†</label>
          <select id="start-practice-select">
            <option value="default">é»˜è®¤é¢˜ç›®</option>
          </select>
        </div>
        <div class="category-filter-wrap" id="category-filter-wrap">
          <label for="filter-category">åˆ†ç±»ç­›é€‰</label>
          <select id="filter-category">
            <option value="">å…¨éƒ¨</option>
          </select>
        </div>
        <div class="home-actions">
          <button type="button" class="btn btn-primary" id="btn-start-practice">å¼€å§‹ç»ƒä¹ </button>
          <button type="button" class="btn btn-secondary" id="btn-import-show">å¯¼å…¥æˆ‘çš„é¢˜ç›®</button>
        </div>
        <div class="import-section" id="import-section" style="display: none;">
        <h3>ç²˜è´´é¢˜ç›®æ–‡æœ¬ï¼ˆæ”¯æŒä½ ç»™çš„æ ¼å¼ï¼‰</h3>
        <textarea id="import-text" placeholder="ç²˜è´´é¢˜ç›®æ–‡æœ¬ï¼ˆè§ä¸‹æ–¹è¯´æ˜ï¼‰æˆ– JSON æ•°ç»„â€¦"></textarea>
        <div class="import-name-wrap">
          <label for="import-set-name">ä¹ é¢˜é›†åç§°ï¼ˆä¿å­˜ç”¨ï¼Œå¡«å†™åæœ¬æ¬¡å¯¼å…¥ä¼šåŠ å…¥ã€Œæˆ‘çš„ä¹ é¢˜é›†ã€ï¼‰</label>
          <input type="text" id="import-set-name" placeholder="ä¾‹å¦‚ï¼šavoir å›ºå®šè¡¨è¾¾" autocomplete="off" />
        </div>
        <button type="button" class="btn btn-primary" id="btn-import-parse" style="margin-top: 0.75rem;">è§£æå¹¶å¼€å§‹</button>
        </div>
      </div>

      <div class="home-section">
        <h2>é”™é¢˜æœ¬</h2>
        <div class="home-actions">
          <button type="button" class="btn wrong-book-btn" id="btn-wrong-book">æŒ‰è®¡åˆ’å¤ä¹  (<span id="wrong-count">0</span>)</button>
          <button type="button" class="btn btn-secondary" id="btn-wrong-free">è‡ªç”±ç»ƒä¹ å…¨éƒ¨</button>
          <button type="button" class="btn btn-secondary" id="btn-clear-wrong">æ¸…ç©ºé”™é¢˜æœ¬</button>
        </div>
      </div>

      <div class="home-section" id="storage-section">
        <h2>æ•°æ®å­˜åˆ°é¡¹ç›®æ–‡ä»¶å¤¹ / äº‘ç«¯åŒæ­¥</h2>
        <p class="storage-desc">ç”µè„‘ï¼šä¸€é”®ä¿å­˜åˆ°é¡¹ç›®é‡Œçš„ <code>french_quiz_data.json</code>ã€‚æ‰‹æœºè¦çœ‹åˆ°åŒä¸€ä»½ä¹ é¢˜é›†ï¼šä¿å­˜ååœ¨é¡¹ç›®ç›®å½•æ‰§è¡Œä¸‹æ–¹å‘½ä»¤ï¼Œ<strong>åŒæ—¶æ¨é€ä¸»ä»“åº“ + Pages ç«™ç‚¹</strong>ï¼Œæ‰‹æœºæ‰“å¼€æœ¬é¡µåç‚¹ã€Œ<strong>ä»äº‘ç«¯åŠ è½½</strong>ã€å³å¯åŒæ­¥ã€‚</p>
        <button type="button" class="btn btn-primary btn-one-save" id="btn-one-save">ä¸€é”®ä¿å­˜ï¼ˆè¦†ç›–åˆ°é¡¹ç›®æ–‡ä»¶å¤¹ï¼‰</button>
        <button type="button" class="btn btn-primary btn-one-save" id="btn-load-cloud" style="background: linear-gradient(135deg, #059669, #0d9488);">ä»äº‘ç«¯åŠ è½½ï¼ˆæ‰‹æœºåŒæ­¥ä¹ é¢˜é›†ï¼‰</button>
        <div class="storage-grid">
          <button type="button" class="storage-card" id="btn-open-folder">
            <span class="title">æ‰“å¼€å¹¶åŠ è½½</span>
            <span class="hint">é€‰æ‹© french-quiz æ–‡ä»¶å¤¹ï¼Œè¯»å–æœ¬åœ° JSON</span>
          </button>
          <button type="button" class="storage-card" id="btn-save-to-folder">
            <span class="title">ä¿å­˜åˆ°é¡¹ç›®æ–‡ä»¶å¤¹</span>
            <span class="hint">è¦†ç›– french_quiz_data.json</span>
          </button>
          <button type="button" class="storage-card" id="btn-export-data">
            <span class="title">å¯¼å‡ºåˆ°é¡¹ç›®æ–‡ä»¶å¤¹ï¼ˆè¦†ç›–ï¼‰</span>
            <span class="hint">ç›´æ¥å†™å…¥é¡¹ç›®ç›®å½•ï¼Œè¦†ç›–åŸæ–‡ä»¶</span>
          </button>
          <button type="button" class="storage-card" id="btn-import-data">
            <span class="title">ä»æ–‡ä»¶å¯¼å…¥</span>
            <span class="hint">é€‰æ‹©æœ¬æœº JSON æ–‡ä»¶æ¢å¤æ•°æ®</span>
          </button>
        </div>
        <div class="save-success-tip" id="save-success-tip" style="display: none;">
          <p class="save-success-tip-title">å·²ä¿å­˜ã€‚è¦åŒæ­¥åˆ° GitHubï¼ˆä¸»ä»“åº“ + Pages ç«™ç‚¹ä¸€èµ·æ›´æ–°ï¼‰ï¼š</p>
          <p class="save-success-tip-desc">åœ¨é¡¹ç›®ç›®å½•æ‰“å¼€ç»ˆç«¯ï¼Œè¿è¡Œï¼ˆæˆ–ç‚¹å‡»å¤åˆ¶ï¼‰ï¼ŒæŠŠ <code>../french-quiz-pages</code> æ¢æˆä½ çš„å…¬å¼€ Pages ä»“åº“è·¯å¾„ï¼š</p>
          <div class="save-success-tip-cmd-wrap">
            <code class="save-success-tip-cmd" id="save-deploy-cmd">./sync-and-push.sh ../french-quiz-pages</code>
            <button type="button" class="btn btn-secondary btn-sm" id="btn-copy-deploy-cmd">å¤åˆ¶å‘½ä»¤</button>
          </div>
          <p class="save-success-tip-extra">åªæ¨å½“å‰ä»“åº“ç”¨ <code>./sync-and-push.sh</code>ï¼›åŒæ—¶æ›´æ–°ä¸»ä»“åº“+Pages ç”¨ <code>./sync-and-push.sh ../french-quiz-pages</code>ã€‚é¦–æ¬¡éœ€ <code>chmod +x sync-and-push.sh</code>ã€‚</p>
        </div>
        <p class="storage-fallback">æ— æ³•é€‰æ‹©æ–‡ä»¶å¤¹ï¼Ÿ<a href="#" id="link-download-json">ä¸‹è½½ JSON åˆ°ç”µè„‘</a></p>
        <input type="file" id="file-import-data" accept=".json,application/json" />
      </div>

      <div class="home-section saved-sets" id="saved-sets-section">
        <h2>æˆ‘çš„ä¹ é¢˜é›†</h2>
        <div class="saved-sets-search">
          <div class="saved-sets-search-wrap">
            <input type="text" id="saved-sets-search" placeholder="æœç´¢ä¹ é¢˜é›†åç§°â€¦" autocomplete="off" />
          </div>
        </div>
        <ul class="saved-sets-list" id="saved-sets-list"></ul>
        <p class="saved-sets-empty" id="saved-sets-empty" style="display: none;">æš‚æ— ä¿å­˜çš„ä¹ é¢˜é›†ï¼Œå¯¼å…¥é¢˜ç›®æ—¶å¡«å†™åç§°å³å¯ä¿å­˜ã€‚</p>
      </div>

      <div class="home-section format-doc" id="format-doc">
        <h2 class="format-doc-title">å„é¢˜å‹æ ¼å¼è¯´æ˜ï¼ˆç‚¹å¼€æŸ¥çœ‹ï¼‰</h2>
        <div class="format-doc-content">
          <p><strong>é€šç”¨ï¼š</strong>å¯ç›´æ¥ç²˜è´´ JSON é¢˜ç›®æ•°ç»„ï¼Œæˆ–æŒ‰ä¸‹æ–¹æ–‡æœ¬æ ¼å¼ç²˜è´´ã€‚</p>
          <p><span class="type-tag">å•é€‰é¢˜ single_choice</span></p>
          <pre>{"type":"single_choice","stem":"Nous ______ une lettre.","options":["Ã©cris","Ã©crit","Ã©crivons","Ã©crivent"],"correct":2,"explanation":"nous ç”¨ Ã©crivonsã€‚","category":"è¯­æ³•"}</pre>
          <p><span class="type-tag">å¤šé€‰é¢˜ multiple_choice</span> â€” correct ä¸ºæ­£ç¡®é€‰é¡¹ç´¢å¼•æ•°ç»„ã€‚</p>
          <pre>{"type":"multiple_choice","stem":"ä¸‹åˆ—å“ªäº›æ˜¯å¤æ•°å½¢å¼ï¼Ÿ","options":["ils","il","elles","elle"],"correct":[0,2],"explanation":"ils/elles ä¸ºå¤æ•°ã€‚"}</pre>
          <p><span class="type-tag">å¡«ç©ºé¢˜ fill_blank</span> â€” correct ä¸ºç­”æ¡ˆå­—ç¬¦ä¸²æˆ–å¯æ¥å—ç­”æ¡ˆæ•°ç»„ã€‚</p>
          <pre>{"type":"fill_blank","stem":"Il _____ (avoir) 20 ans.","correct":["a","a "],"explanation":"avoir ç¬¬ä¸‰äººç§°å•æ•°å˜ä½ä¸º aã€‚"}</pre>
          <p><span class="type-tag">æ®µè½å¡«ç©ºé¢˜ paragraph_fill_blank</span> â€” é¢˜å¹²ä¸­ç”¨ _____ è¡¨ç¤ºç©ºï¼Œé¡ºåºå¯¹åº” correct æ•°ç»„ã€‚</p>
          <pre>{"type":"paragraph_fill_blank","stem":"Il a _____ ans. Elle _____ (s'appeler) Marie.","correct":["15","s'appelle"],"explanation":"ä¸¤ç©ºä¾æ¬¡å¡«å†™ã€‚"}</pre>
          <p><strong>æ–‡æœ¬æ ¼å¼ï¼ˆå•é€‰é¢˜ï¼‰ï¼š</strong>å«ã€Œé¢˜å‹ï¼šã€ã€ŒA) B) C) D)ã€ã€Œæ­£ç¡®ï¼šã€å³å¯è§£æã€‚ä¾‹ï¼š</p>
          <pre>é¢˜å‹ï¼šNous ______ une lettre Ã  nos parents.
A) Ã©cris  B) Ã©crit  C) Ã©crivons  D) Ã©crivent
æ­£ç¡®ï¼šC</pre>
        </div>
      </div>
    </div>

    <div id="screen-quiz" class="screen">
      <div class="progress-wrap">
        <span class="progress-estimate" id="progress-estimate"></span>
        <span class="progress-label" id="progress-label">ç¬¬ 1 / 1 é¢˜</span>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
      </div>
      <div class="question-card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.5rem;">
          <div class="question-meta" id="question-meta"></div>
          <div style="display:flex;align-items:center;gap:0.35rem;">
            <svg class="timer-ring" id="timer-ring" width="40" height="40" viewBox="0 0 40 40" style="display:none;">
              <circle cx="20" cy="20" r="17" fill="none" stroke="var(--surface)" stroke-width="3" />
              <circle class="timer-ring-fill" id="timer-ring-fill" cx="20" cy="20" r="17" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="106.81" stroke-dashoffset="0" stroke-linecap="round" transform="rotate(-90 20 20)" />
            </svg>
            <span class="quiz-timer" id="quiz-timer" style="display: none;"></span>
          </div>
        </div>
        <div class="question-stem-wrap">
          <div class="question-stem" id="question-stem"></div>
          <button type="button" class="btn-read-aloud" id="btn-read-aloud" title="æœ—è¯»é¢˜å¹²ï¼ˆæ³•è¯­ï¼‰" aria-label="æœ—è¯»é¢˜å¹²ï¼ˆæ³•è¯­ï¼‰">ğŸ”Š æœ—è¯»</button>
        </div>
        <div class="options" id="options-container"></div>
        <div class="fill-input-wrap" id="fill-input-wrap" style="display: none;">
          <input type="text" id="fill-input" placeholder="è¾“å…¥ç­”æ¡ˆ..." autocomplete="off" />
        </div>
        <div class="paragraph-blanks" id="paragraph-blanks-wrap" style="display: none;"></div>
        <div class="answer-feedback" id="answer-feedback"></div>
        <div class="explanation" id="explanation" style="display: none;"></div>
        <div class="wrong-book-remove-wrap" id="wrong-book-remove-wrap" style="display: none;">
          <button type="button" class="btn btn-secondary btn-sm" id="btn-remove-from-wrong">ç§»å‡ºé”™é¢˜æœ¬</button>
        </div>
        <div class="remove-from-set-wrap" id="remove-from-set-wrap" style="display: none;">
          <button type="button" class="btn btn-secondary btn-sm" id="btn-remove-from-set">ä»ç»ƒä¹ é›†åˆ é™¤æœ¬é¢˜</button>
        </div>
      </div>
      <div class="quiz-actions">
        <span id="question-counter"></span>
        <div class="quiz-actions-right">
          <button type="button" class="btn btn-secondary" id="btn-exit-quiz" aria-label="æå‰é€€å‡ºç»ƒä¹ ">æå‰é€€å‡º</button>
          <button type="button" class="btn btn-primary" id="btn-next" style="display: none;" aria-label="ä¸‹ä¸€é¢˜">ä¸‹ä¸€é¢˜</button>
          <button type="button" class="btn btn-primary" id="btn-submit" aria-label="ç¡®è®¤ç­”æ¡ˆ">ç¡®è®¤</button>
        </div>
      </div>
      <p class="quiz-shortcut-hint" aria-hidden="true">å¿«æ·é”®ï¼š1â€“4 é€‰é€‰é¡¹ï¼ŒEnter ç¡®è®¤</p>
    </div>

    <div id="screen-result" class="screen">
      <div class="result-card" id="result-card">
        <div class="result-score" id="result-score" role="text" aria-live="polite">0/0</div>
        <p class="result-pct" id="result-pct"></p>
        <p class="result-desc" id="result-desc">å®Œæˆç»ƒä¹ </p>
        <p class="result-celebration" id="result-celebration" style="display: none;">ğŸ‰ å…¨å¯¹ï¼</p>
        <div class="result-confetti" id="result-confetti" aria-hidden="true"></div>
        <div class="result-actions">
          <button type="button" class="btn btn-primary" id="btn-restart" aria-label="å†ç»ƒä¸€é">å†ç»ƒä¸€é</button>
          <button type="button" class="btn wrong-book-btn" id="btn-result-wrong" aria-label="é”™é¢˜æœ¬æŒ‰è®¡åˆ’å¤ä¹ ">é”™é¢˜æœ¬Â·æŒ‰è®¡åˆ’</button>
          <button type="button" class="btn btn-secondary" id="btn-result-wrong-free" aria-label="é”™é¢˜è‡ªç”±ç»ƒä¹ ">é”™é¢˜è‡ªç”±ç»ƒä¹ </button>
          <button type="button" class="btn btn-secondary" id="btn-share-result" aria-label="åˆ†äº«æˆç»©">åˆ†äº«æˆç»©</button>
          <button type="button" class="btn btn-secondary" id="btn-back-home" aria-label="è¿”å›é¦–é¡µ">è¿”å›é¦–é¡µ</button>
        </div>
        <div class="result-recent" id="result-recent" style="display: none;"></div>
      </div>
    </div>
    <div id="sr-announcer" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
  </div>

  <script>
    const LETTERS = ['A', 'B', 'C', 'D'];
    const WRONG_BOOK_KEY = 'french_quiz_wrong';
    const SAVED_SETS_KEY = 'french_quiz_saved_sets';
    const TIMER_SECONDS_KEY = 'french_quiz_timer_seconds';
    const DAILY_STATS_KEY = 'french_quiz_daily_stats';
    const RECENT_SESSIONS_KEY = 'french_quiz_recent_sessions';
    const THEME_KEY = 'french_quiz_theme';
    const DATA_FILE_NAME = 'french_quiz_data.json';
    const RECENT_SESSIONS_MAX = 10;
    const SCREEN = { HOME: 'screen-home', QUIZ: 'screen-quiz', RESULT: 'screen-result' };

    const QUIZ_PROGRESS_KEY = 'french_quiz_progress';

    let projectFolderHandle = null;
    let _savedSetsCache = null;
    let _savedSetsCacheDirty = true;
    let _wrongBookCache = null;
    let _wrongBookCacheDirty = true;
    const _escapeDiv = document.createElement('div');
    const _wrongBookIdCache = new WeakMap();

    function getRecentSessions() {
      try {
        const raw = localStorage.getItem(RECENT_SESSIONS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr.slice(-RECENT_SESSIONS_MAX) : [];
      } catch (_) { return []; }
    }
    function pushRecentSession(total, score) {
      const sessions = getRecentSessions();
      sessions.push({ total, score, at: new Date().toISOString() });
      localStorage.setItem(RECENT_SESSIONS_KEY, JSON.stringify(sessions.slice(-RECENT_SESSIONS_MAX)));
    }

    function saveQuizProgress() {
      try {
        sessionStorage.setItem(QUIZ_PROGRESS_KEY, JSON.stringify({
          questions: state.questions, index: state.index, score: state.score,
          timerSeconds: state.timerSeconds, practicingWrongBook: state.practicingWrongBook,
          practicedSetId: state.practicedSetId, savedAt: Date.now()
        }));
      } catch (_) {}
    }
    function clearQuizProgress() { try { sessionStorage.removeItem(QUIZ_PROGRESS_KEY); } catch (_) {} }
    function getQuizProgress() {
      try {
        const raw = sessionStorage.getItem(QUIZ_PROGRESS_KEY);
        if (!raw) return null;
        const p = JSON.parse(raw);
        if (Date.now() - p.savedAt > 2 * 60 * 60 * 1000) { clearQuizProgress(); return null; }
        return p;
      } catch (_) { return null; }
    }

    function getDailyStats() {
      try {
        const raw = localStorage.getItem(DAILY_STATS_KEY);
        const data = raw ? JSON.parse(raw) : {};
        const today = new Date().toISOString().slice(0, 10);
        const yesterday = new Date(Date.now() - 864e5).toISOString().slice(0, 10);
        if (data.date !== today) {
          return {
            date: today,
            todayCount: 0,
            lastDate: data.lastDate || data.date,
            streak: data.streak || 0
          };
        }
        return {
          date: today,
          todayCount: data.todayCount || 0,
          lastDate: data.lastDate || data.date,
          streak: data.streak || 0
        };
      } catch (_) { return { date: new Date().toISOString().slice(0, 10), todayCount: 0, lastDate: null, streak: 0 }; }
    }
    function addTodayPractice(n) {
      const raw = localStorage.getItem(DAILY_STATS_KEY);
      const data = raw ? JSON.parse(raw) : {};
      const today = new Date().toISOString().slice(0, 10);
      const yesterday = new Date(Date.now() - 864e5).toISOString().slice(0, 10);
      let streak = data.streak || 0;
      let todayCount = data.todayCount || 0;
      if (data.date === today) {
        todayCount += (n || 0);
      } else {
        todayCount = n || 0;
        const prevDate = data.lastDate || data.date;
        if (prevDate === yesterday) streak += 1;
        else if (prevDate !== today) streak = 1;
      }
      const st = { date: today, todayCount, lastDate: today, streak };
      localStorage.setItem(DAILY_STATS_KEY, JSON.stringify(st));
      updateStatsBar();
    }
    function animateStatChange(el, newValue) {
      if (!el) return;
      const oldText = el.textContent;
      el.textContent = newValue;
      if (oldText !== String(newValue)) {
        el.classList.remove('updated');
        void el.offsetWidth;
        el.classList.add('updated');
      }
    }
    function updateStatsBar() {
      const st = getDailyStats();
      const elToday = document.getElementById('stat-today');
      const elWrong = document.getElementById('stat-wrong');
      const elSets = document.getElementById('stat-sets');
      const elStreak = document.getElementById('stat-streak');
      animateStatChange(elToday, st.todayCount || 0);
      animateStatChange(elWrong, getWrongBook().length);
      animateStatChange(elSets, getSavedSets().length);
      animateStatChange(elStreak, st.streak || 0);
    }
    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function normalizeFrench(str) {
      return str
        .trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/\u0153/g, 'oe')
        .replace(/\u00e6/g, 'ae')
        .replace(/\s+/g, ' ');
    }
    function matchFrenchAnswer(val, acceptList) {
      return acceptList.some(c => c === val) || acceptList.some(c => normalizeFrench(c) === normalizeFrench(val));
    }

    const QUESTION_TYPES = { single_choice: 'å•é€‰', multiple_choice: 'å¤šé€‰', fill_blank: 'å¡«ç©º', paragraph_fill_blank: 'æ®µè½å¡«ç©º' };
    function getSelectedTypeFilter() {
      const single = document.getElementById('filter-type-single');
      const multiple = document.getElementById('filter-type-multiple');
      const fill = document.getElementById('filter-type-fill');
      const paragraph = document.getElementById('filter-type-paragraph');
      const types = [];
      if (single && single.checked) types.push('single_choice');
      if (multiple && multiple.checked) types.push('multiple_choice');
      if (fill && fill.checked) types.push('fill_blank');
      if (paragraph && paragraph.checked) types.push('paragraph_fill_blank');
      return types.length === 0 ? null : types;
    }
    function filterQuestionsByType(questions, typeFilter) {
      if (!questions || !typeFilter || typeFilter.length === 0) return questions || [];
      return questions.filter(q => q && typeFilter.includes(q.type));
    }
    function shuffleQuestionOptions(q) {
      if (!q || (q.type !== 'single_choice' && q.type !== 'multiple_choice') || !q.options || !q.options.length) return q;
      const perm = shuffleArray(q.options.map((_, i) => i));
      const newOptions = perm.map(i => q.options[i]);
      const oldCorrect = Array.isArray(q.correct) ? q.correct : [q.correct];
      const newCorrect = q.type === 'single_choice'
        ? perm.indexOf(oldCorrect[0])
        : oldCorrect.map(c => perm.indexOf(c)).sort((a, b) => a - b);
      return Object.assign({}, q, { options: newOptions, correct: newCorrect });
    }

    function getDataForExport() {
      const timerEl = document.getElementById('timer-seconds');
      return {
        savedSets: getSavedSets(),
        wrongBook: getWrongBook(),
        timerSeconds: timerEl ? Math.max(0, parseInt(timerEl.value, 10) || 10) : 10,
        dailyStats: getDailyStats(),
        exportedAt: new Date().toISOString()
      };
    }
    function loadDataFromObject(data) {
      if (data.savedSets != null) setSavedSets(Array.isArray(data.savedSets) ? data.savedSets : []);
      if (data.wrongBook != null) setWrongBook(Array.isArray(data.wrongBook) ? data.wrongBook : []);
      if (data.timerSeconds != null) {
        const n = Math.max(0, Math.min(120, parseInt(data.timerSeconds, 10) || 10));
        const el = document.getElementById('timer-seconds');
        if (el) { el.value = n; localStorage.setItem(TIMER_SECONDS_KEY, String(n)); }
      }
      if (data.dailyStats != null && data.dailyStats.date) {
        try {
          localStorage.setItem(DAILY_STATS_KEY, JSON.stringify({
            date: data.dailyStats.date,
            todayCount: data.dailyStats.todayCount || 0,
            lastDate: data.dailyStats.lastDate || data.dailyStats.date,
            streak: data.dailyStats.streak || 0
          }));
        } catch (_) {}
        updateStatsBar();
      }
      updateWrongCount();
      renderSavedSets();
      updateStartPracticeSelect();
    }
    async function loadFromCloud() {
      let url = DATA_FILE_NAME;
      if (typeof location !== 'undefined' && location.origin) {
        const dir = location.pathname.replace(/\/[^/]*$/, '') || '/';
        const base = dir.endsWith('/') ? dir : dir + '/';
        url = location.origin + base + DATA_FILE_NAME;
      }
      const btn = document.getElementById('btn-load-cloud');
      if (btn) { btn.disabled = true; btn.textContent = 'åŠ è½½ä¸­â€¦'; }
      try {
        const res = await fetch(url + '?t=' + Date.now());
        if (!res.ok) throw new Error(res.status === 404 ? 'æœªæ‰¾åˆ°äº‘ç«¯æ•°æ®' : 'è¯·æ±‚å¤±è´¥');
        const data = await res.json();
        if (!data || (data.savedSets == null && data.wrongBook == null)) throw new Error('æ•°æ®æ ¼å¼æ— æ•ˆ');
        loadDataFromObject(data);
        alert('å·²ä»äº‘ç«¯åŠ è½½ï¼š' + (data.savedSets && data.savedSets.length ? data.savedSets.length + ' å¥—ä¹ é¢˜é›†' : '') + (data.wrongBook && data.wrongBook.length ? 'ï¼Œ' + data.wrongBook.length + ' é“é”™é¢˜' : '') + 'ã€‚');
      } catch (e) {
        alert('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚è‹¥å·²éƒ¨ç½²ï¼Œè¯·ç¡®è®¤ç”µè„‘ç«¯å·²ä¿å­˜å¹¶æŠŠ french_quiz_data.json æäº¤æ¨é€åˆ° GitHubã€‚');
      }
      if (btn) { btn.disabled = false; btn.textContent = 'ä»äº‘ç«¯åŠ è½½ï¼ˆæ‰‹æœºåŒæ­¥ä¹ é¢˜é›†ï¼‰'; }
    }
    async function pickFolderAndLoad() {
      if (!('showDirectoryPicker' in window)) {
        alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒé€‰æ‹©æ–‡ä»¶å¤¹ï¼Œè¯·ç”¨ Chrome æˆ– Edgeï¼Œæˆ–ä½¿ç”¨ä¸‹æ–¹ã€Œä»æ–‡ä»¶å¯¼å…¥æ•°æ®ã€é€‰æ‹© JSON æ–‡ä»¶ã€‚');
        return;
      }
      try {
        const handle = await window.showDirectoryPicker();
        projectFolderHandle = handle;
        let fileHandle = await handle.getFileHandle(DATA_FILE_NAME, { create: false }).catch(() => null);
        if (!fileHandle) {
          fileHandle = await handle.getFileHandle(DATA_FILE_NAME, { create: true });
          const writable = await fileHandle.createWritable();
          const empty = { savedSets: [], wrongBook: [], timerSeconds: 10 };
          await writable.write(JSON.stringify(empty, null, 2));
          await writable.close();
          loadDataFromObject(empty);
          alert('å·²åœ¨é¡¹ç›®æ–‡ä»¶å¤¹åˆ›å»º ' + DATA_FILE_NAME + ' å¹¶åŠ è½½ç©ºæ•°æ®ã€‚');
          return;
        }
        const file = await fileHandle.getFile();
        const text = await file.text();
        const data = JSON.parse(text);
        loadDataFromObject(data);
        alert('å·²ä»é¡¹ç›®æ–‡ä»¶å¤¹åŠ è½½æ•°æ®ã€‚');
      } catch (e) {
        if (e.name === 'AbortError') return;
        console.error(e);
        alert('åŠ è½½å¤±è´¥ï¼š' + (e.message || String(e)));
      }
    }
    async function saveToProjectFolder() {
      if (!projectFolderHandle) {
        if (!('showDirectoryPicker' in window)) {
          alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒã€‚è¯·ç”¨ Chrome/Edge é€‰æ‹©æ–‡ä»¶å¤¹ï¼Œæˆ–ä½¿ç”¨ã€Œå¯¼å‡ºæ•°æ®ã€ä¸‹è½½ JSON åæ‰‹åŠ¨æ”¾åˆ° french-quiz æ–‡ä»¶å¤¹ã€‚');
          return;
        }
        try {
          projectFolderHandle = await window.showDirectoryPicker();
        } catch (e) {
          if (e.name === 'AbortError') return;
          throw e;
        }
      }
      try {
        const fileHandle = await projectFolderHandle.getFileHandle(DATA_FILE_NAME, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(getDataForExport(), null, 2));
        await writable.close();
        const tipEl = document.getElementById('save-success-tip');
        if (tipEl) {
          tipEl.style.display = 'block';
          tipEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        alert('å·²ä¿å­˜ã€‚ä¸‹æ–¹å¤åˆ¶å‘½ä»¤åˆ°ç»ˆç«¯æ‰§è¡Œï¼Œå¯åŒæ—¶æ¨é€ä¸»ä»“åº“å’Œ Pages ç«™ç‚¹ã€‚');
      } catch (e) {
        console.error(e);
        alert('ä¿å­˜å¤±è´¥ï¼š' + (e.message || String(e)) + 'ã€‚è¯·é‡æ–°ç‚¹å‡»ã€Œæ‰“å¼€é¡¹ç›®æ–‡ä»¶å¤¹å¹¶åŠ è½½ã€é€‰æ‹© french-quiz æ–‡ä»¶å¤¹ã€‚');
        projectFolderHandle = null;
      }
    }
    function exportDataDownload() {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([JSON.stringify(getDataForExport(), null, 2)], { type: 'application/json' }));
      a.download = DATA_FILE_NAME;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function importDataFromFile(file) {
      const fr = new FileReader();
      fr.onload = () => {
        try {
          const data = JSON.parse(fr.result);
          loadDataFromObject(data);
          alert('å·²ä»æ–‡ä»¶å¯¼å…¥æ•°æ®ã€‚');
        } catch (e) {
          alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + (e.message || String(e)));
        }
      };
      fr.readAsText(file);
    }

    function getSavedSets() {
      if (!_savedSetsCacheDirty && _savedSetsCache !== null) return _savedSetsCache;
      try {
        const raw = localStorage.getItem(SAVED_SETS_KEY);
        _savedSetsCache = raw ? JSON.parse(raw) : [];
        _savedSetsCacheDirty = false;
        return _savedSetsCache;
      } catch (_) { return []; }
    }
    function setSavedSets(arr) {
      _savedSetsCache = arr;
      _savedSetsCacheDirty = false;
      localStorage.setItem(SAVED_SETS_KEY, JSON.stringify(arr));
      renderSavedSets();
      updateStatsBar();
      updateStartPracticeSelect();
    }
    function removeCurrentQuestionFromSet() {
      if (!state.practicedSetId) return;
      const q = state.questions[state.index];
      if (!q) return;
      const sets = getSavedSets();
      const setId = String(state.practicedSetId);
      const set = sets.find(s => String(s.id) === setId);
      if (!set || !set.questions) return;
      const currentId = wrongBookItemId(q);
      const newQuestions = set.questions.filter(qq => wrongBookItemId(qq) !== currentId);
      if (newQuestions.length === set.questions.length) return;
      const updated = sets.map(s => String(s.id) === setId ? Object.assign({}, s, { questions: newQuestions }) : s);
      setSavedSets(updated);
      state.questions.splice(state.index, 1);
      if (state.questions.length === 0) {
        showResult();
        return;
      }
      if (state.index >= state.questions.length) state.index = state.questions.length - 1;
      renderQuestion();
    }
    function updateStartPracticeSelect() {
      const sel = document.getElementById('start-practice-select');
      if (!sel) return;
      const saved = getSavedSets();
      const currentVal = sel.value;
      sel.innerHTML = '<option value="default">é»˜è®¤é¢˜ç›®</option>' +
        saved.map(s => '<option value="' + s.id + '">' + escapeHtml(s.name) + ' (' + s.questions.length + ' é¢˜)</option>').join('');
      if (currentVal && (currentVal === 'default' || saved.some(s => String(s.id) === currentVal))) sel.value = currentVal;
    }
    function formatSavedSetDate(iso) {
      const d = new Date(iso);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const h = String(d.getHours()).padStart(2, '0');
      const min = String(d.getMinutes()).padStart(2, '0');
      return y + '-' + m + '-' + day + ' ' + h + ':' + min;
    }
    function renderSavedSets() {
      const sets = getSavedSets();
      const searchEl = document.getElementById('saved-sets-search');
      const query = (searchEl && searchEl.value ? searchEl.value : '').trim().toLowerCase();
      const filtered = query ? sets.filter(s => (s.name || '').toLowerCase().includes(query)) : sets;
      const listEl = document.getElementById('saved-sets-list');
      const emptyEl = document.getElementById('saved-sets-empty');
      if (!listEl || !emptyEl) return;
      if (filtered.length === 0) {
        listEl.innerHTML = '';
        emptyEl.style.display = 'block';
        emptyEl.textContent = query ? 'æ²¡æœ‰åŒ¹é…çš„ä¹ é¢˜é›†' : 'è¿˜æ²¡æœ‰ä¹ é¢˜é›†ï¼Œå»ã€Œå¼€å§‹ç»ƒä¹ ã€é‡Œç²˜è´´é¢˜ç›®å¹¶å¡«å†™åç§°ï¼Œå³å¯ä¿å­˜åˆ°è¿™é‡Œã€‚';
        return;
      }
      emptyEl.style.display = 'none';
      listEl.innerHTML = filtered.map(s => {
        const count = s.practiceCount || 0;
        const lastStr = s.lastPracticedAt ? 'æœ€è¿‘ ' + formatSavedSetDate(s.lastPracticedAt) : 'æœªç»ƒä¹ ';
        return `
        <li class="saved-sets-item" data-id="${String(s.id)}">
          <div class="saved-sets-item-content">
            <span class="name">${escapeHtml(s.name)}</span>
            <div class="meta">
              <span>${escapeHtml(formatSavedSetDate(s.createdAt))}</span>
              <span class="dot">Â·</span>
              <span>${s.questions.length} é¢˜</span>
              <span class="dot">Â·</span>
              <span>ç»ƒä¹  ${count} æ¬¡</span>
              <span class="dot">Â·</span>
              <span>${lastStr}</span>
            </div>
          </div>
          <div class="actions">
            <button type="button" class="btn btn-primary" data-action="start">å¼€å§‹</button>
            <button type="button" class="btn btn-secondary" data-action="export">å¯¼å‡º</button>
            <button type="button" class="btn btn-secondary" data-action="rename">é‡å‘½å</button>
            <button type="button" class="btn btn-secondary" data-action="delete">åˆ é™¤</button>
          </div>
        </li>
      `;
      }).join('');
    }
    function handleSavedSetsAction(e) {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;
      const item = btn.closest('.saved-sets-item');
      if (!item) return;
      const id = item.dataset.id;
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === id);
      switch (btn.dataset.action) {
        case 'start':
          if (set && set.questions && set.questions.length) startQuiz(set.questions, false, set.id);
          break;
        case 'export':
          if (!set || !set.questions) return;
          const name = (set.name || 'ä¹ é¢˜é›†').replace(/[\\/:*?"<>|]/g, '_').slice(0, 50);
          const blob = new Blob([JSON.stringify(set.questions, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = (name || 'export') + '.json';
          a.click();
          URL.revokeObjectURL(a.href);
          break;
        case 'rename':
          if (!set) return;
          const newName = prompt('è¾“å…¥ä¹ é¢˜é›†æ–°åç§°ï¼š', set.name || '');
          if (newName == null) return;
          const trimmed = String(newName).trim();
          if (!trimmed) return;
          setSavedSets(sets.map(s => String(s.id) === id ? Object.assign({}, s, { name: trimmed }) : s));
          break;
        case 'delete':
          if (confirm('ç¡®å®šåˆ é™¤è¯¥ä¹ é¢˜é›†ï¼Ÿ')) {
            setSavedSets(sets.filter(s => String(s.id) !== id));
          }
          break;
      }
    }

    const EBINGHAUS_INTERVALS = [1, 3, 7, 14, 30];
    function todayString() {
      const d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }
    function addDays(dayStr, days) {
      const d = new Date(dayStr + 'T12:00:00');
      d.setDate(d.getDate() + days);
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }
    function wrongBookItemId(item) {
      if (_wrongBookIdCache.has(item)) return _wrongBookIdCache.get(item);
      const id = (item.stem || '') + '|' + (item.options ? item.options.join('|') : '') + '|' + String(item.correct != null ? item.correct : '');
      _wrongBookIdCache.set(item, id);
      return id;
    }
    function getWrongBook() {
      if (!_wrongBookCacheDirty && _wrongBookCache !== null) return _wrongBookCache;
      try {
        const raw = localStorage.getItem(WRONG_BOOK_KEY);
        _wrongBookCache = raw ? JSON.parse(raw) : [];
        _wrongBookCacheDirty = false;
        return _wrongBookCache;
      } catch (_) { return []; }
    }
    function setWrongBook(arr) {
      _wrongBookCache = arr;
      _wrongBookCacheDirty = false;
      localStorage.setItem(WRONG_BOOK_KEY, JSON.stringify(arr));
      updateWrongCount();
      updateStatsBar();
    }
    function removeFromWrongBook(q) {
      const book = getWrongBook();
      const id = wrongBookItemId(q);
      const next = book.filter(item => wrongBookItemId(item) !== id);
      if (next.length < book.length) setWrongBook(next);
    }
    function getWrongBookDue() {
      const book = getWrongBook();
      const today = todayString();
      return book
        .filter(item => {
          const next = item.nextReview;
          if (!next) return true;
          return next <= today;
        })
        .sort((a, b) => (a.nextReview || '').localeCompare(b.nextReview || ''));
    }
    function addToWrongBook(q) {
      const book = getWrongBook();
      const id = wrongBookItemId(q);
      if (book.some(item => wrongBookItemId(item) === id)) return;
      const nextReview = addDays(todayString(), 1);
      book.push(Object.assign({}, q, { nextReview: nextReview, interval: 1, repetitions: 0 }));
      setWrongBook(book);
    }
    function addToWrongBookDirect(item) {
      const book = getWrongBook();
      const id = wrongBookItemId(item);
      if (book.some(i => wrongBookItemId(i) === id)) return;
      book.push(item);
      setWrongBook(book);
    }
    function updateWrongBookAfterAnswer(item, correct) {
      const book = getWrongBook();
      const id = wrongBookItemId(item);
      const idx = book.findIndex(i => wrongBookItemId(i) === id);
      if (idx === -1) return;
      const today = todayString();
      if (correct) {
        const rep = (book[idx].repetitions || 0) + 1;
        if (rep >= 5) {
          book.splice(idx, 1);
        } else {
          const intervalDays = EBINGHAUS_INTERVALS[Math.min(rep, EBINGHAUS_INTERVALS.length - 1)];
          book[idx] = Object.assign({}, book[idx], {
            repetitions: rep,
            interval: intervalDays,
            nextReview: addDays(today, intervalDays)
          });
        }
      } else {
        book[idx] = Object.assign({}, book[idx], {
          nextReview: addDays(today, 1),
          repetitions: 0,
          interval: 1
        });
      }
      setWrongBook(book);
    }
    function updateWrongCount() {
      const el = document.getElementById('wrong-count');
      if (el) el.textContent = getWrongBook().length;
    }

    const DEFAULT_QUESTIONS = [
      {
        type: 'single_choice',
        category: 'è¯å¹²å˜åŒ–é™·é˜±',
        stem: 'Nous ______ une lettre Ã  nos parents.',
        options: ['Ã©cris', 'Ã©crit', 'Ã©crivons', 'Ã©crivent'],
        correct: 2,
        explanation: 'nous/vous/ils ç”¨è¯å¹² Ã©criv-ã€‚A) Ã©cris â†’ je/tuï¼›B) Ã©crit â†’ ilï¼›D) Ã©crivent â†’ ilsã€‚æ­£ç¡®ä¸º C) Ã©crivonsã€‚'
      },
      {
        type: 'single_choice',
        category: 'å•æ•°äººç§°æ‹¼å†™åŒºåˆ†',
        stem: 'Mon frÃ¨re ______ un roman.',
        options: ['Ã©cris', 'Ã©crit', 'Ã©crive', 'Ã©cri'],
        correct: 1,
        explanation: 'mon frÃ¨re = ilï¼Œç”¨ Ã©criTï¼ˆ-t ç»“å°¾ï¼‰ã€‚è®°å¿†ï¼šje/tu â†’ Ã©criSï¼›il/elle/on â†’ Ã©criTã€‚C) è™šæ‹Ÿå¼ï¼›D) ä¸å­˜åœ¨ã€‚'
      },
      {
        type: 'single_choice',
        category: 'å¬åŠ›è¾¨éŸ³',
        stem: 'å¬åŠ› [ilzekÊiv]ï¼Œquelle est la forme correcte ?',
        options: ['il Ã©crit', 'ils Ã©crivent', 'ils Ã©crit', 'il Ã©crivent'],
        correct: 1,
        explanation: '[ekÊiv] æœ‰ [v] éŸ³ â†’ å¤æ•°ï¼›è”è¯µ [z] â†’ ilsã€‚æ•… B) ils Ã©criventã€‚'
      },
      {
        type: 'single_choice',
        category: 'çœéŸ³è§„åˆ™',
        stem: '______ Ã©cris une lettre.',
        options: ["Je", "J'", "Tu", "Il"],
        correct: 1,
        explanation: 'Ã©crire ä»¥å…ƒéŸ³å¼€å¤´ï¼Œje + å…ƒéŸ³ = j\'ã€‚A) Je Ã©cris è¯­æ³•é”™è¯¯ï¼›C/D ä¸ç©ºæ ¼å Ã©cris ä¸åŒ¹é…ã€‚'
      },
      {
        type: 'paragraph_fill_blank',
        category: 'æ®µè½å¡«ç©º',
        stem: 'Il a _____ ans. Elle _____ (s\'appeler) Marie.',
        correct: ['15', "s'appelle"],
        explanation: 'ç¬¬ä¸€ç©ºå¡«å¹´é¾„æ•°å­—ï¼›ç¬¬äºŒç©º s\'appeler ç¬¬ä¸‰äººç§°å•æ•°å˜ä½ä¸º s\'appelleã€‚'
      }
    ];

    function getCurrentSetQuestions() {
      const sel = document.getElementById('start-practice-select');
      const val = sel ? sel.value : 'default';
      if (val === 'default') return DEFAULT_QUESTIONS;
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === val);
      return (set && set.questions) ? set.questions : [];
    }
    function updateCategoryFilter() {
      const questions = getCurrentSetQuestions();
      const categories = [...new Set(questions.map(q => q.category).filter(Boolean))].sort();
      const wrap = document.getElementById('category-filter-wrap');
      const sel = document.getElementById('filter-category');
      if (!wrap || !sel) return;
      const currentVal = sel.value;
      sel.innerHTML = '<option value="">å…¨éƒ¨</option>' + categories.map(c => '<option value="' + escapeHtml(c) + '">' + escapeHtml(c) + '</option>').join('');
      if (categories.indexOf(currentVal) !== -1) sel.value = currentVal;
      else sel.value = '';
      wrap.style.display = categories.length > 0 ? 'block' : 'none';
    }

    let state = {
      questions: [],
      index: 0,
      score: 0,
      answered: false,
      timerSeconds: 10,
      practicingWrongBook: false,
      practicedSetId: null
    };
    let timerId = null;

    const TIMER_CIRCUMFERENCE = 2 * Math.PI * 17; // ~106.81
    function clearTimer() {
      if (timerId) clearInterval(timerId);
      timerId = null;
      const el = document.getElementById('quiz-timer');
      if (el) { el.style.display = 'none'; el.textContent = ''; el.classList.remove('low'); }
      const ring = document.getElementById('timer-ring');
      const ringFill = document.getElementById('timer-ring-fill');
      if (ring) ring.style.display = 'none';
      if (ringFill) { ringFill.style.strokeDashoffset = '0'; ringFill.classList.remove('low'); }
    }
    function startTimer() {
      clearTimer();
      const seconds = state.timerSeconds;
      if (!seconds) return;
      let remain = seconds;
      const el = document.getElementById('quiz-timer');
      const ring = document.getElementById('timer-ring');
      const ringFill = document.getElementById('timer-ring-fill');
      if (!el) return;
      el.style.display = 'inline';
      el.textContent = remain;
      el.classList.remove('low');
      if (ring) ring.style.display = 'block';
      if (ringFill) { ringFill.style.strokeDashoffset = '0'; ringFill.classList.remove('low'); }
      timerId = setInterval(() => {
        remain--;
        el.textContent = remain;
        if (ringFill) {
          const offset = TIMER_CIRCUMFERENCE * (1 - remain / seconds);
          ringFill.style.strokeDashoffset = offset;
        }
        if (remain <= 3) {
          el.classList.add('low');
          if (ringFill) ringFill.classList.add('low');
          if (remain > 0 && navigator.vibrate) navigator.vibrate(200);
        }
        if (remain <= 0) {
          clearTimer();
          submitAnswer();
        }
      }, 1000);
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const screen = document.getElementById(id);
      screen.classList.add('active');
      requestAnimationFrame(() => {
        if (id === SCREEN.QUIZ) {
          const first = screen.querySelector('.option, input[type="text"], .btn-primary');
          if (first) first.focus();
        } else if (id === SCREEN.RESULT) {
          const scoreEl = screen.querySelector('.result-score');
          if (scoreEl) { scoreEl.setAttribute('tabindex', '-1'); scoreEl.focus(); }
        }
      });
    }

    function parsePastedText(text) {
      const questions = [];
      // æŒ‰ã€Œå¥—è·¯ Nã€æˆ–ã€Œé¢˜å‹ï¼šã€åˆ†å—ï¼Œä¿è¯æ¯å—é‡Œæœ‰ä¸€é“é¢˜
      const chunks = text.split(/(?=å¥—è·¯\s*\d|é¢˜å‹[ï¼š:])/i).filter(b => b.trim());
      for (const chunk of chunks) {
        // é¢˜å‹ï¼šåé¢åˆ° A) ä¹‹å‰ä¸ºé¢˜å¹²ï¼ˆå¯å¤šè¡Œï¼‰
        const stemMatch = chunk.match(/é¢˜å‹[ï¼š:]\s*([\s\S]*?)(?=A\)\s)/i);
        if (!stemMatch) continue;
        const stem = stemMatch[1].replace(/\s+/g, ' ').trim();
        // A) ... B) ... C) ... D) ...ï¼ˆå…è®¸åŒä¸€è¡Œæˆ–æ¢è¡Œï¼‰
        const optMatch = chunk.match(/A\)\s*([\s\S]*?)\s*B\)\s*([\s\S]*?)\s*C\)\s*([\s\S]*?)\s*D\)\s*([\s\S]*?)(?=\n|æ­£ç¡®|$)/);
        if (!optMatch) continue;
        const options = [optMatch[1], optMatch[2], optMatch[3], optMatch[4]].map(s => s.trim());
        const correctMatch = chunk.match(/æ­£ç¡®[ï¼š:]\s*([A-D])/i);
        if (!correctMatch) continue;
        const correct = LETTERS.indexOf(correctMatch[1].toUpperCase());
        if (correct === -1) continue;
        let category = '';
        const catMatch = chunk.match(/å¥—è·¯\s*\d+[ï¼š:]\s*([^\nï¼ˆ(]+)/);
        if (catMatch) category = catMatch[1].trim();
        let explanation = '';
        const expMatch = chunk.match(/(?:å¹²æ‰°é¡¹åˆ†æ|è§£é‡Š|å‡ºé¢˜äººæƒ³è€ƒ|è®°å¿†å£è¯€)[ï¼š:]\s*([\s\S]+?)(?=å¥—è·¯\s*\d|é¢˜å‹[ï¼š:]|$)/i);
        if (expMatch) explanation = expMatch[1].trim().split(/\n/).slice(0, 8).join('\n');
        questions.push({
          type: 'single_choice',
          category,
          stem,
          options,
          correct,
          explanation: explanation || `æ­£ç¡®ç­”æ¡ˆï¼š${LETTERS[correct]}`
        });
      }
      return questions;
    }

    function startQuiz(questions, fromWrongBook, setId) {
      if (!questions || questions.length === 0) {
        alert(fromWrongBook ? 'æ²¡æœ‰åˆ°æœŸéœ€è¦å¤ä¹ çš„é”™é¢˜ã€‚æ˜å¤©å†æ¥æˆ–æ¸…ç©ºé”™é¢˜æœ¬åé‡æ–°åšé¢˜ã€‚' : 'æ²¡æœ‰å¯ç”¨çš„é¢˜ç›®ï¼Œè¯·æ£€æŸ¥å¯¼å…¥æ ¼å¼æˆ–ä½¿ç”¨é»˜è®¤é¢˜ç›®ã€‚');
        return;
      }
      const timerInput = document.getElementById('timer-seconds');
      state.timerSeconds = timerInput ? Math.max(0, parseInt(timerInput.value, 10) || 10) : 10;
      let list = document.getElementById('shuffle-questions') && document.getElementById('shuffle-questions').checked
        ? shuffleArray(questions)
        : questions;
      if (document.getElementById('shuffle-options') && document.getElementById('shuffle-options').checked) {
        list = list.map(shuffleQuestionOptions);
      }
      state.questions = list;
      state.index = 0;
      state.score = 0;
      state.answered = false;
      state.practicingWrongBook = !!fromWrongBook;
      state.practicedSetId = setId || null;
      showScreen(SCREEN.QUIZ);
      renderQuestion();
    }
    function recordSavedSetPractice(setId) {
      if (!setId) return;
      const sets = getSavedSets();
      const idx = sets.findIndex(s => String(s.id) === String(setId));
      if (idx === -1) return;
      sets[idx] = Object.assign({}, sets[idx], {
        practiceCount: (sets[idx].practiceCount || 0) + 1,
        lastPracticedAt: new Date().toISOString()
      });
      setSavedSets(sets);
    }

    function renderParagraphBlanks(q, correctArr) {
      const parts = q.stem.split('_____');
      let stemHtml = '';
      for (let i = 0; i < parts.length; i++) {
        stemHtml += escapeHtml(parts[i]);
        if (i < parts.length - 1) stemHtml += '<span class="blank" data-blank="' + i + '">( ' + (i + 1) + ' )</span>';
      }
      document.getElementById('question-stem').innerHTML = stemHtml;
      const wrap = document.getElementById('paragraph-blanks-wrap');
      wrap.style.display = 'block';
      wrap.innerHTML = correctArr.map((_, i) =>
        '<label style="display:flex;align-items:center;gap:0.5rem;"><span style="min-width:2.5rem;">ç¬¬' + (i + 1) + 'ç©º:</span><input type="text" data-blank="' + i + '" placeholder="..." autocomplete="off" /></label>'
      ).join('');
      wrap.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('keydown', e => { if (e.key === 'Enter') submitAnswer(); });
      });
    }

    function renderQuestion() {
      const q = state.questions[state.index];
      if (!q) {
        showResult();
        return;
      }

      state.answered = false;
      const idx = state.index + 1;
      const total = state.questions.length;
      document.getElementById('progress-fill').style.width = (idx / total) * 100 + '%';
      document.getElementById('question-counter').textContent = `${idx} / ${total}`;
      const labelEl = document.getElementById('progress-label');
      if (labelEl) labelEl.textContent = 'ç¬¬ ' + idx + ' / ' + total + ' é¢˜';
      const estimateEl = document.getElementById('progress-estimate');
      if (estimateEl && idx === 1) {
        estimateEl.textContent = 'å…± ' + total + ' é¢˜' + (state.timerSeconds ? 'ï¼Œçº¦ ' + Math.ceil(total * state.timerSeconds / 60) + ' åˆ†é’Ÿ' : 'ï¼Œä¸é™æ—¶');
      }
      document.getElementById('question-meta').textContent = q.category ? `å¥—è·¯ Â· ${q.category}` : '';
      document.getElementById('question-stem').innerHTML = escapeHtml(q.stem);
      document.getElementById('explanation').style.display = 'none';
      document.getElementById('explanation').textContent = q.explanation || '';
      const removeWrapEl = document.getElementById('wrong-book-remove-wrap');
      if (removeWrapEl) removeWrapEl.style.display = 'none';
      const removeFromSetWrap = document.getElementById('remove-from-set-wrap');
      if (removeFromSetWrap) removeFromSetWrap.style.display = state.practicedSetId ? 'block' : 'none';
      document.getElementById('answer-feedback').className = 'answer-feedback';
      document.getElementById('answer-feedback').textContent = '';

      const optionsEl = document.getElementById('options-container');
      const fillWrap = document.getElementById('fill-input-wrap');
      const fillInput = document.getElementById('fill-input');

      if (q.type === 'fill_blank') {
        optionsEl.innerHTML = '';
        const blankCount = (q.stem.match(/_____/g) || []).length;
        const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
        const isMultiBlank = blankCount >= 2 && correctArr.length >= 2;
        if (isMultiBlank) {
          fillWrap.style.display = 'none';
          renderParagraphBlanks(q, correctArr.slice(0, blankCount));
        } else {
          fillWrap.style.display = 'block';
          fillInput.value = '';
          fillInput.placeholder = 'è¾“å…¥ç­”æ¡ˆ...';
          document.getElementById('paragraph-blanks-wrap').style.display = 'none';
          document.getElementById('paragraph-blanks-wrap').innerHTML = '';
        }
        document.getElementById('btn-submit').style.display = 'inline-flex';
        document.getElementById('btn-next').style.display = 'none';
        startTimer();
        return;
      }

      if (q.type === 'paragraph_fill_blank') {
        optionsEl.innerHTML = '';
        fillWrap.style.display = 'none';
        const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
        renderParagraphBlanks(q, correctArr);
        document.getElementById('btn-submit').style.display = 'inline-flex';
        document.getElementById('btn-next').style.display = 'none';
        startTimer();
        return;
      }

      fillWrap.style.display = 'none';
      document.getElementById('paragraph-blanks-wrap').style.display = 'none';
      document.getElementById('paragraph-blanks-wrap').innerHTML = '';
      const isMulti = q.type === 'multiple_choice';
      const correctSet = Array.isArray(q.correct) ? new Set(q.correct) : new Set([q.correct]);
      optionsEl.setAttribute('role', 'group');
      optionsEl.setAttribute('aria-label', isMulti ? 'å¤šé€‰é€‰é¡¹' : 'å•é€‰é€‰é¡¹');

      optionsEl.innerHTML = q.options.map((opt, i) => {
        const letter = LETTERS[i];
        const inputType = isMulti ? 'checkbox' : 'radio';
        const name = isMulti ? `opt-${state.index}` : 'option';
        return `
          <label class="option" data-index="${i}">
            <input type="${inputType}" name="${name}" value="${i}" />
            <span class="option-letter">${letter}</span>
            <span class="option-label">${escapeHtml(opt)}</span>
          </label>
        `;
      }).join('');

      optionsEl.querySelectorAll('.option').forEach(label => {
        label.addEventListener('click', () => {
          if (state.answered) return;
          const input = label.querySelector('input');
          if (isMulti) {
            input.checked = !input.checked;
          } else {
            optionsEl.querySelectorAll('.option').forEach(l => l.classList.remove('selected'));
            optionsEl.querySelectorAll('input').forEach(inp => { inp.checked = false; });
            input.checked = true;
            label.classList.add('selected');
          }
          label.classList.remove('just-selected');
          void label.offsetWidth;
          label.classList.add('just-selected');
        });
      });

      document.getElementById('btn-submit').style.display = 'inline-flex';
      document.getElementById('btn-next').style.display = 'none';
      startTimer();
    }

    function escapeHtml(s) {
      _escapeDiv.textContent = s;
      return _escapeDiv.innerHTML;
    }

    function submitAnswer() {
      clearTimer();
      if (state.answered) return;
      const q = state.questions[state.index];
      const optionsEl = document.getElementById('options-container');
      const fillWrap = document.getElementById('fill-input-wrap');
      const fillInput = document.getElementById('fill-input');

      let correct = false;
      if (q.type === 'fill_blank') {
        const paragraphWrap = document.getElementById('paragraph-blanks-wrap');
        const multiInputs = paragraphWrap && paragraphWrap.style.display !== 'none' ? paragraphWrap.querySelectorAll('input') : [];
        if (multiInputs.length >= 2) {
          const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
          let allRight = true;
          const answers = [];
          for (let i = 0; i < correctArr.length && i < multiInputs.length; i++) {
            const val = (multiInputs[i].value || '').trim().toLowerCase();
            const accept = Array.isArray(correctArr[i]) ? correctArr[i].map(c => String(c).toLowerCase().trim()) : [String(correctArr[i]).toLowerCase().trim()];
            const ok = matchFrenchAnswer(val, accept);
            answers.push({ val, ok, accept });
            if (!ok) allRight = false;
          }
          state.answered = true;
          if (allRight) state.score++;
          else addToWrongBook(q);
          correct = allRight;
          multiInputs.forEach((inp, i) => {
            inp.disabled = true;
            inp.classList.add(answers[i].ok ? 'correct-blank' : 'wrong-blank');
          });
          const stemEl = document.getElementById('question-stem');
          stemEl.querySelectorAll('.blank').forEach((span, i) => {
            if (answers[i]) {
              span.classList.add(answers[i].ok ? 'filled' : 'wrong');
              span.textContent = answers[i].ok ? answers[i].val : (answers[i].val || '?') + ' â†’ ' + (Array.isArray(q.correct[i]) ? q.correct[i][0] : q.correct[i]);
            }
          });
        } else {
          const answer = (fillInput.value || '').trim().toLowerCase();
          const accept = (Array.isArray(q.correct) ? q.correct : [q.correct]).map(c => String(c).toLowerCase().trim());
          correct = matchFrenchAnswer(answer, accept);
          state.answered = true;
          if (correct) state.score++;
          else addToWrongBook(q);
        }
      } else if (q.type === 'paragraph_fill_blank') {
        const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
        const inputs = document.querySelectorAll('#paragraph-blanks-wrap input');
        const len = Math.min(correctArr.length, inputs.length);
        let allRight = true;
        const answers = [];
        for (let i = 0; i < len; i++) {
          const val = (inputs[i] && inputs[i].value ? inputs[i].value : '').trim().toLowerCase();
          const accept = Array.isArray(correctArr[i]) ? correctArr[i].map(c => String(c).toLowerCase().trim()) : [String(correctArr[i]).toLowerCase().trim()];
          const ok = matchFrenchAnswer(val, accept);
          answers.push({ val, ok, accept });
          if (!ok) allRight = false;
        }
        for (let i = len; i < correctArr.length; i++) { allRight = false; answers.push({ val: '', ok: false, accept: [] }); }
        state.answered = true;
        if (allRight) state.score++;
        else addToWrongBook(q);
        inputs.forEach((inp, i) => {
          inp.disabled = true;
          if (answers[i]) inp.classList.add(answers[i].ok ? 'correct-blank' : 'wrong-blank');
        });
        const stemEl = document.getElementById('question-stem');
        stemEl.querySelectorAll('.blank').forEach((span, i) => {
          if (answers[i]) {
            span.classList.add(answers[i].ok ? 'filled' : 'wrong');
            span.textContent = answers[i].ok ? answers[i].val : (answers[i].val || '?') + ' â†’ ' + (Array.isArray(q.correct[i]) ? q.correct[i][0] : q.correct[i]);
          }
        });
        correct = allRight;
      } else {
        const isMulti = q.type === 'multiple_choice';
        const correctSet = Array.isArray(q.correct) ? new Set(q.correct) : new Set([q.correct]);
        const selected = Array.from(optionsEl.querySelectorAll('input:checked')).map(inp => parseInt(inp.value, 10));
        correct = isMulti
          ? selected.length === correctSet.size && selected.every(i => correctSet.has(i))
          : selected.length === 1 && correctSet.has(selected[0]);
        state.answered = true;
        if (correct) state.score++;
        else addToWrongBook(q);

        optionsEl.querySelectorAll('.option').forEach((label, i) => {
          label.classList.add('disabled');
          const inCorrect = correctSet.has(i);
          const wasSelected = label.querySelector('input').checked;
          if (inCorrect) label.classList.add('correct');
          else if (wasSelected) label.classList.add('wrong');
        });
      }

      if (state.practicingWrongBook) updateWrongBookAfterAnswer(q, correct);

      const feedbackEl = document.getElementById('answer-feedback');
      feedbackEl.textContent = correct ? 'æ­£ç¡®ï¼' : 'é”™è¯¯';
      feedbackEl.className = 'answer-feedback ' + (correct ? 'correct-msg' : 'wrong-msg');

      const explanationEl = document.getElementById('explanation');
      let explanationText = q.explanation || '';
      if (!explanationText && !correct) {
        if (q.type === 'fill_blank') {
          const ans = Array.isArray(q.correct) ? q.correct : [q.correct];
          explanationText = 'æ­£ç¡®ç­”æ¡ˆï¼š' + ans.map(a => String(a).trim()).join(' æˆ– ');
        } else if (q.type === 'single_choice') {
          explanationText = 'æ­£ç¡®ç­”æ¡ˆï¼š' + (q.options ? LETTERS[q.correct] + ') ' + q.options[q.correct] : LETTERS[q.correct]);
        } else if (q.type === 'multiple_choice' && q.options) {
          const indices = Array.isArray(q.correct) ? q.correct : [q.correct];
          explanationText = 'æ­£ç¡®ç­”æ¡ˆï¼š' + indices.map(i => LETTERS[i] + ') ' + q.options[i]).join('ï¼›');
        } else if (q.type === 'paragraph_fill_blank') {
          const arr = Array.isArray(q.correct) ? q.correct : [q.correct];
          explanationText = 'æ­£ç¡®ç­”æ¡ˆï¼š' + arr.map((c, i) => 'ç¬¬' + (i + 1) + 'ç©º ' + (Array.isArray(c) ? c[0] : c)).join('ï¼›');
        }
      }
      explanationEl.textContent = explanationText;
      explanationEl.style.display = explanationText ? 'block' : 'none';

      const announcer = document.getElementById('sr-announcer');
      if (announcer) announcer.textContent = correct ? 'å›ç­”æ­£ç¡®' : 'å›ç­”é”™è¯¯ã€‚' + (explanationText || '');

      const removeWrap = document.getElementById('wrong-book-remove-wrap');
      const btnRemove = document.getElementById('btn-remove-from-wrong');
      if (removeWrap && btnRemove) {
        if (state.practicingWrongBook) {
          removeWrap.style.display = 'block';
          btnRemove.textContent = 'ç§»å‡ºé”™é¢˜æœ¬';
          btnRemove.disabled = false;
          btnRemove.onclick = () => {
            const removedItem = JSON.parse(JSON.stringify(q));
            removeFromWrongBook(q);
            btnRemove.textContent = 'å·²ç§»å‡ºï¼ˆ5ç§’å†…å¯æ’¤é”€ï¼‰';
            btnRemove.disabled = false;
            const undoTimer = setTimeout(() => {
              btnRemove.textContent = 'å·²ç§»å‡º';
              btnRemove.disabled = true;
            }, 5000);
            btnRemove.onclick = () => {
              clearTimeout(undoTimer);
              addToWrongBookDirect(removedItem);
              btnRemove.textContent = 'å·²æ’¤é”€ï¼Œä»åœ¨é”™é¢˜æœ¬';
              btnRemove.disabled = true;
            };
          };
        } else {
          removeWrap.style.display = 'none';
        }
      }

      document.getElementById('btn-submit').style.display = 'none';
      const btnNext = document.getElementById('btn-next');
      btnNext.style.display = 'inline-flex';
      btnNext.textContent = state.index >= state.questions.length - 1 ? 'æŸ¥çœ‹ç»“æœ' : 'ä¸‹ä¸€é¢˜';
      btnNext.setAttribute('aria-label', state.index >= state.questions.length - 1 ? 'æŸ¥çœ‹ç»“æœ' : 'ä¸‹ä¸€é¢˜');
      saveQuizProgress();
    }

    function nextQuestion() {
      state.index++;
      if (state.index >= state.questions.length) {
        showResult();
      } else {
        const card = document.querySelector('.question-card');
        if (card) {
          card.classList.add('animate-out');
          setTimeout(() => {
            card.classList.remove('animate-out');
            renderQuestion();
            card.classList.add('animate-in');
            card.addEventListener('animationend', () => card.classList.remove('animate-in'), { once: true });
          }, 200);
        } else {
          renderQuestion();
        }
      }
    }

    function showResult() {
      clearQuizProgress();
      if (state.practicedSetId) {
        recordSavedSetPractice(state.practicedSetId);
        state.practicedSetId = null;
      }
      addTodayPractice(state.questions.length);
      document.getElementById('result-score').textContent = `${state.score} / ${state.questions.length}`;
      const pct = state.questions.length ? Math.round((state.score / state.questions.length) * 100) : 0;
      const pctEl = document.getElementById('result-pct');
      if (pctEl) pctEl.textContent = 'æ­£ç¡®ç‡ ' + pct + '%';
      document.getElementById('result-desc').textContent = pct >= 80 ? 'TrÃ¨s bien !' : pct >= 60 ? 'Pas mal !' : 'Continuez Ã  pratiquer !';
      const celebrationEl = document.getElementById('result-celebration');
      const isFull = state.score === state.questions.length && state.questions.length > 0;
      if (celebrationEl) celebrationEl.style.display = isFull ? 'block' : 'none';
      const confettiEl = document.getElementById('result-confetti');
      if (confettiEl) {
        confettiEl.innerHTML = '';
        if (isFull) {
          const colors = ['#8b5cf6', '#34d399', '#fbbf24', '#60a5fa', '#f87171'];
          for (let i = 0; i < 14; i++) {
            const s = document.createElement('span');
            s.style.left = (10 + Math.random() * 80) + '%';
            s.style.top = (60 + Math.random() * 35) + '%';
            s.style.background = colors[i % colors.length];
            s.style.animationDelay = (Math.random() * 0.6) + 's';
            s.style.animationDuration = (2 + Math.random() * 1.2) + 's';
            confettiEl.appendChild(s);
          }
        }
      }
      pushRecentSession(state.questions.length, state.score);
      const recentEl = document.getElementById('result-recent');
      if (recentEl) {
        const sessions = getRecentSessions();
        const toShow = sessions.slice(-5).reverse();
        if (toShow.length <= 1) {
          recentEl.style.display = 'none';
        } else {
          recentEl.style.display = 'block';
          recentEl.innerHTML = '<div class="result-recent-title">æœ€è¿‘ç»ƒä¹ </div><ul>' +
            toShow.map((s, i) => '<li>' + s.score + '/' + s.total + (i === 0 ? 'ï¼ˆæœ¬æ¬¡ï¼‰' : '') + '</li>').join('') + '</ul>';
        }
      }
      const announcer = document.getElementById('sr-announcer');
      if (announcer) announcer.textContent = 'ç»ƒä¹ å®Œæˆï¼Œå¾—åˆ† ' + state.score + ' / ' + state.questions.length + 'ï¼Œæ­£ç¡®ç‡ ' + pct + '%';
      showScreen(SCREEN.RESULT);
    }
    function readAloudStem() {
      const q = state.questions[state.index];
      if (!q || !q.stem) return;
      const text = (q.stem || '').replace(/_____/g, ' ').trim();
      if (!text) return;
      if (typeof speechSynthesis === 'undefined') return;
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'fr-FR';
      u.rate = 0.9;
      speechSynthesis.speak(u);
    }
    function onQuizKeydown(e) {
      if (!document.getElementById('screen-quiz').classList.contains('active')) return;
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : '';
      if (tag === 'INPUT' || tag === 'TEXTAREA') {
        if (e.key === 'Enter') { e.preventDefault(); if (state.answered) nextQuestion(); else submitAnswer(); }
        return;
      }
      if (e.key === 'Enter') {
        e.preventDefault();
        if (state.answered) nextQuestion();
        else submitAnswer();
        return;
      }
      if (['1','2','3','4'].includes(e.key)) {
        const q = state.questions[state.index];
        if (!q || state.answered) return;
        if ((q.type === 'single_choice' || q.type === 'multiple_choice') && q.options && q.options.length > 0) {
          const idx = parseInt(e.key, 10) - 1;
          if (idx < 0 || idx >= q.options.length) return;
          const opts = document.querySelectorAll('#options-container .option');
          if (opts[idx]) opts[idx].click();
        }
      }
    }

    document.getElementById('btn-start-practice').addEventListener('click', () => {
      const typeFilter = getSelectedTypeFilter();
      const sel = document.getElementById('start-practice-select');
      const val = sel ? sel.value : 'default';
      let questions = [];
      if (val === 'default') {
        questions = DEFAULT_QUESTIONS;
      } else {
        const sets = getSavedSets();
        const set = sets.find(s => String(s.id) === val);
        if (!set || !set.questions || !set.questions.length) {
          alert('æœªæ‰¾åˆ°è¯¥ä¹ é¢˜é›†ï¼Œè¯·é‡æ–°é€‰æ‹©ã€‚');
          return;
        }
        questions = set.questions;
      }
      let filtered = filterQuestionsByType(questions, typeFilter);
      const categoryEl = document.getElementById('filter-category');
      const categoryVal = categoryEl && categoryEl.value ? categoryEl.value.trim() : '';
      if (categoryVal) {
        filtered = filtered.filter(q => q && q.category === categoryVal);
      }
      if (filtered.length === 0) {
        const typeNames = typeFilter ? typeFilter.map(t => QUESTION_TYPES[t] || t).join('ã€') : '';
        alert('å½“å‰é€‰é¢˜å‹æˆ–åˆ†ç±»ä¸‹æ²¡æœ‰é¢˜ç›®ã€‚è¯·å‹¾é€‰æ›´å¤šé¢˜å‹ã€æ¢åˆ†ç±»æˆ–é€‰æ‹©å…¶ä»–ä¹ é¢˜é›†ã€‚' + (typeNames ? 'ï¼ˆå·²é€‰é¢˜å‹ï¼š' + typeNames + 'ï¼‰' : ''));
        return;
      }
      if (val !== 'default') {
        const sets = getSavedSets();
        const set = sets.find(s => String(s.id) === val);
        if (set) startQuiz(filtered, false, set.id);
        else startQuiz(filtered);
      } else {
        startQuiz(filtered);
      }
    });

    document.getElementById('btn-import-show').addEventListener('click', () => {
      const sec = document.getElementById('import-section');
      sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
    });

    document.getElementById('btn-import-parse').addEventListener('click', () => {
      const text = document.getElementById('import-text').value.trim();
      let parsed = [];
      if (/^\s*[\[{]/.test(text)) {
        try {
          const data = JSON.parse(text);
          parsed = Array.isArray(data) ? data : (data.questions || []);
        } catch (_) {}
      }
      if (parsed.length === 0) parsed = parsePastedText(text);
      if (parsed.length > 0) {
        const nameInput = document.getElementById('import-set-name');
        const name = (nameInput && nameInput.value ? nameInput.value.trim() : '') || ('æœªå‘½å ' + formatSavedSetDate(new Date().toISOString()));
        const saved = {
          id: Date.now(),
          name: name,
          createdAt: new Date().toISOString(),
          questions: parsed,
          practiceCount: 0,
          lastPracticedAt: null
        };
        const all = getSavedSets();
        all.unshift(saved);
        setSavedSets(all);
        startQuiz(parsed);
        document.getElementById('import-section').style.display = 'none';
        document.getElementById('import-text').value = '';
        if (nameInput) nameInput.value = '';
      } else {
        alert('æœªèƒ½è§£æå‡ºé¢˜ç›®ã€‚è¯·ä½¿ç”¨ï¼šâ‘  å«ã€Œé¢˜å‹ï¼šã€ã€ŒA) B) C) D)ã€ã€Œæ­£ç¡®ï¼šã€çš„æ–‡æœ¬ï¼Œæˆ– â‘¡ é¢˜ç›®æ•°ç»„ JSONã€‚');
      }
    });

    document.getElementById('btn-submit').addEventListener('click', submitAnswer);
    document.getElementById('btn-next').addEventListener('click', nextQuestion);
    document.getElementById('btn-remove-from-set').addEventListener('click', () => {
      if (!state.practicedSetId) return;
      if (confirm('ç¡®å®šä»æœ¬ç»ƒä¹ é›†ä¸­åˆ é™¤è¿™é“é¢˜ï¼Ÿåˆ é™¤åæœ¬é¢˜å°†ä¸å†å‡ºç°åœ¨è¯¥ç»ƒä¹ é›†ä¸­ã€‚')) removeCurrentQuestionFromSet();
    });
    document.getElementById('btn-exit-quiz').addEventListener('click', () => {
      if (confirm('ç¡®å®šè¦æå‰é€€å‡ºå—ï¼Ÿ')) {
        clearTimer();
        clearQuizProgress();
        showScreen(SCREEN.HOME);
        updateWrongCount();
        renderSavedSets();
      }
    });
    document.getElementById('fill-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        if (state.answered) nextQuestion();
        else submitAnswer();
      }
    });
    document.getElementById('btn-restart').addEventListener('click', () => {
      showScreen(SCREEN.HOME);
      updateWrongCount();
      renderSavedSets();
      updateStatsBar();
      updateStartPracticeSelect();
    });
    document.getElementById('btn-back-home').addEventListener('click', () => {
      showScreen(SCREEN.HOME);
      updateWrongCount();
      renderSavedSets();
      updateStatsBar();
      updateStartPracticeSelect();
    });
    document.getElementById('btn-share-result').addEventListener('click', () => {
      const scoreEl = document.getElementById('result-score');
      const scoreText = scoreEl ? scoreEl.textContent.trim() : '0/0';
      const st = getDailyStats();
      const streak = st.streak || 0;
      const text = 'FranÃ§ais Quiz ' + scoreText + 'ï¼Œè¿ç»­ ' + streak + ' å¤© âœ¨';
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')).catch(() => alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶'));
      } else {
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.opacity = '0';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        } catch (_) { alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶'); }
      }
    });
    document.getElementById('format-doc').addEventListener('click', (e) => {
      if (e.target.closest('.format-doc-title')) document.getElementById('format-doc').classList.toggle('open');
    });
    const readAloudBtn = document.getElementById('btn-read-aloud');
    if (readAloudBtn) readAloudBtn.addEventListener('click', readAloudStem);
    document.addEventListener('keydown', onQuizKeydown);
    const searchInput = document.getElementById('saved-sets-search');
    if (searchInput) searchInput.addEventListener('input', renderSavedSets);
    document.getElementById('saved-sets-list').addEventListener('click', handleSavedSetsAction);
    function startWrongBookDuePractice() {
      const due = getWrongBookDue();
      if (due.length === 0) {
        const total = getWrongBook().length;
        if (total === 0) alert('é”™é¢˜æœ¬è¿˜æ˜¯ç©ºçš„ã€‚å¤šåšå‡ é“é¢˜ï¼Œé”™é¢˜ä¼šè‡ªåŠ¨è¿›æ¥ï¼Œå†æŒ‰è®¡åˆ’å¤ä¹ å°±å¥½ã€‚');
        else alert('æ²¡æœ‰åˆ°æœŸéœ€è¦å¤ä¹ çš„é”™é¢˜ï¼ˆè‰¾å®¾æµ©æ–¯å·²æ’å¥½åç»­æ—¥æœŸï¼‰ã€‚é”™é¢˜æœ¬é‡Œå…±æœ‰ ' + total + ' é¢˜ã€‚');
        return;
      }
      const typeFilter = getSelectedTypeFilter();
      const filtered = filterQuestionsByType(due, typeFilter);
      if (filtered.length === 0) { alert('å½“å‰é€‰é¢˜å‹ä¸‹æ²¡æœ‰åˆ°æœŸçš„é”™é¢˜ã€‚è¯·å‹¾é€‰æ›´å¤šé¢˜å‹æˆ–æ”¹å¤©å†è¯•ã€‚'); return; }
      startQuiz(filtered, true);
    }
    function startWrongBookFreePractice() {
      const book = getWrongBook();
      if (book.length === 0) { alert('é”™é¢˜æœ¬è¿˜æ˜¯ç©ºçš„ã€‚åšé”™é¢˜ç›®åä¼šè‡ªåŠ¨åŠ å…¥ï¼Œå†æ¥è¿™é‡Œç»ƒä¹ å³å¯ã€‚'); return; }
      const typeFilter = getSelectedTypeFilter();
      const filtered = filterQuestionsByType(book, typeFilter);
      if (filtered.length === 0) { alert('å½“å‰é€‰é¢˜å‹ä¸‹æ²¡æœ‰é”™é¢˜ã€‚è¯·å‹¾é€‰æ›´å¤šé¢˜å‹ã€‚'); return; }
      startQuiz(filtered, true);
    }
    document.getElementById('btn-wrong-book').addEventListener('click', startWrongBookDuePractice);
    document.getElementById('btn-result-wrong').addEventListener('click', startWrongBookDuePractice);
    document.getElementById('btn-wrong-free').addEventListener('click', startWrongBookFreePractice);
    document.getElementById('btn-result-wrong-free').addEventListener('click', startWrongBookFreePractice);
    document.getElementById('btn-clear-wrong').addEventListener('click', () => {
      if (getWrongBook().length === 0) {
        alert('é”™é¢˜æœ¬å·²ç»æ˜¯ç©ºçš„äº†ã€‚');
        return;
      }
      if (confirm('ç¡®å®šè¦æ¸…ç©ºé”™é¢˜æœ¬å—ï¼Ÿæ¸…ç©ºåæ— æ³•æ¢å¤ã€‚')) {
        setWrongBook([]);
      }
    });
    (function initTimerInput() {
      const el = document.getElementById('timer-seconds');
      if (el) {
        const saved = localStorage.getItem(TIMER_SECONDS_KEY);
        if (saved !== null) { const n = parseInt(saved, 10); if (!isNaN(n) && n >= 0) el.value = n; }
        el.addEventListener('change', () => {
          const n = Math.max(0, Math.min(120, parseInt(el.value, 10) || 0));
          el.value = n;
          localStorage.setItem(TIMER_SECONDS_KEY, n);
        });
      }
    })();

    document.getElementById('btn-one-save').addEventListener('click', saveToProjectFolder);
    document.getElementById('btn-copy-deploy-cmd').addEventListener('click', () => {
      const cmd = document.getElementById('save-deploy-cmd');
      const text = cmd ? cmd.textContent.trim() : './sync-and-push.sh ../french-quiz-pages';
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶ï¼Œåˆ°ç»ˆç«¯ç²˜è´´æ‰§è¡Œå³å¯ã€‚')).catch(() => alert('å¤åˆ¶å¤±è´¥'));
      } else {
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.opacity = '0';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          alert('å·²å¤åˆ¶ï¼Œåˆ°ç»ˆç«¯ç²˜è´´æ‰§è¡Œå³å¯ã€‚');
        } catch (_) { alert('å¤åˆ¶å¤±è´¥'); }
      }
    });
    document.getElementById('btn-load-cloud').addEventListener('click', loadFromCloud);
    document.getElementById('btn-open-folder').addEventListener('click', pickFolderAndLoad);
    document.getElementById('btn-save-to-folder').addEventListener('click', saveToProjectFolder);
    document.getElementById('btn-export-data').addEventListener('click', saveToProjectFolder);
    document.getElementById('btn-import-data').addEventListener('click', () => document.getElementById('file-import-data').click());
    document.getElementById('link-download-json').addEventListener('click', (e) => { e.preventDefault(); exportDataDownload(); });
    document.getElementById('file-import-data').addEventListener('change', function() {
      const file = this.files && this.files[0];
      if (file) importDataFromFile(file);
      this.value = '';
    });

    (function initTheme() {
      const theme = localStorage.getItem(THEME_KEY) || 'dark';
      if (theme === 'light') document.body.classList.add('theme-light');
      const btn = document.getElementById('theme-toggle');
      if (btn) btn.addEventListener('click', () => {
        document.body.classList.toggle('theme-light');
        localStorage.setItem(THEME_KEY, document.body.classList.contains('theme-light') ? 'light' : 'dark');
      });
    })();
    updateWrongCount();
    renderSavedSets();
    updateStatsBar();
    updateStartPracticeSelect();
    updateCategoryFilter();
    const startSel = document.getElementById('start-practice-select');
    if (startSel) startSel.addEventListener('change', updateCategoryFilter);

    // Restore in-progress quiz
    (function checkSavedProgress() {
      const saved = getQuizProgress();
      if (saved && saved.questions && saved.questions.length > 0 && saved.index < saved.questions.length) {
        if (confirm('æ£€æµ‹åˆ°ä¸Šæ¬¡æœªå®Œæˆçš„ç»ƒä¹ ï¼ˆç¬¬ ' + (saved.index + 1) + '/' + saved.questions.length + ' é¢˜ï¼‰ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
          state.questions = saved.questions;
          state.index = saved.index;
          state.score = saved.score;
          state.answered = false;
          state.timerSeconds = saved.timerSeconds;
          state.practicingWrongBook = saved.practicingWrongBook;
          state.practicedSetId = saved.practicedSetId;
          showScreen(SCREEN.QUIZ);
          renderQuestion();
        } else {
          clearQuizProgress();
        }
      }
    })();
  </script>
</body>
</html>
