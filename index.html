<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <meta name="theme-color" content="#0c0a14" />
  <meta name="description" content="Ê≥ïËØ≠ÁªÉ‰π† ¬∑ TCF Â°´Á©∫„ÄÅÊÆµËêΩÂ°´Á©∫„ÄÅÂçïÈÄâ„ÄÅÂ§öÈÄâÔºåÊîØÊåÅÈîôÈ¢òÊú¨‰∏é‰π†È¢òÈõÜÁÆ°ÁêÜ" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self'; base-uri 'self';" />
  <title>Fran√ßais Quiz ¬∑ Ê≥ïËØ≠ÁªÉ‰π†</title>
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJiZyIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzZkMjhkOSIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6IzhiNWNmNiIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgcng9IjgiIGZpbGw9InVybCgjYmcpIi8+PHJlY3QgeD0iOSIgeT0iOCIgd2lkdGg9IjMuMiIgaGVpZ2h0PSIxNiIgcng9IjEiIGZpbGw9IiNmZmYiLz48cmVjdCB4PSI5IiB5PSI4IiB3aWR0aD0iMTEiIGhlaWdodD0iMi44IiByeD0iMSIgZmlsbD0iI2ZmZiIvPjxyZWN0IHg9IjkiIHk9IjE1IiB3aWR0aD0iNi41IiBoZWlnaHQ9IjIuNiIgcng9IjEiIGZpbGw9IiNmZmYiLz48cGF0aCBkPSJNMTguNSA2LjJsMiAyLjIiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxLjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg==" type="image/svg+xml" />
  <link rel="icon" href="favicon.svg?v=3" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" as="style" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
  <noscript><link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet" /></noscript>
  <style>
    :root {
      --bg: #0c0a14;
      --card: #16141f;
      --surface: #1e1b28;
      --accent: #8b5cf6;
      --accent-hover: #a78bfa;
      --accent-soft: rgba(139, 92, 246, 0.15);
      --correct: #34d399;
      --wrong: #f87171;
      --option-a: #60a5fa;
      --option-b: #fbbf24;
      --option-c: #4ade80;
      --option-d: #fb923c;
      --text: #f5f3ff;
      --text-muted: #a1a1aa;
      --radius: 16px;
      --radius-sm: 10px;
      --shadow: 0 4px 24px rgba(0,0,0,0.25);
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.15);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.35);
      --border-subtle: rgba(255,255,255,0.06);
      --border-subtle-hover: rgba(255,255,255,0.08);
      --border-strong: rgba(255,255,255,0.1);
    }
    body.theme-light {
      --bg: #f8f7fc;
      --card: #fff;
      --surface: #f0eef8;
      --text: #1c1917;
      --text-muted: #78716c;
      --shadow: 0 4px 20px rgba(124, 58, 237, 0.08);
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
      --border-subtle: rgba(0,0,0,0.06);
      --border-subtle-hover: rgba(0,0,0,0.08);
      --border-strong: rgba(0,0,0,0.1);
      background: var(--bg);
      background-image: none;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    *:focus { outline: none; }
    *:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    @media (pointer: coarse) {
      .btn, .storage-card, .saved-sets-item .btn, .option { min-height: 44px; }
    }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    html { overflow-x: hidden; }
    body {
      overflow-x: hidden;
      font-family: 'Plus Jakarta Sans', 'Noto Sans SC', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image:
        radial-gradient(ellipse 100% 60% at 50% -15%, rgba(139, 92, 246, 0.2), transparent 50%),
        radial-gradient(ellipse 70% 50% at 100% 80%, rgba(96, 165, 250, 0.12), transparent),
        radial-gradient(ellipse 50% 30% at 0% 60%, rgba(139, 92, 246, 0.08), transparent);
      transition: background 0.3s, color 0.3s;
    }

    .container {
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem;
      padding-left: max(1.25rem, env(safe-area-inset-left));
      padding-right: max(1.25rem, env(safe-area-inset-right));
      padding-top: max(1.5rem, env(safe-area-inset-top));
      padding-bottom: max(1.25rem, env(safe-area-inset-bottom));
    }
    @media (min-width: 600px) {
      .container { padding: 2rem 1.5rem; }
    }
    @media (max-width: 380px) {
      .container { padding: 1rem 0.75rem; }
      header h1 { font-size: 1.35rem; }
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.75rem;
      padding-bottom: 1.25rem;
      border-bottom: 1px solid var(--border-subtle);
    }
    body.theme-light header { border-bottom-color: var(--border-subtle); }
    header .brand {
      text-align: left;
    }
    header h1 {
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #c4b5fd 0%, #a78bfa 50%, #818cf8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    header p {
      color: var(--text-muted);
      font-size: 0.875rem;
      font-weight: 500;
      margin-top: 0.2rem;
    }
    .theme-toggle {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-strong);
      background: var(--surface);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.2s;
    }
    .theme-toggle:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
    body.theme-light .theme-toggle { border-color: var(--border-subtle-hover); background: var(--surface); }
    body.theme-light .question-card,
    body.theme-light .result-card { box-shadow: var(--shadow-sm); }
    body.theme-light .option { border-color: var(--border-subtle-hover); }
    body.theme-light .option:hover { background: rgba(0,0,0,0.04); }

    .stats-bar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    .stats-bar span {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.6rem 1rem;
      background: var(--surface);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
    }
    body.theme-light .stats-bar span { border-color: var(--border-subtle); background: var(--card); }
    .stats-bar strong {
      color: var(--accent);
      font-weight: 700;
      margin-right: 0.15rem;
    }

    .home-section {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
      padding: 1.5rem;
      margin-bottom: 1.25rem;
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    .home-section:hover {
      border-color: var(--border-subtle-hover);
      box-shadow: var(--shadow);
    }
    body.theme-light .home-section { border-color: var(--border-subtle); }
    body.theme-light .home-section:hover { border-color: rgba(124, 58, 237, 0.2); box-shadow: var(--shadow); }
    .home-section h2 {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.85rem;
    }

    .screen {
      display: none;
    }
    .screen.active {
      display: block;
      animation: fadeIn 0.35s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #screen-result.active {
      animation: fadeIn 0.4s ease;
    }
    #screen-result .result-card {
      animation: fadeIn 0.5s ease 0.1s both;
    }

    /* Question transitions */
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideOutLeft {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(-30px); }
    }
    .question-card.animate-in { animation: slideInRight 0.3s ease forwards; }
    .question-card.animate-out { animation: slideOutLeft 0.2s ease forwards; }

    /* Answer feedback animations */
    @keyframes bounceIn {
      0% { transform: scale(0.8); opacity: 0; }
      60% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes shakeX {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-6px); }
      40%, 80% { transform: translateX(6px); }
    }
    .answer-feedback.correct-msg { animation: bounceIn 0.4s ease; }
    .answer-feedback.wrong-msg { animation: shakeX 0.4s ease; }

    /* Option click effect */
    @keyframes optionPulse {
      0% { transform: scale(1); }
      50% { transform: scale(0.97); }
      100% { transform: scale(1); }
    }
    .option.just-selected { animation: optionPulse 0.2s ease; }

    /* Stats bar number pop */
    @keyframes countPop {
      0% { transform: scale(1); }
      50% { transform: scale(1.25); color: var(--accent-hover); }
      100% { transform: scale(1); }
    }
    .stats-bar strong { display: inline-block; }
    .stats-bar strong.updated { animation: countPop 0.3s ease; }

    /* Circular timer ring */
    .timer-ring { flex-shrink: 0; }
    .timer-ring-fill { transition: stroke-dashoffset 1s linear, stroke 0.3s; }
    .timer-ring-fill.low { stroke: var(--wrong); }

    .home-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .home-actions .btn { min-height: 52px; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.95rem 1.5rem;
      min-height: 48px;
      font-size: 1rem;
      font-weight: 600;
      font-family: inherit;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(139, 92, 246, 0.35);
    }
    .btn:active { transform: translateY(0); }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, #6366f1 100%);
      color: white;
      box-shadow: 0 4px 14px rgba(139, 92, 246, 0.4);
    }
    .btn-primary:hover { box-shadow: 0 10px 32px rgba(139, 92, 246, 0.45); }
    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border-strong);
    }
    .btn-secondary:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
      box-shadow: 0 8px 24px rgba(139, 92, 246, 0.2);
    }
    body.theme-light .btn-secondary { background: var(--card); border-color: var(--border-strong); }
    body.theme-light .btn-secondary:hover { background: var(--surface); border-color: var(--accent); }

    .import-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-sm);
    }
    body.theme-light .import-section { border-color: var(--border-subtle); }
    .import-section h3 {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }
    .import-section textarea {
      width: 100%;
      min-height: 140px;
      padding: 0.85rem;
      font-family: inherit;
      font-size: 0.9rem;
      background: var(--surface);
      border: 1px solid var(--border-subtle-hover);
      border-radius: var(--radius-sm);
      color: var(--text);
      resize: vertical;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .import-section textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    body.theme-light .import-section textarea { background: var(--bg); border-color: var(--border-strong); }
    .import-section textarea::placeholder {
      color: var(--text-muted);
    }
    .import-section .hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    /* Quiz */
    .progress-wrap {
      margin-bottom: 1.25rem;
    }
    .progress-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    .progress-estimate {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }
    .progress-bar {
      height: 8px;
      background: var(--surface);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.04);
    }
    body.theme-light .progress-bar { border-color: var(--border-subtle); }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #818cf8);
      border-radius: 999px;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 12px rgba(139, 92, 246, 0.5);
    }

    .question-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1.75rem;
      border: 1px solid var(--border-subtle);
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .question-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(180deg, var(--accent), #818cf8);
      border-radius: 4px 0 0 4px;
    }
    body.theme-light .question-card::before { opacity: 0.9; }
    .question-meta {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.5rem;
      letter-spacing: 0.03em;
    }
    .question-stem {
      font-size: 1.25rem;
      line-height: 1.65;
      margin-bottom: 1.25rem;
      font-weight: 500;
      letter-spacing: 0.01em;
    }
    @media (min-width: 480px) {
      .question-stem { font-size: 1.35rem; }
    }
    .question-stem .blank {
      display: inline-block;
      min-width: 120px;
      border-bottom: 2px solid var(--accent);
      margin: 0 4px;
      padding: 0 4px;
    }
    .question-stem .blank.filled {
      border-color: var(--correct);
      color: var(--correct);
    }
    .question-stem .blank.wrong {
      border-color: var(--wrong);
      color: var(--wrong);
    }
    .paragraph-blanks {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .paragraph-blanks input {
      width: 120px;
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      background: var(--surface);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    body.theme-light .paragraph-blanks input { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .paragraph-blanks input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .paragraph-blanks input.correct-blank {
      border-color: var(--correct);
      background: rgba(16, 185, 129, 0.15);
    }
    .paragraph-blanks input.wrong-blank {
      border-color: var(--wrong);
      background: rgba(239, 68, 68, 0.15);
    }

    .options {
      display: grid;
      contain: layout;
      grid-template-columns: 1fr 1fr;
      gap: 0.85rem;
    }
    @media (max-width: 480px) {
      .options { grid-template-columns: 1fr; }
      .question-card { padding: 1.25rem; }
      .question-stem { font-size: 1rem; word-break: break-word; }
      .option { padding: 0.85rem 1rem; min-height: 44px; }
      .quiz-actions .btn { min-width: 100px; }
    }
    @media (max-width: 360px) {
      .question-card { padding: 1rem; }
      .option-letter { width: 28px; height: 28px; font-size: 0.8rem; }
    }
    .option {
      display: flex;
      align-items: center;
      gap: 0.85rem;
      padding: 1rem 1.25rem;
      min-height: 48px;
      background: var(--surface);
      border: 2px solid rgba(255,255,255,0.06);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }
    .option:hover {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
      transform: translateY(-1px);
    }
    .option.selected {
      border-color: var(--accent);
      background: var(--accent-soft);
      box-shadow: 0 0 0 1px var(--accent);
    }
    .option.correct {
      border-color: var(--correct);
      background: rgba(52, 211, 153, 0.12);
    }
    .option.wrong {
      border-color: var(--wrong);
      background: rgba(248, 113, 113, 0.12);
    }
    .option.disabled {
      pointer-events: none;
      opacity: 0.65;
    }
    .option-letter {
      width: 34px;
      height: 34px;
      flex-shrink: 0;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
    }
    .option:nth-child(1) .option-letter { background: var(--option-a); color: #fff; }
    .option:nth-child(2) .option-letter { background: var(--option-b); color: #1a1a1a; }
    .option:nth-child(3) .option-letter { background: var(--option-c); color: #fff; }
    .option:nth-child(4) .option-letter { background: var(--option-d); color: #fff; }
    .option input {
      margin: 0;
      accent-color: var(--accent);
    }
    .option-label {
      flex: 1;
    }

    .fill-input-wrap {
      margin-top: 0.5rem;
    }
    .fill-input-wrap input {
      width: 100%;
      max-width: 280px;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      font-family: inherit;
      background: var(--surface);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .fill-input-wrap input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    body.theme-light .fill-input-wrap input { background: var(--card); border-color: rgba(0,0,0,0.12); }

    .answer-feedback {
      margin-top: 1rem;
      padding: 0.65rem 1rem;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 1rem;
      display: none;
    }
    .answer-feedback.correct-msg { background: rgba(52, 211, 153, 0.15); color: var(--correct); display: block; border: 1px solid rgba(52, 211, 153, 0.3); }
    .answer-feedback.wrong-msg { background: rgba(248, 113, 113, 0.15); color: var(--wrong); display: block; border: 1px solid rgba(248, 113, 113, 0.3); }
    .explanation-scroll-wrap {
      margin-top: 1.25rem;
      max-height: 40vh;
      overflow-y: auto;
      overflow-x: hidden;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(52, 211, 153, 0.25);
      background: rgba(52, 211, 153, 0.08);
    }
    body.theme-light .explanation-scroll-wrap { border-color: rgba(52, 211, 153, 0.3); background: rgba(52, 211, 153, 0.1); }
    .explanation-wrong-count {
      padding: 0 1.15rem 0.35rem;
      font-size: 0.8rem;
      color: var(--wrong);
    }
    body.theme-light .explanation-wrong-count { color: #dc2626; }
    .explanation {
      padding: 1rem 1.15rem;
      font-size: 0.9rem;
      line-height: 1.65;
      color: #6ee7b7;
      white-space: pre-wrap;
    }
    body.theme-light .explanation { color: #059669; }
    .explanation-notes-section { padding: 0 1.15rem 1rem; }
    .explanation-notes-section .explanation-notes-display {
      margin-bottom: 0.5rem;
      padding: 0.75rem 1rem;
      background: var(--surface);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
      font-size: 0.88rem;
      line-height: 1.6;
      color: var(--text);
      white-space: pre-wrap;
      max-height: 20vh;
      overflow-y: auto;
    }
    body.theme-light .explanation-notes-section .explanation-notes-display { background: var(--card); border-color: var(--border-strong); }
    .explanation-notes-section .explanation-notes-display::before { content: 'ÊàëÁöÑÂ§áÊ≥®Ôºö'; font-weight: 600; color: var(--accent); display: block; margin-bottom: 0.35rem; }
    .explanation-notes-edit-btn { margin-top: 0.25rem; }
    .explanation-notes-edit { margin-top: 0.5rem; }
    .explanation-notes-textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      line-height: 1.55;
      font-family: inherit;
      background: var(--surface);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-sm);
      color: var(--text);
      resize: vertical;
      min-height: 100px;
      max-height: 30vh;
      display: block;
      box-sizing: border-box;
    }
    body.theme-light .explanation-notes-textarea { background: var(--card); border-color: var(--border-strong); }
    .explanation-notes-edit-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .wrong-book-remove-wrap { margin-top: 0.75rem; }
    .remove-from-set-wrap { margin-top: 0.5rem; }
    .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.85rem; min-height: auto; }

    .quiz-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1.5rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .quiz-actions-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .quiz-actions .btn {
      min-width: 120px;
    }
    .quiz-actions #btn-exit-quiz { min-width: auto; }
    .quiz-shortcut-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      width: 100%;
    }

    .timer-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .timer-wrap label { font-size: 0.9rem; color: var(--text-muted); }
    .timer-wrap input[type="number"] {
      width: 4rem;
      padding: 0.45rem 0.5rem;
      font-size: 0.9rem;
      background: var(--surface);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-sm);
      color: var(--text);
    }
    body.theme-light .timer-wrap input[type="number"] { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .shuffle-wrap { display: flex; align-items: center; gap: 0.4rem; }
    .shuffle-wrap input[type="checkbox"] { accent-color: var(--accent); cursor: pointer; }
    .shuffle-wrap label { font-size: 0.85rem; color: var(--text-muted); cursor: pointer; }
    .type-filter-wrap { margin-top: 0.75rem; }
    .type-filter-wrap .type-filter-label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.4rem; }
    .type-filter-row { display: flex; flex-wrap: wrap; gap: 0.75rem 1.25rem; align-items: center; }
    .type-filter-row label { display: flex; align-items: center; gap: 0.35rem; font-size: 0.9rem; color: var(--text); cursor: pointer; }
    .type-filter-row input[type="checkbox"] { accent-color: var(--accent); cursor: pointer; }
    .start-select-wrap { margin-bottom: 0.75rem; }
    .category-filter-wrap { margin-bottom: 0.75rem; }
    .category-filter-wrap label { display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .category-filter-wrap select {
      width: 100%;
      max-width: 320px;
      padding: 0.65rem 0.85rem;
      font-size: 0.95rem;
      font-family: inherit;
      background: var(--surface);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-sm);
      color: var(--text);
      cursor: pointer;
    }
    body.theme-light .category-filter-wrap select { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .start-select-wrap label { display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .start-select-wrap select {
      width: 100%;
      max-width: 320px;
      padding: 0.65rem 0.85rem;
      font-size: 0.95rem;
      font-family: inherit;
      background: var(--surface);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-sm);
      color: var(--text);
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .start-select-wrap select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }
    body.theme-light .start-select-wrap select { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .quiz-timer {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent);
      min-width: 2.5rem;
    }
    .quiz-timer.low { color: var(--wrong); }
    .question-stem-wrap { position: relative; }
    .btn-read-aloud {
      margin-top: 0.5rem;
      padding: 0.4rem 0.85rem;
      font-size: 0.85rem;
      font-weight: 500;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-strong);
      background: var(--surface);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-read-aloud:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
    body.theme-light .btn-read-aloud { background: var(--card); border-color: var(--border-strong); }
    .result-celebration {
      font-size: 1.35rem;
      margin-top: 0.75rem;
      color: var(--correct);
      font-weight: 700;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.02); }
    }
    .saved-sets-search { margin-bottom: 1rem; }
    .saved-sets-search input {
      width: 100%;
      padding: 0.65rem 1rem 0.65rem 2.25rem;
      font-size: 0.9rem;
      background: var(--bg);
      border: 1px solid var(--border-strong);
      border-radius: 10px;
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .saved-sets-search input::placeholder { color: var(--text-muted); }
    .saved-sets-search input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    .saved-sets-search-wrap { position: relative; }
    .saved-sets-search-wrap::before {
      content: 'üîç';
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      opacity: 0.6;
      pointer-events: none;
    }
    body.theme-light .saved-sets-search input { border-color: rgba(0,0,0,0.12); }

    /* Result */
    .result-card {
      text-align: center;
      padding: 2.5rem 2rem;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow);
      position: relative;
      overflow: visible;
    }
    .result-card .result-confetti { border-radius: var(--radius); }
    .result-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), #818cf8);
    }
    .result-score {
      font-size: 3.25rem;
      font-weight: 800;
      letter-spacing: -0.03em;
      background: linear-gradient(135deg, #c4b5fd, #a78bfa 40%, #818cf8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      line-height: 1.1;
    }
    .result-pct {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent);
      margin: -0.25rem 0 0.5rem;
    }
    .result-desc {
      color: var(--text-muted);
      font-size: 1.05rem;
      font-weight: 500;
      margin-bottom: 1.5rem;
    }
    .result-confetti {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      border-radius: inherit;
    }
    .result-confetti span {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: confetti 2.5s ease-out forwards;
      opacity: 0;
    }
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-120px) rotate(720deg); opacity: 0; }
    }
    .result-card .btn {
      margin-top: 0.5rem;
    }
    .result-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
      margin-top: 1.25rem;
    }
    .result-shortcut-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin: 0.75rem 0 0;
      text-align: center;
    }
    .wrong-book-btn { background: rgba(248, 113, 113, 0.15); color: #fca5a5; border: 1px solid rgba(248, 113, 113, 0.35); }
    .wrong-book-btn:hover { background: rgba(248, 113, 113, 0.25); box-shadow: 0 4px 16px rgba(248, 113, 113, 0.2); }
    .result-recent {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.06);
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    body.theme-light .result-recent { border-top-color: var(--border-subtle); }
    .result-recent-title { font-weight: 600; margin-bottom: 0.35rem; }
    .result-recent ul { list-style: none; }
    .result-recent li { padding: 0.2rem 0; }

    .format-doc {
      margin-top: 1.5rem;
      padding: 1.25rem;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
    }
    body.theme-light .format-doc { border-color: var(--border-subtle); }
    .format-doc-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .format-doc-title::before { content: '‚ñ∂'; font-size: 0.7rem; transition: transform 0.2s; }
    .format-doc.open .format-doc-title::before { transform: rotate(90deg); }
    .format-doc-content { display: none; font-size: 0.8rem; line-height: 1.7; color: var(--text-muted); max-height: 320px; overflow-y: auto; overflow-x: hidden; }
    .format-doc.open .format-doc-content { display: block; }
    .format-doc pre {
      background: var(--bg);
      padding: 0.75rem;
      border-radius: 8px;
      overflow-x: auto;
      margin: 0.5rem 0;
      font-size: 0.75rem;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .format-doc .type-tag { color: var(--accent); font-weight: 600; }
    .format-doc-hint { margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px solid var(--border-subtle); font-size: 0.8rem; }
    .format-doc-hint code { font-size: 0.75em; padding: 0.1em 0.35em; background: var(--surface); border-radius: 4px; }

    .saved-sets {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-sm);
    }
    body.theme-light .saved-sets { border-color: var(--border-subtle); }
    .saved-sets h3 {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-muted);
      letter-spacing: 0.03em;
      margin-bottom: 0.85rem;
    }
    .saved-sets-folders-bar { display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem 0.75rem; margin-bottom: 0.75rem; }
    .saved-sets-folders-label { font-size: 0.85rem; color: var(--text-muted); }
    .saved-sets-folder-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .folder-tag { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.65rem; background: var(--surface); border: 1px solid var(--border-strong); border-radius: 6px; font-size: 0.85rem; color: var(--text); box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
    .folder-tag .folder-tag-icon { width: 16px; height: 16px; flex-shrink: 0; opacity: 0.9; }
    .folder-tag .folder-tag-icon svg { width: 100%; height: 100%; fill: var(--accent); }
    .folder-tag .folder-tag-name { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .folder-tag .folder-tag-edit, .folder-tag .folder-tag-delete { min-width: 44px; min-height: 44px; padding: 0 0.35rem; font-size: 0.9rem; line-height: 1; background: none; border: none; color: var(--text-muted); cursor: pointer; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; }
    .folder-tag .folder-tag-edit:hover, .folder-tag .folder-tag-delete:hover { color: var(--text); }
    .folder-tag .folder-tag-delete:hover { color: #f87171; }
    body.theme-light .folder-tag { border-color: var(--border-strong); box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
    .saved-sets-folder { margin-bottom: 0.75rem; border-radius: var(--radius-sm); border: 1px solid var(--border-subtle-hover); background: var(--surface); overflow: hidden; }
    .saved-sets-folder:last-child { margin-bottom: 0; }
    body.theme-light .saved-sets-folder { border-color: var(--border-subtle-hover); background: var(--bg); }
    .saved-sets-folder-header { display: flex; align-items: center; gap: 0.25rem; width: 100%; padding: 0; background: rgba(139, 92, 246, 0.08); color: var(--text); }
    .saved-sets-folder-header:hover { background: rgba(139, 92, 246, 0.14); }
    body.theme-light .saved-sets-folder-header { background: rgba(139, 92, 246, 0.06); }
    body.theme-light .saved-sets-folder-header:hover { background: rgba(139, 92, 246, 0.12); }
    .saved-sets-folder-toggle { display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 0; padding: 0.6rem 0.85rem; border: none; background: none; color: inherit; font-size: 0.9rem; font-weight: 600; text-align: left; cursor: pointer; }
    .saved-sets-folder-header .folder-icon-wrap { width: 20px; height: 20px; flex-shrink: 0; }
    .saved-sets-folder-header .folder-icon-wrap svg { width: 100%; height: 100%; fill: var(--accent); }
    .saved-sets-folder-header .saved-sets-folder-name { flex: 1; min-width: 0; }
    .saved-sets-folder-header .folder-chevron { font-size: 0.7rem; opacity: 0.8; transition: transform 0.2s; flex-shrink: 0; }
    .saved-sets-folder-collapsed .saved-sets-folder-header .folder-chevron { transform: rotate(-90deg); }
    .saved-sets-folder-header .folder-header-edit, .saved-sets-folder-header .folder-header-delete { min-width: 44px; min-height: 44px; padding: 0 0.5rem; margin-right: 0.25rem; font-size: 0.85rem; background: none; border: none; color: var(--text-muted); cursor: pointer; border-radius: 4px; flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center; }
    .saved-sets-folder-header .folder-header-edit:hover, .saved-sets-folder-header .folder-header-delete:hover { color: var(--text); }
    .saved-sets-folder-header .folder-header-delete:hover { color: #f87171; }
    .saved-sets-folder-body { border-top: 1px solid rgba(255,255,255,0.06); }
    body.theme-light .saved-sets-folder-body { border-top-color: var(--border-subtle); }
    .saved-sets-folder-collapsed .saved-sets-folder-body { display: none; }
    .saved-sets-folder-body .saved-sets-list { padding: 0.5rem 0.75rem 0.75rem; gap: 0.5rem; }
    .saved-sets-folder-body .saved-sets-item { margin: 0; }
    .saved-sets-show-more-wrap { margin-top: 0.75rem; text-align: center; }
    .saved-sets-show-more { min-width: 160px; }
    .saved-sets-list-wrap {
      max-height: 320px;
      overflow-y: auto;
      overflow-x: hidden;
      margin: 0 -0.25rem 0 0;
      padding-right: 0.25rem;
    }
    .saved-sets-list-wrap::-webkit-scrollbar { width: 6px; }
    .saved-sets-list-wrap::-webkit-scrollbar-track { background: transparent; border-radius: 3px; }
    .saved-sets-list-wrap::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    body.theme-light .saved-sets-list-wrap::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); }
    .saved-sets-list { list-style: none; display: flex; flex-direction: column; gap: 0.65rem; contain: layout; }
    .saved-sets-item {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.15rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
      background: var(--surface);
      flex-wrap: wrap;
      transition: all 0.2s;
    }
    .saved-sets-item:hover {
      border-color: rgba(139, 92, 246, 0.35);
      background: var(--accent-soft);
      box-shadow: var(--shadow-sm);
    }
    body.theme-light .saved-sets-item { border-color: var(--border-subtle-hover); background: var(--bg); }
    body.theme-light .saved-sets-item:hover { border-color: var(--accent); background: var(--surface); }
    .saved-sets-item-content { flex: 1; min-width: 0; }
    .saved-sets-item .name {
      display: block;
      font-weight: 600;
      font-size: 1rem;
      color: var(--text);
      margin-bottom: 0.35rem;
      line-height: 1.4;
    }
    .saved-sets-item .meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.35rem;
    }
    .saved-sets-item .meta span { white-space: nowrap; }
    .saved-sets-item .meta .dot { opacity: 0.5; user-select: none; }
    .saved-sets-item .actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
    .saved-sets-item .btn { padding: 0.45rem 0.9rem; font-size: 0.85rem; border-radius: 8px; }
    .saved-sets-item .btn[data-action="edit"] { color: var(--text-muted); border-color: rgba(255,255,255,0.15); }
    .saved-sets-item .btn[data-action="edit"]:hover { color: var(--accent); border-color: var(--accent); }
    .saved-sets-item .btn[data-action="delete"] { color: var(--text-muted); border-color: var(--border-strong); }
    .saved-sets-item .btn[data-action="delete"]:hover { color: #f87171; border-color: rgba(248,113,113,0.5); background: rgba(248,113,113,0.08); }
    .saved-sets-item .btn[data-action="export"] { color: var(--text-muted); border-color: var(--border-strong); }
    .saved-sets-item .btn[data-action="export"]:hover { color: var(--accent); border-color: var(--accent); }
    body.theme-light .saved-sets-item .btn[data-action="edit"] { border-color: rgba(0,0,0,0.15); }
    body.theme-light .saved-sets-item .btn[data-action="delete"] { border-color: var(--border-strong); }
    body.theme-light .saved-sets-item .btn[data-action="export"] { border-color: var(--border-strong); }
    .saved-sets-empty { font-size: 0.9rem; color: var(--text-muted); padding: 1rem 0; text-align: center; }
    .import-name-wrap { margin-top: 0.75rem; }
    .import-name-wrap label { display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .import-name-wrap input { width: 100%; max-width: 320px; padding: 0.5rem 0.75rem; font-size: 0.9rem; background: var(--bg); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; color: var(--text); }
    .import-folder-label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; margin-bottom: 0.35rem; }
    .import-name-wrap select { max-width: 280px; padding: 0.5rem 0.75rem; font-size: 0.9rem; background: var(--bg); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; color: var(--text); }
    body.theme-light .import-name-wrap input { background: var(--bg); border-color: rgba(0,0,0,0.12); }
    body.theme-light .import-name-wrap select { background: var(--bg); border-color: rgba(0,0,0,0.12); }
    .import-review-wrap { margin-top: 0.75rem; }
    .import-review-wrap label { display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .import-review-wrap textarea { width: 100%; max-width: 100%; padding: 0.5rem 0.75rem; font-size: 0.85rem; font-family: inherit; background: var(--bg); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; color: var(--text); resize: vertical; min-height: 4rem; }
    body.theme-light .import-review-wrap textarea { background: var(--bg); border-color: rgba(0,0,0,0.12); }
    .import-dup-hint { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem; }
    .storage-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; line-height: 1.5; }
    .storage-desc code { font-size: 0.75em; padding: 0.15em 0.4em; background: var(--bg); border-radius: 4px; }
    .storage-security-hint { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; padding: 0.65rem 0.85rem; background: var(--surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); line-height: 1.5; }
    .storage-security-hint strong { color: var(--text); }
    body.theme-light .storage-security-hint { background: var(--surface); border-color: var(--border-subtle); }
    .btn-one-save {
      width: 100%;
      margin-bottom: 1rem;
      min-height: 48px;
      font-size: 1rem;
    }
    .storage-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.75rem;
    }
    @media (max-width: 420px) {
      .storage-grid { grid-template-columns: 1fr; }
    }
    .storage-card {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
      padding: 1.1rem 1.2rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
      background: var(--surface);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    body.theme-light .storage-card { border-color: var(--border-subtle-hover); background: var(--card); }
    .storage-card:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    body.theme-light .storage-card:hover { background: var(--surface); border-color: var(--accent); }
    .storage-card .title { font-weight: 600; font-size: 0.9rem; color: var(--text); }
    .storage-card .hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.35rem; line-height: 1.4; }
    .save-success-tip {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--surface);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: var(--radius-sm);
    }
    body.theme-light .save-success-tip { border-color: rgba(124, 58, 237, 0.35); background: var(--card); }
    .save-success-tip-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.35rem; }
    .save-success-tip-desc { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; }
    .save-success-tip-cmd-wrap { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    .save-success-tip-cmd {
      flex: 1;
      min-width: 0;
      font-size: 0.8rem;
      padding: 0.5rem 0.6rem;
      background: var(--bg);
      border-radius: 6px;
      word-break: break-all;
    }
    body.theme-light .save-success-tip-cmd { background: var(--surface); }
    .save-success-tip-extra { font-size: 0.8rem; color: var(--text-muted); }
    .import-lock-wrap { margin-top: 1rem; padding: 0.75rem 0.9rem; background: var(--surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); }
    .import-lock-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; line-height: 1.45; }
    .import-lock-per-device { display: inline-block; margin-top: 0.35rem; font-size: 0.75rem; opacity: 0.9; }
    .import-device-bind { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle); }
    .import-lock-status { display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
    .import-lock-status #import-lock-status-text { font-size: 0.85rem; color: var(--text-muted); }
    .import-lock-btns { display: flex; gap: 0.4rem; }
    body.theme-light .import-lock-wrap { background: var(--surface); border-color: var(--border-subtle); }
    .storage-fallback { margin-top: 0.75rem; font-size: 0.8rem; color: var(--text-muted); }
    .storage-fallback a { color: var(--accent); text-decoration: none; }
    .storage-fallback a:hover { text-decoration: underline; }
    input[type="file"]#file-import-data { display: none; }

    /* Review materials modal */
    .review-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .review-modal-overlay.show { display: flex; }
    .review-modal {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-strong);
      padding: 1.5rem;
      max-width: 420px;
      width: 100%;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
    }
    body.theme-light .review-modal { border-color: var(--border-strong); }
    .review-modal h3 { font-size: 1rem; margin-bottom: 1rem; color: var(--text); }
    .review-modal-body { flex: 1; overflow-y: auto; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 1rem; }
    .review-modal-texts-wrap { max-height: 180px; overflow-y: auto; border-radius: var(--radius-sm); border: 1px solid var(--border-subtle); background: var(--surface); padding: 0.6rem 0.75rem; }
    body.theme-light .review-modal-texts-wrap { border-color: var(--border-subtle-hover); }
    .review-modal-texts { font-size: 0.9rem; line-height: 1.6; color: var(--text); white-space: pre-wrap; word-break: break-word; }
    .review-modal-texts .review-text-block { margin-bottom: 0.75rem; }
    .review-modal-texts .review-text-block:last-child { margin-bottom: 0; }
    .review-modal-links { display: flex; flex-direction: column; gap: 0.5rem; }
    .review-modal-links a {
      display: block;
      padding: 0.6rem 0.75rem;
      background: var(--surface);
      border-radius: var(--radius-sm);
      color: var(--accent);
      text-decoration: none;
      font-size: 0.9rem;
      word-break: break-all;
      border: 1px solid var(--border-subtle);
      transition: background 0.2s, border-color 0.2s;
    }
    .review-modal-links a:hover { background: var(--accent-soft); border-color: var(--accent); }
    body.theme-light .review-modal-links a { border-color: var(--border-subtle-hover); }
    .review-modal-links .review-modal-msg {
      display: block;
      padding: 0.6rem 0.75rem;
      background: var(--surface);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      line-height: 1.5;
      word-break: break-word;
      white-space: pre-wrap;
      color: var(--text);
      border: 1px solid var(--border-subtle);
    }
    body.theme-light .review-modal-links .review-modal-msg { border-color: var(--border-subtle-hover); }
    .review-modal-actions { display: flex; gap: 0.75rem; flex-shrink: 0; }
    .review-modal-actions .btn { flex: 1; }

    /* Edit set modal */
    .edit-set-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1001;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .edit-set-modal-overlay.show { display: flex; }
    .edit-set-modal {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-strong);
      padding: 1.5rem;
      max-width: 440px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }
    body.theme-light .edit-set-modal { border-color: var(--border-strong); }
    .edit-set-modal h3 { font-size: 1rem; margin-bottom: 1.25rem; color: var(--text); }
    .edit-set-field { margin-bottom: 1rem; }
    .edit-set-field label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .edit-set-field input,
    .edit-set-field select,
    .edit-set-field textarea {
      width: 100%;
      padding: 0.55rem 0.75rem;
      font-size: 0.9rem;
      font-family: inherit;
      background: var(--surface);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-sm);
      color: var(--text);
    }
    .edit-set-field textarea { resize: vertical; min-height: 4.5rem; }
    body.theme-light .edit-set-field input,
    body.theme-light .edit-set-field select,
    body.theme-light .edit-set-field textarea { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .edit-set-meta { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; }
    .edit-set-append .btn { margin-top: 0.5rem; }
    .edit-set-review-label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem; }
    .edit-set-review-row { margin-bottom: 0.75rem; }
    .edit-set-review-row label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; }
    .edit-set-review-row textarea { width: 100%; padding: 0.5rem 0.75rem; font-size: 0.85rem; font-family: inherit; background: var(--surface); border: 1px solid var(--border-strong); border-radius: var(--radius-sm); color: var(--text); resize: vertical; }
    body.theme-light .edit-set-review-row textarea { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .edit-set-paste-images { margin-top: 0.5rem; }
    .edit-set-paste-images-hint { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .edit-set-paste-zone {
      min-height: 56px;
      padding: 0.5rem 0.75rem;
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: var(--radius-sm);
      background: var(--surface);
      color: var(--text-muted);
      font-size: 0.85rem;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .edit-set-paste-zone:hover { border-color: var(--accent); background: var(--accent-soft); color: var(--text); }
    .edit-set-paste-zone:focus { outline: none; border-color: var(--accent); }
    body.theme-light .edit-set-paste-zone { border-color: rgba(0,0,0,0.15); background: var(--card); }
    .edit-set-pasted-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    .edit-set-pasted-item { position: relative; flex-shrink: 0; }
    .edit-set-pasted-item img { display: block; max-width: 80px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-strong); }
    .edit-set-pasted-item .edit-set-pasted-remove { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; border-radius: 50%; border: none; background: rgba(0,0,0,0.6); color: #fff; font-size: 14px; line-height: 1; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; }
    .review-modal-links .review-modal-img { max-width: 100%; max-height: 280px; display: block; border-radius: var(--radius-sm); margin-top: 0.25rem; }
    .review-modal-images { display: flex; flex-direction: column; gap: 0.5rem; }
    .review-modal-images .review-modal-msg { margin: 0; }
    .review-modal-images .review-modal-img { max-width: 100%; max-height: 240px; display: block; border-radius: var(--radius-sm); cursor: pointer; }
    .review-modal-images .review-modal-msg { cursor: pointer; }
    .image-lightbox-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 2rem; box-sizing: border-box; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; }
    .image-lightbox-overlay.show { opacity: 1; visibility: visible; }
    .image-lightbox-overlay .image-lightbox-content { position: relative; max-width: 95vw; max-height: 95vh; display: flex; align-items: center; justify-content: center; }
    .image-lightbox-overlay .image-lightbox-content img { max-width: 95vw; max-height: 95vh; width: auto; height: auto; object-fit: contain; border-radius: var(--radius-sm); box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
    .image-lightbox-overlay .image-lightbox-close { position: absolute; top: -2.5rem; right: 0; min-width: 44px; min-height: 44px; width: 2.5rem; height: 2.5rem; border: none; background: rgba(255,255,255,0.2); color: #fff; font-size: 1.25rem; line-height: 1; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; padding: 0; }
    .image-lightbox-overlay .image-lightbox-close:hover { background: rgba(255,255,255,0.35); }
    .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); padding: 0.65rem 1.25rem; background: var(--surface); border: 1px solid var(--border-strong); border-radius: 999px; color: var(--text); font-size: 0.9rem; z-index: 10001; box-shadow: 0 4px 20px rgba(0,0,0,0.3); opacity: 0; visibility: hidden; transition: opacity 0.35s, visibility 0.35s, transform 0.35s; pointer-events: none; }
    .toast.show { opacity: 1; visibility: visible; }
    body.theme-light .toast { border-color: var(--border-strong); box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
    .edit-set-actions { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
    .edit-set-actions .btn { flex: 1; }
    .edit-set-extra { padding-top: 0.75rem; border-top: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    body.theme-light .edit-set-extra { border-top-color: rgba(0,0,0,0.08); }
    .edit-set-sep { color: var(--text-muted); opacity: 0.6; font-size: 0.85rem; }
    .preview-questions-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; padding: 1.5rem; box-sizing: border-box; }
    .preview-questions-overlay.show { display: flex; }
    .preview-questions-modal { width: 100%; max-width: 560px; max-height: 85vh; display: flex; flex-direction: column; background: var(--card); border-radius: var(--radius); border: 1px solid var(--border-subtle-hover); box-shadow: var(--shadow-lg); }
    body.theme-light .preview-questions-modal { border-color: rgba(0,0,0,0.1); }
    .preview-questions-modal h3 { font-size: 1rem; margin: 0 0 0.75rem 0; padding: 0 1rem; color: var(--text); flex-shrink: 0; }
    .preview-questions-body { flex: 1; overflow-y: auto; padding: 0 1rem 1rem; display: flex; flex-direction: column; gap: 1rem; min-height: 0; }
    .preview-questions-body .preview-q { padding: 0.85rem 1rem; background: var(--surface); border-radius: var(--radius-sm); border: 1px solid var(--border-subtle); font-size: 0.9rem; }
    body.theme-light .preview-questions-body .preview-q { border-color: rgba(0,0,0,0.08); }
    .preview-questions-body .preview-q-head { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; }
    .preview-questions-body .preview-q-stem { color: var(--text); line-height: 1.55; margin-bottom: 0.5rem; }
    .preview-questions-body .preview-q-options { margin: 0.35rem 0; padding-left: 1rem; color: var(--text); }
    .preview-questions-body .preview-q-correct { font-size: 0.85rem; color: var(--correct); margin-top: 0.4rem; }
    .preview-questions-body .preview-q-explanation { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.35rem; }
    .preview-questions-actions { padding: 0 1rem 1rem; flex-shrink: 0; }
    .btn-link { background: none; border: none; color: var(--accent); font-size: 0.85rem; cursor: pointer; padding: 0.35rem 0; text-decoration: underline; }
    .btn-link:hover { color: var(--accent-hover); }
    .btn-link-danger { background: none; border: none; color: var(--text-muted); font-size: 0.85rem; cursor: pointer; padding: 0.35rem 0; text-decoration: underline; }
    .btn-link-danger:hover { color: #f87171; }

    .start-mode-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.65); backdrop-filter: blur(4px); z-index: 9998; align-items: center; justify-content: center; padding: 1.5rem; box-sizing: border-box; }
    .start-mode-modal-overlay.show { display: flex !important; }
    .start-mode-modal { width: 100%; max-width: 440px; background: var(--card); border-radius: 20px; border: 1px solid var(--border-subtle); box-shadow: 0 24px 48px rgba(0,0,0,0.35); padding: 1.5rem 1.75rem; }
    body.theme-light .start-mode-modal { border-color: var(--border-subtle); box-shadow: 0 24px 48px rgba(0,0,0,0.12); }
    .start-mode-modal h3 { font-size: 1.15rem; font-weight: 700; margin: 0 0 0.35rem 0; color: var(--text); letter-spacing: -0.02em; }
    .start-mode-desc { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.25rem; line-height: 1.5; }
    .start-mode-cards { display: flex; flex-direction: column; gap: 1rem; }
    .start-mode-card { background: var(--surface); border: 1px solid var(--border-subtle); border-radius: 14px; padding: 1.1rem 1.25rem; transition: border-color 0.2s, box-shadow 0.2s; }
    .start-mode-card:hover { border-color: var(--border-subtle-hover); }
    body.theme-light .start-mode-card { background: var(--surface); }
    .start-mode-card-title { font-size: 0.95rem; font-weight: 600; color: var(--text); margin-bottom: 0.25rem; }
    .start-mode-card-hint { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem; line-height: 1.4; }
    .start-mode-check-wrap { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text); cursor: pointer; margin-bottom: 0.75rem; }
    .start-mode-check-wrap input { width: 1.1em; height: 1.1em; accent-color: var(--accent); cursor: pointer; }
    .start-mode-card-btn { width: 100%; justify-content: center; margin-top: 0.25rem; }
    .start-mode-sequential-row { display: flex; flex-wrap: wrap; align-items: center; gap: 0.4rem 0.5rem; margin-bottom: 0.75rem; }
    .start-mode-sequential-row input[type="number"] { width: 4rem; padding: 0.5rem 0.6rem; font-size: 0.95rem; background: var(--bg); border: 1px solid var(--border-strong); border-radius: 10px; color: var(--text); }
    .start-mode-sequential-text { font-size: 0.88rem; color: var(--text-muted); }
    .start-mode-finished-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .start-mode-finished-btns .btn { flex: 1; min-width: 100px; }
    .start-mode-footer { margin-top: 1.25rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle); text-align: center; }
    .btn-ghost { background: none; border: none; color: var(--text-muted); font-size: 0.9rem; cursor: pointer; padding: 0.4rem 0.75rem; border-radius: 8px; }
    .btn-ghost:hover { color: var(--text); background: var(--surface); }
    body.theme-light .start-mode-sequential-row input { background: var(--card); border-color: var(--border-strong); }

    /* Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    .skip-link {
      position: absolute;
      top: -100%;
      left: 0.75rem;
      z-index: 10002;
      padding: 0.75rem 1rem;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      border-radius: var(--radius-sm);
      text-decoration: none;
      transition: top 0.2s;
    }
    .skip-link:focus {
      top: 0.75rem;
      outline: 2px solid #fff;
      outline-offset: 2px;
    }
    .screen { contain: layout style; }

    @media print {
      .skip-link, #toast, .review-modal-overlay, .start-mode-modal-overlay, .image-lightbox-overlay, .edit-set-modal-overlay, .preview-questions-overlay,
      header .theme-toggle, header .home-actions .btn,
      .result-actions, .result-shortcut-hint, .result-recent { display: none !important; }
      body { background: #fff; color: #111; }
      .container, .screen.active, .result-card, .question-card { background: #fff; color: #111; border-color: #ddd; box-shadow: none; }
      .screen { display: none !important; }
      .screen.active { display: block !important; }
      a { color: #111; }
    }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">Ë∑≥ËøáËá≥‰∏ªÂÜÖÂÆπ</a>
  <div class="container" id="main" role="main">
    <header>
      <div class="brand">
        <h1>Fran√ßais Quiz</h1>
        <p>TCF Â°´Á©∫ ¬∑ ÊÆµËêΩÂ°´Á©∫ ¬∑ ÂçïÈÄâ ¬∑ Â§öÈÄâ</p>
      </div>
      <button type="button" class="theme-toggle" id="theme-toggle" title="ÂàáÊç¢Ê∑±Ëâ≤/ÊµÖËâ≤" aria-label="ÂàáÊç¢Ê∑±Ëâ≤ÊàñÊµÖËâ≤‰∏ªÈ¢ò" aria-pressed="false">üåì</button>
    </header>

    <div id="screen-home" class="screen active">
      <div class="stats-bar" id="stats-bar">
        <span>‰ªäÊó•Â∑≤ÁªÉ <strong id="stat-today">0</strong> È¢ò</span>
        <span>ËøûÁª≠ <strong id="stat-streak">0</strong> Â§©</span>
        <span>ÈîôÈ¢òÊú¨ <strong id="stat-wrong">0</strong> È¢ò</span>
        <span>‰π†È¢òÈõÜ <strong id="stat-sets">0</strong> Â•ó</span>
      </div>

      <div class="home-section">
        <h2>ÂºÄÂßãÁªÉ‰π†</h2>
        <div class="timer-wrap">
          <label for="timer-seconds">ÊØèÈ¢òÂÄíËÆ°Êó∂ÔºàÁßíÔºâ</label>
          <input type="number" id="timer-seconds" min="0" max="120" value="10" title="0 Ë°®Á§∫‰∏çÈôêÊó∂" />
          <div class="shuffle-wrap">
            <input type="checkbox" id="shuffle-questions" />
            <label for="shuffle-questions">Êâì‰π±È¢òÁõÆÈ°∫Â∫è</label>
          </div>
          <div class="shuffle-wrap">
            <input type="checkbox" id="shuffle-options" />
            <label for="shuffle-options">Êâì‰π±ÈÄâÈ°πÈ°∫Â∫è</label>
          </div>
        </div>
        <div class="type-filter-wrap">
          <span class="type-filter-label">Âè™ÂÅö‰ª•‰∏ãÈ¢òÂûãÔºà‰∏çÂãæÈÄâ = ÂÖ®ÈÉ®Ôºâ</span>
          <div class="type-filter-row">
            <label><input type="checkbox" id="filter-type-single" checked /> ÂçïÈÄâ</label>
            <label><input type="checkbox" id="filter-type-multiple" checked /> Â§öÈÄâ</label>
            <label><input type="checkbox" id="filter-type-fill" checked /> Â°´Á©∫</label>
            <label><input type="checkbox" id="filter-type-paragraph" checked /> ÊÆµËêΩÂ°´Á©∫</label>
          </div>
        </div>
        <div class="start-select-wrap">
          <label for="start-practice-select">ÈÄâÊã©‰π†È¢òÈõÜ</label>
          <select id="start-practice-select">
            <option value="default">ÈªòËÆ§È¢òÁõÆ</option>
          </select>
        </div>
        <div class="category-filter-wrap" id="category-filter-wrap">
          <label for="filter-category">ÂàÜÁ±ªÁ≠õÈÄâ</label>
          <select id="filter-category">
            <option value="">ÂÖ®ÈÉ®</option>
          </select>
        </div>
        <div class="home-actions">
          <button type="button" class="btn btn-primary" id="btn-start-practice">ÂºÄÂßãÁªÉ‰π†</button>
          <button type="button" class="btn btn-secondary" id="btn-import-show">ÂØºÂÖ•ÊàëÁöÑÈ¢òÁõÆ</button>
        </div>
        <div class="import-section" id="import-section" style="display: none;">
        <h3>Á≤òË¥¥È¢òÁõÆÊñáÊú¨ÔºàÊîØÊåÅ‰Ω†ÁªôÁöÑÊ†ºÂºèÔºâ</h3>
        <textarea id="import-text" placeholder="Á≤òË¥¥È¢òÁõÆÊñáÊú¨ÔºàËßÅ‰∏ãÊñπËØ¥ÊòéÔºâÊàñ JSON Êï∞ÁªÑ‚Ä¶"></textarea>
        <div class="import-name-wrap">
          <label for="import-set-name">‰π†È¢òÈõÜÂêçÁß∞Ôºà‰øùÂ≠òÁî®ÔºåÂ°´ÂÜôÂêéÊú¨Ê¨°ÂØºÂÖ•‰ºöÂä†ÂÖ•„ÄåÊàëÁöÑ‰π†È¢òÈõÜ„ÄçÔºâ</label>
          <input type="text" id="import-set-name" placeholder="‰æãÂ¶ÇÔºöavoir Âõ∫ÂÆöË°®Ëææ" autocomplete="off" />
          <label for="import-set-folder" class="import-folder-label">‰øùÂ≠òÂà∞Êñá‰ª∂Â§π</label>
          <select id="import-set-folder">
            <option value="">Êú™ÂàÜÁ±ª</option>
          </select>
        </div>
        <div class="import-review-wrap">
          <label for="import-review-urls">ÁªÉ‰π†ÂâçÂ§ç‰π†ËµÑÊñôÔºàÂèØÈÄâÔºåÊØèË°å‰∏Ä‰∏™ URLÔºåÂºÄÂßãÁªÉ‰π†ÂâçÂèØÂÖàÁúãÔºâ</label>
          <textarea id="import-review-urls" rows="3" placeholder="https://‚Ä¶&#10;https://‚Ä¶" autocomplete="off"></textarea>
        </div>
        <p class="import-dup-hint">ÈáçÂ§çÈ¢òÁõÆÔºàÈ¢òÂπ≤+ÈÄâÈ°π+Á≠îÊ°àÁõ∏ÂêåÔºâÂ∞ÜËá™Âä®Ë∑≥ËøáÔºå‰ªÖ‰øùÁïô‰∏ÄÈÅì„ÄÇ</p>
        <button type="button" class="btn btn-primary" id="btn-import-parse" style="margin-top: 0.75rem;">Ëß£ÊûêÂπ∂ÂºÄÂßã</button>
        </div>
      </div>

      <div class="home-section">
        <h2>ÈîôÈ¢òÊú¨</h2>
        <div class="home-actions">
          <button type="button" class="btn wrong-book-btn" id="btn-wrong-book">ÊåâËÆ°ÂàíÂ§ç‰π† (<span id="wrong-count">0</span>)</button>
          <button type="button" class="btn btn-secondary" id="btn-wrong-free">Ëá™Áî±ÁªÉ‰π†ÂÖ®ÈÉ®</button>
          <button type="button" class="btn btn-secondary" id="btn-clear-wrong">Ê∏ÖÁ©∫ÈîôÈ¢òÊú¨</button>
        </div>
      </div>

      <div class="home-section saved-sets" id="saved-sets-section">
        <h2>ÊàëÁöÑ‰π†È¢òÈõÜ</h2>
        <div class="saved-sets-search">
          <div class="saved-sets-search-wrap">
            <input type="text" id="saved-sets-search" placeholder="ÊêúÁ¥¢‰π†È¢òÈõÜÂêçÁß∞‚Ä¶" autocomplete="off" aria-label="ÊêúÁ¥¢‰π†È¢òÈõÜÂêçÁß∞" />
          </div>
        </div>
        <div class="saved-sets-folders-bar" id="saved-sets-folders-bar">
          <span class="saved-sets-folders-label">Êñá‰ª∂Â§π</span>
          <button type="button" class="btn btn-secondary btn-sm" id="btn-add-folder">Ê∑ªÂä†Êñá‰ª∂Â§π</button>
          <div class="saved-sets-folder-tags" id="saved-sets-folder-tags"></div>
        </div>
        <div class="saved-sets-list-wrap">
          <div id="saved-sets-list"></div>
          <p class="saved-sets-empty" id="saved-sets-empty" style="display: none;">ÊöÇÊó†‰øùÂ≠òÁöÑ‰π†È¢òÈõÜÔºåÂØºÂÖ•È¢òÁõÆÊó∂Â°´ÂÜôÂêçÁß∞Âç≥ÂèØ‰øùÂ≠ò„ÄÇ</p>
        </div>
      </div>

      <div class="home-section" id="storage-section">
        <h2>Êï∞ÊçÆÂ≠òÂà∞È°πÁõÆÊñá‰ª∂Â§π / ‰∫ëÁ´ØÂêåÊ≠•</h2>
        <p class="storage-desc">ÁîµËÑëÔºö‰∏ÄÈîÆ‰øùÂ≠òÂà∞È°πÁõÆÈáåÁöÑ <code>french_quiz_data.json</code>„ÄÇÊâãÊú∫Ë¶ÅÁúãÂà∞Âêå‰∏Ä‰ªΩ‰π†È¢òÈõÜÔºö‰øùÂ≠òÂêéÂú®È°πÁõÆÁõÆÂΩïÊâßË°å‰∏ãÊñπÂëΩ‰ª§Ôºå<strong>ÂêåÊó∂Êé®ÈÄÅ‰∏ª‰ªìÂ∫ì + Pages Á´ôÁÇπ</strong>ÔºåÊâãÊú∫ÊâìÂºÄÊú¨È°µÂêéÁÇπ„Äå<strong>‰ªé‰∫ëÁ´ØÂä†ËΩΩ</strong>„ÄçÂç≥ÂèØÂêåÊ≠•„ÄÇ</p>
        <p class="storage-security-hint">ÂÆâÂÖ®ËØ¥ÊòéÔºö‰∫ëÁ´Ø‰π†È¢òÈõÜÊù•Ëá™ÂΩìÂâçÁΩëÁ´ôÈáåÁöÑÈùôÊÄÅÊñá‰ª∂ÔºåÁΩëÈ°µ<strong>Ê≤°Êúâ‰∏ä‰º†/Êé®ÈÄÅÂäüËÉΩ</strong>ÔºåËÆøÂÆ¢Êó†Ê≥ïÊîπÂÜô‰Ω†ÁöÑÊï∞ÊçÆ„ÄÇÂè™Êúâ‰Ω†Ëá™Â∑±ÔºàÊàñ‰Ω†Êéà‰∫àÂÜôÊùÉÈôêÁöÑ GitHub Âçè‰ΩúËÄÖÔºâËÉΩÂú®Êú¨Êú∫ÊâßË°åËÑöÊú¨Êé®ÈÄÅÂà∞‰ªìÂ∫ì„ÄÇËã•Â∏åÊúõÂà´‰∫∫ÊîπÂä®‰πüÈúÄ‰Ω†ÂêåÊÑèÔºåËØ∑ÂãøÊéà‰∫à‰ªìÂ∫ìÂÜôÊùÉÈôêÔºåÊàñÂú® GitHub ‰ªìÂ∫ìËÆæÁΩÆ‰∏≠ÂºÄÂêØÂàÜÊîØ‰øùÊä§„ÄÅË¶ÅÊ±Ç PR ÂÆ°Ê†∏ÂêéÂÜçÂêàÂπ∂„ÄÇ</p>
        <button type="button" class="btn btn-primary btn-one-save" id="btn-one-save">‰∏ÄÈîÆ‰øùÂ≠òÔºàË¶ÜÁõñÂà∞È°πÁõÆÊñá‰ª∂Â§πÔºâ</button>
        <button type="button" class="btn btn-primary btn-one-save" id="btn-load-cloud" style="background: linear-gradient(135deg, #059669, #0d9488);">‰ªé‰∫ëÁ´ØÂä†ËΩΩÔºàÊâãÊú∫ÂêåÊ≠•‰π†È¢òÈõÜÔºâ</button>
        <div class="storage-grid">
          <button type="button" class="storage-card" id="btn-open-folder">
            <span class="title">ÊâìÂºÄÂπ∂Âä†ËΩΩ</span>
            <span class="hint">ÈÄâÊã© french-quiz Êñá‰ª∂Â§πÔºåËØªÂèñÊú¨Âú∞ JSON</span>
          </button>
          <button type="button" class="storage-card" id="btn-save-to-folder">
            <span class="title">‰øùÂ≠òÂà∞È°πÁõÆÊñá‰ª∂Â§π</span>
            <span class="hint">Ë¶ÜÁõñ french_quiz_data.json</span>
          </button>
          <button type="button" class="storage-card" id="btn-export-data">
            <span class="title">ÂØºÂá∫Âà∞È°πÁõÆÊñá‰ª∂Â§πÔºàË¶ÜÁõñÔºâ</span>
            <span class="hint">Áõ¥Êé•ÂÜôÂÖ•È°πÁõÆÁõÆÂΩïÔºåË¶ÜÁõñÂéüÊñá‰ª∂</span>
          </button>
          <button type="button" class="storage-card" id="btn-import-data">
            <span class="title">‰ªéÊñá‰ª∂ÂØºÂÖ•</span>
            <span class="hint">ÈÄâÊã©Êú¨Êú∫ JSON Êñá‰ª∂ÊÅ¢Â§çÊï∞ÊçÆ</span>
          </button>
        </div>
        <div class="save-success-tip" id="save-success-tip" style="display: none;">
          <p class="save-success-tip-title">Â∑≤‰øùÂ≠ò„ÄÇË¶ÅÂêåÊ≠•Âà∞ GitHubÔºà‰∏ª‰ªìÂ∫ì + Pages Á´ôÁÇπ‰∏ÄËµ∑Êõ¥Êñ∞ÔºâÔºö</p>
          <p class="save-success-tip-desc">Âú®È°πÁõÆÁõÆÂΩïÊâìÂºÄÁªàÁ´ØÔºåËøêË°åÔºàÊàñÁÇπÂáªÂ§çÂà∂ÔºâÔºåÊää <code>../french-quiz-pages</code> Êç¢Êàê‰Ω†ÁöÑÂÖ¨ÂºÄ Pages ‰ªìÂ∫ìË∑ØÂæÑÔºö</p>
          <div class="save-success-tip-cmd-wrap">
            <code class="save-success-tip-cmd" id="save-deploy-cmd">./scripts/sync-and-push.sh ../french-quiz-pages</code>
            <button type="button" class="btn btn-secondary btn-sm" id="btn-copy-deploy-cmd">Â§çÂà∂ÂëΩ‰ª§</button>
          </div>
          <p class="save-success-tip-extra">Âè™Êé®ÂΩìÂâç‰ªìÂ∫ìÁî® <code>./scripts/sync-and-push.sh</code>ÔºõÂêåÊó∂Êõ¥Êñ∞‰∏ª‰ªìÂ∫ì+Pages Áî® <code>./scripts/sync-and-push.sh ../french-quiz-pages</code>„ÄÇÈ¶ñÊ¨°ÈúÄ <code>chmod +x scripts/sync-and-push.sh</code>„ÄÇ</p>
        </div>
        <div class="import-lock-wrap" id="import-lock-wrap">
        <p class="import-lock-desc">ÂØºÂÖ•‰øùÊä§Ôºö‰ªÖ‰∏ª‰∫∫ÂèØÂæÄ„ÄåÊàëÁöÑ‰π†È¢òÈõÜ„ÄçÈáå<strong>Êñ∞Â¢ûÈ¢òÁõÆ</strong>„ÄÇPIN Áî±<strong>‰Ω†Ëá™Â∑±Âú®‰∏ãÊñπÁÇπÂáª„ÄåËÆæÁΩÆ‰∏ª‰∫∫ PIN„ÄçÊó∂ËÆæÂÆö</strong>Ôºà4ÔΩû12 ‰ΩçÔºâÔºåËØ∑Áâ¢ËÆ∞„ÄÇËÆæÁΩÆÂêéÔºåÂè™ÊúâÈÄöËøáÈ™åËØÅÊâçËÉΩ‰ΩøÁî®„Äå<strong>ÂØºÂÖ•ÊàëÁöÑÈ¢òÁõÆ</strong>„ÄçÔºõ„Äå‰ªé‰∫ëÁ´ØÂä†ËΩΩ„Äç„Äå‰ªéÊñá‰ª∂ÂØºÂÖ•„Äç„ÄåÊâìÂºÄÂπ∂Âä†ËΩΩ„Äç‰∏çÂèóÈôêÂà∂Ôºå‰ªñ‰∫∫ÂèØÊ≠£Â∏∏ÂêåÊ≠•‰∫ëÁ´ØÊõ¥Êñ∞„ÄÇ<br><span class="import-lock-per-device">Êú¨ËÆæÁΩÆ<strong>‰ªÖÂØπÂΩìÂâçËÆæÂ§á/ÊµèËßàÂô®ÁîüÊïà</strong>„ÄÇËã•Â∑≤ÂêØÁî®‰∏ãÊñπ„Äå‰ªÖÂÖÅËÆ∏Êú¨Êú∫ÂØºÂÖ•„ÄçÔºåÂàôÂÖ∂‰ªñËÆæÂ§áÂ∑≤Êó†Ê≥ïÂØºÂÖ•ÔºåÊú¨È°π PIN ‰∏∫<strong>ÂèØÈÄâ</strong>ÔºåÁî®‰∫éÊú¨Êú∫Â§ö‰∫∫ÂÖ±Áî®Êàñ‰∏¥Êó∂ÂÄüÁî®Êó∂ÁöÑÈ¢ùÂ§ñ‰øùÊä§„ÄÇ</span></p>
        <div class="import-lock-status" id="import-lock-status">
          <span id="import-lock-status-text">Êú™ÂêØÁî®</span>
          <span class="import-lock-btns">
            <button type="button" class="btn btn-secondary btn-sm" id="btn-import-lock-set">ËÆæÁΩÆ‰∏ª‰∫∫ PIN</button>
            <button type="button" class="btn btn-secondary btn-sm" id="btn-import-lock-change" style="display:none;">‰øÆÊîπ PIN</button>
            <button type="button" class="btn btn-secondary btn-sm" id="btn-import-lock-disable" style="display:none;">ÂÖ≥Èó≠‰øùÊä§</button>
          </span>
        </div>
        <div class="import-device-bind" id="import-device-bind">
          <p class="import-lock-desc">‰ªÖÂÖÅËÆ∏Êú¨Êú∫„ÄåÂØºÂÖ•ÊàëÁöÑÈ¢òÁõÆ„ÄçÔºöÁªëÂÆöÂêé<strong>Âè™ÊúâÂΩìÂâçËøôÂè∞ÁîµËÑë</strong>ËÉΩ‰ΩøÁî®„ÄåÂØºÂÖ•ÊàëÁöÑÈ¢òÁõÆ„ÄçÂæÄÊàëÁöÑ‰π†È¢òÈõÜÈáåÊñ∞Â¢ûÈ¢òÁõÆ„ÄÇÂÖ∂‰ªñËÆæÂ§á‰ªçÂèØÊ≠£Â∏∏‰ΩøÁî®„Äå‰ªé‰∫ëÁ´ØÂä†ËΩΩ„Äç„Äå‰ªéÊñá‰ª∂ÂØºÂÖ•„Äç„ÄåÊâìÂºÄÂπ∂Âä†ËΩΩ„ÄçËé∑ÂèñÊàñË¶ÜÁõñÊï∞ÊçÆ„ÄÇËØ∑Âú®ÁîµËÑë‰∏äÁÇπÂáª„ÄåÁªëÂÆöÊú¨Êú∫„ÄçÔºåÂÜç„Äå‰∏ÄÈîÆ‰øùÂ≠ò„ÄçÂπ∂Êé®ÈÄÅÂà∞‰∫ëÁ´Ø„ÄÇ</p>
          <div class="import-lock-status">
            <span id="device-bind-status-text">Êú™ÁªëÂÆö</span>
            <span class="import-lock-btns">
              <button type="button" class="btn btn-secondary btn-sm" id="btn-device-bind">ÁªëÂÆöÊú¨Êú∫</button>
              <button type="button" class="btn btn-secondary btn-sm" id="btn-device-unbind" style="display:none;">Ëß£Èô§ÁªëÂÆö</button>
            </span>
          </div>
        </div>
      </div>
        <p class="storage-fallback">Êó†Ê≥ïÈÄâÊã©Êñá‰ª∂Â§πÔºü<a href="#" id="link-download-json">‰∏ãËΩΩ JSON Âà∞ÁîµËÑë</a></p>
        <input type="file" id="file-import-data" accept=".json,application/json" />
      </div>

      <div class="home-section format-doc" id="format-doc">
        <h2 class="format-doc-title">ÂêÑÈ¢òÂûãÊ†ºÂºèËØ¥ÊòéÔºàÁÇπÂºÄÊü•ÁúãÔºâ</h2>
        <div class="format-doc-content">
          <p><strong>ÈÄöÁî®Ôºö</strong>ÂèØÁõ¥Êé•Á≤òË¥¥ JSON È¢òÁõÆÊï∞ÁªÑÔºåÊàñÊåâ‰∏ãÊñπÊñáÊú¨Ê†ºÂºèÁ≤òË¥¥„ÄÇ</p>
          <p><span class="type-tag">ÂçïÈÄâÈ¢ò single_choice</span></p>
          <pre>{"type":"single_choice","stem":"Nous ______ une lettre.","options":["√©cris","√©crit","√©crivons","√©crivent"],"correct":2,"explanation":"nous Áî® √©crivons„ÄÇ","category":"ËØ≠Ê≥ï"}</pre>
          <p><span class="type-tag">Â§öÈÄâÈ¢ò multiple_choice</span> ‚Äî correct ‰∏∫Ê≠£Á°ÆÈÄâÈ°πÁ¥¢ÂºïÊï∞ÁªÑ„ÄÇ</p>
          <pre>{"type":"multiple_choice","stem":"‰∏ãÂàóÂì™‰∫õÊòØÂ§çÊï∞ÂΩ¢ÂºèÔºü","options":["ils","il","elles","elle"],"correct":[0,2],"explanation":"ils/elles ‰∏∫Â§çÊï∞„ÄÇ"}</pre>
          <p><span class="type-tag">Â°´Á©∫È¢ò fill_blank</span> ‚Äî correct ‰∏∫Á≠îÊ°àÂ≠óÁ¨¶‰∏≤ÊàñÂèØÊé•ÂèóÁ≠îÊ°àÊï∞ÁªÑ„ÄÇ</p>
          <pre>{"type":"fill_blank","stem":"Il _____ (avoir) 20 ans.","correct":["a","a "],"explanation":"avoir Á¨¨‰∏â‰∫∫Áß∞ÂçïÊï∞Âèò‰Ωç‰∏∫ a„ÄÇ"}</pre>
          <p><span class="type-tag">ÊÆµËêΩÂ°´Á©∫È¢ò paragraph_fill_blank</span> ‚Äî È¢òÂπ≤‰∏≠Áî® _____ Ë°®Á§∫Á©∫ÔºåÈ°∫Â∫èÂØπÂ∫î correct Êï∞ÁªÑ„ÄÇ</p>
          <pre>{"type":"paragraph_fill_blank","stem":"Il a _____ ans. Elle _____ (s'appeler) Marie.","correct":["15","s'appelle"],"explanation":"‰∏§Á©∫‰æùÊ¨°Â°´ÂÜô„ÄÇ"}</pre>
          <p><strong>ÊñáÊú¨Ê†ºÂºèÔºàÂçïÈÄâÈ¢òÔºâÔºö</strong>Âê´„ÄåÈ¢òÂûãÔºö„Äç„ÄåA) B) C) D)„Äç„ÄåÊ≠£Á°ÆÔºö„ÄçÂç≥ÂèØËß£Êûê„ÄÇ‰æãÔºö</p>
          <pre>È¢òÂûãÔºöNous ______ une lettre √† nos parents.
A) √©cris  B) √©crit  C) √©crivons  D) √©crivent
Ê≠£Á°ÆÔºöC</pre>
          <p class="format-doc-hint"><strong>ÂàÜÁ±ªÁ≠õÈÄâÔºö</strong>È¢òÁõÆ JSON ‰∏≠ÂèØÂ∏¶ <code>category</code> Â≠óÊÆµÔºàÂ¶Ç <code>"category":"ËØ≠Ê≥ï"</code>ÔºâÔºåÈÄâ‰π†È¢òÈõÜÂêéÂèØÊåâÂàÜÁ±ªÁ≠õÈ¢òÔºõÊó† <code>category</code> Êó∂‰ªÖÊòæÁ§∫„ÄåÂÖ®ÈÉ®„Äç„ÄÇ</p>
        </div>
      </div>
    </div>

    <div id="screen-quiz" class="screen">
      <div class="progress-wrap">
        <span class="progress-estimate" id="progress-estimate"></span>
        <span class="progress-label" id="progress-label">Á¨¨ 1 / 1 È¢ò</span>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
      </div>
      <div class="question-card" role="region" aria-labelledby="question-stem" aria-describedby="question-meta">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.5rem;">
          <div class="question-meta" id="question-meta"></div>
          <div style="display:flex;align-items:center;gap:0.35rem;">
            <svg class="timer-ring" id="timer-ring" width="40" height="40" viewBox="0 0 40 40" style="display:none;">
              <circle cx="20" cy="20" r="17" fill="none" stroke="var(--surface)" stroke-width="3" />
              <circle class="timer-ring-fill" id="timer-ring-fill" cx="20" cy="20" r="17" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="106.81" stroke-dashoffset="0" stroke-linecap="round" transform="rotate(-90 20 20)" />
            </svg>
            <span class="quiz-timer" id="quiz-timer" style="display: none;"></span>
          </div>
        </div>
        <div class="question-stem-wrap">
          <div class="question-stem" id="question-stem"></div>
          <button type="button" class="btn-read-aloud" id="btn-read-aloud" title="ÊúóËØªÈ¢òÂπ≤ÔºàÊ≥ïËØ≠Ôºâ" aria-label="ÊúóËØªÈ¢òÂπ≤ÔºàÊ≥ïËØ≠Ôºâ">üîä ÊúóËØª</button>
        </div>
        <div class="options" id="options-container"></div>
        <div class="fill-input-wrap" id="fill-input-wrap" style="display: none;">
          <input type="text" id="fill-input" placeholder="ËæìÂÖ•Á≠îÊ°à..." autocomplete="off" />
        </div>
        <div class="paragraph-blanks" id="paragraph-blanks-wrap" style="display: none;"></div>
        <div class="answer-feedback" id="answer-feedback"></div>
        <div class="explanation-scroll-wrap" id="explanation-scroll-wrap" style="display: none;">
          <div class="explanation-wrong-count" id="explanation-wrong-count" style="display: none;" aria-live="polite"></div>
          <div class="explanation" id="explanation"></div>
          <div class="explanation-notes-section" id="explanation-notes-section">
            <div class="explanation-notes-display" id="explanation-notes-display" style="display: none;"></div>
            <button type="button" class="btn btn-secondary btn-sm explanation-notes-edit-btn" id="btn-edit-explanation-notes" aria-label="ÁºñËæëÂ§áÊ≥®">ÁºñËæëÂ§áÊ≥®</button>
            <div class="explanation-notes-edit" id="explanation-notes-edit" style="display: none;">
              <textarea id="explanation-notes-textarea" rows="4" placeholder="Âú®Ê≠§Ê∑ªÂä†‰Ω†ÁöÑÂ§áÊ≥®ÔºàÁ∫ØÊñáÊú¨ÔºâÔºåEnter Êç¢Ë°å" class="explanation-notes-textarea"></textarea>
              <div class="explanation-notes-edit-actions">
                <button type="button" class="btn btn-primary btn-sm" id="btn-save-explanation-notes">‰øùÂ≠ò</button>
                <button type="button" class="btn btn-secondary btn-sm" id="btn-cancel-explanation-notes">ÂèñÊ∂à</button>
              </div>
            </div>
          </div>
        </div>
        <div class="wrong-book-remove-wrap" id="wrong-book-remove-wrap" style="display: none;">
          <button type="button" class="btn btn-secondary btn-sm" id="btn-remove-from-wrong">ÁßªÂá∫ÈîôÈ¢òÊú¨</button>
        </div>
        <div class="remove-from-set-wrap" id="remove-from-set-wrap" style="display: none;">
          <button type="button" class="btn btn-secondary btn-sm" id="btn-remove-from-set">‰ªéÁªÉ‰π†ÈõÜÂà†Èô§Êú¨È¢ò</button>
        </div>
      </div>
      <div class="quiz-actions">
        <span id="question-counter"></span>
        <div class="quiz-actions-right">
          <button type="button" class="btn btn-secondary" id="btn-prev-quiz" style="display: none;" aria-label="‰∏ä‰∏ÄÈ¢ò">‰∏ä‰∏ÄÈ¢ò</button>
          <button type="button" class="btn btn-secondary" id="btn-exit-quiz" aria-label="ÊèêÂâçÈÄÄÂá∫ÁªÉ‰π†">ÊèêÂâçÈÄÄÂá∫</button>
          <button type="button" class="btn btn-primary" id="btn-next" style="display: none;" aria-label="‰∏ã‰∏ÄÈ¢ò" aria-keyshortcuts="Enter">‰∏ã‰∏ÄÈ¢ò</button>
          <button type="button" class="btn btn-primary" id="btn-submit" aria-label="Á°ÆËÆ§Á≠îÊ°à" aria-keyshortcuts="Enter">Á°ÆËÆ§</button>
        </div>
      </div>
      <p class="quiz-shortcut-hint" aria-hidden="true">Âø´Êç∑ÈîÆÔºö1‚Äì4 ÈÄâÈÄâÈ°πÔºåEnter Á°ÆËÆ§</p>
    </div>

    <div id="screen-result" class="screen">
      <div class="result-card" id="result-card" aria-live="polite" aria-atomic="true">
        <div class="result-score" id="result-score" role="text">0/0</div>
        <p class="result-pct" id="result-pct"></p>
        <p class="result-desc" id="result-desc">ÂÆåÊàêÁªÉ‰π†</p>
        <p class="result-celebration" id="result-celebration" style="display: none;">üéâ ÂÖ®ÂØπÔºÅ</p>
        <div class="result-confetti" id="result-confetti" aria-hidden="true"></div>
        <div class="result-actions">
          <button type="button" class="btn btn-primary" id="btn-restart" aria-label="ÂÜçÁªÉ‰∏ÄÈÅç">ÂÜçÁªÉ‰∏ÄÈÅç</button>
          <button type="button" class="btn wrong-book-btn" id="btn-result-wrong" aria-label="ÈîôÈ¢òÊú¨ÊåâËÆ°ÂàíÂ§ç‰π†">ÈîôÈ¢òÊú¨¬∑ÊåâËÆ°Âàí</button>
          <button type="button" class="btn btn-secondary" id="btn-result-wrong-free" aria-label="ÈîôÈ¢òËá™Áî±ÁªÉ‰π†">ÈîôÈ¢òËá™Áî±ÁªÉ‰π†</button>
          <button type="button" class="btn btn-secondary" id="btn-share-result" aria-label="ÂàÜ‰∫´ÊàêÁª©">ÂàÜ‰∫´ÊàêÁª©</button>
          <button type="button" class="btn btn-secondary" id="btn-back-home" aria-label="ËøîÂõûÈ¶ñÈ°µ">ËøîÂõûÈ¶ñÈ°µ</button>
        </div>
        <p class="result-shortcut-hint" aria-hidden="true">ÊèêÁ§∫ÔºöÁ≠îÈ¢òÊó∂Êåâ Enter ÂèØ‰∏ã‰∏ÄÈ¢òÔºåEsc ÂÖ≥Èó≠ÂºπÁ™ó</p>
        <div class="result-recent" id="result-recent" style="display: none;"></div>
      </div>
    </div>
    <div id="sr-announcer" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
  </div>

  <div class="review-modal-overlay" id="review-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="review-modal-title">
    <div class="review-modal">
      <h3 id="review-modal-title">ÊòØÂê¶ËßÇÁúãÂ§ç‰π†ÊùêÊñôÔºü</h3>
      <div class="review-modal-body">
        <div class="review-modal-texts-wrap" id="review-modal-texts-wrap">
          <div class="review-modal-texts roll" id="review-modal-texts"></div>
        </div>
        <div class="review-modal-links" id="review-modal-links"></div>
        <div class="review-modal-images" id="review-modal-images"></div>
      </div>
      <div class="review-modal-actions">
        <button type="button" class="btn btn-primary" id="btn-review-start-quiz">Áõ¥Êé•ÂºÄÂßãÁªÉ‰π†</button>
      </div>
    </div>
  </div>

  <div class="start-mode-modal-overlay" id="start-mode-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="start-mode-modal-title" style="display: none;">
    <div class="start-mode-modal">
      <h3 id="start-mode-modal-title">ÈÄâÊã©ÁªÉ‰π†ÊñπÂºè</h3>
      <p class="start-mode-desc">Êú¨È¢òÈõÜÈ¢òÁõÆËæÉÂ§öÔºåÂèØÈÄâÊã©ÁªÉ‰π†ÊñπÂºè‰∏éÊòØÂê¶Êâì‰π±È°∫Â∫è„ÄÇ</p>
      <div class="start-mode-cards">
        <div class="start-mode-card start-mode-card-full">
          <div class="start-mode-card-title">ÁªÉ‰π†ÂÖ®ÈÉ®</div>
          <p class="start-mode-card-hint">‰∏ÄÊ¨°ÂÅöÂÆåÊú¨È¢òÈõÜÂÖ®ÈÉ®È¢òÁõÆ„ÄÇ</p>
          <label class="start-mode-check-wrap">
            <input type="checkbox" id="start-mode-shuffle" checked />
            <span>Êâì‰π±È¢òÁõÆÈ°∫Â∫è</span>
          </label>
          <button type="button" class="btn btn-primary start-mode-card-btn" id="btn-start-mode-full">ÂºÄÂßãÁªÉ‰π†</button>
        </div>
        <div class="start-mode-card start-mode-card-sequential" id="start-mode-sequential">
          <div class="start-mode-card-title">ÊåâÈ°∫Â∫èÁªÉ‰∏ÄÈÉ®ÂàÜ</div>
          <p class="start-mode-card-hint">Ëá™ÈÄâÈ¢òÊï∞ÔºåÊåâÈ°∫Â∫èÂÅöÔºõ‰∏ãÊ¨°‰ªéÂâ©‰ΩôÈ¢òÁõÆÁªßÁª≠„ÄÇ</p>
          <div class="start-mode-sequential-row">
            <input type="number" id="start-mode-count" min="1" value="20" aria-label="È¢òÁõÆÊï∞Èáè" />
            <span class="start-mode-sequential-text">È¢òÔºà‰ªéÁ¨¨ <span id="start-mode-from">1</span> È¢òËµ∑ÔºåÂâ©‰Ωô <span id="start-mode-remain">0</span> È¢òÔºâ</span>
          </div>
          <button type="button" class="btn btn-secondary start-mode-card-btn" id="btn-start-mode-sequential">ÂºÄÂßãÊåâÈ°∫Â∫èÁªÉ‰π†</button>
        </div>
        <div class="start-mode-card start-mode-finished" id="start-mode-finished" style="display: none;">
          <div class="start-mode-card-title">Êú¨Â•óÂ∑≤ÊåâÈ°∫Â∫èÁªÉÂÆå</div>
          <p class="start-mode-card-hint">ÂèØÈáçÁΩÆËøõÂ∫¶ÂêéÈáçÊñ∞ÊåâÈ°∫Â∫èÁªÉÔºåÊàñÁõ¥Êé•ÁªÉ‰π†ÂÖ®ÈÉ®„ÄÇ</p>
          <div class="start-mode-finished-btns">
            <button type="button" class="btn btn-secondary" id="btn-start-mode-reset">ÈáçÁΩÆËøõÂ∫¶</button>
            <button type="button" class="btn btn-primary" id="btn-start-mode-full-after">ÁªÉ‰π†ÂÖ®ÈÉ®</button>
          </div>
        </div>
      </div>
      <div class="start-mode-footer">
        <button type="button" class="btn btn-ghost" id="btn-start-mode-cancel" aria-keyshortcuts="Escape">ÂèñÊ∂à</button>
      </div>
    </div>
  </div>

  <div class="image-lightbox-overlay" id="image-lightbox-overlay" role="dialog" aria-modal="true" aria-label="ÊîæÂ§ßÊü•ÁúãÂõæÁâá">
    <div class="image-lightbox-content">
      <img id="image-lightbox-img" src="" alt="ÊîæÂ§ßÂõæ" />
      <button type="button" class="image-lightbox-close" id="image-lightbox-close" aria-label="ÂÖ≥Èó≠" aria-keyshortcuts="Escape">√ó</button>
    </div>
  </div>

  <div id="toast" class="toast" aria-live="polite" role="status"></div>

  <div class="edit-set-modal-overlay" id="edit-set-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="edit-set-modal-title">
    <div class="edit-set-modal">
      <h3 id="edit-set-modal-title">ÁºñËæë‰π†È¢òÈõÜ</h3>
      <div class="edit-set-field">
        <label for="edit-set-name">‰π†È¢òÈõÜÂêçÁß∞</label>
        <input type="text" id="edit-set-name" placeholder="‰æãÂ¶ÇÔºöavoir Âõ∫ÂÆöË°®Ëææ" autocomplete="off" />
      </div>
      <div class="edit-set-field">
        <label for="edit-set-folder">ÊâÄÂ±ûÊñá‰ª∂Â§π</label>
        <select id="edit-set-folder">
          <option value="">Êú™ÂàÜÁ±ª</option>
        </select>
      </div>
      <div class="edit-set-field">
        <span class="edit-set-review-label">ÁªÉ‰π†ÂâçÂ§ç‰π†ËµÑÊñôÔºàÂèØÈÄâÔºâ</span>
        <div class="edit-set-review-row">
          <label for="edit-set-review-texts">ÊñáÊú¨ÔºàÊØèË°å‰∏ÄÊÆµÔºåÁªÉ‰π†ÂâçÂèØÊªöÂä®Êü•ÁúãÔºâ</label>
          <textarea id="edit-set-review-texts" rows="3" placeholder="Âè£ËØÄ„ÄÅËØ¥ÊòéÁ≠â&#10;ÊØèË°å‰∏ÄÊÆµ" autocomplete="off"></textarea>
        </div>
        <div class="edit-set-review-row">
          <label for="edit-set-review-links">ÈìæÊé•ÔºàÊØèË°å‰∏Ä‰∏™ URLÔºâ</label>
          <textarea id="edit-set-review-links" rows="2" placeholder="https://‚Ä¶" autocomplete="off"></textarea>
        </div>
        <div class="edit-set-paste-images" id="edit-set-paste-images">
          <span class="edit-set-paste-images-hint">ÂõæÁâáÔºöÁÇπÂáª‰∏ãÊñπÂå∫ÂüüÂêé Ctrl+V / Cmd+V Á≤òË¥¥</span>
          <div class="edit-set-paste-zone" id="edit-set-paste-zone" tabindex="0" role="button" aria-label="ÁÇπÂáªÂêéÊåâ Ctrl+V Êàñ Cmd+V Á≤òË¥¥ÂõæÁâá">Á≤òË¥¥ÂõæÁâáÂà∞Ê≠§Â§Ñ</div>
          <div class="edit-set-pasted-list" id="edit-set-pasted-list"></div>
        </div>
      </div>
      <div class="edit-set-meta" id="edit-set-meta"></div>
      <div class="edit-set-field edit-set-append">
        <label for="edit-set-append-text">ËøΩÂä†È¢òÁõÆÔºàÁ≤òË¥¥ JSON Êï∞ÁªÑÊàñÊñáÊú¨Ê†ºÂºèÔºå‰ºöËøΩÂä†Âà∞Êú¨È¢òÈõÜÊú´Â∞æÔºâ</label>
        <textarea id="edit-set-append-text" rows="4" placeholder="[{&quot;type&quot;:&quot;single_choice&quot;, ...}, ...] Êàñ È¢òÂûãÔºö... A) B) C) D) Ê≠£Á°ÆÔºöC" autocomplete="off"></textarea>
        <button type="button" class="btn btn-secondary btn-sm" id="btn-edit-set-append">Ëß£ÊûêÂπ∂ËøΩÂä†</button>
      </div>
      <div class="edit-set-actions">
        <button type="button" class="btn btn-primary" id="btn-edit-set-save">‰øùÂ≠ò</button>
        <button type="button" class="btn btn-secondary" id="btn-edit-set-cancel" aria-keyshortcuts="Escape">ÂèñÊ∂à</button>
      </div>
      <div class="edit-set-extra">
        <button type="button" class="btn btn-link" id="btn-edit-set-export">ÂØºÂá∫Êú¨È¢òÈõÜ (JSON)</button>
        <span class="edit-set-sep">¬∑</span>
        <button type="button" class="btn btn-link" id="btn-edit-set-preview" aria-haspopup="dialog">È¢ÑËßà‰π†È¢ò</button>
        <span class="edit-set-sep">¬∑</span>
        <button type="button" class="btn btn-link-danger" id="btn-edit-set-delete">Âà†Èô§Êú¨‰π†È¢òÈõÜ</button>
      </div>
    </div>
  </div>

  <div class="preview-questions-overlay" id="preview-questions-overlay" role="dialog" aria-modal="true" aria-labelledby="preview-questions-title">
    <div class="preview-questions-modal">
      <h3 id="preview-questions-title">‰π†È¢òÈ¢ÑËßà</h3>
      <div class="preview-questions-body" id="preview-questions-body"></div>
      <div class="preview-questions-actions">
        <button type="button" class="btn btn-primary" id="btn-preview-questions-close" aria-keyshortcuts="Escape">ÂÖ≥Èó≠</button>
      </div>
    </div>
  </div>

  <script>
    if (typeof performance !== 'undefined' && performance.mark) performance.mark('app-start');
    const LETTERS = ['A', 'B', 'C', 'D'];
    const WRONG_BOOK_KEY = 'french_quiz_wrong';
    const SAVED_SETS_KEY = 'french_quiz_saved_sets';
    const FOLDERS_KEY = 'french_quiz_folders';
    const FOLDER_COLLAPSED_KEY = 'french_quiz_folder_collapsed';
    const TIMER_SECONDS_KEY = 'french_quiz_timer_seconds';
    const DAILY_STATS_KEY = 'french_quiz_daily_stats';
    const RECENT_SESSIONS_KEY = 'french_quiz_recent_sessions';
    const QUESTION_NOTES_KEY = 'french_quiz_question_notes';
    const THEME_KEY = 'french_quiz_theme';
    const DATA_FILE_NAME = 'french_quiz_data.json';
    const IMPORT_PIN_HASH_KEY = 'french_quiz_import_pin_hash';
    const IMPORT_ALLOWED_FINGERPRINT_KEY = 'french_quiz_import_allowed_device';
    const RECENT_SESSIONS_MAX = 10;
    const SAVED_SETS_DISPLAY_LIMIT = 30;
    const SEQUENTIAL_MODE_THRESHOLD = 16;
    const SCREEN = { HOME: 'screen-home', QUIZ: 'screen-quiz', RESULT: 'screen-result' };

    const QUIZ_PROGRESS_KEY = 'french_quiz_progress';

    let projectFolderHandle = null;
    let _savedSetsCache = null;
    let _savedSetsCacheDirty = true;
    let _wrongBookCache = null;
    let _wrongBookCacheDirty = true;
    const _escapeDiv = document.createElement('div');
    const _wrongBookIdCache = new WeakMap();
    let _modalLastFocus = null;
    let _openModalOverlay = null;
    let _savedSetsDisplayLimit = SAVED_SETS_DISPLAY_LIMIT;
    let _currentQuestionIdForNotes = null;

    async function hashPin(pin) {
      const enc = new TextEncoder();
      const data = enc.encode(String(pin));
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    function isImportLockEnabled() { return !!localStorage.getItem(IMPORT_PIN_HASH_KEY); }
    async function setImportPin(pin) { localStorage.setItem(IMPORT_PIN_HASH_KEY, await hashPin(pin)); }
    async function verifyImportPin(pin) { return (await hashPin(pin)) === localStorage.getItem(IMPORT_PIN_HASH_KEY); }
    function computeFingerprint() {
      const parts = [
        navigator.userAgent || '',
        (screen && (screen.width + 'x' + screen.height)) || '',
        new Date().getTimezoneOffset(),
        navigator.language || '',
        (navigator.hardwareConcurrency || '') + ''
      ].join('|');
      let h = 0;
      for (let i = 0; i < parts.length; i++) h = ((h << 5) - h) + parts.charCodeAt(i) | 0;
      return (h >>> 0).toString(36);
    }
    function getImportAllowedFingerprint() { return localStorage.getItem(IMPORT_ALLOWED_FINGERPRINT_KEY) || ''; }
    function setImportAllowedFingerprintToThisDevice() { localStorage.setItem(IMPORT_ALLOWED_FINGERPRINT_KEY, computeFingerprint()); }
    function canImportOnThisDevice() {
      const allowed = getImportAllowedFingerprint();
      if (!allowed) return true;
      return computeFingerprint() === allowed;
    }
    async function checkImportPin() {
      if (!canImportOnThisDevice()) {
        showToast('‰ªÖÂÖÅËÆ∏Âú®Â∑≤ÁªëÂÆöÁöÑÁîµËÑë‰∏äÂØºÂÖ•ÔºåÂΩìÂâçËÆæÂ§áÊú™ÁªëÂÆö');
        return false;
      }
      if (!isImportLockEnabled()) return true;
      const pin = prompt('ËØ∑ËæìÂÖ•‰∏ª‰∫∫ PIN ‰ª•ÁªßÁª≠ÂØºÂÖ•');
      if (pin === null) return false;
      const ok = await verifyImportPin(pin);
      if (!ok) showToast('PIN ÈîôËØØ');
      return ok;
    }
    function updateImportLockUI() {
      const statusText = document.getElementById('import-lock-status-text');
      const setBtn = document.getElementById('btn-import-lock-set');
      const changeBtn = document.getElementById('btn-import-lock-change');
      const disableBtn = document.getElementById('btn-import-lock-disable');
      if (!statusText) return;
      if (isImportLockEnabled()) {
        statusText.textContent = 'Â∑≤ÂêØÁî®';
        if (setBtn) setBtn.style.display = 'none';
        if (changeBtn) changeBtn.style.display = 'inline-flex';
        if (disableBtn) disableBtn.style.display = 'inline-flex';
      } else {
        statusText.textContent = 'Êú™ÂêØÁî®';
        if (setBtn) setBtn.style.display = 'inline-flex';
        if (changeBtn) changeBtn.style.display = 'none';
        if (disableBtn) disableBtn.style.display = 'none';
      }
    }
    function updateDeviceBindUI() {
      const statusText = document.getElementById('device-bind-status-text');
      const bindBtn = document.getElementById('btn-device-bind');
      const unbindBtn = document.getElementById('btn-device-unbind');
      if (!statusText) return;
      const allowed = getImportAllowedFingerprint();
      const isThisDevice = allowed && computeFingerprint() === allowed;
      if (allowed) {
        statusText.textContent = isThisDevice ? 'Â∑≤ÁªëÂÆöÊú¨Êú∫Ôºà‰ªÖÊú¨Êú∫ÂèØÂØºÂÖ•Ôºâ' : 'Â∑≤ÁªëÂÆöÂÖ∂‰ªñËÆæÂ§áÔºàÂΩìÂâçËÆæÂ§á‰∏çÂèØÂØºÂÖ•Ôºâ';
        if (bindBtn) bindBtn.style.display = 'none';
        if (unbindBtn) unbindBtn.style.display = isThisDevice ? 'inline-flex' : 'none';
      } else {
        statusText.textContent = 'Êú™ÁªëÂÆö';
        if (bindBtn) bindBtn.style.display = 'inline-flex';
        if (unbindBtn) unbindBtn.style.display = 'none';
      }
    }

    function getFocusableIn(container) {
      if (!container) return [];
      const nodes = container.querySelectorAll('button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');
      return Array.prototype.filter.call(nodes, function(el) { return el.offsetParent != null; });
    }
    function setModalFocusTrap(overlayEl) {
      _openModalOverlay = overlayEl;
      _modalLastFocus = document.activeElement;
      var focusable = getFocusableIn(overlayEl);
      if (focusable.length) requestAnimationFrame(function() { focusable[0].focus(); });
    }
    function clearModalFocusTrap() {
      if (_modalLastFocus && typeof _modalLastFocus.focus === 'function') _modalLastFocus.focus();
      _modalLastFocus = null;
      _openModalOverlay = null;
    }

    function getRecentSessions() {
      try {
        const raw = localStorage.getItem(RECENT_SESSIONS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr.slice(-RECENT_SESSIONS_MAX) : [];
      } catch (_) { return []; }
    }
    function pushRecentSession(total, score) {
      const sessions = getRecentSessions();
      sessions.push({ total, score, at: new Date().toISOString() });
      localStorage.setItem(RECENT_SESSIONS_KEY, JSON.stringify(sessions.slice(-RECENT_SESSIONS_MAX)));
    }

    function saveQuizProgress() {
      try {
        sessionStorage.setItem(QUIZ_PROGRESS_KEY, JSON.stringify({
          questions: state.questions, index: state.index, score: state.score,
          timerSeconds: state.timerSeconds, practicingWrongBook: state.practicingWrongBook,
          practicedSetId: state.practicedSetId, savedAt: Date.now()
        }));
      } catch (_) {}
    }
    function clearQuizProgress() { try { sessionStorage.removeItem(QUIZ_PROGRESS_KEY); } catch (_) {} }
    function getQuizProgress() {
      try {
        const raw = sessionStorage.getItem(QUIZ_PROGRESS_KEY);
        if (!raw) return null;
        const p = JSON.parse(raw);
        if (Date.now() - p.savedAt > 2 * 60 * 60 * 1000) { clearQuizProgress(); return null; }
        return p;
      } catch (_) { return null; }
    }

    function getDailyStats() {
      try {
        const raw = localStorage.getItem(DAILY_STATS_KEY);
        const data = raw ? JSON.parse(raw) : {};
        const today = new Date().toISOString().slice(0, 10);
        const yesterday = new Date(Date.now() - 864e5).toISOString().slice(0, 10);
        if (data.date !== today) {
          return {
            date: today,
            todayCount: 0,
            lastDate: data.lastDate || data.date,
            streak: data.streak || 0
          };
        }
        return {
          date: today,
          todayCount: data.todayCount || 0,
          lastDate: data.lastDate || data.date,
          streak: data.streak || 0
        };
      } catch (_) { return { date: new Date().toISOString().slice(0, 10), todayCount: 0, lastDate: null, streak: 0 }; }
    }
    function addTodayPractice(n) {
      const raw = localStorage.getItem(DAILY_STATS_KEY);
      const data = raw ? JSON.parse(raw) : {};
      const today = new Date().toISOString().slice(0, 10);
      const yesterday = new Date(Date.now() - 864e5).toISOString().slice(0, 10);
      let streak = data.streak || 0;
      let todayCount = data.todayCount || 0;
      if (data.date === today) {
        todayCount += (n || 0);
      } else {
        todayCount = n || 0;
        const prevDate = data.lastDate || data.date;
        if (prevDate === yesterday) streak += 1;
        else if (prevDate !== today) streak = 1;
      }
      const st = { date: today, todayCount, lastDate: today, streak };
      localStorage.setItem(DAILY_STATS_KEY, JSON.stringify(st));
      updateStatsBar();
    }
    function animateStatChange(el, newValue) {
      if (!el) return;
      const oldText = el.textContent;
      el.textContent = newValue;
      if (oldText !== String(newValue)) {
        el.classList.remove('updated');
        void el.offsetWidth;
        el.classList.add('updated');
      }
    }
    function updateStatsBar() {
      const st = getDailyStats();
      const elToday = document.getElementById('stat-today');
      const elWrong = document.getElementById('stat-wrong');
      const elSets = document.getElementById('stat-sets');
      const elStreak = document.getElementById('stat-streak');
      animateStatChange(elToday, st.todayCount || 0);
      animateStatChange(elWrong, getWrongBook().length);
      animateStatChange(elSets, getSavedSets().length);
      animateStatChange(elStreak, st.streak || 0);
    }
    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function normalizeFrench(str) {
      return str
        .trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/\u0153/g, 'oe')
        .replace(/\u00e6/g, 'ae')
        .replace(/\s+/g, ' ');
    }
    function matchFrenchAnswer(val, acceptList) {
      return acceptList.some(c => c === val) || acceptList.some(c => normalizeFrench(c) === normalizeFrench(val));
    }

    /**
     * Âà§È¢òÁ∫ØÂáΩÊï∞Ôºö‰∏çËØª DOM„ÄÅ‰∏çÂÜôÂ≠òÂÇ®Ôºå‰ªÖÊ†πÊçÆÈ¢òÁõÆÂíåÁî®Êà∑Á≠îÊ°àËøîÂõûÂØπÈîôÔºàÂèäÂ°´Á©∫ÁöÑ detailsÔºâ„ÄÇ
     * Áî®‰∫éÂèØÊµãËØïÊÄß‰∏éÂêéÁª≠È¢òÂûãÊâ©Â±ïÔºõsubmitAnswer ‰∏≠Êî∂ÈõÜ DOM Á≠îÊ°àÂêéË∞ÉÁî®Ê≠§ÂáΩÊï∞„ÄÇ
     */
    function evaluateAnswer(q, userAnswer) {
      if (q.type === 'single_choice') {
        const correctIndex = Array.isArray(q.correct) ? q.correct[0] : q.correct;
        return { correct: userAnswer.single === correctIndex };
      }
      if (q.type === 'multiple_choice') {
        const correctSet = new Set(Array.isArray(q.correct) ? q.correct : [q.correct]);
        const selected = new Set(Array.isArray(userAnswer.multiple) ? userAnswer.multiple : []);
        const correct = selected.size === correctSet.size && [...selected].every(i => correctSet.has(i));
        return { correct };
      }
      if (q.type === 'fill_blank') {
        const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
        const blankCount = (q.stem.match(/_____/g) || []).length;
        if (blankCount >= 2 && (userAnswer.paragraph || []).length >= 2) {
          const answers = userAnswer.paragraph.slice(0, correctArr.length);
          const details = answers.map((val, i) => {
            const accept = (Array.isArray(correctArr[i]) ? correctArr[i] : [correctArr[i]]).map(c => String(c).toLowerCase().trim());
            return { ok: matchFrenchAnswer(val.trim().toLowerCase(), accept), val, accept };
          });
          return { correct: details.every(d => d.ok), details };
        }
        const val = (userAnswer.fill || '').trim().toLowerCase();
        const accept = correctArr.map(c => String(c).toLowerCase().trim());
        return { correct: matchFrenchAnswer(val, accept) };
      }
      if (q.type === 'paragraph_fill_blank') {
        const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
        const inputs = userAnswer.paragraph || [];
        const len = Math.min(correctArr.length, inputs.length);
        const details = [];
        let correct = true;
        for (let i = 0; i < len; i++) {
          const val = (inputs[i] || '').trim().toLowerCase();
          const accept = (Array.isArray(correctArr[i]) ? correctArr[i] : [correctArr[i]]).map(c => String(c).toLowerCase().trim());
          const ok = matchFrenchAnswer(val, accept);
          details.push({ ok, val, accept });
          if (!ok) correct = false;
        }
        for (let i = len; i < correctArr.length; i++) details.push({ ok: false, val: '', accept: [] });
        return { correct, details };
      }
      return { correct: false };
    }

    const QUESTION_TYPES = { single_choice: 'ÂçïÈÄâ', multiple_choice: 'Â§öÈÄâ', fill_blank: 'Â°´Á©∫', paragraph_fill_blank: 'ÊÆµËêΩÂ°´Á©∫' };
    function getSelectedTypeFilter() {
      const single = document.getElementById('filter-type-single');
      const multiple = document.getElementById('filter-type-multiple');
      const fill = document.getElementById('filter-type-fill');
      const paragraph = document.getElementById('filter-type-paragraph');
      const types = [];
      if (single && single.checked) types.push('single_choice');
      if (multiple && multiple.checked) types.push('multiple_choice');
      if (fill && fill.checked) types.push('fill_blank');
      if (paragraph && paragraph.checked) types.push('paragraph_fill_blank');
      return types.length === 0 ? null : types;
    }
    function filterQuestionsByType(questions, typeFilter) {
      if (!questions || !typeFilter || typeFilter.length === 0) return questions || [];
      return questions.filter(q => q && typeFilter.includes(q.type));
    }
    function shuffleQuestionOptions(q) {
      if (!q || (q.type !== 'single_choice' && q.type !== 'multiple_choice') || !q.options || !q.options.length) return q;
      const perm = shuffleArray(q.options.map((_, i) => i));
      const newOptions = perm.map(i => q.options[i]);
      const oldCorrect = Array.isArray(q.correct) ? q.correct : [q.correct];
      const newCorrect = q.type === 'single_choice'
        ? perm.indexOf(oldCorrect[0])
        : oldCorrect.map(c => perm.indexOf(c)).sort((a, b) => a - b);
      return Object.assign({}, q, { options: newOptions, correct: newCorrect });
    }

    function getDataForExport() {
      const timerEl = document.getElementById('timer-seconds');
      let questionNotes = {};
      try {
        const raw = localStorage.getItem(QUESTION_NOTES_KEY);
        if (raw) questionNotes = JSON.parse(raw);
      } catch (_) {}
      const out = {
        savedSets: getSavedSets(),
        folders: getFolders(),
        wrongBook: getWrongBook(),
        questionNotes: questionNotes,
        timerSeconds: timerEl ? Math.max(0, parseInt(timerEl.value, 10) || 10) : 10,
        dailyStats: getDailyStats(),
        exportedAt: new Date().toISOString()
      };
      const fp = getImportAllowedFingerprint();
      if (fp) out.importAllowedDeviceFingerprint = fp;
      return out;
    }
    function sanitizeImportedData(data) {
      if (!data || typeof data !== 'object') return {};
      const DANGEROUS_KEYS = ['__proto__', 'constructor', 'prototype'];
      function stripDangerousKeys(val) {
        if (val === null || typeof val !== 'object') return val;
        if (Array.isArray(val)) return val.map(stripDangerousKeys);
        const out = {};
        for (const k of Object.keys(val)) {
          if (DANGEROUS_KEYS.includes(k)) continue;
          out[k] = stripDangerousKeys(val[k]);
        }
        return out;
      }
      return stripDangerousKeys(data);
    }
    function loadDataFromObject(data) {
      const safe = sanitizeImportedData(data);
      if (safe.savedSets != null) setSavedSets(Array.isArray(safe.savedSets) ? safe.savedSets : []);
      if (safe.folders != null) setFolders(Array.isArray(safe.folders) ? safe.folders : []);
      if (safe.wrongBook != null) setWrongBook(Array.isArray(safe.wrongBook) ? safe.wrongBook : []);
      if (safe.questionNotes != null && typeof safe.questionNotes === 'object') {
        try {
          localStorage.setItem(QUESTION_NOTES_KEY, JSON.stringify(safe.questionNotes));
        } catch (_) {}
      }
      if (safe.timerSeconds != null) {
        const n = Math.max(0, Math.min(120, parseInt(safe.timerSeconds, 10) || 10));
        const el = document.getElementById('timer-seconds');
        if (el) { el.value = n; localStorage.setItem(TIMER_SECONDS_KEY, String(n)); }
      }
      if (safe.dailyStats != null && safe.dailyStats && safe.dailyStats.date) {
        try {
          localStorage.setItem(DAILY_STATS_KEY, JSON.stringify({
            date: safe.dailyStats.date,
            todayCount: safe.dailyStats.todayCount || 0,
            lastDate: safe.dailyStats.lastDate || safe.dailyStats.date,
            streak: safe.dailyStats.streak || 0
          }));
        } catch (_) {}
        updateStatsBar();
      }
      if (safe.importAllowedDeviceFingerprint != null && String(safe.importAllowedDeviceFingerprint)) {
        localStorage.setItem(IMPORT_ALLOWED_FINGERPRINT_KEY, String(safe.importAllowedDeviceFingerprint));
      } else {
        localStorage.removeItem(IMPORT_ALLOWED_FINGERPRINT_KEY);
      }
      updateImportLockUI();
      updateDeviceBindUI();
      updateWrongCount();
      renderSavedSets();
      updateStartPracticeSelect();
    }
    async function loadFromCloud() {
      let url = DATA_FILE_NAME;
      if (typeof location !== 'undefined' && location.origin) {
        const dir = location.pathname.replace(/\/[^/]*$/, '') || '/';
        const base = dir.endsWith('/') ? dir : dir + '/';
        url = location.origin + base + DATA_FILE_NAME;
      }
      const btn = document.getElementById('btn-load-cloud');
      if (btn) { btn.disabled = true; btn.textContent = 'Âä†ËΩΩ‰∏≠‚Ä¶'; }
      try {
        const res = await fetch(url + '?t=' + Date.now());
        if (!res.ok) throw new Error(res.status === 404 ? 'Êú™ÊâæÂà∞‰∫ëÁ´ØÊï∞ÊçÆ' : 'ËØ∑Ê±ÇÂ§±Ë¥•');
        const data = await res.json();
        if (!data || (data.savedSets == null && data.wrongBook == null)) throw new Error('Êï∞ÊçÆÊ†ºÂºèÊó†Êïà');
        if (!confirm('‰∫ëÁ´ØÊï∞ÊçÆÂ∞ÜË¶ÜÁõñÂΩìÂâçÊú¨Âú∞ÁöÑ‰π†È¢òÈõÜ„ÄÅÊñá‰ª∂Â§πÂíåÈîôÈ¢òÊú¨„ÄÇÁ°ÆÂÆöË¶ÅÂä†ËΩΩÂπ∂Ë¶ÜÁõñÂêóÔºü')) return;
        loadDataFromObject(data);
        const setCount = data.savedSets && data.savedSets.length ? data.savedSets.length : 0;
        const wrongCount = data.wrongBook && data.wrongBook.length ? data.wrongBook.length : 0;
        showToast('Â∑≤Âä†ËΩΩ' + (setCount ? ' ' + setCount + ' Â•ó‰π†È¢òÈõÜ' : '') + (wrongCount ? 'Ôºå' + wrongCount + ' ÈÅìÈîôÈ¢ò' : ''));
      } catch (e) {
        showToast('Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÁ®çÂêéÂÜçËØï„ÄÇËã•‰ªçÂ§±Ë¥•ÂèØÂ∞ùËØï„Äå‰ªéÊñá‰ª∂ÂØºÂÖ•„Äç');
      }
      if (btn) { btn.disabled = false; btn.textContent = '‰ªé‰∫ëÁ´ØÂä†ËΩΩÔºàÊâãÊú∫ÂêåÊ≠•‰π†È¢òÈõÜÔºâ'; }
    }
    async function pickFolderAndLoad() {
      if (!('showDirectoryPicker' in window)) {
        alert('ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅÈÄâÊã©Êñá‰ª∂Â§πÔºåËØ∑Áî® Chrome Êàñ EdgeÔºåÊàñ‰ΩøÁî®‰∏ãÊñπ„Äå‰ªéÊñá‰ª∂ÂØºÂÖ•Êï∞ÊçÆ„ÄçÈÄâÊã© JSON Êñá‰ª∂„ÄÇ');
        return;
      }
      const btn = document.getElementById('btn-open-folder');
      const titleEl = btn && btn.querySelector('.title');
      const origTitle = titleEl ? titleEl.textContent : '';
      try {
        const handle = await window.showDirectoryPicker();
        projectFolderHandle = handle;
        let fileHandle = await handle.getFileHandle(DATA_FILE_NAME, { create: false }).catch(() => null);
        if (!fileHandle) {
          fileHandle = await handle.getFileHandle(DATA_FILE_NAME, { create: true });
          const writable = await fileHandle.createWritable();
          const empty = { savedSets: [], folders: [], wrongBook: [], timerSeconds: 10 };
          await writable.write(JSON.stringify(empty, null, 2));
          await writable.close();
          loadDataFromObject(empty);
          showToast('Â∑≤ÂàõÂª∫Âπ∂Âä†ËΩΩÁ©∫Êï∞ÊçÆ');
          return;
        }
        if (btn) { btn.disabled = true; if (titleEl) titleEl.textContent = 'Âä†ËΩΩ‰∏≠‚Ä¶'; }
        const file = await fileHandle.getFile();
        const text = await file.text();
        const data = JSON.parse(text);
        loadDataFromObject(data);
        showToast('Â∑≤‰ªéÈ°πÁõÆÊñá‰ª∂Â§πÂä†ËΩΩÊï∞ÊçÆ');
      } catch (e) {
        if (e.name === 'AbortError') return;
        console.error(e);
        showToast('Âä†ËΩΩÂ§±Ë¥•Ôºö' + (e.message || String(e)));
      } finally {
        if (btn) { btn.disabled = false; if (titleEl) titleEl.textContent = origTitle; }
      }
    }
    async function saveToProjectFolder() {
      if (!projectFolderHandle) {
        if (!('showDirectoryPicker' in window)) {
          alert('ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅ„ÄÇËØ∑Áî® Chrome/Edge ÈÄâÊã©Êñá‰ª∂Â§πÔºåÊàñ‰ΩøÁî®„ÄåÂØºÂá∫Êï∞ÊçÆ„Äç‰∏ãËΩΩ JSON ÂêéÊâãÂä®ÊîæÂà∞ french-quiz Êñá‰ª∂Â§π„ÄÇ');
          return;
        }
        try {
          projectFolderHandle = await window.showDirectoryPicker();
        } catch (e) {
          if (e.name === 'AbortError') return;
          throw e;
        }
      }
      const btn = document.getElementById('btn-one-save');
      if (btn) { btn.disabled = true; btn.textContent = '‰øùÂ≠ò‰∏≠‚Ä¶'; }
      if (typeof performance !== 'undefined' && performance.mark) performance.mark('save-start');
      try {
        const fileHandle = await projectFolderHandle.getFileHandle(DATA_FILE_NAME, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(getDataForExport(), null, 2));
        await writable.close();
        if (typeof performance !== 'undefined' && performance.mark) {
          performance.mark('save-end');
          try { performance.measure('save-to-folder', 'save-start', 'save-end'); } catch (_) {}
        }
        const tipEl = document.getElementById('save-success-tip');
        if (tipEl) {
          tipEl.style.display = 'block';
          tipEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        showToast('Â∑≤‰øùÂ≠ò');
      } catch (e) {
        console.error(e);
        showToast('‰øùÂ≠òÂ§±Ë¥•Ôºö' + (e.message || String(e)));
        projectFolderHandle = null;
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = '‰∏ÄÈîÆ‰øùÂ≠òÔºàË¶ÜÁõñÂà∞È°πÁõÆÊñá‰ª∂Â§πÔºâ'; }
      }
    }
    function exportDataDownload() {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([JSON.stringify(getDataForExport(), null, 2)], { type: 'application/json' }));
      a.download = DATA_FILE_NAME;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function importDataFromFile(file) {
      const btn = document.getElementById('btn-import-data');
      const titleEl = btn && btn.querySelector('.title');
      const origTitle = titleEl ? titleEl.textContent : '';
      if (btn) { btn.disabled = true; if (titleEl) titleEl.textContent = 'ÂØºÂÖ•‰∏≠‚Ä¶'; }
      const fr = new FileReader();
      fr.onload = () => {
        try {
          const data = JSON.parse(fr.result);
          loadDataFromObject(data);
          showToast('Â∑≤‰ªéÊñá‰ª∂ÂØºÂÖ•Êï∞ÊçÆ');
        } catch (e) {
          showToast('Êñá‰ª∂Ê†ºÂºèÈîôËØØÔºåËØ∑Á°ÆËÆ§ÊòØÊúâÊïàÁöÑ JSONÔºö' + (e.message || String(e)));
        } finally {
          if (btn) { btn.disabled = false; if (titleEl) titleEl.textContent = origTitle; }
        }
      };
      fr.onerror = () => {
        showToast('Êñá‰ª∂ËØªÂèñÂ§±Ë¥•');
        if (btn) { btn.disabled = false; if (titleEl) titleEl.textContent = origTitle; }
      };
      fr.readAsText(file);
    }

    function getSavedSets() {
      if (!_savedSetsCacheDirty && _savedSetsCache !== null) return _savedSetsCache;
      try {
        const raw = localStorage.getItem(SAVED_SETS_KEY);
        _savedSetsCache = raw ? JSON.parse(raw) : [];
        _savedSetsCacheDirty = false;
        return _savedSetsCache;
      } catch (_) { return []; }
    }
    function setSavedSets(arr) {
      _savedSetsCache = arr;
      _savedSetsCacheDirty = false;
      localStorage.setItem(SAVED_SETS_KEY, JSON.stringify(arr));
      renderSavedSets();
      updateStatsBar();
      updateStartPracticeSelect();
    }
    function getFolders() {
      try {
        const raw = localStorage.getItem(FOLDERS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch (_) { return []; }
    }
    function setFolders(arr) {
      const list = Array.isArray(arr) ? arr : [];
      localStorage.setItem(FOLDERS_KEY, JSON.stringify(list));
      renderSavedSets();
      updateStartPracticeSelect();
      renderFolderSelects();
    }
    function renderFolderSelects() {
      const folders = getFolders();
      const opts = '<option value="">Êú™ÂàÜÁ±ª</option>' + folders.map(f => '<option value="' + escapeAttr(String(f.id)) + '">' + escapeHtml(f.name) + '</option>').join('');
      const editSel = document.getElementById('edit-set-folder');
      if (editSel) { editSel.innerHTML = opts; }
      const importSel = document.getElementById('import-set-folder');
      if (importSel) { importSel.innerHTML = opts; }
    }
    function removeCurrentQuestionFromSet() {
      if (!state.practicedSetId) return;
      const q = state.questions[state.index];
      if (!q) return;
      const sets = getSavedSets();
      const setId = String(state.practicedSetId);
      const set = sets.find(s => String(s.id) === setId);
      if (!set || !set.questions) return;
      const currentId = wrongBookItemId(q);
      const newQuestions = set.questions.filter(qq => wrongBookItemId(qq) !== currentId);
      if (newQuestions.length === set.questions.length) return;
      const updated = sets.map(s => String(s.id) === setId ? Object.assign({}, s, { questions: newQuestions }) : s);
      setSavedSets(updated);
      state.questions.splice(state.index, 1);
      if (state.questions.length === 0) {
        showResult();
        return;
      }
      if (state.index >= state.questions.length) state.index = state.questions.length - 1;
      renderQuestion();
    }
    function updateStartPracticeSelect() {
      const sel = document.getElementById('start-practice-select');
      if (!sel) return;
      const saved = getSavedSets();
      const folders = getFolders();
      const folderIds = new Set(folders.map(f => String(f.id)));
      let html = '<option value="default">ÈªòËÆ§È¢òÁõÆ</option>';
      folders.forEach(f => {
        const inFolder = saved.filter(s => String(s.folderId || '') === String(f.id));
        if (inFolder.length === 0) return;
        html += '<optgroup label="' + escapeHtml(f.name) + '">' +
          inFolder.map(s => '<option value="' + escapeAttr(String(s.id)) + '">' + escapeHtml(s.name) + ' (' + s.questions.length + ' È¢ò)</option>').join('') + '</optgroup>';
      });
      const uncategorized = saved.filter(s => !s.folderId || !folderIds.has(String(s.folderId)));
      if (uncategorized.length > 0) {
        html += '<optgroup label="Êú™ÂàÜÁ±ª">' +
          uncategorized.map(s => '<option value="' + escapeAttr(String(s.id)) + '">' + escapeHtml(s.name) + ' (' + s.questions.length + ' È¢ò)</option>').join('') + '</optgroup>';
      }
      const currentVal = sel.value;
      sel.innerHTML = html;
      if (currentVal && (currentVal === 'default' || saved.some(s => String(s.id) === currentVal))) sel.value = currentVal;
    }
    function formatSavedSetDate(iso) {
      const d = new Date(iso);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const h = String(d.getHours()).padStart(2, '0');
      const min = String(d.getMinutes()).padStart(2, '0');
      return y + '-' + m + '-' + day + ' ' + h + ':' + min;
    }
    function renderSavedSets() {
      const sets = getSavedSets();
      const folders = getFolders();
      const folderIds = new Set(folders.map(f => String(f.id)));
      const searchEl = document.getElementById('saved-sets-search');
      const query = (searchEl && searchEl.value ? searchEl.value : '').trim().toLowerCase();
      const filtered = query ? sets.filter(s => (s.name || '').toLowerCase().includes(query)) : sets;
      const listEl = document.getElementById('saved-sets-list');
      const emptyEl = document.getElementById('saved-sets-empty');
      const tagsEl = document.getElementById('saved-sets-folder-tags');
      if (!listEl || !emptyEl) return;
      renderFolderTags();
      function itemHtml(s) {
        const count = s.practiceCount || 0;
        const lastStr = s.lastPracticedAt ? 'ÊúÄËøë ' + formatSavedSetDate(s.lastPracticedAt) : 'Êú™ÁªÉ‰π†';
        return '<li class="saved-sets-item" data-id="' + escapeAttr(String(s.id)) + '">' +
          '<div class="saved-sets-item-content">' +
          '<span class="name">' + escapeHtml(s.name) + '</span>' +
          '<div class="meta">' +
          '<span>' + escapeHtml(formatSavedSetDate(s.createdAt)) + '</span><span class="dot">¬∑</span><span>' + s.questions.length + ' È¢ò</span><span class="dot">¬∑</span><span>ÁªÉ‰π† ' + count + ' Ê¨°</span><span class="dot">¬∑</span><span>' + lastStr + '</span>' +
          '</div></div>' +
          '<div class="actions"><button type="button" class="btn btn-primary" data-action="start" aria-haspopup="dialog">ÂºÄÂßã</button><button type="button" class="btn btn-secondary" data-action="edit" aria-haspopup="dialog">ÁºñËæë</button></div>' +
          '</li>';
      }
      if (filtered.length === 0) {
        listEl.innerHTML = '';
        emptyEl.style.display = 'block';
        emptyEl.textContent = query ? 'Ê≤°ÊúâÂåπÈÖçÁöÑ‰π†È¢òÈõÜ' : 'ËøòÊ≤°Êúâ‰π†È¢òÈõÜÔºåÂéª„ÄåÂºÄÂßãÁªÉ‰π†„ÄçÈáåÁ≤òË¥¥È¢òÁõÆÂπ∂Â°´ÂÜôÂêçÁß∞ÔºåÂç≥ÂèØ‰øùÂ≠òÂà∞ËøôÈáå„ÄÇ';
        return;
      }
      emptyEl.style.display = 'none';
      if (query) _savedSetsDisplayLimit = SAVED_SETS_DISPLAY_LIMIT;
      const orderedSets = [];
      folders.forEach(f => {
        orderedSets.push(...filtered.filter(s => String(s.folderId || '') === String(f.id)));
      });
      orderedSets.push(...filtered.filter(s => !s.folderId || !folderIds.has(String(s.folderId))));
      const limit = _savedSetsDisplayLimit;
      const toShow = orderedSets.slice(0, limit);
      const toShowSet = new Set(toShow.map(s => String(s.id)));
      const hasMore = orderedSets.length > limit;
      let collapsedState = {};
      try {
        const raw = localStorage.getItem(FOLDER_COLLAPSED_KEY);
        if (raw) collapsedState = JSON.parse(raw) || {};
      } catch (_) {}
      const folderIconSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>';
      let html = '';
      folders.forEach(f => {
        const inFolder = filtered.filter(s => String(s.folderId || '') === String(f.id));
        const inFolderShow = inFolder.filter(s => toShowSet.has(String(s.id)));
        if (inFolderShow.length === 0) return;
        const fid = String(f.id);
        const collapsed = collapsedState[fid];
        const collapsedClass = collapsed ? ' saved-sets-folder-collapsed' : '';
        html += '<div class="saved-sets-folder' + collapsedClass + '" data-folder-id="' + escapeAttr(fid) + '" data-is-uncategorized="false">' +
          '<div class="saved-sets-folder-header">' +
          '<button type="button" class="saved-sets-folder-toggle">' +
          '<span class="folder-icon-wrap">' + folderIconSvg + '</span>' +
          '<span class="saved-sets-folder-name">' + escapeHtml(f.name) + '</span>' +
          '<span class="folder-chevron" aria-hidden="true">‚ñº</span>' +
          '</button>' +
          '<button type="button" class="folder-header-edit" aria-label="ÈáçÂëΩÂêç">‚úé</button>' +
          '<button type="button" class="folder-header-delete" aria-label="Âà†Èô§">√ó</button>' +
          '</div>' +
          '<div class="saved-sets-folder-body"><ul class="saved-sets-list">' + inFolderShow.map(itemHtml).join('') + '</ul></div></div>';
      });
      const uncategorized = filtered.filter(s => !s.folderId || !folderIds.has(String(s.folderId)));
      const uncategorizedShow = uncategorized.filter(s => toShowSet.has(String(s.id)));
      if (uncategorizedShow.length > 0) {
        const collapsed = collapsedState['__uncategorized__'];
        const collapsedClass = collapsed ? ' saved-sets-folder-collapsed' : '';
        html += '<div class="saved-sets-folder' + collapsedClass + '" data-folder-id="__uncategorized__" data-is-uncategorized="true">' +
          '<div class="saved-sets-folder-header">' +
          '<button type="button" class="saved-sets-folder-toggle">' +
          '<span class="folder-icon-wrap">' + folderIconSvg + '</span>' +
          '<span class="saved-sets-folder-name">Êú™ÂàÜÁ±ª</span>' +
          '<span class="folder-chevron" aria-hidden="true">‚ñº</span>' +
          '</button>' +
          '</div>' +
          '<div class="saved-sets-folder-body"><ul class="saved-sets-list">' + uncategorizedShow.map(itemHtml).join('') + '</ul></div></div>';
      }
      if (hasMore) {
        html += '<div class="saved-sets-show-more-wrap"><button type="button" class="btn btn-secondary saved-sets-show-more" id="btn-saved-sets-show-more">ÊòæÁ§∫Êõ¥Â§öÔºàÂÖ± ' + orderedSets.length + ' Â•óÔºâ</button></div>';
      }
      requestAnimationFrame(() => {
      listEl.innerHTML = html;
      listEl.querySelectorAll('.saved-sets-folder-toggle').forEach(toggleBtn => {
        toggleBtn.addEventListener('click', function() {
          const block = this.closest('.saved-sets-folder');
          const fid = block.dataset.folderId;
          block.classList.toggle('saved-sets-folder-collapsed');
          const collapsed = block.classList.contains('saved-sets-folder-collapsed');
          try {
            const raw = localStorage.getItem(FOLDER_COLLAPSED_KEY);
            const state = raw ? JSON.parse(raw) : {};
            state[fid] = collapsed;
            localStorage.setItem(FOLDER_COLLAPSED_KEY, JSON.stringify(state));
          } catch (_) {}
        });
      });
      listEl.querySelectorAll('.folder-header-edit').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const block = this.closest('.saved-sets-folder');
          const id = block.dataset.folderId;
          if (id === '__uncategorized__') return;
          const folders = getFolders();
          const folder = folders.find(f => String(f.id) === id);
          if (!folder) return;
          const name = prompt('ÈáçÂëΩÂêçÊñá‰ª∂Â§π', folder.name || '');
          if (name == null || !name.trim()) return;
          setFolders(folders.map(f => String(f.id) === id ? Object.assign({}, f, { name: name.trim() }) : f));
        });
      });
      listEl.querySelectorAll('.folder-header-delete').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const block = this.closest('.saved-sets-folder');
          const id = block.dataset.folderId;
          if (id === '__uncategorized__') return;
          if (!confirm('Âà†Èô§ËØ•Êñá‰ª∂Â§πÔºüÂÖ∂‰∏ã‰π†È¢òÈõÜ‰ºöÁßªÂà∞„ÄåÊú™ÂàÜÁ±ª„Äç„ÄÇ')) return;
          setFolders(getFolders().filter(f => String(f.id) !== id));
          const sets = getSavedSets();
          const updated = sets.map(s => String(s.folderId || '') === id ? Object.assign({}, s, { folderId: undefined }) : s);
          setSavedSets(updated);
        });
      });
      var showMoreBtn = listEl.querySelector('#btn-saved-sets-show-more');
      if (showMoreBtn) showMoreBtn.addEventListener('click', function() {
        _savedSetsDisplayLimit = Infinity;
        renderSavedSets();
      });
      });
    }
    function renderFolderTags() {
      const tagsEl = document.getElementById('saved-sets-folder-tags');
      if (!tagsEl) return;
      const folders = getFolders();
      const folderIconSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>';
      tagsEl.innerHTML = folders.map(f => {
        return '<span class="folder-tag" data-folder-id="' + escapeAttr(String(f.id)) + '">' +
          '<span class="folder-tag-icon">' + folderIconSvg + '</span>' +
          '<span class="folder-tag-name" title="' + escapeAttr(f.name) + '">' + escapeHtml(f.name) + '</span>' +
          '<button type="button" class="folder-tag-edit" aria-label="ÈáçÂëΩÂêç">‚úé</button>' +
          '<button type="button" class="folder-tag-delete" aria-label="Âà†Èô§">√ó</button>' +
          '</span>';
      }).join('');
      tagsEl.querySelectorAll('.folder-tag-edit').forEach(btn => {
        btn.addEventListener('click', function() {
          const tag = this.closest('.folder-tag');
          const id = tag.dataset.folderId;
          const folders = getFolders();
          const folder = folders.find(f => String(f.id) === id);
          if (!folder) return;
          const name = prompt('ÈáçÂëΩÂêçÊñá‰ª∂Â§π', folder.name || '');
          if (name == null || (name && !name.trim())) return;
          const trimmed = name.trim();
          if (!trimmed) return;
          setFolders(folders.map(f => String(f.id) === id ? Object.assign({}, f, { name: trimmed }) : f));
        });
      });
      tagsEl.querySelectorAll('.folder-tag-delete').forEach(btn => {
        btn.addEventListener('click', function() {
          const tag = this.closest('.folder-tag');
          const id = tag.dataset.folderId;
          if (!confirm('Âà†Èô§ËØ•Êñá‰ª∂Â§πÔºüÂÖ∂‰∏ã‰π†È¢òÈõÜ‰ºöÁßªÂà∞„ÄåÊú™ÂàÜÁ±ª„Äç„ÄÇ')) return;
          const folders = getFolders().filter(f => String(f.id) !== id);
          setFolders(folders);
          const sets = getSavedSets();
          const updated = sets.map(s => String(s.folderId || '') === id ? Object.assign({}, s, { folderId: undefined }) : s);
          setSavedSets(updated);
        });
      });
    }
    function handleSavedSetsAction(e) {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;
      const item = btn.closest('.saved-sets-item');
      if (!item) return;
      const id = item.dataset.id;
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === id);
      switch (btn.dataset.action) {
        case 'start':
          if (set && set.questions && set.questions.length) {
            if (set.questions.length > SEQUENTIAL_MODE_THRESHOLD) openStartModeModal(set);
            else if (hasReviewMaterial(set)) showReviewModal(set, set.questions, false, set.id);
            else startQuiz(set.questions, false, set.id);
          }
          break;
        case 'edit':
          if (set) openEditSetModal(id);
          break;
      }
    }
    let _editingSetId = null;
    let _editModalPastedImages = [];
    function isDataImageUrl(s) { return typeof s === 'string' && /^data:image\//i.test(s.trim()); }
    function isLikelyUrl(str) {
      const s = (str || '').trim();
      if (!s) return false;
      if (/^data:image\//i.test(s)) return false;
      let toTry = /^https?:\/\//i.test(s) ? s : ('https://' + s);
      try {
        const u = new URL(toTry);
        const host = (u.hostname || '').toLowerCase();
        return host.length > 0 && (host.includes('.') || host === 'localhost');
      } catch (_) { return false; }
    }
    function getReviewMaterials(set) {
      if (!set) return { texts: [], links: [], images: [] };
      const hasNew = (set.reviewTexts && set.reviewTexts.length) || (set.reviewLinks && set.reviewLinks.length) || (set.reviewImages && set.reviewImages.length);
      if (hasNew) {
        return {
          texts: Array.isArray(set.reviewTexts) ? set.reviewTexts : [],
          links: Array.isArray(set.reviewLinks) ? set.reviewLinks : [],
          images: Array.isArray(set.reviewImages) ? set.reviewImages : []
        };
      }
      const urls = Array.isArray(set.reviewUrls) ? set.reviewUrls : [];
      const texts = [], links = [], images = [];
      urls.forEach(u => {
        const s = (u || '').trim();
        if (!s) return;
        if (isDataImageUrl(s)) images.push(s);
        else if (isLikelyUrl(s)) links.push(/^https?:\/\//i.test(s) ? s : 'https://' + s);
        else texts.push(s);
      });
      return { texts, links, images };
    }
    function hasReviewMaterial(set) {
      const m = getReviewMaterials(set);
      return m.texts.length > 0 || m.links.length > 0 || m.images.length > 0;
    }
    let _toastTimer = null;
    function showToast(msg) {
      const el = document.getElementById('toast');
      if (!el) return;
      if (_toastTimer) clearTimeout(_toastTimer);
      el.textContent = msg;
      el.classList.add('show');
      _toastTimer = setTimeout(() => {
        el.classList.remove('show');
        _toastTimer = null;
      }, 2200);
    }
    function renderEditModalPastedImages() {
      const listEl = document.getElementById('edit-set-pasted-list');
      if (!listEl) return;
      listEl.innerHTML = _editModalPastedImages.map((dataUrl, i) =>
        '<div class="edit-set-pasted-item" data-index="' + i + '">' +
        '<img src="' + safeImageSrc(dataUrl) + '" alt="" loading="lazy" />' +
        '<button type="button" class="edit-set-pasted-remove" aria-label="Âà†Èô§ËØ•ÂõæÁâá">√ó</button></div>'
      ).join('');
      listEl.querySelectorAll('.edit-set-pasted-remove').forEach(btn => {
        btn.addEventListener('click', function() {
          const i = parseInt(this.closest('.edit-set-pasted-item').dataset.index, 10);
          _editModalPastedImages.splice(i, 1);
          renderEditModalPastedImages();
        });
      });
    }
    function openEditSetModal(setId) {
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === setId);
      if (!set) return;
      _editingSetId = setId;
      const nameEl = document.getElementById('edit-set-name');
      const textsEl = document.getElementById('edit-set-review-texts');
      const linksEl = document.getElementById('edit-set-review-links');
      const metaEl = document.getElementById('edit-set-meta');
      if (nameEl) nameEl.value = set.name || '';
      const folderEl = document.getElementById('edit-set-folder');
      if (folderEl) folderEl.value = set.folderId != null ? String(set.folderId) : '';
      const m = getReviewMaterials(set);
      if (textsEl) textsEl.value = m.texts.join('\n');
      if (linksEl) linksEl.value = m.links.join('\n');
      _editModalPastedImages = m.images.slice();
      if (metaEl) metaEl.textContent = set.questions ? set.questions.length + ' È¢ò ¬∑ ÁªÉ‰π† ' + (set.practiceCount || 0) + ' Ê¨°' : '';
      renderEditModalPastedImages();
      const appendEl = document.getElementById('edit-set-append-text');
      if (appendEl) appendEl.value = '';
      const editOverlay = document.getElementById('edit-set-modal-overlay');
      editOverlay.classList.add('show');
      setModalFocusTrap(editOverlay);
    }
    function closeEditSetModal() {
      _editingSetId = null;
      clearModalFocusTrap();
      document.getElementById('edit-set-modal-overlay').classList.remove('show');
    }
    function formatQuestionForPreview(q, index) {
      const typeLabel = QUESTION_TYPES[q.type] || q.type || 'È¢òÁõÆ';
      const head = 'Á¨¨ ' + (index + 1) + ' È¢ò ¬∑ ' + typeLabel + (q.category ? ' ¬∑ ' + escapeHtml(q.category) : '');
      const stem = '<div class="preview-q-stem">' + escapeHtml(q.stem || '') + '</div>';
      let options = '';
      if (q.options && q.options.length) {
        const opts = q.options.map((opt, i) => LETTERS[i] + ') ' + escapeHtml(opt)).join('<br/>');
        options = '<div class="preview-q-options">' + opts + '</div>';
      }
      let correctStr = '';
      if (q.type === 'single_choice' && q.options && q.options.length) {
        const idx = Array.isArray(q.correct) ? q.correct[0] : q.correct;
        if (idx >= 0 && idx < q.options.length) correctStr = 'Ê≠£Á°ÆÁ≠îÊ°àÔºö' + LETTERS[idx] + ') ' + escapeHtml(q.options[idx]);
      } else if (q.type === 'multiple_choice' && q.options && Array.isArray(q.correct)) {
        const labels = q.correct.map(i => LETTERS[i] + ') ' + (q.options[i] ? escapeHtml(q.options[i]) : '')).filter(Boolean);
        correctStr = 'Ê≠£Á°ÆÁ≠îÊ°àÔºö' + (labels.length ? labels.join('Ôºõ') : escapeHtml(String(q.correct)));
      } else if ((q.type === 'fill_blank' || q.type === 'paragraph_fill_blank') && q.correct != null) {
        const arr = Array.isArray(q.correct) ? q.correct : [q.correct];
        correctStr = 'Ê≠£Á°ÆÁ≠îÊ°àÔºö' + arr.map(c => Array.isArray(c) ? c.join(' / ') : escapeHtml(String(c))).join('Ôºõ');
      }
      const correct = correctStr ? '<div class="preview-q-correct">' + correctStr + '</div>' : '';
      const explanation = (q.explanation && q.explanation.trim()) ? '<div class="preview-q-explanation">Ëß£ÊûêÔºö' + escapeHtml(q.explanation.trim()) + '</div>' : '';
      return '<div class="preview-q"><div class="preview-q-head">' + head + '</div>' + stem + options + correct + explanation + '</div>';
    }
    function showPreviewQuestions(set) {
      if (!set || !set.questions || !set.questions.length) {
        showToast('Êú¨È¢òÈõÜÊöÇÊó†È¢òÁõÆÔºåÊó†Ê≥ïÈ¢ÑËßà');
        return;
      }
      const titleEl = document.getElementById('preview-questions-title');
      const bodyEl = document.getElementById('preview-questions-body');
      if (titleEl) titleEl.textContent = '‰π†È¢òÈ¢ÑËßàÔºö' + (set.name || 'Êú™ÂëΩÂêç');
      if (bodyEl) bodyEl.innerHTML = set.questions.map((q, i) => formatQuestionForPreview(q, i)).join('');
      const prevOverlay = document.getElementById('preview-questions-overlay');
      prevOverlay.classList.add('show');
      setModalFocusTrap(prevOverlay);
    }
    function closePreviewQuestions() {
      clearModalFocusTrap();
      document.getElementById('preview-questions-overlay').classList.remove('show');
    }
    function saveEditSetModal() {
      if (_editingSetId == null) return;
      const nameEl = document.getElementById('edit-set-name');
      const textsEl = document.getElementById('edit-set-review-texts');
      const linksEl = document.getElementById('edit-set-review-links');
      const name = nameEl ? String(nameEl.value).trim() : '';
      if (!name) {
        showToast('ËØ∑Â°´ÂÜô‰π†È¢òÈõÜÂêçÁß∞');
        if (nameEl) nameEl.focus();
        return;
      }
      const reviewTexts = (textsEl && textsEl.value ? textsEl.value.trim().split(/\n/) : []).map(s => s.trim()).filter(s => s.length > 0);
      const linkLines = (linksEl && linksEl.value ? linksEl.value.trim().split(/\n/) : []).map(s => s.trim()).filter(s => s.length > 0);
      const reviewLinks = linkLines.map(s => (/^https?:\/\//i.test(s) || isLikelyUrl(s)) ? (/^https?:\/\//i.test(s) ? s : 'https://' + s) : s);
      const reviewImages = _editModalPastedImages.slice();
      const sets = getSavedSets();
      const folderEl = document.getElementById('edit-set-folder');
      const folderId = (folderEl && folderEl.value) ? folderEl.value : null;
      const updated = sets.map(s => String(s.id) === String(_editingSetId) ? Object.assign({}, s, { name: name, folderId: folderId || undefined, reviewTexts: reviewTexts, reviewLinks: reviewLinks, reviewImages: reviewImages }) : s);
      setSavedSets(updated);
      closeEditSetModal();
    }
    function exportFromEditModal() {
      if (_editingSetId == null) return;
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === String(_editingSetId));
      if (!set || !set.questions) return;
      const name = (set.name || '‰π†È¢òÈõÜ').replace(/[\\/:*?"<>|]/g, '_').slice(0, 50);
      const blob = new Blob([JSON.stringify(set.questions, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (name || 'export') + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function appendToEditSetModal() {
      if (_editingSetId == null) return;
      const textEl = document.getElementById('edit-set-append-text');
      const text = textEl ? textEl.value.trim() : '';
      if (!text) {
        showToast('ËØ∑ÂÖàÁ≤òË¥¥Ë¶ÅËøΩÂä†ÁöÑÈ¢òÁõÆÔºàJSON ÊàñÂê´È¢òÂûã/ÈÄâÈ°πÁöÑÊñáÊú¨Ôºâ');
        if (textEl) textEl.focus();
        return;
      }
      const appendBtn = document.getElementById('btn-edit-set-append');
      const origAppendText = appendBtn ? appendBtn.textContent : '';
      if (appendBtn) { appendBtn.disabled = true; appendBtn.textContent = 'Ëß£Êûê‰∏≠‚Ä¶'; }
      let parsed = [];
      if (/^\s*[\[{]/.test(text)) {
        try {
          const data = JSON.parse(text);
          parsed = Array.isArray(data) ? data : (data.questions || []);
        } catch (_) {}
      }
      if (parsed.length === 0) parsed = parsePastedText(text);
      if (appendBtn) { appendBtn.disabled = false; appendBtn.textContent = origAppendText; }
      if (parsed.length === 0) {
        showToast('Êú™ËÉΩËß£ÊûêÂá∫È¢òÁõÆÔºåËØ∑Ê£ÄÊü•Ê†ºÂºè');
        return;
      }
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === String(_editingSetId));
      if (!set || !Array.isArray(set.questions)) return;
      const existingFps = new Set(set.questions.map(q => wrongBookItemId(q)));
      const toAdd = [];
      let dupCount = 0;
      for (let i = 0; i < parsed.length; i++) {
        const fp = wrongBookItemId(parsed[i]);
        if (existingFps.has(fp)) dupCount++; else { existingFps.add(fp); toAdd.push(parsed[i]); }
      }
      const newQuestions = set.questions.concat(toAdd);
      const updated = sets.map(s => String(s.id) === String(_editingSetId) ? Object.assign({}, s, { questions: newQuestions }) : s);
      setSavedSets(updated);
      const metaEl = document.getElementById('edit-set-meta');
      if (metaEl) metaEl.textContent = newQuestions.length + ' È¢ò ¬∑ ÁªÉ‰π† ' + (set.practiceCount || 0) + ' Ê¨°';
      if (textEl) textEl.value = '';
      showToast('Â∑≤ËøΩÂä† ' + toAdd.length + ' È¢ò' + (dupCount ? 'ÔºåË∑≥Ëøá ' + dupCount + ' ÈÅìÈáçÂ§ç' : '') + 'ÔºåÂΩìÂâçÂÖ± ' + newQuestions.length + ' È¢ò');
    }
    function deleteFromEditModal() {
      if (_editingSetId == null) return;
      if (!confirm('Á°ÆÂÆöÂà†Èô§ËØ•‰π†È¢òÈõÜÔºüÂà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ')) return;
      const sets = getSavedSets().filter(s => String(s.id) !== String(_editingSetId));
      setSavedSets(sets);
      closeEditSetModal();
    }

    const EBINGHAUS_INTERVALS = [1, 3, 7, 14, 30];
    function todayString() {
      const d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }
    function addDays(dayStr, days) {
      const d = new Date(dayStr + 'T12:00:00');
      d.setDate(d.getDate() + days);
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }
    function wrongBookItemId(item) {
      if (_wrongBookIdCache.has(item)) return _wrongBookIdCache.get(item);
      const id = (item.stem || '') + '|' + (item.options ? item.options.join('|') : '') + '|' + String(item.correct != null ? item.correct : '');
      _wrongBookIdCache.set(item, id);
      return id;
    }
    function getQuestionNotes(questionId) {
      try {
        const raw = localStorage.getItem(QUESTION_NOTES_KEY);
        const obj = raw ? JSON.parse(raw) : {};
        return (obj && obj[questionId] != null) ? String(obj[questionId]) : '';
      } catch (_) { return ''; }
    }
    function setQuestionNotes(questionId, text) {
      try {
        const raw = localStorage.getItem(QUESTION_NOTES_KEY);
        const obj = raw ? JSON.parse(raw) : {};
        obj[questionId] = (text || '').trim();
        if (!obj[questionId]) delete obj[questionId];
        localStorage.setItem(QUESTION_NOTES_KEY, JSON.stringify(obj));
      } catch (_) {}
    }
    function getWrongBook() {
      if (!_wrongBookCacheDirty && _wrongBookCache !== null) return _wrongBookCache;
      try {
        const raw = localStorage.getItem(WRONG_BOOK_KEY);
        _wrongBookCache = raw ? JSON.parse(raw) : [];
        _wrongBookCacheDirty = false;
        return _wrongBookCache;
      } catch (_) { return []; }
    }
    function setWrongBook(arr) {
      _wrongBookCache = arr;
      _wrongBookCacheDirty = false;
      localStorage.setItem(WRONG_BOOK_KEY, JSON.stringify(arr));
      updateWrongCount();
      updateStatsBar();
    }
    function removeFromWrongBook(q) {
      const book = getWrongBook();
      const id = wrongBookItemId(q);
      const next = book.filter(item => wrongBookItemId(item) !== id);
      if (next.length < book.length) setWrongBook(next);
    }
    function getWrongBookDue() {
      const book = getWrongBook();
      const today = todayString();
      return book
        .filter(item => {
          const next = item.nextReview;
          if (!next) return true;
          return next <= today;
        })
        .sort((a, b) => (a.nextReview || '').localeCompare(b.nextReview || ''));
    }
    function addToWrongBook(q) {
      const book = getWrongBook();
      const id = wrongBookItemId(q);
      const idx = book.findIndex(item => wrongBookItemId(item) === id);
      if (idx >= 0) {
        book[idx] = Object.assign({}, book[idx], { wrongCount: (book[idx].wrongCount || 0) + 1 });
      } else {
        const nextReview = addDays(todayString(), 1);
        book.push(Object.assign({}, q, { nextReview: nextReview, interval: 1, repetitions: 0, wrongCount: 1 }));
      }
      setWrongBook(book);
    }
    function addToWrongBookDirect(item) {
      const book = getWrongBook();
      const id = wrongBookItemId(item);
      if (book.some(i => wrongBookItemId(i) === id)) return;
      book.push(item);
      setWrongBook(book);
    }
    function updateWrongBookAfterAnswer(item, correct) {
      const book = getWrongBook();
      const id = wrongBookItemId(item);
      const idx = book.findIndex(i => wrongBookItemId(i) === id);
      if (idx === -1) return;
      const today = todayString();
      if (correct) {
        const rep = (book[idx].repetitions || 0) + 1;
        if (rep >= 5) {
          book.splice(idx, 1);
        } else {
          const intervalDays = EBINGHAUS_INTERVALS[Math.min(rep, EBINGHAUS_INTERVALS.length - 1)];
          book[idx] = Object.assign({}, book[idx], {
            repetitions: rep,
            interval: intervalDays,
            nextReview: addDays(today, intervalDays)
          });
        }
      } else {
        book[idx] = Object.assign({}, book[idx], {
          nextReview: addDays(today, 1),
          repetitions: 0,
          interval: 1
        });
      }
      setWrongBook(book);
    }
    function getWrongCountForQuestion(q) {
      if (!q) return 0;
      const book = getWrongBook();
      const id = wrongBookItemId(q);
      const item = book.find(i => wrongBookItemId(i) === id);
      return (item && item.wrongCount != null) ? item.wrongCount : 0;
    }
    function updateWrongCount() {
      const el = document.getElementById('wrong-count');
      if (el) el.textContent = getWrongBook().length;
    }

    const DEFAULT_QUESTIONS = [
      { type: 'single_choice', stem: 'En ce moment, nous ______ un film int√©ressant.', options: ['voions', 'voyons', 'voyez', 'voient'], correct: 1, explanation: '„ÄêA2 ÊãºÂÜôÈô∑Èò±„ÄëNous/Vous Âèò‰ΩçÊó∂ÔºåËØçÊ†π i ÂøÖÈ°ªÂèò‰∏∫ y„ÄÇNous voyons ÊòØÂîØ‰∏ÄÊ≠£Á°ÆÂΩ¢Âºè„ÄÇ', category: 'Áõ¥ÈôàÂºèÁé∞Âú®Êó∂' },
      { type: 'single_choice', stem: 'Hier, est-ce que tu ______ tes amis ?', options: ['a vu', 'as vu', 'as vus', 'es vu'], correct: 1, explanation: '„ÄêA1 Â§çÂêàËøáÂéªÊó∂„ÄëTu Êê≠ÈÖçÂä©Âä®ËØç avoir (as) + ËøáÂéªÂàÜËØç vu„ÄÇÊ≠§Êó∂Ê≤°ÊúâÂÆæËØ≠ÊèêÂâçÔºåvu ‰∏çÈÖçÂêàÔºå‰∏çÁî®Âä† s„ÄÇ', category: 'Â§çÂêàËøáÂéªÊó∂' },
      { type: 'single_choice', stem: 'Les fleurs ? Oui, je les ai ______.', options: ['vu', 'vue', 'vus', 'vues'], correct: 3, explanation: '„ÄêB2 ËøáÂéªÂàÜËØçÈÖçÂêà„ÄëÊ†∏ÂøÉËÄÉÁÇπÔºÅles Êåá‰ª£ les fleurs (Èò¥ÊÄßÂ§çÊï∞)Ôºå‰∏îÊîæÂú®‰∫ÜÂä©Âä®ËØç ai ‰πãÂâç„ÄÇËøáÂéªÂàÜËØç vu ÂøÖÈ°ªÈÖçÂêàÔºåÂä† es ‚Üí vues„ÄÇ', category: 'Â§çÂêàËøáÂéªÊó∂' },
      { type: 'single_choice', stem: 'Demain, je ______ le m√©decin.', options: ['vais voir', 'vais vois', 'va voir', 'aller voir'], correct: 0, explanation: '„ÄêA1 ÊúÄËøëÂ∞ÜÊù•Êó∂„ÄëÁªìÊûÑÔºöAller (Âèò‰Ωç) +Âä®ËØçÂéüÂΩ¢„ÄÇJe vais + voir„ÄÇ', category: 'ÊúÄËøëÂ∞ÜÊù•Êó∂' },
      { type: 'single_choice', stem: 'Non, je ne ______ pas le voir ce soir.', options: ['vais', 'va', 'vois', 'ai'], correct: 0, explanation: '„ÄêA2 Âê¶ÂÆöÂè•ÁªìÊûÑ„ÄëÊúÄËøëÂ∞ÜÊù•Êó∂ÁöÑÂê¶ÂÆöÊòØ Ne + Aller + Pas + ÂéüÂΩ¢„ÄÇJe ne *vais* pas le voir„ÄÇ', category: 'ÊúÄËøëÂ∞ÜÊù•Êó∂' },
      { type: 'multiple_choice', stem: '‰∏ãÂàóÂì™‰∫õÂè•Â≠êÁöÑÂèò‰ΩçÂΩ¢ÂºèÂú®ÂèëÈü≥‰∏äÂÆåÂÖ®Áõ∏ÂêåÔºàÂç≥ TCF Âê¨Âäõ‰∏≠ÁöÑÂêåÈü≥Èô∑Èò±ÔºâÔºü', options: ['Je vois', 'Tu vois', 'Il voit', 'Ils voient'], correct: [0, 1, 2, 3], explanation: '„ÄêA1 ËØ≠Èü≥Ëæ®Êûê„ÄëTCF Âê¨ÂäõÈöæÁÇπ„ÄÇvois, voit, voient ÂèëÈü≥Âùá‰∏∫ /vwa/„ÄÇÂè™Êúâ‰∏ä‰∏ãÊñáÁöÑ‰∏ªËØ≠ËÉΩÂå∫ÂàÜÂÆÉ‰ª¨„ÄÇ', category: 'Áõ¥ÈôàÂºèÁé∞Âú®Êó∂' },
      { type: 'multiple_choice', stem: 'ÂÖ≥‰∫éÂ§çÂêàËøáÂéªÊó∂ \'J\'ai vu\'Ôºå‰∏ãÂàóÂì™‰∫õËØ¥Ê≥ïÊòØÊ≠£Á°ÆÁöÑÔºü', options: ['Âä©Âä®ËØçÊòØ √™tre', 'Âä©Âä®ËØçÊòØ avoir', 'ËøáÂéªÂàÜËØçÊòØ vu', 'ËøáÂéªÂàÜËØçÊòØ voir√©'], correct: [1, 2], explanation: '„ÄêA1 Âü∫Á°ÄÊûÑÊàê„ÄëVoir ÁöÑÂ§çÂêàËøáÂéªÊó∂Áî± Avoir + Vu ÊûÑÊàê„ÄÇ', category: 'Â§çÂêàËøáÂéªÊó∂' },
      { type: 'multiple_choice', stem: 'Âú®ÊúÄËøëÂ∞ÜÊù•Êó∂‰∏≠Ôºå‰ª£ËØçÁöÑ‰ΩçÁΩÆÂì™ÈáåÊòØÊ≠£Á°ÆÁöÑÔºü', options: ['Je vais le voir.', 'Je le vais voir.', 'Nous allons les voir.', 'Nous les allons voir.'], correct: [0, 2], explanation: '„ÄêB1 ‰ª£ËØç‰ΩçÁΩÆ„ÄëÂú®ÊúÄËøëÂ∞ÜÊù•Êó∂‰∏≠ÔºåÂÆæËØ≠‰ª£ËØçÔºàle, la, les, lui...ÔºâÂøÖÈ°ªÊîæÂú®ÂéüÂΩ¢Âä®ËØçÔºàvoirÔºâ‰πãÂâçÔºå‰∏çËÉΩÊîæÂú® aller ‰πãÂâç„ÄÇ', category: 'ÊúÄËøëÂ∞ÜÊù•Êó∂' },
      { type: 'multiple_choice', stem: 'ÈÄâÂá∫‰∏ãÂàóÂè•Â≠ê‰∏≠ËØ≠Ê≥ï**ÈîôËØØ**ÁöÑÈÄâÈ°πÔºö', options: ['Ils voyent la mer.', 'Nous voions la montagne.', 'Vous voyez le probl√®me.', 'Elles voient le chat.'], correct: [0, 1], explanation: '„ÄêA2 ÊãºÂÜôËßÑÂàô„ÄëIls ÂêéÈù¢Â∫î‰∏∫ voient (i ‰∏çÂèò y)ÔºõNous ÂêéÈù¢Â∫î‰∏∫ voyons (i ÂøÖÈ°ªÂèò y)„ÄÇ', category: 'Áõ¥ÈôàÂºèÁé∞Âú®Êó∂' },
      { type: 'multiple_choice', stem: 'Âì™‰∫õÊó∂Èó¥Ê†áÂøóËØçÈÄöÂ∏∏Ëß¶Âèë\'Â§çÂêàËøáÂéªÊó∂\'Ôºü', options: ['Hier', 'La semaine derni√®re', 'Demain', 'Maintenant'], correct: [0, 1], explanation: '„ÄêA2 Êó∂Èó¥Áä∂ËØ≠„ÄëHier (Êò®Â§©) Âíå La semaine derni√®re (‰∏äÂë®) ÊòØËøáÂéªÊó∂ÁöÑÂÖ∏ÂûãÊ†áÂøó„ÄÇ', category: 'Â§çÂêàËøáÂéªÊó∂' },
      { type: 'fill_blank', stem: 'Regarde ! Ils ______ (voir) un arc-en-ciel.', options: ['voient'], correct: ['voient'], explanation: '„ÄêA1 Âèò‰Ωç„ÄëIls (Â§çÊï∞Á¨¨‰∏â‰∫∫Áß∞) Âèò‰Ωç‰∏∫ voient„ÄÇ', category: 'Áõ¥ÈôàÂºèÁé∞Âú®Êó∂' },
      { type: 'fill_blank', stem: 'C\'est la lettre que j\'ai ______ (voir).', options: ['vue'], correct: ['vue'], explanation: '„ÄêB2 ÈÖçÂêà„ÄëQue Êåá‰ª£ la lettre (Èò¥ÊÄßÂçïÊï∞)Ôºå‰∏îÂú®Âä®ËØçÂâçÔºåvu ÈúÄÂèòÊàê vue„ÄÇ', category: 'Â§çÂêàËøáÂéªÊó∂' },
      { type: 'fill_blank', stem: 'Nous ______ (voir) que tu es fatigu√©.', options: ['voyons'], correct: ['voyons'], explanation: '„ÄêA2 ÊãºÂÜô„ÄëNous + voir = voyons (Ê≥®ÊÑè y)„ÄÇ', category: 'Áõ¥ÈôàÂºèÁé∞Âú®Êó∂' },
      { type: 'fill_blank', stem: 'Bient√¥t, on ______ (aller) voir le r√©sultat.', options: ['va'], correct: ['va'], explanation: '„ÄêA1 ÊúÄËøëÂ∞ÜÊù•Êó∂„ÄëOn va voir„ÄÇÊ≥®ÊÑè On ÁöÑÂèò‰ΩçÁ≠âÂêå‰∫é Il/Elle„ÄÇ', category: 'ÊúÄËøëÂ∞ÜÊù•Êó∂' },
      { type: 'fill_blank', stem: 'O√π sont mes lunettes ? Je ne les ai pas ______ (voir).', options: ['vues'], correct: ['vues'], explanation: '„ÄêB2 ÈÖçÂêà+Âê¶ÂÆö„ÄëLes Êåá‰ª£ lunettes (Èò¥ÊÄßÂ§çÊï∞)ÔºåÊîæÂú® ai ‰πãÂâçÔºåËøáÂéªÂàÜËØçÂøÖÈ°ªÈÖçÂêà‰∏∫ vues„ÄÇÂê¶ÂÆöËØç ne...pas ‰∏çÂΩ±ÂìçÈÖçÂêàËßÑÂàô„ÄÇ', category: 'Â§çÂêàËøáÂéªÊó∂' },
      { type: 'paragraph_fill_blank', stem: 'Hier, j\'ai _____ un accident. Aujourd\'hui, je _____ que la police est l√†.', correct: ['vu', 'vois'], explanation: '„ÄêÊó∂ÊÄÅÂØπÊØî„ÄëÁ¨¨‰∏ÄÁ©∫ Hier Ëß¶ÂèëÂ§çÂêàËøáÂéªÊó∂ (ai vu)ÔºõÁ¨¨‰∫åÁ©∫ Aujourd\'hui Ëß¶ÂèëÁé∞Âú®Êó∂ (vois)„ÄÇ', category: 'Êó∂ÊÄÅÁªºÂêà' },
      { type: 'paragraph_fill_blank', stem: 'Tu _____ voir ce film demain ? Non, je l\'ai d√©j√† _____.', correct: ['vas', 'vu'], explanation: '„ÄêËØ≠Â¢ÉËæ®Êûê„ÄëÁ¨¨‰∏ÄÁ©∫ Demain Ëß¶ÂèëÊúÄËøëÂ∞ÜÊù•Êó∂ (vas voir)ÔºõÁ¨¨‰∫åÁ©∫ d√©j√† Ëß¶ÂèëÂ§çÂêàËøáÂéªÊó∂„ÄÇÊ≥®ÊÑèËøôÈáå le Êåá‰ª£ film (Èò≥ÊÄß)ÔºåÊâÄ‰ª• vu ‰∏çÂèò„ÄÇ', category: 'Êó∂ÊÄÅÁªºÂêà' },
      { type: 'paragraph_fill_blank', stem: 'Les photos ? Nous les _____ vues. Elles sont belles, vous _____ ?', correct: ['avons', 'voyez'], explanation: '„ÄêB2 Âä©Âä®ËØç‰∏éÂèò‰Ωç„ÄëÁ¨¨‰∏ÄÁ©∫ÔºöÂ§çÂêàËøáÂéªÊó∂Âä©Âä®ËØç nous avons (vues Â∑≤ÈÖçÂêà)ÔºõÁ¨¨‰∫åÁ©∫ÔºöÁé∞Âú®Êó∂ vous voyez (Ê≥®ÊÑè y)„ÄÇ', category: 'Â§çÂêàËøáÂéªÊó∂ & Áé∞Âú®Êó∂' },
      { type: 'paragraph_fill_blank', stem: 'Elles _____ (voir) mal sans lunettes. Elles vont _____ (voir) le docteur.', correct: ['voient', 'voir'], explanation: '„ÄêÂΩ¢‰ººËØçËæ®Êûê„ÄëÁ¨¨‰∏ÄÁ©∫ÊòØÁé∞Âú®Êó∂Âèò‰Ωç voientÔºõÁ¨¨‰∫åÁ©∫ÊòØÊúÄËøëÂ∞ÜÊù•Êó∂ÔºåAller ÂêéÈù¢ÂøÖÈ°ªË∑üÂéüÂΩ¢ voir„ÄÇ', category: 'Áõ¥ÈôàÂºèÁé∞Âú®Êó∂ & ÊúÄËøëÂ∞ÜÊù•Êó∂' },
      { type: 'paragraph_fill_blank', stem: 'C\'est la fille que tu as _____ ? Oui, je vais la _____ demain.', correct: ['vue', 'voir'], explanation: '„ÄêB2 ÁªºÂêàÈöæÁÇπ„ÄëÁ¨¨‰∏ÄÁ©∫ÔºöQue Êåá‰ª£ la fille (Èò¥ÊÄß)Ôºåas vue ÈúÄÈÖçÂêà„ÄÇÁ¨¨‰∫åÁ©∫ÔºöÊúÄËøëÂ∞ÜÊù•Êó∂ la ÊîæÂú®ÂéüÂΩ¢ voir ‰πãÂâç„ÄÇ', category: 'Â§çÂêàËøáÂéªÊó∂ & ÊúÄËøëÂ∞ÜÊù•Êó∂' }
    ];

    function getCurrentSetQuestions() {
      const sel = document.getElementById('start-practice-select');
      const val = sel ? sel.value : 'default';
      if (val === 'default') return DEFAULT_QUESTIONS;
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === val);
      return (set && set.questions) ? set.questions : [];
    }
    function updateCategoryFilter() {
      const questions = getCurrentSetQuestions();
      const categories = [...new Set(questions.map(q => q.category).filter(Boolean))].sort();
      const wrap = document.getElementById('category-filter-wrap');
      const sel = document.getElementById('filter-category');
      if (!wrap || !sel) return;
      const currentVal = sel.value;
      sel.innerHTML = '<option value="">ÂÖ®ÈÉ®</option>' + categories.map(c => '<option value="' + escapeHtml(c) + '">' + escapeHtml(c) + '</option>').join('');
      if (categories.indexOf(currentVal) !== -1) sel.value = currentVal;
      else sel.value = '';
      wrap.style.display = categories.length > 0 ? 'block' : 'none';
    }

    let state = {
      questions: [],
      index: 0,
      score: 0,
      answered: false,
      timerSeconds: 10,
      practicingWrongBook: false,
      practicedSetId: null,
      sequentialBatch: null
    };
    let timerId = null;

    const TIMER_CIRCUMFERENCE = 2 * Math.PI * 17; // ~106.81
    function clearTimer() {
      if (timerId) clearInterval(timerId);
      timerId = null;
      const el = document.getElementById('quiz-timer');
      if (el) { el.style.display = 'none'; el.textContent = ''; el.classList.remove('low'); }
      const ring = document.getElementById('timer-ring');
      const ringFill = document.getElementById('timer-ring-fill');
      if (ring) ring.style.display = 'none';
      if (ringFill) { ringFill.style.strokeDashoffset = '0'; ringFill.classList.remove('low'); }
    }
    function startTimer(extraSeconds) {
      clearTimer();
      const base = state.timerSeconds || 0;
      const seconds = base + (extraSeconds || 0);
      if (!seconds) return;
      let remain = seconds;
      const el = document.getElementById('quiz-timer');
      const ring = document.getElementById('timer-ring');
      const ringFill = document.getElementById('timer-ring-fill');
      if (!el) return;
      el.style.display = 'inline';
      el.textContent = remain;
      el.classList.remove('low');
      if (ring) ring.style.display = 'block';
      if (ringFill) { ringFill.style.strokeDashoffset = '0'; ringFill.classList.remove('low'); }
      timerId = setInterval(() => {
        remain--;
        el.textContent = remain;
        if (ringFill) {
          const offset = TIMER_CIRCUMFERENCE * (1 - remain / seconds);
          ringFill.style.strokeDashoffset = offset;
        }
        if (remain <= 3) {
          el.classList.add('low');
          if (ringFill) ringFill.classList.add('low');
          if (remain > 0 && navigator.vibrate) navigator.vibrate(200);
        }
        if (remain <= 0) {
          clearTimer();
          submitAnswer();
        }
      }, 1000);
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const screen = document.getElementById(id);
      screen.classList.add('active');
      requestAnimationFrame(() => {
        if (id === SCREEN.QUIZ) {
          const first = screen.querySelector('.option, input[type="text"], .btn-primary');
          if (first) first.focus();
        } else if (id === SCREEN.RESULT) {
          const scoreEl = screen.querySelector('.result-score');
          if (scoreEl) { scoreEl.setAttribute('tabindex', '-1'); scoreEl.focus(); }
        }
      });
    }

    function parsePastedText(text) {
      const questions = [];
      // Êåâ„ÄåÂ•óË∑Ø N„ÄçÊàñ„ÄåÈ¢òÂûãÔºö„ÄçÂàÜÂùóÔºå‰øùËØÅÊØèÂùóÈáåÊúâ‰∏ÄÈÅìÈ¢ò
      const chunks = text.split(/(?=Â•óË∑Ø\s*\d|È¢òÂûã[Ôºö:])/i).filter(b => b.trim());
      for (const chunk of chunks) {
        // È¢òÂûãÔºöÂêéÈù¢Âà∞ A) ‰πãÂâç‰∏∫È¢òÂπ≤ÔºàÂèØÂ§öË°åÔºâ
        const stemMatch = chunk.match(/È¢òÂûã[Ôºö:]\s*([\s\S]*?)(?=A\)\s)/i);
        if (!stemMatch) continue;
        const stem = stemMatch[1].replace(/\s+/g, ' ').trim();
        // A) ... B) ... C) ... D) ...ÔºàÂÖÅËÆ∏Âêå‰∏ÄË°åÊàñÊç¢Ë°åÔºâ
        const optMatch = chunk.match(/A\)\s*([\s\S]*?)\s*B\)\s*([\s\S]*?)\s*C\)\s*([\s\S]*?)\s*D\)\s*([\s\S]*?)(?=\n|Ê≠£Á°Æ|$)/);
        if (!optMatch) continue;
        const options = [optMatch[1], optMatch[2], optMatch[3], optMatch[4]].map(s => s.trim());
        const correctMatch = chunk.match(/Ê≠£Á°Æ[Ôºö:]\s*([A-D])/i);
        if (!correctMatch) continue;
        const correct = LETTERS.indexOf(correctMatch[1].toUpperCase());
        if (correct === -1) continue;
        let category = '';
        const catMatch = chunk.match(/Â•óË∑Ø\s*\d+[Ôºö:]\s*([^\nÔºà(]+)/);
        if (catMatch) category = catMatch[1].trim();
        let explanation = '';
        const expMatch = chunk.match(/(?:Âπ≤Êâ∞È°πÂàÜÊûê|Ëß£Èáä|Âá∫È¢ò‰∫∫ÊÉ≥ËÄÉ|ËÆ∞ÂøÜÂè£ËØÄ)[Ôºö:]\s*([\s\S]+?)(?=Â•óË∑Ø\s*\d|È¢òÂûã[Ôºö:]|$)/i);
        if (expMatch) explanation = expMatch[1].trim().split(/\n/).slice(0, 8).join('\n');
        questions.push({
          type: 'single_choice',
          category,
          stem,
          options,
          correct,
          explanation: explanation || `Ê≠£Á°ÆÁ≠îÊ°àÔºö${LETTERS[correct]}`
        });
      }
      return questions;
    }

    function startQuiz(questions, fromWrongBook, setId, opts) {
      if (!questions || questions.length === 0) {
        showToast(fromWrongBook ? 'Ê≤°ÊúâÂà∞ÊúüÈúÄË¶ÅÂ§ç‰π†ÁöÑÈîôÈ¢òÔºåÊòéÂ§©ÂÜçÊù•' : 'Ê≤°ÊúâÂèØÁî®ÁöÑÈ¢òÁõÆÔºåËØ∑Ê£ÄÊü•ÂØºÂÖ•Êàñ‰ΩøÁî®ÈªòËÆ§È¢òÁõÆ');
        return;
      }
      opts = opts || {};
      if (typeof performance !== 'undefined' && performance.mark) performance.mark('quiz-start');
      const timerInput = document.getElementById('timer-seconds');
      state.timerSeconds = timerInput ? Math.max(0, parseInt(timerInput.value, 10) || 10) : 10;
      const noShuffle = !!opts.noShuffle;
      let list = (noShuffle || !(document.getElementById('shuffle-questions') && document.getElementById('shuffle-questions').checked))
        ? questions.slice()
        : shuffleArray(questions);
      if (!noShuffle && document.getElementById('shuffle-options') && document.getElementById('shuffle-options').checked) {
        list = list.map(shuffleQuestionOptions);
      }
      state.questions = list;
      state.index = 0;
      state.score = 0;
      state.answered = false;
      state.answerResults = {};
      state.practicingWrongBook = !!fromWrongBook;
      state.practicedSetId = setId || null;
      state.sequentialBatch = opts.sequentialBatch || null;
      showScreen(SCREEN.QUIZ);
      if (typeof performance !== 'undefined' && performance.mark) performance.mark('quiz-first-render-start');
      renderQuestion();
      if (typeof performance !== 'undefined' && performance.mark) {
        performance.mark('quiz-first-render-end');
        try { performance.measure('quiz-first-render', 'quiz-first-render-start', 'quiz-first-render-end'); } catch (_) {}
      }
    }
    let _pendingReviewStart = null;
    let _pendingStartSet = null;
    function openStartModeModal(set) {
      _pendingStartSet = set;
      const total = set.questions.length;
      const nextIdx = Math.max(0, parseInt(set.sequentialNextIndex, 10) || 0);
      const remain = total - nextIdx;
      const overlay = document.getElementById('start-mode-modal-overlay');
      const seqBlock = document.getElementById('start-mode-sequential');
      const finishedBlock = document.getElementById('start-mode-finished');
      const fromEl = document.getElementById('start-mode-from');
      const remainEl = document.getElementById('start-mode-remain');
      const countInput = document.getElementById('start-mode-count');
      if (remain <= 0) {
        if (seqBlock) seqBlock.style.display = 'none';
        if (finishedBlock) finishedBlock.style.display = 'flex';
        if (fromEl) fromEl.textContent = '1';
        if (remainEl) remainEl.textContent = total;
      } else {
        if (seqBlock) seqBlock.style.display = 'flex';
        if (finishedBlock) finishedBlock.style.display = 'none';
        if (fromEl) fromEl.textContent = nextIdx + 1;
        if (remainEl) remainEl.textContent = remain;
        if (countInput) {
          countInput.max = remain;
          countInput.value = Math.min(20, remain);
        }
      }
      if (overlay) { overlay.classList.add('show'); overlay.style.display = 'flex'; setModalFocusTrap(overlay); }
    }
    function closeStartModeModal() {
      _pendingStartSet = null;
      const overlay = document.getElementById('start-mode-modal-overlay');
      if (overlay) { overlay.classList.remove('show'); overlay.style.display = 'none'; clearModalFocusTrap(); }
    }
    function showReviewModal(set, questions, fromWrongBook, setId, startOpts) {
      const m = getReviewMaterials(set);
      const total = m.texts.length + m.links.length + m.images.length;
      if (total === 0) {
        startQuiz(questions, fromWrongBook, setId, startOpts);
        return;
      }
      _pendingReviewStart = { questions, fromWrongBook, setId, noShuffle: startOpts && startOpts.noShuffle };
      const textsWrap = document.getElementById('review-modal-texts');
      const linksEl = document.getElementById('review-modal-links');
      const imagesEl = document.getElementById('review-modal-images');
      const textsWrapParent = document.getElementById('review-modal-texts-wrap');
      if (textsWrap) {
        textsWrap.innerHTML = m.texts.length ? m.texts.map(t => '<div class="review-text-block">' + escapeHtml(t) + '</div>').join('') : '';
        if (textsWrapParent) textsWrapParent.style.display = m.texts.length ? 'block' : 'none';
      }
      if (linksEl) {
        linksEl.innerHTML = m.links.map(href => {
          const label = href.length > 80 ? href.slice(0, 77) + '‚Ä¶' : href;
          return '<a href="' + safeHref(href) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(label) + '</a>';
        }).join('');
        linksEl.style.display = m.links.length ? 'flex' : 'none';
      }
      if (imagesEl) {
        imagesEl.innerHTML = m.images.map(dataUrl => {
          const safeSrc = safeImageSrc(dataUrl);
          if (!safeSrc) return '';
          return '<div class="review-modal-msg"><img src="' + safeSrc + '" alt="Â§ç‰π†ÂõæÁâá" class="review-modal-img" title="ÁÇπÂáªÊîæÂ§ß" loading="lazy" /></div>';
        }).join('');
        imagesEl.style.display = m.images.length ? 'flex' : 'none';
      }
      const overlay = document.getElementById('review-modal-overlay');
      if (overlay) { overlay.classList.add('show'); setModalFocusTrap(overlay); }
    }
    function hideReviewModal() {
      clearModalFocusTrap();
      const overlay = document.getElementById('review-modal-overlay');
      if (overlay) overlay.classList.remove('show');
      _pendingReviewStart = null;
    }
    function openImageLightbox(src) {
      const el = document.getElementById('image-lightbox-overlay');
      const img = document.getElementById('image-lightbox-img');
      if (el && img && src) { img.src = src; el.classList.add('show'); setModalFocusTrap(el); }
    }
    function closeImageLightbox() {
      clearModalFocusTrap();
      const el = document.getElementById('image-lightbox-overlay');
      if (el) el.classList.remove('show');
    }
    function recordSavedSetPractice(setId) {
      if (!setId) return;
      const sets = getSavedSets();
      const idx = sets.findIndex(s => String(s.id) === String(setId));
      if (idx === -1) return;
      sets[idx] = Object.assign({}, sets[idx], {
        practiceCount: (sets[idx].practiceCount || 0) + 1,
        lastPracticedAt: new Date().toISOString()
      });
      setSavedSets(sets);
    }

    function renderParagraphBlanks(q, correctArr) {
      const parts = q.stem.split('_____');
      let stemHtml = '';
      for (let i = 0; i < parts.length; i++) {
        stemHtml += escapeHtml(parts[i]);
        if (i < parts.length - 1) stemHtml += '<span class="blank" data-blank="' + i + '">( ' + (i + 1) + ' )</span>';
      }
      document.getElementById('question-stem').innerHTML = stemHtml;
      const wrap = document.getElementById('paragraph-blanks-wrap');
      wrap.style.display = 'block';
      wrap.innerHTML = correctArr.map((_, i) =>
        '<label style="display:flex;align-items:center;gap:0.5rem;"><span style="min-width:2.5rem;">Á¨¨' + (i + 1) + 'Á©∫:</span><input type="text" data-blank="' + i + '" placeholder="..." autocomplete="off" aria-label="Á¨¨' + (i + 1) + 'Á©∫Á≠îÊ°à" /></label>'
      ).join('');
      wrap.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('keydown', e => { if (e.key === 'Enter') submitAnswer(); });
      });
    }

    function renderQuestion() {
      const q = state.questions[state.index];
      if (!q) {
        showResult();
        return;
      }

      state.answered = !!state.answerResults[state.index];
      const idx = state.index + 1;
      const total = state.questions.length;
      document.getElementById('progress-fill').style.width = (idx / total) * 100 + '%';
      document.getElementById('question-counter').textContent = `${idx} / ${total}`;
      const labelEl = document.getElementById('progress-label');
      if (labelEl) labelEl.textContent = 'Á¨¨ ' + idx + ' / ' + total + ' È¢ò';
      const estimateEl = document.getElementById('progress-estimate');
      if (estimateEl && idx === 1) {
        estimateEl.textContent = 'ÂÖ± ' + total + ' È¢ò' + (state.timerSeconds ? 'ÔºåÁ∫¶ ' + Math.ceil(total * state.timerSeconds / 60) + ' ÂàÜÈíü' : 'Ôºå‰∏çÈôêÊó∂');
      }
      document.getElementById('question-meta').textContent = q.category ? `Â•óË∑Ø ¬∑ ${q.category}` : '';
      document.getElementById('question-stem').innerHTML = escapeHtml(q.stem);
      var explanationScrollWrap = document.getElementById('explanation-scroll-wrap');
      if (explanationScrollWrap) explanationScrollWrap.style.display = 'none';
      var wrongCountEl = document.getElementById('explanation-wrong-count');
      if (wrongCountEl) { wrongCountEl.textContent = ''; wrongCountEl.style.display = 'none'; }
      document.getElementById('explanation').textContent = q.explanation || '';
      var notesDisplay = document.getElementById('explanation-notes-display');
      if (notesDisplay) { notesDisplay.textContent = ''; notesDisplay.style.display = 'none'; }
      var notesEdit = document.getElementById('explanation-notes-edit');
      if (notesEdit) notesEdit.style.display = 'none';
      var notesTextarea = document.getElementById('explanation-notes-textarea');
      if (notesTextarea) notesTextarea.value = '';
      const removeWrapEl = document.getElementById('wrong-book-remove-wrap');
      if (removeWrapEl) removeWrapEl.style.display = 'none';
      const removeFromSetWrap = document.getElementById('remove-from-set-wrap');
      if (removeFromSetWrap) removeFromSetWrap.style.display = state.practicedSetId ? 'block' : 'none';
      document.getElementById('answer-feedback').className = 'answer-feedback';
      document.getElementById('answer-feedback').textContent = '';

      const optionsEl = document.getElementById('options-container');
      const fillWrap = document.getElementById('fill-input-wrap');
      const fillInput = document.getElementById('fill-input');

      if (q.type === 'fill_blank') {
        optionsEl.innerHTML = '';
        const blankCount = (q.stem.match(/_____/g) || []).length;
        const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
        const isMultiBlank = blankCount >= 2 && correctArr.length >= 2;
        if (isMultiBlank) {
          fillWrap.style.display = 'none';
          renderParagraphBlanks(q, correctArr.slice(0, blankCount));
        } else {
          fillWrap.style.display = 'block';
          fillInput.value = '';
          fillInput.placeholder = 'ËæìÂÖ•Á≠îÊ°à...';
          fillInput.setAttribute('aria-label', 'ËæìÂÖ•Á≠îÊ°à');
          document.getElementById('paragraph-blanks-wrap').style.display = 'none';
          document.getElementById('paragraph-blanks-wrap').innerHTML = '';
        }
        if (state.answerResults[state.index]) {
          applyAnsweredState(q, state.answerResults[state.index]);
          return;
        }
        document.getElementById('btn-submit').style.display = 'inline-flex';
        document.getElementById('btn-next').style.display = 'none';
        var btnPrev0 = document.getElementById('btn-prev-quiz');
        if (btnPrev0) btnPrev0.style.display = state.index > 0 ? 'inline-flex' : 'none';
        var fillExtra = (q.type === 'fill_blank' && isMultiBlank) ? blankCount * 5 : 0;
        startTimer(fillExtra);
        return;
      }

      if (q.type === 'paragraph_fill_blank') {
        optionsEl.innerHTML = '';
        fillWrap.style.display = 'none';
        const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
        renderParagraphBlanks(q, correctArr);
        if (state.answerResults[state.index]) {
          applyAnsweredState(q, state.answerResults[state.index]);
          return;
        }
        document.getElementById('btn-submit').style.display = 'inline-flex';
        document.getElementById('btn-next').style.display = 'none';
        var btnPrev1 = document.getElementById('btn-prev-quiz');
        if (btnPrev1) btnPrev1.style.display = state.index > 0 ? 'inline-flex' : 'none';
        var paraBlanks = (correctArr && correctArr.length) ? correctArr.length : 1;
        startTimer(paraBlanks * 5);
        return;
      }

      fillWrap.style.display = 'none';
      document.getElementById('paragraph-blanks-wrap').style.display = 'none';
      document.getElementById('paragraph-blanks-wrap').innerHTML = '';
      const isMulti = q.type === 'multiple_choice';
      const correctSet = Array.isArray(q.correct) ? new Set(q.correct) : new Set([q.correct]);
      optionsEl.setAttribute('role', isMulti ? 'group' : 'radiogroup');
      optionsEl.setAttribute('aria-label', isMulti ? 'Â§öÈÄâÈÄâÈ°π' : 'ÂçïÈÄâÈÄâÈ°π');

      optionsEl.innerHTML = q.options.map((opt, i) => {
        const letter = LETTERS[i];
        const inputType = isMulti ? 'checkbox' : 'radio';
        const name = isMulti ? `opt-${state.index}` : 'option';
        return `
          <label class="option" data-index="${i}">
            <input type="${inputType}" name="${name}" value="${i}" />
            <span class="option-letter">${letter}</span>
            <span class="option-label">${escapeHtml(opt)}</span>
          </label>
        `;
      }).join('');

      optionsEl.querySelectorAll('.option').forEach(label => {
        label.addEventListener('click', () => {
          if (state.answered) return;
          const input = label.querySelector('input');
          if (isMulti) {
            input.checked = !input.checked;
          } else {
            optionsEl.querySelectorAll('.option').forEach(l => l.classList.remove('selected'));
            optionsEl.querySelectorAll('input').forEach(inp => { inp.checked = false; });
            input.checked = true;
            label.classList.add('selected');
          }
          label.classList.remove('just-selected');
          void label.offsetWidth;
          label.classList.add('just-selected');
        });
      });

      if (state.answerResults[state.index]) {
        applyAnsweredState(q, state.answerResults[state.index]);
        return;
      }
      document.getElementById('btn-submit').style.display = 'inline-flex';
      document.getElementById('btn-next').style.display = 'none';
      var btnPrev2 = document.getElementById('btn-prev-quiz');
      if (btnPrev2) btnPrev2.style.display = state.index > 0 ? 'inline-flex' : 'none';
      startTimer();
    }

    function escapeHtml(s) {
      if (s == null) return '';
      _escapeDiv.textContent = s;
      return _escapeDiv.innerHTML;
    }
    function escapeAttr(s) {
      if (s == null) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    function safeHref(href) {
      const u = (href || '').trim();
      if (!/^https?:\/\//i.test(u) && !/^\/[^/]/.test(u) && u !== '#') return '#';
      return escapeAttr(u);
    }
    function safeImageSrc(url) {
      const u = (url || '').trim();
      if (!/^data:image\//i.test(u)) return '';
      return escapeAttr(u);
    }

    function submitAnswer() {
      clearTimer();
      if (state.answered) return;
      const q = state.questions[state.index];
      const optionsEl = document.getElementById('options-container');
      const fillWrap = document.getElementById('fill-input-wrap');
      const fillInput = document.getElementById('fill-input');

      let correct = false;
      if (q.type === 'fill_blank') {
        const paragraphWrap = document.getElementById('paragraph-blanks-wrap');
        const multiInputs = paragraphWrap && paragraphWrap.style.display !== 'none' ? paragraphWrap.querySelectorAll('input') : [];
        if (multiInputs.length >= 2) {
          const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
          let allRight = true;
          const answers = [];
          for (let i = 0; i < correctArr.length && i < multiInputs.length; i++) {
            const val = (multiInputs[i].value || '').trim().toLowerCase();
            const accept = Array.isArray(correctArr[i]) ? correctArr[i].map(c => String(c).toLowerCase().trim()) : [String(correctArr[i]).toLowerCase().trim()];
            const ok = matchFrenchAnswer(val, accept);
            answers.push({ val, ok, accept });
            if (!ok) allRight = false;
          }
          state.answered = true;
          if (allRight) state.score++;
          else addToWrongBook(q);
          correct = allRight;
          multiInputs.forEach((inp, i) => {
            inp.disabled = true;
            inp.classList.add(answers[i].ok ? 'correct-blank' : 'wrong-blank');
          });
          const stemEl = document.getElementById('question-stem');
          stemEl.querySelectorAll('.blank').forEach((span, i) => {
            if (answers[i]) {
              span.classList.add(answers[i].ok ? 'filled' : 'wrong');
              span.textContent = answers[i].ok ? answers[i].val : (answers[i].val || '?') + ' ‚Üí ' + (Array.isArray(q.correct[i]) ? q.correct[i][0] : q.correct[i]);
            }
          });
        } else {
          const answer = (fillInput.value || '').trim().toLowerCase();
          const accept = (Array.isArray(q.correct) ? q.correct : [q.correct]).map(c => String(c).toLowerCase().trim());
          correct = matchFrenchAnswer(answer, accept);
          state.answered = true;
          if (correct) state.score++;
          else addToWrongBook(q);
        }
      } else if (q.type === 'paragraph_fill_blank') {
        const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
        const inputs = document.querySelectorAll('#paragraph-blanks-wrap input');
        const len = Math.min(correctArr.length, inputs.length);
        let allRight = true;
        const answers = [];
        for (let i = 0; i < len; i++) {
          const val = (inputs[i] && inputs[i].value ? inputs[i].value : '').trim().toLowerCase();
          const accept = Array.isArray(correctArr[i]) ? correctArr[i].map(c => String(c).toLowerCase().trim()) : [String(correctArr[i]).toLowerCase().trim()];
          const ok = matchFrenchAnswer(val, accept);
          answers.push({ val, ok, accept });
          if (!ok) allRight = false;
        }
        for (let i = len; i < correctArr.length; i++) { allRight = false; answers.push({ val: '', ok: false, accept: [] }); }
        state.answered = true;
        if (allRight) state.score++;
        else addToWrongBook(q);
        inputs.forEach((inp, i) => {
          inp.disabled = true;
          if (answers[i]) inp.classList.add(answers[i].ok ? 'correct-blank' : 'wrong-blank');
        });
        const stemEl = document.getElementById('question-stem');
        stemEl.querySelectorAll('.blank').forEach((span, i) => {
          if (answers[i]) {
            span.classList.add(answers[i].ok ? 'filled' : 'wrong');
            span.textContent = answers[i].ok ? answers[i].val : (answers[i].val || '?') + ' ‚Üí ' + (Array.isArray(q.correct[i]) ? q.correct[i][0] : q.correct[i]);
          }
        });
        correct = allRight;
      } else {
        const isMulti = q.type === 'multiple_choice';
        const selected = Array.from(optionsEl.querySelectorAll('input:checked')).map(inp => parseInt(inp.value, 10));
        const userAnswer = isMulti ? { multiple: selected } : { single: selected.length === 1 ? selected[0] : undefined };
        const result = evaluateAnswer(q, userAnswer);
        correct = result.correct;
        state.answered = true;
        if (correct) state.score++;
        else addToWrongBook(q);

        const correctSet = Array.isArray(q.correct) ? new Set(q.correct) : new Set([q.correct]);
        optionsEl.querySelectorAll('.option').forEach((label, i) => {
          label.classList.add('disabled');
          const inCorrect = correctSet.has(i);
          const wasSelected = label.querySelector('input').checked;
          if (inCorrect) label.classList.add('correct');
          else if (wasSelected) label.classList.add('wrong');
        });
      }

      if (state.practicingWrongBook) updateWrongBookAfterAnswer(q, correct);

      const feedbackEl = document.getElementById('answer-feedback');
      feedbackEl.textContent = correct ? 'Ê≠£Á°ÆÔºÅ' : 'ÈîôËØØ';
      feedbackEl.className = 'answer-feedback ' + (correct ? 'correct-msg' : 'wrong-msg');

      const explanationEl = document.getElementById('explanation');
      let explanationText = q.explanation || '';
      if (!explanationText && !correct) {
        if (q.type === 'fill_blank') {
          const ans = Array.isArray(q.correct) ? q.correct : [q.correct];
          explanationText = 'Ê≠£Á°ÆÁ≠îÊ°àÔºö' + ans.map(a => String(a).trim()).join(' Êàñ ');
        } else if (q.type === 'single_choice') {
          explanationText = 'Ê≠£Á°ÆÁ≠îÊ°àÔºö' + (q.options ? LETTERS[q.correct] + ') ' + q.options[q.correct] : LETTERS[q.correct]);
        } else if (q.type === 'multiple_choice' && q.options) {
          const indices = Array.isArray(q.correct) ? q.correct : [q.correct];
          explanationText = 'Ê≠£Á°ÆÁ≠îÊ°àÔºö' + indices.map(i => LETTERS[i] + ') ' + q.options[i]).join('Ôºõ');
        } else if (q.type === 'paragraph_fill_blank') {
          const arr = Array.isArray(q.correct) ? q.correct : [q.correct];
          explanationText = 'Ê≠£Á°ÆÁ≠îÊ°àÔºö' + arr.map((c, i) => 'Á¨¨' + (i + 1) + 'Á©∫ ' + (Array.isArray(c) ? c[0] : c)).join('Ôºõ');
        }
      }
      explanationEl.textContent = explanationText;
      var scrollWrap = document.getElementById('explanation-scroll-wrap');
      if (scrollWrap) {
        scrollWrap.style.display = 'block';
        var wrongCountEl = document.getElementById('explanation-wrong-count');
        var wrongCount = getWrongCountForQuestion(q);
        if (wrongCountEl) {
          if (wrongCount > 0) {
            wrongCountEl.textContent = 'Êú¨È¢òÂ∑≤Èîô ' + wrongCount + ' Ê¨°';
            wrongCountEl.style.display = 'block';
          } else {
            wrongCountEl.textContent = '';
            wrongCountEl.style.display = 'none';
          }
        }
        var qid = wrongBookItemId(q);
        _currentQuestionIdForNotes = qid;
        var notes = getQuestionNotes(qid);
        var notesDisplayEl = document.getElementById('explanation-notes-display');
        var notesEditEl = document.getElementById('explanation-notes-edit');
        var btnEditNotes = document.getElementById('btn-edit-explanation-notes');
        if (notesDisplayEl) {
          if (notes) { notesDisplayEl.textContent = notes; notesDisplayEl.style.display = 'block'; } else { notesDisplayEl.style.display = 'none'; }
        }
        if (notesEditEl) notesEditEl.style.display = 'none';
        if (btnEditNotes) btnEditNotes.style.display = 'inline-flex';
      }

      const announcer = document.getElementById('sr-announcer');
      if (announcer) announcer.textContent = correct ? 'ÂõûÁ≠îÊ≠£Á°Æ' : 'ÂõûÁ≠îÈîôËØØ„ÄÇ' + (explanationText || '');

      const removeWrap = document.getElementById('wrong-book-remove-wrap');
      const btnRemove = document.getElementById('btn-remove-from-wrong');
      if (removeWrap && btnRemove) {
        if (state.practicingWrongBook) {
          removeWrap.style.display = 'block';
          btnRemove.textContent = 'ÁßªÂá∫ÈîôÈ¢òÊú¨';
          btnRemove.disabled = false;
          btnRemove.onclick = () => {
            const removedItem = JSON.parse(JSON.stringify(q));
            removeFromWrongBook(q);
            btnRemove.textContent = 'Â∑≤ÁßªÂá∫Ôºà5ÁßíÂÜÖÂèØÊí§ÈîÄÔºâ';
            btnRemove.disabled = false;
            const undoTimer = setTimeout(() => {
              btnRemove.textContent = 'Â∑≤ÁßªÂá∫';
              btnRemove.disabled = true;
            }, 5000);
            btnRemove.onclick = () => {
              clearTimeout(undoTimer);
              addToWrongBookDirect(removedItem);
              btnRemove.textContent = 'Â∑≤Êí§ÈîÄÔºå‰ªçÂú®ÈîôÈ¢òÊú¨';
              btnRemove.disabled = true;
            };
          };
        } else {
          removeWrap.style.display = 'none';
        }
      }

      var saved = { correct: correct, explanationText: explanationText };
      if (q.type === 'single_choice') {
        var sel = Array.from(optionsEl.querySelectorAll('input:checked')).map(function(inp) { return parseInt(inp.value, 10); });
        saved.selectedSingle = sel.length === 1 ? sel[0] : undefined;
      }
      if (q.type === 'multiple_choice') saved.selectedMultiple = Array.from(optionsEl.querySelectorAll('input:checked')).map(function(inp) { return parseInt(inp.value, 10); });
      state.answerResults[state.index] = saved;

      document.getElementById('btn-submit').style.display = 'none';
      const btnNext = document.getElementById('btn-next');
      btnNext.style.display = 'inline-flex';
      btnNext.textContent = state.index >= state.questions.length - 1 ? 'Êü•ÁúãÁªìÊûú' : '‰∏ã‰∏ÄÈ¢ò';
      btnNext.setAttribute('aria-label', state.index >= state.questions.length - 1 ? 'Êü•ÁúãÁªìÊûú' : '‰∏ã‰∏ÄÈ¢ò');
      var btnPrev = document.getElementById('btn-prev-quiz');
      if (btnPrev) btnPrev.style.display = state.index > 0 ? 'inline-flex' : 'none';
      saveQuizProgress();
    }

    function applyAnsweredState(q, saved) {
      state.answered = true;
      clearTimer();
      var feedbackEl = document.getElementById('answer-feedback');
      feedbackEl.textContent = saved.correct ? 'Ê≠£Á°ÆÔºÅ' : 'ÈîôËØØ';
      feedbackEl.className = 'answer-feedback ' + (saved.correct ? 'correct-msg' : 'wrong-msg');
      feedbackEl.style.display = 'block';
      var explanationEl = document.getElementById('explanation');
      explanationEl.textContent = saved.explanationText || '';
      var scrollWrap = document.getElementById('explanation-scroll-wrap');
      if (scrollWrap) {
        scrollWrap.style.display = 'block';
        var wrongCountEl = document.getElementById('explanation-wrong-count');
        var wrongCount = getWrongCountForQuestion(q);
        if (wrongCountEl) {
          if (wrongCount > 0) {
            wrongCountEl.textContent = 'Êú¨È¢òÂ∑≤Èîô ' + wrongCount + ' Ê¨°';
            wrongCountEl.style.display = 'block';
          } else {
            wrongCountEl.textContent = '';
            wrongCountEl.style.display = 'none';
          }
        }
        var qid = wrongBookItemId(q);
        _currentQuestionIdForNotes = qid;
        var notes = getQuestionNotes(qid);
        var notesDisplayEl = document.getElementById('explanation-notes-display');
        var notesEditEl = document.getElementById('explanation-notes-edit');
        var btnEditNotes = document.getElementById('btn-edit-explanation-notes');
        if (notesDisplayEl) {
          if (notes) { notesDisplayEl.textContent = notes; notesDisplayEl.style.display = 'block'; } else { notesDisplayEl.style.display = 'none'; }
        }
        if (notesEditEl) notesEditEl.style.display = 'none';
        if (btnEditNotes) btnEditNotes.style.display = 'inline-flex';
      }
      var optionsEl = document.getElementById('options-container');
      if (optionsEl && (q.type === 'single_choice' || q.type === 'multiple_choice') && q.options) {
        var correctSet = Array.isArray(q.correct) ? new Set(q.correct) : new Set([q.correct]);
        optionsEl.querySelectorAll('.option').forEach(function(label, i) {
          label.classList.add('disabled');
          var inCorrect = correctSet.has(i);
          var wasSelected = (q.type === 'single_choice' && saved.selectedSingle === i) || (q.type === 'multiple_choice' && saved.selectedMultiple && saved.selectedMultiple.indexOf(i) !== -1);
          if (inCorrect) label.classList.add('correct');
          else if (wasSelected) label.classList.add('wrong');
          var input = label.querySelector('input');
          if (input) { input.checked = wasSelected; input.disabled = true; }
        });
      }
      var fillWrap = document.getElementById('fill-input-wrap');
      var paragraphWrap = document.getElementById('paragraph-blanks-wrap');
      if (fillWrap) fillWrap.querySelectorAll('input').forEach(function(inp) { inp.disabled = true; });
      if (paragraphWrap) paragraphWrap.querySelectorAll('input').forEach(function(inp) { inp.disabled = true; });
      document.getElementById('btn-submit').style.display = 'none';
      var btnNext = document.getElementById('btn-next');
      btnNext.style.display = 'inline-flex';
      btnNext.textContent = state.index >= state.questions.length - 1 ? 'Êü•ÁúãÁªìÊûú' : '‰∏ã‰∏ÄÈ¢ò';
      btnNext.setAttribute('aria-label', state.index >= state.questions.length - 1 ? 'Êü•ÁúãÁªìÊûú' : '‰∏ã‰∏ÄÈ¢ò');
      var btnPrev = document.getElementById('btn-prev-quiz');
      if (btnPrev) btnPrev.style.display = state.index > 0 ? 'inline-flex' : 'none';
    }

    function prevQuestion() {
      if (state.index <= 0) return;
      state.index--;
      state.answered = true;
      renderQuestion();
    }

    function nextQuestion() {
      state.index++;
      if (state.index >= state.questions.length) {
        showResult();
      } else {
        const card = document.querySelector('.question-card');
        if (card) {
          card.classList.add('animate-out');
          setTimeout(() => {
            if (typeof performance !== 'undefined' && performance.mark) performance.mark('next-question-start');
            card.classList.remove('animate-out');
            renderQuestion();
            if (typeof performance !== 'undefined' && performance.mark) {
              performance.mark('next-question-end');
              try { performance.measure('next-question', 'next-question-start', 'next-question-end'); } catch (_) {}
            }
            card.classList.add('animate-in');
            card.style.willChange = 'transform';
            card.addEventListener('animationend', () => {
              card.classList.remove('animate-in');
              card.style.willChange = '';
            }, { once: true });
          }, 200);
        } else {
          renderQuestion();
        }
      }
    }

    function showResult() {
      clearQuizProgress();
      if (state.practicedSetId) {
        recordSavedSetPractice(state.practicedSetId);
        state.practicedSetId = null;
      }
      addTodayPractice(state.questions.length);
      document.getElementById('result-score').textContent = `${state.score} / ${state.questions.length}`;
      const pct = state.questions.length ? Math.round((state.score / state.questions.length) * 100) : 0;
      const pctEl = document.getElementById('result-pct');
      if (pctEl) pctEl.textContent = 'Ê≠£Á°ÆÁéá ' + pct + '%';
      document.getElementById('result-desc').textContent = pct >= 80 ? 'Tr√®s bien !' : pct >= 60 ? 'Pas mal !' : 'Continuez √† pratiquer !';
      const celebrationEl = document.getElementById('result-celebration');
      const isFull = state.score === state.questions.length && state.questions.length > 0;
      if (celebrationEl) celebrationEl.style.display = isFull ? 'block' : 'none';
      const confettiEl = document.getElementById('result-confetti');
      if (confettiEl) {
        confettiEl.innerHTML = '';
        if (isFull) {
          const colors = ['#8b5cf6', '#34d399', '#fbbf24', '#60a5fa', '#f87171'];
          for (let i = 0; i < 14; i++) {
            const s = document.createElement('span');
            s.style.left = (10 + Math.random() * 80) + '%';
            s.style.top = (60 + Math.random() * 35) + '%';
            s.style.background = colors[i % colors.length];
            s.style.animationDelay = (Math.random() * 0.6) + 's';
            s.style.animationDuration = (2 + Math.random() * 1.2) + 's';
            confettiEl.appendChild(s);
          }
        }
      }
      pushRecentSession(state.questions.length, state.score);
      if (state.sequentialBatch && state.practicedSetId) {
        const sets = getSavedSets();
        const nextIdx = state.sequentialBatch.startIndex + state.sequentialBatch.count;
        const updated = sets.map(s => String(s.id) === String(state.practicedSetId)
          ? Object.assign({}, s, { sequentialNextIndex: nextIdx })
          : s);
        setSavedSets(updated);
        state.sequentialBatch = null;
      }
      const recentEl = document.getElementById('result-recent');
      if (recentEl) {
        const sessions = getRecentSessions();
        const toShow = sessions.slice(-5).reverse();
        if (toShow.length <= 1) {
          recentEl.style.display = 'none';
        } else {
          recentEl.style.display = 'block';
          recentEl.innerHTML = '<div class="result-recent-title">ÊúÄËøëÁªÉ‰π†</div><ul>' +
            toShow.map((s, i) => '<li>' + s.score + '/' + s.total + (i === 0 ? 'ÔºàÊú¨Ê¨°Ôºâ' : '') + '</li>').join('') + '</ul>';
        }
      }
      const announcer = document.getElementById('sr-announcer');
      if (announcer) announcer.textContent = 'ÁªÉ‰π†ÂÆåÊàêÔºåÂæóÂàÜ ' + state.score + ' / ' + state.questions.length + 'ÔºåÊ≠£Á°ÆÁéá ' + pct + '%';
      showScreen(SCREEN.RESULT);
      var firstBtn = document.getElementById('btn-restart');
      if (firstBtn) setTimeout(function () { firstBtn.focus(); }, 100);
    }
    function readAloudStem() {
      const q = state.questions[state.index];
      if (!q || !q.stem) return;
      const text = (q.stem || '').replace(/_____/g, ' ').trim();
      if (!text) return;
      if (typeof speechSynthesis === 'undefined') return;
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'fr-FR';
      u.rate = 0.9;
      speechSynthesis.speak(u);
    }
    function onQuizKeydown(e) {
      if (!document.getElementById('screen-quiz').classList.contains('active')) return;
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : '';
      if (tag === 'INPUT' || tag === 'TEXTAREA') {
        if (e.key === 'Enter' && (e.target.id === 'explanation-notes-textarea' || e.target.closest('#explanation-notes-edit'))) return;
        if (e.key === 'Enter') { e.preventDefault(); if (state.answered) nextQuestion(); else submitAnswer(); }
        return;
      }
      if (e.key === 'Enter') {
        e.preventDefault();
        if (state.answered) nextQuestion();
        else submitAnswer();
        return;
      }
      if (['1','2','3','4'].includes(e.key)) {
        const q = state.questions[state.index];
        if (!q || state.answered) return;
        if ((q.type === 'single_choice' || q.type === 'multiple_choice') && q.options && q.options.length > 0) {
          const idx = parseInt(e.key, 10) - 1;
          if (idx < 0 || idx >= q.options.length) return;
          const opts = document.querySelectorAll('#options-container .option');
          if (opts[idx]) opts[idx].click();
        }
      }
    }

    document.getElementById('btn-start-practice').addEventListener('click', () => {
      const typeFilter = getSelectedTypeFilter();
      const sel = document.getElementById('start-practice-select');
      const val = sel ? sel.value : 'default';
      let questions = [];
      if (val === 'default') {
        questions = DEFAULT_QUESTIONS;
      } else {
        const sets = getSavedSets();
        const set = sets.find(s => String(s.id) === val);
        if (!set || !set.questions || !set.questions.length) {
          showToast('Êú™ÊâæÂà∞ËØ•‰π†È¢òÈõÜÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©');
          return;
        }
        questions = set.questions;
      }
      let filtered = filterQuestionsByType(questions, typeFilter);
      const categoryEl = document.getElementById('filter-category');
      const categoryVal = categoryEl && categoryEl.value ? categoryEl.value.trim() : '';
      if (categoryVal) {
        filtered = filtered.filter(q => q && q.category === categoryVal);
      }
      if (filtered.length === 0) {
        const typeNames = typeFilter ? typeFilter.map(t => QUESTION_TYPES[t] || t).join('„ÄÅ') : '';
        showToast('ÂΩìÂâçÈÄâÈ¢òÂûãÊàñÂàÜÁ±ª‰∏ãÊ≤°ÊúâÈ¢òÁõÆÔºåËØ∑ÂãæÈÄâÊõ¥Â§öÈ¢òÂûãÊàñÊç¢‰π†È¢òÈõÜ');
        return;
      }
      if (val !== 'default') {
        const sets = getSavedSets();
        const set = sets.find(s => String(s.id) === val);
        if (set) {
          if (hasReviewMaterial(set)) showReviewModal(set, filtered, false, set.id);
          else startQuiz(filtered, false, set.id);
        } else {
          startQuiz(filtered);
        }
      } else {
        startQuiz(filtered);
      }
    });

    document.getElementById('btn-import-show').addEventListener('click', async () => {
      if (!(await checkImportPin())) return;
      const sec = document.getElementById('import-section');
      sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
    });

    document.getElementById('btn-import-parse').addEventListener('click', () => {
      const parseBtn = document.getElementById('btn-import-parse');
      const origText = parseBtn ? parseBtn.textContent : '';
      if (parseBtn) { parseBtn.disabled = true; parseBtn.textContent = 'Ëß£Êûê‰∏≠‚Ä¶'; }
      const text = document.getElementById('import-text').value.trim();
      let parsed = [];
      if (/^\s*[\[{]/.test(text)) {
        try {
          const data = JSON.parse(text);
          parsed = Array.isArray(data) ? data : (data.questions || []);
        } catch (_) {}
      }
      if (parsed.length === 0) parsed = parsePastedText(text);
      if (parseBtn) { parseBtn.disabled = false; parseBtn.textContent = origText; }
      if (parsed.length > 0) {
        const seen = new Set();
        const deduped = [];
        let dupCount = 0;
        for (let i = 0; i < parsed.length; i++) {
          const fp = wrongBookItemId(parsed[i]);
          if (seen.has(fp)) dupCount++; else { seen.add(fp); deduped.push(parsed[i]); }
        }
        const nameInput = document.getElementById('import-set-name');
        const reviewInput = document.getElementById('import-review-urls');
        const name = (nameInput && nameInput.value ? nameInput.value.trim() : '') || ('Êú™ÂëΩÂêç ' + formatSavedSetDate(new Date().toISOString()));
        const rawLines = (reviewInput && reviewInput.value ? reviewInput.value.trim().split(/\n/) : [])
          .map(s => s.trim())
          .filter(s => s.length > 0);
        const reviewTexts = [];
        const reviewLinks = [];
        const reviewImages = [];
        rawLines.forEach(s => {
          if (/^data:image\//i.test(s)) reviewImages.push(s);
          else if (isLikelyUrl(s)) reviewLinks.push(/^https?:\/\//i.test(s) ? s : 'https://' + s);
          else reviewTexts.push(s);
        });
        const folderSel = document.getElementById('import-set-folder');
        const folderId = (folderSel && folderSel.value) ? folderSel.value : null;
        const saved = {
          id: Date.now(),
          name: name,
          folderId: folderId || undefined,
          createdAt: new Date().toISOString(),
          questions: deduped,
          practiceCount: 0,
          lastPracticedAt: null,
          reviewTexts,
          reviewLinks,
          reviewImages
        };
        const all = getSavedSets();
        all.unshift(saved);
        setSavedSets(all);
        startQuiz(deduped);
        showToast('Â∑≤Âä†ÂÖ• ' + deduped.length + ' ÈÅìÊñ∞È¢ò' + (dupCount ? 'ÔºåË∑≥Ëøá ' + dupCount + ' ÈÅìÈáçÂ§ç' : ''));
        document.getElementById('import-section').style.display = 'none';
        document.getElementById('import-text').value = '';
        if (nameInput) nameInput.value = '';
        if (reviewInput) reviewInput.value = '';
      } else {
        showToast('Êú™ËÉΩËß£ÊûêÂá∫È¢òÁõÆÔºåËØ∑Ê£ÄÊü•Ê†ºÂºè');
      }
    });

    document.getElementById('btn-submit').addEventListener('click', submitAnswer);
    document.getElementById('btn-next').addEventListener('click', nextQuestion);
    document.getElementById('btn-prev-quiz').addEventListener('click', prevQuestion);
    document.getElementById('btn-remove-from-set').addEventListener('click', () => {
      if (!state.practicedSetId) return;
      if (confirm('Á°ÆÂÆö‰ªéÊú¨ÁªÉ‰π†ÈõÜ‰∏≠Âà†Èô§ËøôÈÅìÈ¢òÔºüÂà†Èô§ÂêéÊú¨È¢òÂ∞Ü‰∏çÂÜçÂá∫Áé∞Âú®ËØ•ÁªÉ‰π†ÈõÜ‰∏≠„ÄÇ')) removeCurrentQuestionFromSet();
    });
    document.getElementById('btn-exit-quiz').addEventListener('click', () => {
      if (confirm('Á°ÆÂÆöË¶ÅÊèêÂâçÈÄÄÂá∫ÂêóÔºü')) {
        clearTimer();
        clearQuizProgress();
        showScreen(SCREEN.HOME);
        updateWrongCount();
        renderSavedSets();
      }
    });
    document.getElementById('fill-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        if (state.answered) nextQuestion();
        else submitAnswer();
      }
    });
    (function initExplanationNotesEdit() {
      var btnEdit = document.getElementById('btn-edit-explanation-notes');
      var btnSave = document.getElementById('btn-save-explanation-notes');
      var btnCancel = document.getElementById('btn-cancel-explanation-notes');
      var notesDisplay = document.getElementById('explanation-notes-display');
      var notesEdit = document.getElementById('explanation-notes-edit');
      var notesTextarea = document.getElementById('explanation-notes-textarea');
      if (!btnEdit || !notesEdit || !notesTextarea) return;
      btnEdit.addEventListener('click', function() {
        notesTextarea.value = _currentQuestionIdForNotes ? getQuestionNotes(_currentQuestionIdForNotes) : '';
        notesDisplay.style.display = 'none';
        btnEdit.style.display = 'none';
        notesEdit.style.display = 'block';
        notesTextarea.focus();
      });
      function closeNotesEdit() {
        notesEdit.style.display = 'none';
        btnEdit.style.display = 'inline-flex';
        if (_currentQuestionIdForNotes) {
          var notes = getQuestionNotes(_currentQuestionIdForNotes);
          if (notes) { notesDisplay.textContent = notes; notesDisplay.style.display = 'block'; } else { notesDisplay.style.display = 'none'; }
        }
      }
      if (btnSave) btnSave.addEventListener('click', function() {
        if (_currentQuestionIdForNotes != null) {
          setQuestionNotes(_currentQuestionIdForNotes, notesTextarea.value);
          var notes = getQuestionNotes(_currentQuestionIdForNotes);
          if (notes) { notesDisplay.textContent = notes; notesDisplay.style.display = 'block'; } else { notesDisplay.style.display = 'none'; }
          showToast('Â§áÊ≥®Â∑≤‰øùÂ≠ò');
        }
        closeNotesEdit();
      });
      if (btnCancel) btnCancel.addEventListener('click', closeNotesEdit);
    })();
    document.getElementById('btn-restart').addEventListener('click', () => {
      showScreen(SCREEN.HOME);
      updateWrongCount();
      renderSavedSets();
      updateStatsBar();
      updateStartPracticeSelect();
    });
    document.getElementById('btn-back-home').addEventListener('click', () => {
      showScreen(SCREEN.HOME);
      updateWrongCount();
      renderSavedSets();
      updateStatsBar();
      updateStartPracticeSelect();
    });
    document.getElementById('btn-share-result').addEventListener('click', () => {
      const scoreEl = document.getElementById('result-score');
      const scoreText = scoreEl ? scoreEl.textContent.trim() : '0/0';
      const st = getDailyStats();
      const streak = st.streak || 0;
      const text = 'Fran√ßais Quiz ' + scoreText + 'ÔºåËøûÁª≠ ' + streak + ' Â§© ‚ú®';
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø')).catch(() => showToast('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂'));
      } else {
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.opacity = '0';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          showToast('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
        } catch (_) { showToast('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂'); }
      }
    });
    document.getElementById('format-doc').addEventListener('click', (e) => {
      if (e.target.closest('.format-doc-title')) document.getElementById('format-doc').classList.toggle('open');
    });
    const readAloudBtn = document.getElementById('btn-read-aloud');
    if (readAloudBtn) readAloudBtn.addEventListener('click', readAloudStem);
    document.addEventListener('keydown', onQuizKeydown);
    function debounce(fn, ms) {
      let t = null;
      return function() {
        if (t) clearTimeout(t);
        t = setTimeout(fn, ms);
      };
    }
    const searchInput = document.getElementById('saved-sets-search');
    if (searchInput) searchInput.addEventListener('input', debounce(renderSavedSets, 180));
    document.getElementById('saved-sets-list').addEventListener('click', handleSavedSetsAction);
    document.getElementById('btn-add-folder').addEventListener('click', () => {
      const name = prompt('ËæìÂÖ•Êñá‰ª∂Â§πÂêçÁß∞', '');
      if (name == null || !name.trim()) return;
      const trimmed = name.trim();
      setFolders(getFolders().concat([{ id: String(Date.now()), name: trimmed }]));
    });
    function startWrongBookDuePractice() {
      const due = getWrongBookDue();
      if (due.length === 0) {
        const total = getWrongBook().length;
        if (total === 0) showToast('ÈîôÈ¢òÊú¨ËøòÊòØÁ©∫ÁöÑÔºåÂ§öÂÅöÂá†ÈÅìÈ¢ò‰ºöËá™Âä®Âä†ÂÖ•');
        else showToast('Ê≤°ÊúâÂà∞ÊúüÈúÄË¶ÅÂ§ç‰π†ÁöÑÈîôÈ¢òÔºåÈîôÈ¢òÊú¨ÂÖ± ' + total + ' È¢ò');
        return;
      }
      const typeFilter = getSelectedTypeFilter();
      const filtered = filterQuestionsByType(due, typeFilter);
      if (filtered.length === 0) { showToast('ÂΩìÂâçÈÄâÈ¢òÂûã‰∏ãÊ≤°ÊúâÂà∞ÊúüÁöÑÈîôÈ¢òÔºåÊîπÂ§©ÂÜçËØï'); return; }
      startQuiz(filtered, true);
    }
    function startWrongBookFreePractice() {
      const book = getWrongBook();
      if (book.length === 0) { showToast('ÈîôÈ¢òÊú¨ËøòÊòØÁ©∫ÁöÑÔºåÂÅöÈîôÈ¢òÂêé‰ºöËá™Âä®Âä†ÂÖ•'); return; }
      const typeFilter = getSelectedTypeFilter();
      const filtered = filterQuestionsByType(book, typeFilter);
      if (filtered.length === 0) { showToast('ÂΩìÂâçÈÄâÈ¢òÂûã‰∏ãÊ≤°ÊúâÈîôÈ¢òÔºåËØ∑ÂãæÈÄâÊõ¥Â§öÈ¢òÂûã'); return; }
      startQuiz(filtered, true);
    }
    document.getElementById('btn-wrong-book').addEventListener('click', startWrongBookDuePractice);
    document.getElementById('btn-result-wrong').addEventListener('click', startWrongBookDuePractice);
    document.getElementById('btn-wrong-free').addEventListener('click', startWrongBookFreePractice);
    document.getElementById('btn-result-wrong-free').addEventListener('click', startWrongBookFreePractice);
    document.getElementById('btn-clear-wrong').addEventListener('click', () => {
      if (getWrongBook().length === 0) {
        showToast('ÈîôÈ¢òÊú¨Â∑≤ÁªèÊòØÁ©∫ÁöÑ‰∫Ü');
        return;
      }
      if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÈîôÈ¢òÊú¨ÂêóÔºüÊ∏ÖÁ©∫ÂêéÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ')) {
        setWrongBook([]);
      }
    });
    (function initTimerInput() {
      const el = document.getElementById('timer-seconds');
      if (el) {
        const saved = localStorage.getItem(TIMER_SECONDS_KEY);
        if (saved !== null) { const n = parseInt(saved, 10); if (!isNaN(n) && n >= 0) el.value = n; }
        el.addEventListener('change', () => {
          const n = Math.max(0, Math.min(120, parseInt(el.value, 10) || 0));
          el.value = n;
          localStorage.setItem(TIMER_SECONDS_KEY, n);
        });
      }
    })();

    document.getElementById('btn-one-save').addEventListener('click', saveToProjectFolder);
    document.getElementById('btn-copy-deploy-cmd').addEventListener('click', () => {
      const cmd = document.getElementById('save-deploy-cmd');
      const text = cmd ? cmd.textContent.trim() : './scripts/sync-and-push.sh ../french-quiz-pages';
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => showToast('Â§çÂà∂ÊàêÂäü')).catch(() => showToast('Â§çÂà∂Â§±Ë¥•'));
      } else {
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.opacity = '0';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          showToast('Â§çÂà∂ÊàêÂäü');
        } catch (_) { showToast('Â§çÂà∂Â§±Ë¥•'); }
      }
    });
    function confirmReviewStartQuiz() {
      if (_pendingReviewStart) {
        const p = _pendingReviewStart;
        hideReviewModal();
        startQuiz(p.questions, p.fromWrongBook, p.setId, p.noShuffle ? { noShuffle: true } : {});
      }
    }
    document.getElementById('btn-review-start-quiz').addEventListener('click', confirmReviewStartQuiz);
    document.getElementById('review-modal-overlay').addEventListener('click', (e) => {
      if (e.target.closest('#review-modal-images') && e.target.classList.contains('review-modal-img')) {
        e.preventDefault();
        e.stopPropagation();
        openImageLightbox(e.target.src);
        return;
      }
      if (e.target.id === 'review-modal-overlay') confirmReviewStartQuiz();
    });
    (function initStartModeModal() {
      const overlay = document.getElementById('start-mode-modal-overlay');
      const btnFull = document.getElementById('btn-start-mode-full');
      const btnSequential = document.getElementById('btn-start-mode-sequential');
      const countInput = document.getElementById('start-mode-count');
      const btnCancel = document.getElementById('btn-start-mode-cancel');
      const btnReset = document.getElementById('btn-start-mode-reset');
      const btnFullAfter = document.getElementById('btn-start-mode-full-after');
      function doStartFull() {
        if (!_pendingStartSet) return;
        const set = _pendingStartSet;
        const shuffleEl = document.getElementById('start-mode-shuffle');
        const shuffle = shuffleEl ? shuffleEl.checked : true;
        const opts = shuffle ? {} : { noShuffle: true };
        closeStartModeModal();
        if (hasReviewMaterial(set)) showReviewModal(set, set.questions, false, set.id, opts);
        else startQuiz(set.questions, false, set.id, opts);
      }
      function doStartSequential() {
        if (!_pendingStartSet || !countInput) return;
        const set = _pendingStartSet;
        const nextIdx = Math.max(0, parseInt(set.sequentialNextIndex, 10) || 0);
        const remain = set.questions.length - nextIdx;
        let n = Math.max(1, Math.min(remain, parseInt(countInput.value, 10) || 20));
        if (n > remain) n = remain;
        const slice = set.questions.slice(nextIdx, nextIdx + n);
        closeStartModeModal();
        startQuiz(slice, false, set.id, { noShuffle: true, sequentialBatch: { startIndex: nextIdx, count: slice.length } });
      }
      function doResetProgress() {
        if (!_pendingStartSet) return;
        const set = _pendingStartSet;
        const sets = getSavedSets();
        const updated = sets.map(s => String(s.id) === String(set.id) ? Object.assign({}, s, { sequentialNextIndex: 0 }) : s);
        setSavedSets(updated);
        closeStartModeModal();
        showToast('Â∑≤ÈáçÁΩÆËøõÂ∫¶Ôºå‰∏ãÊ¨°ÂèØ‰ªéÁ¨¨ 1 È¢òËµ∑ÊåâÈ°∫Â∫èÁªÉ‰π†');
      }
      if (btnFull) btnFull.addEventListener('click', doStartFull);
      if (btnSequential) btnSequential.addEventListener('click', doStartSequential);
      if (btnCancel) btnCancel.addEventListener('click', closeStartModeModal);
      if (btnReset) btnReset.addEventListener('click', doResetProgress);
      if (btnFullAfter) btnFullAfter.addEventListener('click', function() {
        if (!_pendingStartSet) return;
        const set = _pendingStartSet;
        const shuffleEl = document.getElementById('start-mode-shuffle');
        const shuffle = shuffleEl ? shuffleEl.checked : true;
        closeStartModeModal();
        startQuiz(set.questions, false, set.id, shuffle ? {} : { noShuffle: true });
      });
      if (overlay) overlay.addEventListener('click', function(e) {
        if (e.target.id === 'start-mode-modal-overlay') closeStartModeModal();
      });
    })();
    document.getElementById('image-lightbox-close').addEventListener('click', closeImageLightbox);
    document.getElementById('image-lightbox-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'image-lightbox-overlay') closeImageLightbox();
    });
    document.querySelector('.image-lightbox-content').addEventListener('click', (e) => e.stopPropagation());
    document.getElementById('btn-edit-set-save').addEventListener('click', saveEditSetModal);
    document.getElementById('btn-edit-set-cancel').addEventListener('click', closeEditSetModal);
    document.getElementById('btn-edit-set-export').addEventListener('click', exportFromEditModal);
    document.getElementById('btn-edit-set-append').addEventListener('click', appendToEditSetModal);
    document.getElementById('btn-edit-set-preview').addEventListener('click', () => {
      if (_editingSetId == null) return;
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === String(_editingSetId));
      if (set) showPreviewQuestions(set);
    });
    document.getElementById('btn-edit-set-delete').addEventListener('click', deleteFromEditModal);
    document.getElementById('btn-preview-questions-close').addEventListener('click', closePreviewQuestions);
    document.getElementById('preview-questions-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'preview-questions-overlay') closePreviewQuestions();
    });
    document.getElementById('edit-set-modal-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'edit-set-modal-overlay') closeEditSetModal();
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && _openModalOverlay) {
        var id = _openModalOverlay.id;
        if (id === 'review-modal-overlay') confirmReviewStartQuiz();
        else if (id === 'start-mode-modal-overlay') closeStartModeModal();
        else if (id === 'edit-set-modal-overlay') closeEditSetModal();
        else if (id === 'preview-questions-overlay') closePreviewQuestions();
        else if (id === 'image-lightbox-overlay') closeImageLightbox();
        e.preventDefault();
        return;
      }
      if (e.key !== 'Tab' || !_openModalOverlay) return;
      var focusable = getFocusableIn(_openModalOverlay);
      if (focusable.length === 0) return;
      var first = focusable[0], last = focusable[focusable.length - 1];
      if (e.shiftKey) {
        if (document.activeElement === first) { e.preventDefault(); last.focus(); }
      } else {
        if (document.activeElement === last) { e.preventDefault(); first.focus(); }
      }
    });
    (function initEditSetPasteZone() {
      const zone = document.getElementById('edit-set-paste-zone');
      if (!zone) return;
      zone.addEventListener('paste', function(e) {
        const items = e.clipboardData && e.clipboardData.items;
        if (!items) return;
        for (let i = 0; i < items.length; i++) {
          if (items[i].type.indexOf('image') !== -1) {
            e.preventDefault();
            const file = items[i].getAsFile();
            if (!file) continue;
            const reader = new FileReader();
            reader.onload = function() {
              const dataUrl = reader.result;
              if (dataUrl && typeof dataUrl === 'string') {
                _editModalPastedImages.push(dataUrl);
                renderEditModalPastedImages();
              }
            };
            reader.readAsDataURL(file);
            break;
          }
        }
      });
    })();
    document.getElementById('btn-load-cloud').addEventListener('click', loadFromCloud);
    document.getElementById('btn-open-folder').addEventListener('click', pickFolderAndLoad);
    document.getElementById('btn-save-to-folder').addEventListener('click', saveToProjectFolder);
    document.getElementById('btn-export-data').addEventListener('click', saveToProjectFolder);
    document.getElementById('btn-import-data').addEventListener('click', () => document.getElementById('file-import-data').click());
    document.getElementById('link-download-json').addEventListener('click', (e) => { e.preventDefault(); exportDataDownload(); });
    document.getElementById('file-import-data').addEventListener('change', function() {
      const file = this.files && this.files[0];
      if (file) importDataFromFile(file);
      this.value = '';
    });

    (function initImportLock() {
      updateImportLockUI();
      updateDeviceBindUI();
      const setBtn = document.getElementById('btn-import-lock-set');
      const changeBtn = document.getElementById('btn-import-lock-change');
      const disableBtn = document.getElementById('btn-import-lock-disable');
      if (setBtn) setBtn.addEventListener('click', async function() {
        if (!(window.crypto && crypto.subtle)) { showToast('ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅËÆæÁΩÆ PIN'); return; }
        const pin1 = prompt('ËØ∑ËÆæÂÆö 4ÔΩû12 ‰Ωç‰∏ª‰∫∫ PINÔºàÁî±‰Ω†Ëá™ÂÆöÔºå‰æãÂ¶ÇÊï∞Â≠óÊàñÂ≠óÊØçÔºåËØ∑Áâ¢ËÆ∞Ôºõ‰ªÖÊú¨Êú∫‰øùÂ≠òÔºâ');
        if (pin1 == null) return;
        const pin2 = prompt('ÂÜçÊ¨°ËæìÂÖ•Á°ÆËÆ§');
        if (pin1 !== pin2) { showToast('‰∏§Ê¨°ËæìÂÖ•‰∏ç‰∏ÄËá¥'); return; }
        if (pin1.length < 4 || pin1.length > 12) { showToast('ËØ∑ËÆæÁΩÆ 4ÔΩû12 ‰Ωç'); return; }
        await setImportPin(pin1);
        updateImportLockUI();
        showToast('Â∑≤ÂêØÁî®ÂØºÂÖ•‰øùÊä§');
      });
      if (changeBtn) changeBtn.addEventListener('click', async function() {
        if (!(window.crypto && crypto.subtle)) { showToast('ÂΩìÂâçÊµèËßàÂô®‰∏çÊîØÊåÅ'); return; }
        const cur = prompt('ËæìÂÖ•ÂΩìÂâç PIN');
        if (cur == null) return;
        if (!(await verifyImportPin(cur))) { showToast('ÂΩìÂâç PIN ÈîôËØØ'); return; }
        const pin1 = prompt('ËæìÂÖ•Êñ∞ PINÔºà4ÔΩû12 ‰ΩçÔºâ');
        if (pin1 == null) return;
        const pin2 = prompt('ÂÜçÊ¨°ËæìÂÖ•Êñ∞ PIN');
        if (pin1 !== pin2) { showToast('‰∏§Ê¨°ËæìÂÖ•‰∏ç‰∏ÄËá¥'); return; }
        if (pin1.length < 4 || pin1.length > 12) { showToast('ËØ∑ËÆæÁΩÆ 4ÔΩû12 ‰Ωç'); return; }
        await setImportPin(pin1);
        updateImportLockUI();
        showToast('Â∑≤‰øÆÊîπ PIN');
      });
      if (disableBtn) disableBtn.addEventListener('click', async function() {
        const cur = prompt('ËæìÂÖ•ÂΩìÂâç PIN ‰ª•ÂÖ≥Èó≠ÂØºÂÖ•‰øùÊä§');
        if (cur == null) return;
        if (!(await verifyImportPin(cur))) { showToast('PIN ÈîôËØØ'); return; }
        localStorage.removeItem(IMPORT_PIN_HASH_KEY);
        updateImportLockUI();
        showToast('Â∑≤ÂÖ≥Èó≠ÂØºÂÖ•‰øùÊä§');
      });
      const bindBtn = document.getElementById('btn-device-bind');
      const unbindBtn = document.getElementById('btn-device-unbind');
      if (bindBtn) bindBtn.addEventListener('click', function() {
        setImportAllowedFingerprintToThisDevice();
        updateDeviceBindUI();
        showToast('Â∑≤ÁªëÂÆöÊú¨Êú∫„ÄÇËØ∑„Äå‰∏ÄÈîÆ‰øùÂ≠ò„ÄçÂπ∂Êé®ÈÄÅÂà∞‰∫ëÁ´ØÔºåÂÖ∂‰ªñËÆæÂ§áÂ∞ÜÊó†Ê≥ïÂØºÂÖ•');
      });
      if (unbindBtn) unbindBtn.addEventListener('click', function() {
        localStorage.removeItem(IMPORT_ALLOWED_FINGERPRINT_KEY);
        updateDeviceBindUI();
        showToast('Â∑≤Ëß£Èô§ÁªëÂÆö„ÄÇËØ∑„Äå‰∏ÄÈîÆ‰øùÂ≠ò„ÄçÂπ∂Êé®ÈÄÅÂêéÔºåÊâÄÊúâËÆæÂ§áÂùáÂèØÂØºÂÖ•');
      });
    })();

    (function initTheme() {
      const theme = localStorage.getItem(THEME_KEY) || 'dark';
      if (theme === 'light') document.body.classList.add('theme-light');
      function setThemeColorMeta() {
        var meta = document.querySelector('meta[name="theme-color"]');
        if (meta) meta.content = document.body.classList.contains('theme-light') ? '#f8f7fc' : '#0c0a14';
      }
      setThemeColorMeta();
      const btn = document.getElementById('theme-toggle');
      if (btn) {
        btn.setAttribute('aria-pressed', theme === 'light' ? 'true' : 'false');
        btn.addEventListener('click', () => {
          document.body.classList.toggle('theme-light');
          const isLight = document.body.classList.contains('theme-light');
          localStorage.setItem(THEME_KEY, isLight ? 'light' : 'dark');
          btn.setAttribute('aria-pressed', isLight ? 'true' : 'false');
          setThemeColorMeta();
        });
      }
    })();
    updateWrongCount();
    renderSavedSets();
    updateStatsBar();
    updateStartPracticeSelect();
    renderFolderSelects();
    updateCategoryFilter();
    if (typeof performance !== 'undefined' && performance.mark) {
      performance.mark('app-ready');
      try { performance.measure('app-init', 'app-start', 'app-ready'); } catch (_) {}
    }
    if (typeof PerformanceObserver !== 'undefined') {
      try {
        var lcpObserver = new PerformanceObserver(function (list) {
          var entries = list.getEntries();
          if (entries.length > 0 && typeof performance !== 'undefined' && performance.mark) performance.mark('lcp');
        });
        lcpObserver.observe({ type: 'largest-contentful-paint', buffered: true });
      } catch (_) {}
    }
    const startSel = document.getElementById('start-practice-select');
    if (startSel) startSel.addEventListener('change', updateCategoryFilter);

    // Restore in-progress quiz
    (function checkSavedProgress() {
      const saved = getQuizProgress();
      if (saved && saved.questions && saved.questions.length > 0 && saved.index < saved.questions.length) {
        if (confirm('Ê£ÄÊµãÂà∞‰∏äÊ¨°Êú™ÂÆåÊàêÁöÑÁªÉ‰π†ÔºàÁ¨¨ ' + (saved.index + 1) + '/' + saved.questions.length + ' È¢òÔºâÔºåÊòØÂê¶ÁªßÁª≠Ôºü')) {
          state.questions = saved.questions;
          state.index = saved.index;
          state.score = saved.score;
          state.answered = false;
          state.timerSeconds = saved.timerSeconds;
          state.practicingWrongBook = saved.practicingWrongBook;
          state.practicedSetId = saved.practicedSetId;
          showScreen(SCREEN.QUIZ);
          renderQuestion();
        } else {
          clearQuizProgress();
        }
      }
    })();
  </script>
</body>
</html>
