<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=5.0, user-scalable=yes" />
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <meta name="theme-color" content="#0c0a14" />
  <meta name="description" content="æ³•è¯­ç»ƒä¹  Â· TCF å¡«ç©ºã€æ®µè½å¡«ç©ºã€å•é€‰ã€å¤šé€‰ï¼Œæ”¯æŒé”™é¢˜æœ¬ä¸Žä¹ é¢˜é›†ç®¡ç†" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self'; base-uri 'self';" />
  <title>FranÃ§ais Quiz Â· æ³•è¯­ç»ƒä¹ </title>
  <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJiZyIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+PHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6IzZkMjhkOSIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3R5bGU9InN0b3AtY29sb3I6IzhiNWNmNiIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgcng9IjgiIGZpbGw9InVybCgjYmcpIi8+PHJlY3QgeD0iOSIgeT0iOCIgd2lkdGg9IjMuMiIgaGVpZ2h0PSIxNiIgcng9IjEiIGZpbGw9IiNmZmYiLz48cmVjdCB4PSI5IiB5PSI4IiB3aWR0aD0iMTEiIGhlaWdodD0iMi44IiByeD0iMSIgZmlsbD0iI2ZmZiIvPjxyZWN0IHg9IjkiIHk9IjE1IiB3aWR0aD0iNi41IiBoZWlnaHQ9IjIuNiIgcng9IjEiIGZpbGw9IiNmZmYiLz48cGF0aCBkPSJNMTguNSA2LjJsMiAyLjIiIHN0cm9rZT0iI2ZmZiIgc3Ryb2tlLXdpZHRoPSIxLjQiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIvPjwvc3ZnPg==" type="image/svg+xml" />
  <link rel="icon" href="favicon.svg?v=3" type="image/svg+xml" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" as="style" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
  <noscript><link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet" /></noscript>
  <style>
    :root {
      --bg: #0c0a14;
      --card: #16141f;
      --surface: #1e1b28;
      --accent: #8b5cf6;
      --accent-hover: #a78bfa;
      --accent-soft: rgba(139, 92, 246, 0.15);
      --correct: #34d399;
      --wrong: #f87171;
      --option-a: #60a5fa;
      --option-b: #fbbf24;
      --option-c: #4ade80;
      --option-d: #fb923c;
      --text: #f5f3ff;
      --text-muted: #a1a1aa;
      --radius: 16px;
      --radius-sm: 10px;
      --shadow: 0 4px 24px rgba(0,0,0,0.25);
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.15);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.35);
      --border-subtle: rgba(255,255,255,0.06);
      --border-subtle-hover: rgba(255,255,255,0.08);
      --border-strong: rgba(255,255,255,0.1);
    }
    body.theme-light {
      --bg: #f8f7fc;
      --card: #fff;
      --surface: #f0eef8;
      --text: #1c1917;
      --text-muted: #78716c;
      --shadow: 0 4px 20px rgba(124, 58, 237, 0.08);
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
      --border-subtle: rgba(0,0,0,0.06);
      --border-subtle-hover: rgba(0,0,0,0.08);
      --border-strong: rgba(0,0,0,0.1);
      background: var(--bg);
      background-image: none;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    *:focus { outline: none; }
    *:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    @media (pointer: coarse) {
      .btn, .storage-card, .saved-sets-item .btn, .option { min-height: 44px; }
      .btn-read-aloud { min-height: 44px; }
      .theme-toggle { min-width: 44px; min-height: 44px; }
      .collapsible-toggle { min-height: 44px; }
    }
    @supports (-webkit-touch-callout: none) {
      /* iOS specific fixes */
      .container { -webkit-overflow-scrolling: touch; }
      input, textarea, select { 
        -webkit-appearance: none;
        appearance: none;
      }
    }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    html { 
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    body {
      overflow-x: hidden;
      font-family: 'Plus Jakarta Sans', 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      background-image:
        radial-gradient(ellipse 100% 60% at 50% -15%, rgba(139, 92, 246, 0.2), transparent 50%),
        radial-gradient(ellipse 70% 50% at 100% 80%, rgba(96, 165, 250, 0.12), transparent),
        radial-gradient(ellipse 50% 30% at 0% 60%, rgba(139, 92, 246, 0.08), transparent);
      transition: background 0.3s, color 0.3s;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem;
      padding-left: max(1.25rem, env(safe-area-inset-left));
      padding-right: max(1.25rem, env(safe-area-inset-right));
      padding-top: max(1.5rem, env(safe-area-inset-top));
      padding-bottom: max(1.25rem, env(safe-area-inset-bottom));
    }
    @media (min-width: 600px) {
      .container { padding: 2rem 1.5rem; }
    }
    @media (max-width: 380px) {
      .container { padding: 1rem 0.75rem; }
      header h1 { font-size: 1.35rem; }
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.75rem;
      padding-bottom: 1.25rem;
      border-bottom: 1px solid var(--border-subtle);
    }
    body.theme-light header { border-bottom-color: var(--border-subtle); }
    header .brand {
      text-align: left;
    }
    header h1 {
      font-size: 1.75rem;
      font-weight: 800;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, #c4b5fd 0%, #a78bfa 50%, #818cf8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    header p {
      color: var(--text-muted);
      font-size: 0.875rem;
      font-weight: 500;
      margin-top: 0.2rem;
    }
    .theme-toggle {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-strong);
      background: var(--surface);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.2s;
    }
    .theme-toggle:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
    body.theme-light .theme-toggle { border-color: var(--border-subtle-hover); background: var(--surface); }
    body.theme-light .question-card,
    body.theme-light .result-card { box-shadow: var(--shadow-sm); }
    body.theme-light .option { border-color: var(--border-subtle-hover); }
    body.theme-light .option:hover { background: rgba(0,0,0,0.04); }

    .stats-bar {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }
    .stats-bar span {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.6rem 1rem;
      background: var(--surface);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
    }
    body.theme-light .stats-bar span { border-color: var(--border-subtle); background: var(--card); }
    .stats-bar strong {
      color: var(--accent);
      font-weight: 700;
      margin-right: 0.15rem;
    }

    .home-section {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
      padding: 1.5rem;
      margin-bottom: 1.25rem;
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    @media (max-width: 480px) {
      .home-section { padding: 1rem; }
      .wrong-book-row .home-actions { flex-direction: column; }
      .wrong-book-row .btn { width: 100%; text-align: center; }
    }
    .home-section:hover {
      border-color: var(--border-subtle-hover);
      box-shadow: var(--shadow);
    }
    body.theme-light .home-section { border-color: var(--border-subtle); }
    body.theme-light .home-section:hover { border-color: var(--accent-soft); box-shadow: var(--shadow); }
    .home-section h2 {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.85rem;
    }

    .screen {
      display: none;
    }
    .screen.active {
      display: block;
      animation: fadeIn 0.35s ease;
      will-change: opacity, transform;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (prefers-reduced-motion: reduce) {
      .screen.active,
      .question-card.animate-in,
      .question-card.animate-out,
      .answer-feedback.correct-msg,
      .answer-feedback.wrong-msg,
      .option.correct,
      .option.wrong,
      .paragraph-blanks input.correct-blank,
      .paragraph-blanks input.wrong-blank,
      .fill-input-wrap input.correct-blank,
      .fill-input-wrap input.wrong-blank,
      .question-stem .blank.filled,
      .question-stem .blank.wrong,
      .question-card.answer-correct,
      .question-card.answer-wrong {
        animation: none !important;
        will-change: auto !important;
        transform: none !important;
      }
    }
    #screen-result.active {
      animation: fadeIn 0.4s ease;
    }
    #screen-result .result-card {
      animation: fadeIn 0.5s ease 0.1s both;
    }

    /* Question transitions */
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideOutLeft {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(-30px); }
    }
    .question-card.animate-in { 
      animation: slideInRight 0.3s ease forwards;
      will-change: transform, opacity;
    }
    .question-card.animate-out { 
      animation: slideOutLeft 0.2s ease forwards;
      will-change: transform, opacity;
    }

    /* Answer feedback animations */
    /* â”€â”€ Answer Feedback Animations â”€â”€ */
    @keyframes bounceIn {
      0% { transform: scale(0.8); opacity: 0; }
      50% { transform: scale(1.1); }
      70% { transform: scale(0.95); }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes shakeX {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
      20%, 40%, 60%, 80% { transform: translateX(8px); }
    }
    @keyframes correctPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(52, 211, 153, 0); }
    }
    @keyframes wrongPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.4); }
      50% { box-shadow: 0 0 0 8px rgba(248, 113, 113, 0); }
    }
    @keyframes correctGlow {
      0%, 100% { border-color: rgba(52, 211, 153, 0.3); }
      50% { border-color: rgba(52, 211, 153, 0.8); }
    }
    @keyframes wrongGlow {
      0%, 100% { border-color: rgba(248, 113, 113, 0.3); }
      50% { border-color: rgba(248, 113, 113, 0.8); }
    }
    .answer-feedback.correct-msg { 
      animation: bounceIn 0.5s ease, correctPulse 0.6s ease 0.1s;
      will-change: transform, opacity, box-shadow;
    }
    .answer-feedback.wrong-msg { 
      animation: shakeX 0.5s ease, wrongPulse 0.6s ease 0.1s;
      will-change: transform, box-shadow;
    }

    /* Option click effect */
    @keyframes optionPulse {
      0% { transform: scale(1); }
      50% { transform: scale(0.97); }
      100% { transform: scale(1); }
    }
    .option.just-selected { 
      animation: optionPulse 0.2s ease;
      will-change: transform;
    }
    .option.just-selected::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: var(--accent-soft);
      opacity: 0;
      animation: optionPulse 0.2s ease;
      pointer-events: none;
    }

    /* Stats bar number pop */
    @keyframes countPop {
      0% { transform: scale(1); }
      50% { transform: scale(1.25); color: var(--accent-hover); }
      100% { transform: scale(1); }
    }
    .stats-bar strong { display: inline-block; }
    .stats-bar strong.updated { animation: countPop 0.3s ease; }

    /* Circular timer ring */
    .timer-ring { flex-shrink: 0; }
    .timer-ring-fill { transition: stroke-dashoffset 1s linear, stroke 0.3s; }
    .timer-ring-fill.low { stroke: var(--wrong); }

    .home-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .home-actions .btn { min-height: 52px; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.95rem 1.5rem;
      min-height: 48px;
      font-size: 1rem;
      font-weight: 600;
      font-family: inherit;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(139, 92, 246, 0.35);
    }
    .btn:active { 
      transform: translateY(0);
      transition-duration: 0.1s;
    }
    .btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, #6366f1 100%);
      color: white;
      box-shadow: 0 4px 14px rgba(139, 92, 246, 0.4);
      position: relative;
      overflow: hidden;
    }
    .btn-primary:hover { box-shadow: 0 10px 32px rgba(139, 92, 246, 0.45); }
    .btn-primary:active {
      transform: translateY(0) scale(0.98);
    }
    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border-strong);
    }
    .btn-secondary:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
      box-shadow: 0 8px 24px rgba(139, 92, 246, 0.2);
    }
    body.theme-light .btn-secondary { background: var(--card); border-color: var(--border-strong); }
    body.theme-light .btn-secondary:hover { background: var(--surface); border-color: var(--accent); }

    .import-section {
      margin-top: 2rem;
      padding: 1.5rem;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-sm);
    }
    body.theme-light .import-section { border-color: var(--border-subtle); }
    .import-section h3 {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
    }
    .import-section textarea {
      width: 100%;
      min-height: 140px;
      padding: 0.85rem;
      font-family: inherit;
      font-size: 0.9rem;
      background: var(--surface);
      border: 1px solid var(--border-subtle-hover);
      border-radius: var(--radius-sm);
      color: var(--text);
      resize: vertical;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .import-section textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    body.theme-light .import-section textarea { background: var(--bg); border-color: var(--border-strong); }
    .import-section textarea::placeholder {
      color: var(--text-muted);
    }
    .import-section .hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    /* Quiz */
    .progress-wrap {
      margin-bottom: 1.25rem;
    }
    .progress-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }
    .progress-estimate {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }
    .progress-bar {
      height: 8px;
      background: var(--surface);
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid var(--border-subtle);
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #818cf8);
      border-radius: 999px;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 12px rgba(139, 92, 246, 0.5);
      will-change: width;
    }

    .question-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1.75rem;
      border: 1px solid var(--border-subtle);
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }
    .question-card.answer-correct {
      animation: cardCorrectFeedback 0.6s ease;
      border-color: rgba(52, 211, 153, 0.4);
      box-shadow: 0 4px 24px rgba(52, 211, 153, 0.2);
    }
    .question-card.answer-wrong {
      animation: cardWrongFeedback 0.6s ease;
      border-color: rgba(248, 113, 113, 0.4);
      box-shadow: 0 4px 24px rgba(248, 113, 113, 0.2);
    }
    @keyframes cardCorrectFeedback {
      0% { background: var(--card); }
      30% { background: rgba(52, 211, 153, 0.08); }
      100% { background: var(--card); }
    }
    @keyframes cardWrongFeedback {
      0%, 100% { background: var(--card); transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { background: rgba(248, 113, 113, 0.08); transform: translateX(-2px); }
      20%, 40%, 60%, 80% { background: rgba(248, 113, 113, 0.08); transform: translateX(2px); }
    }
    .question-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(180deg, var(--accent), #818cf8);
      border-radius: 4px 0 0 4px;
    }
    body.theme-light .question-card::before { opacity: 0.9; }
    .question-meta {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.5rem;
      letter-spacing: 0.03em;
    }
    .question-stem {
      font-size: 1.25rem;
      line-height: 1.65;
      margin-bottom: 1.25rem;
      font-weight: 500;
      letter-spacing: 0.01em;
    }
    @media (min-width: 480px) {
      .question-stem { font-size: 1.35rem; }
    }
    .question-stem .blank {
      display: inline-block;
      min-width: 120px;
      border-bottom: 2px solid var(--accent);
      margin: 0 4px;
      padding: 0 4px;
    }
    .question-stem .blank.filled {
      border-color: var(--correct);
      color: var(--correct);
      animation: blankCorrectReveal 0.5s ease;
      will-change: transform, box-shadow;
    }
    .question-stem .blank.wrong {
      border-color: var(--wrong);
      color: var(--wrong);
      animation: blankWrongReveal 0.5s ease;
      will-change: transform, box-shadow;
    }
    @keyframes blankCorrectReveal {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.4); }
      50% { transform: scale(1.05); box-shadow: 0 0 0 4px rgba(52, 211, 153, 0.2); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); }
    }
    @keyframes blankWrongReveal {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
      20%, 40%, 60%, 80% { transform: translateX(2px); }
    }
    .paragraph-blanks {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .paragraph-blanks input {
      width: 120px;
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      background: var(--surface);
      border: 2px solid var(--border-strong);
      border-radius: var(--radius-sm);
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    @media (max-width: 480px) {
      .paragraph-blanks input { width: 100%; max-width: 200px; }
    }
    body.theme-light .paragraph-blanks input { background: var(--card); border-color: var(--border-strong); }
    .paragraph-blanks input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    .paragraph-blanks input.correct-blank {
      border-color: var(--correct);
      background: rgba(16, 185, 129, 0.15);
      animation: inputCorrectReveal 0.5s ease;
      will-change: transform, box-shadow;
    }
    .paragraph-blanks input.wrong-blank {
      border-color: var(--wrong);
      background: rgba(239, 68, 68, 0.15);
      animation: inputWrongReveal 0.5s ease;
      will-change: transform, box-shadow;
    }
    @keyframes inputCorrectReveal {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.5); }
      50% { transform: scale(1.02); box-shadow: 0 0 0 6px rgba(52, 211, 153, 0.2); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); }
    }
    @keyframes inputWrongReveal {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
      20%, 40%, 60%, 80% { transform: translateX(3px); }
    }
    .fill-input-wrap input.correct-blank {
      border-color: var(--correct);
      background: rgba(16, 185, 129, 0.15);
      animation: inputCorrectReveal 0.5s ease;
      will-change: transform, box-shadow;
    }
    .fill-input-wrap input.wrong-blank {
      border-color: var(--wrong);
      background: rgba(239, 68, 68, 0.15);
      animation: inputWrongReveal 0.5s ease;
      will-change: transform, box-shadow;
    }

    .options {
      display: grid;
      contain: layout;
      grid-template-columns: 1fr 1fr;
      gap: 0.85rem;
    }
    @media (max-width: 480px) {
      /* åŸºç¡€å¸ƒå±€ä¼˜åŒ– */
      .options { grid-template-columns: 1fr; }
      .question-card { padding: 1.25rem; }
      .question-stem { font-size: 1rem; word-break: break-word; }
      .option { padding: 0.85rem 1rem; min-height: 48px; }
      .quiz-actions { flex-direction: column; align-items: stretch; gap: 0.75rem; }
      .quiz-actions-right { justify-content: space-between; width: 100%; }
      .quiz-actions .btn { min-width: 100px; flex: 1; min-height: 48px; }
      .result-actions { flex-direction: column; gap: 0.75rem; }
      .result-actions .btn { width: 100%; min-height: 48px; }
      
      /* è¾“å…¥æ¡†å’Œé€‰æ‹©æ¡†ä¼˜åŒ– */
      .timer-wrap input[type="number"] { 
        min-height: 44px; 
        font-size: 1rem; 
        padding: 0.6rem 0.75rem; 
        width: 5rem; 
      }
      .start-select-wrap select,
      .category-filter-wrap select {
        min-height: 48px;
        font-size: 1rem;
        padding: 0.75rem 1rem;
      }
      
      /* å¤é€‰æ¡†è§¦æ‘¸åŒºåŸŸä¼˜åŒ– */
      .shuffle-wrap { 
        padding: 0.5rem 0; 
        min-height: 48px; 
      }
      .shuffle-wrap label { 
        padding: 0.75rem 0; 
        min-height: 48px; 
        font-size: 0.95rem; 
        gap: 0.75rem;
      }
      .shuffle-wrap input[type="checkbox"] { 
        width: 22px; 
        height: 22px; 
        min-width: 22px; 
        min-height: 22px; 
      }
      .type-filter-row { 
        gap: 0.5rem; 
      }
      .type-filter-row label { 
        padding: 0.75rem 1rem; 
        min-height: 48px; 
        font-size: 1rem; 
        gap: 0.75rem; 
      }
      .type-filter-row input[type="checkbox"] { 
        width: 24px; 
        height: 24px; 
        min-width: 24px; 
        min-height: 24px; 
      }
      
      /* æŒ‰é’®ä¼˜åŒ– */
      .btn { 
        min-height: 48px; 
        padding: 0.85rem 1.25rem; 
        font-size: 1rem; 
      }
      .home-actions .btn { 
        min-height: 52px; 
        font-size: 1.05rem; 
      }
      
      /* æ¨¡æ€æ¡†ä¼˜åŒ– */
      .review-modal-overlay,
      .edit-set-modal-overlay,
      .start-mode-modal-overlay,
      .sync-text-modal-overlay {
        padding: 0.5rem;
        align-items: flex-end;
      }
      .review-modal,
      .edit-set-modal,
      .start-mode-modal,
      .sync-text-modal {
        max-width: 100%;
        max-height: 90vh;
        border-radius: var(--radius) var(--radius) 0 0;
        padding: 1.25rem;
        margin: 0;
      }
      .review-modal-body { 
        max-height: calc(90vh - 180px); 
      }
      .review-modal-texts-wrap { 
        max-height: 200px; 
        font-size: 0.95rem; 
      }
      .review-modal-links a {
        min-height: 48px;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
      }
      
      /* æ–‡æœ¬è¾“å…¥æ¡†ä¼˜åŒ– */
      .import-section textarea,
      .explanation-notes-textarea {
        min-height: 120px;
        font-size: 1rem;
        padding: 0.75rem;
        -webkit-appearance: none;
        appearance: none;
      }
      /* åŒæ­¥æ–‡æœ¬æ¨¡æ€æ¡†ä¼˜åŒ– */
      .sync-text-modal {
        padding: 1.25rem;
      }
      .sync-text-modal textarea {
        font-size: 0.9rem;
        padding: 0.75rem;
        min-height: 150px;
      }
      .sync-text-tabs {
        flex-direction: column;
        gap: 0;
      }
      .sync-text-tab {
        border-bottom: 1px solid var(--border-subtle);
        border-left: 2px solid transparent;
        text-align: left;
      }
      .sync-text-tab.active {
        border-left-color: var(--accent);
        border-bottom-color: var(--border-subtle);
      }
      .paragraph-blanks input,
      .fill-input-wrap input {
        min-height: 48px;
        font-size: 1rem;
        padding: 0.75rem 1rem;
        -webkit-appearance: none;
        appearance: none;
      }
      
      /* æŒ‰é’®è§¦æ‘¸åé¦ˆ */
      .btn:active {
        transform: scale(0.98);
        transition-duration: 0.1s;
      }
      .option:active {
        transform: scale(0.98);
      }
      
      /* æ¨¡æ€æ¡†æŒ‰é’®ä¼˜åŒ– */
      .start-mode-card-btn,
      .start-mode-review-toggle {
        min-height: 48px;
      }
      .start-mode-sequential-row input[type="number"] {
        min-height: 48px;
        font-size: 1rem;
        padding: 0.75rem 1rem;
      }
      
      /* é“¾æŽ¥è§¦æ‘¸åŒºåŸŸ */
      .review-modal-links a:active {
        background: var(--accent-soft);
        transform: scale(0.98);
      }
      
      /* ç»Ÿè®¡æ ä¼˜åŒ– */
      .stats-bar {
        gap: 0.5rem;
        font-size: 0.9rem;
      }
      .stats-bar span {
        padding: 0.5rem 0.75rem;
        min-height: 44px;
      }
      
      /* æŠ˜å æŒ‰é’®ä¼˜åŒ– */
      .collapsible-toggle {
        min-height: 48px;
        font-size: 0.95rem;
        padding: 0.75rem 0;
      }
    }
    @media (max-width: 360px) {
      .question-card { padding: 1rem; }
      .option-letter { width: 28px; height: 28px; font-size: 0.8rem; }
      .home-section { padding: 1rem; }
      .stats-bar { flex-direction: column; }
      .stats-bar span { width: 100%; }
    }
    .option {
      display: flex;
      align-items: center;
      gap: 0.85rem;
      padding: 1rem 1.25rem;
      min-height: 48px;
      background: var(--surface);
      border: 2px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s;
    }
    .option:hover {
      background: var(--accent-soft);
      border-color: var(--border-subtle-hover);
      transform: translateY(-1px);
    }
    .option.selected {
      border-color: var(--accent);
      background: var(--accent-soft);
      box-shadow: 0 0 0 1px var(--accent);
    }
    .option.correct {
      border-color: var(--correct);
      background: rgba(52, 211, 153, 0.12);
      animation: optionCorrectReveal 0.5s ease;
      will-change: transform, box-shadow;
    }
    .option.wrong {
      border-color: var(--wrong);
      background: rgba(248, 113, 113, 0.12);
      animation: optionWrongReveal 0.5s ease;
      will-change: transform, box-shadow;
    }
    @keyframes optionCorrectReveal {
      0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.5); }
      50% { transform: scale(1.03); box-shadow: 0 0 0 6px rgba(52, 211, 153, 0.2); }
      100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); }
    }
    @keyframes optionWrongReveal {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
      20%, 40%, 60%, 80% { transform: translateX(4px); }
    }
    .option.disabled {
      pointer-events: none;
      opacity: 0.65;
    }
    .option-letter {
      width: 34px;
      height: 34px;
      flex-shrink: 0;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
    }
    .option:nth-child(1) .option-letter { background: var(--option-a); color: #fff; }
    .option:nth-child(2) .option-letter { background: var(--option-b); color: #1a1a1a; }
    .option:nth-child(3) .option-letter { background: var(--option-c); color: #fff; }
    .option:nth-child(4) .option-letter { background: var(--option-d); color: #fff; }
    .option input {
      margin: 0;
      accent-color: var(--accent);
    }
    .option-label {
      flex: 1;
    }

    .fill-input-wrap {
      margin-top: 0.5rem;
    }
    .fill-input-wrap input {
      width: 100%;
      max-width: 280px;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      font-family: inherit;
      background: var(--surface);
      border: 2px solid var(--border-strong);
      border-radius: var(--radius-sm);
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    @media (max-width: 480px) {
      .fill-input-wrap input { max-width: 100%; }
    }
    .fill-input-wrap input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    body.theme-light .fill-input-wrap input { background: var(--card); border-color: var(--border-strong); }

    .answer-feedback {
      margin-top: 1rem;
      padding: 0.65rem 1rem;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 1rem;
      display: none;
    }
    .answer-feedback.correct-msg { background: rgba(52, 211, 153, 0.15); color: var(--correct); display: block; border: 1px solid rgba(52, 211, 153, 0.3); }
    .answer-feedback.wrong-msg { background: rgba(248, 113, 113, 0.15); color: var(--wrong); display: block; border: 1px solid rgba(248, 113, 113, 0.3); }
    .explanation-scroll-wrap {
      margin-top: 1.25rem;
      max-height: 40vh;
      overflow-y: auto;
      overflow-x: hidden;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(52, 211, 153, 0.25);
      background: rgba(52, 211, 153, 0.08);
    }
    body.theme-light .explanation-scroll-wrap { border-color: rgba(52, 211, 153, 0.3); background: rgba(52, 211, 153, 0.1); }
    .explanation-wrong-count {
      padding: 0 1.15rem 0.35rem;
      font-size: 0.8rem;
      color: var(--wrong);
    }
    body.theme-light .explanation-wrong-count { color: #dc2626; }
    .explanation {
      padding: 1rem 1.15rem;
      font-size: 0.9rem;
      line-height: 1.65;
      color: #6ee7b7;
      white-space: pre-wrap;
    }
    body.theme-light .explanation { color: #059669; }
    .explanation-notes-section { padding: 0 1.15rem 1rem; }
    .explanation-notes-section .explanation-notes-display {
      margin-bottom: 0.5rem;
      padding: 0.75rem 1rem;
      background: var(--surface);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
      font-size: 0.88rem;
      line-height: 1.6;
      color: var(--text);
      white-space: pre-wrap;
      max-height: 20vh;
      overflow-y: auto;
    }
    body.theme-light .explanation-notes-section .explanation-notes-display { background: var(--card); border-color: var(--border-strong); }
    .explanation-notes-section .explanation-notes-display::before { content: 'æˆ‘çš„å¤‡æ³¨ï¼š'; font-weight: 600; color: var(--accent); display: block; margin-bottom: 0.35rem; }
    .explanation-notes-edit-btn { margin-top: 0.25rem; }
    .explanation-notes-edit { margin-top: 0.5rem; }
    .explanation-notes-textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      line-height: 1.55;
      font-family: inherit;
      background: var(--surface);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-sm);
      color: var(--text);
      resize: vertical;
      min-height: 100px;
      max-height: 30vh;
      display: block;
      box-sizing: border-box;
    }
    body.theme-light .explanation-notes-textarea { background: var(--card); border-color: var(--border-strong); }
    .explanation-notes-edit-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .wrong-book-remove-wrap { margin-top: 0.75rem; }
    .remove-from-set-wrap { margin-top: 0.5rem; }
    .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.85rem; min-height: auto; }

    .quiz-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1.5rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .quiz-actions-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .quiz-actions .btn {
      min-width: 120px;
    }
    .quiz-actions #btn-exit-quiz { min-width: auto; }
    .quiz-shortcut-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      width: 100%;
    }

    .timer-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .timer-wrap label { font-size: 0.9rem; color: var(--text-muted); }
    .timer-wrap input[type="number"] {
      width: 4rem;
      padding: 0.45rem 0.5rem;
      font-size: 0.9rem;
      background: var(--surface);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-sm);
      color: var(--text);
    }
    body.theme-light .timer-wrap input[type="number"] { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .shuffle-wrap { display: flex; align-items: center; gap: 0.4rem; }
    .shuffle-wrap input[type="checkbox"] { 
      accent-color: var(--accent); 
      cursor: pointer; 
      width: 18px; 
      height: 18px; 
      min-width: 18px; 
      min-height: 18px; 
      flex-shrink: 0;
    }
    .shuffle-wrap label { 
      font-size: 0.85rem; 
      color: var(--text-muted); 
      cursor: pointer; 
      padding: 0.5rem 0; 
      min-height: 44px; 
      display: flex; 
      align-items: center; 
      -webkit-tap-highlight-color: transparent;
    }
    .type-filter-wrap { margin-top: 0.75rem; }
    .type-filter-wrap .type-filter-label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.4rem; }
    .type-filter-row { display: flex; flex-wrap: wrap; gap: 0.75rem 1.25rem; align-items: center; }
    .type-filter-row label { 
      display: flex; 
      align-items: center; 
      gap: 0.5rem; 
      font-size: 0.9rem; 
      color: var(--text); 
      cursor: pointer; 
      padding: 0.5rem 0.75rem; 
      min-height: 44px; 
      border-radius: var(--radius-sm);
      transition: background-color 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .type-filter-row label:active { background-color: var(--accent-soft); }
    .type-filter-row input[type="checkbox"] { 
      accent-color: var(--accent); 
      cursor: pointer; 
      width: 20px; 
      height: 20px; 
      min-width: 20px; 
      min-height: 20px; 
      flex-shrink: 0;
    }
    .start-select-wrap { margin-bottom: 0.75rem; }
    .category-filter-wrap { margin-bottom: 0.75rem; }
    .category-filter-wrap label { display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .category-filter-wrap select {
      width: 100%;
      max-width: 320px;
      padding: 0.65rem 0.85rem;
      font-size: 0.95rem;
      font-family: inherit;
      background: var(--surface);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-sm);
      color: var(--text);
      cursor: pointer;
    }
    body.theme-light .category-filter-wrap select { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .start-select-wrap label { display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .start-select-wrap select {
      width: 100%;
      max-width: 320px;
      padding: 0.65rem 0.85rem;
      font-size: 0.95rem;
      font-family: inherit;
      background: var(--surface);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-sm);
      color: var(--text);
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .start-select-wrap select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
    }
    body.theme-light .start-select-wrap select { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .quiz-timer {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent);
      min-width: 2.5rem;
    }
    .quiz-timer.low { color: var(--wrong); }
    .question-stem-wrap { position: relative; }
    .btn-read-aloud {
      margin-top: 0.5rem;
      padding: 0.4rem 0.85rem;
      font-size: 0.85rem;
      font-weight: 500;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-strong);
      background: var(--surface);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-read-aloud:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }
    body.theme-light .btn-read-aloud { background: var(--card); border-color: var(--border-strong); }
    .result-celebration {
      font-size: 1.35rem;
      margin-top: 0.75rem;
      color: var(--correct);
      font-weight: 700;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.02); }
    }
    .saved-sets-search { margin-bottom: 1rem; }
    .saved-sets-search input {
      width: 100%;
      padding: 0.65rem 1rem 0.65rem 2.25rem;
      font-size: 0.9rem;
      background: var(--surface);
      border: 1px solid var(--border-strong);
      border-radius: 10px;
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .saved-sets-search input::placeholder { color: var(--text-muted); }
    .saved-sets-search input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    body.theme-light .saved-sets-search input { background: var(--card); }
    .saved-sets-search-wrap { position: relative; }
    .saved-sets-search-wrap::before {
      content: 'ðŸ”';
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.9rem;
      opacity: 0.6;
      pointer-events: none;
    }
    body.theme-light .saved-sets-search input { border-color: rgba(0,0,0,0.12); }

    /* Result */
    .result-card {
      text-align: center;
      padding: 2.5rem 2rem;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow);
      position: relative;
      overflow: visible;
    }
    .result-card .result-confetti { border-radius: var(--radius); }
    .result-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), #818cf8);
    }
    .result-score {
      font-size: 3.25rem;
      font-weight: 800;
      letter-spacing: -0.03em;
      background: linear-gradient(135deg, #c4b5fd, #a78bfa 40%, #818cf8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      line-height: 1.1;
    }
    .result-pct {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent);
      margin: -0.25rem 0 0.5rem;
    }
    .result-desc {
      color: var(--text-muted);
      font-size: 1.05rem;
      font-weight: 500;
      margin-bottom: 1.5rem;
    }
    .result-confetti {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      border-radius: inherit;
    }
    .result-confetti span {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: confetti 2.5s ease-out forwards;
      opacity: 0;
    }
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-120px) rotate(720deg); opacity: 0; }
    }
    .result-card .btn {
      margin-top: 0.5rem;
    }
    .result-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
      margin-top: 1.25rem;
    }
    .result-shortcut-hint {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin: 0.75rem 0 0;
      text-align: center;
    }
    .wrong-book-btn { background: rgba(248, 113, 113, 0.15); color: #fca5a5; border: 1px solid rgba(248, 113, 113, 0.35); }
    .wrong-book-btn:hover { background: rgba(248, 113, 113, 0.25); box-shadow: 0 4px 16px rgba(248, 113, 113, 0.2); }
    .result-recent {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-subtle);
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .result-recent-title { font-weight: 600; margin-bottom: 0.35rem; }
    .result-recent ul { list-style: none; }
    .result-recent li { padding: 0.2rem 0; }

    /* â”€â”€ Unified collapsible / accordion system â”€â”€ */
    .collapsible-toggle {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0;
      margin: 0 0 0.5rem;
      background: none;
      border: none;
      color: var(--text-muted);
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      cursor: pointer;
      user-select: none;
      transition: color 0.2s;
      text-align: left;
    }
    .collapsible-toggle:hover { color: var(--text); }
    .collapsible-toggle:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
      border-radius: 4px;
    }
    .collapsible-chevron {
      display: inline-block;
      font-size: 0.65rem;
      transition: transform 0.25s ease;
      flex-shrink: 0;
    }
    .collapsible-toggle[aria-expanded="true"] .collapsible-chevron {
      transform: rotate(90deg);
    }
    .collapsible-body {
      display: grid;
      grid-template-rows: 0fr;
      transition: grid-template-rows 0.3s ease;
      overflow: hidden;
    }
    .collapsible-body > .collapsible-inner {
      overflow: hidden;
      min-height: 0;
    }
    .collapsible-body.open {
      grid-template-rows: 1fr;
    }
    @media (prefers-reduced-motion: reduce) {
      .collapsible-body { transition: none; }
    }

    /* â”€â”€ Wrong book row (merged into start-practice) â”€â”€ */
    .wrong-book-row {
      margin-top: 1rem;
      padding-top: 0.85rem;
      border-top: 1px solid var(--border-subtle);
    }
    .wrong-book-row-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }
    .wrong-book-row .home-actions { gap: 0.5rem; }
    .wrong-book-row .btn { font-size: 0.88rem; padding: 0.65rem 1rem; }

    /* â”€â”€ Format doc (uses collapsible system) â”€â”€ */
    .format-doc {
      margin-top: 1.5rem;
      padding: 1.25rem;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
    }
    body.theme-light .format-doc { border-color: var(--border-subtle); }
    .format-doc .collapsible-toggle {
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .format-doc-content { 
      font-size: 0.8rem; 
      line-height: 1.7; 
      color: var(--text-muted); 
      max-height: 320px; 
      overflow-y: auto; 
      overflow-x: hidden;
    }
    .format-doc pre {
      background: var(--bg);
      padding: 0.75rem;
      border-radius: 8px;
      overflow-x: auto;
      margin: 0.5rem 0;
      font-size: 0.75rem;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .format-doc .type-tag { color: var(--accent); font-weight: 600; }
    .format-doc-hint { margin-top: 0.75rem; padding-top: 0.5rem; border-top: 1px solid var(--border-subtle); font-size: 0.8rem; }
    .format-doc-hint code { font-size: 0.75em; padding: 0.1em 0.35em; background: var(--surface); border-radius: 4px; }

    .saved-sets {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-sm);
    }
    body.theme-light .saved-sets { border-color: var(--border-subtle); }
    .saved-sets h3 {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-muted);
      letter-spacing: 0.03em;
      margin-bottom: 0.85rem;
    }
    .saved-sets-folders-bar { display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem 0.75rem; margin-bottom: 0.75rem; }
    .saved-sets-folders-label { font-size: 0.85rem; color: var(--text-muted); }
    .saved-sets-folder-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .folder-tag { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.65rem; background: var(--surface); border: 1px solid var(--border-strong); border-radius: 6px; font-size: 0.85rem; color: var(--text); box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
    .folder-tag .folder-tag-icon { width: 16px; height: 16px; flex-shrink: 0; opacity: 0.9; }
    .folder-tag .folder-tag-icon svg { width: 100%; height: 100%; fill: var(--accent); }
    .folder-tag .folder-tag-name { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .folder-tag .folder-tag-edit, .folder-tag .folder-tag-delete { min-width: 44px; min-height: 44px; padding: 0 0.35rem; font-size: 0.9rem; line-height: 1; background: none; border: none; color: var(--text-muted); cursor: pointer; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; }
    .folder-tag .folder-tag-edit:hover, .folder-tag .folder-tag-delete:hover { color: var(--text); }
    .folder-tag .folder-tag-delete:hover { color: #f87171; }
    body.theme-light .folder-tag { border-color: var(--border-strong); box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
    .saved-sets-folder { margin-bottom: 0.75rem; border-radius: var(--radius-sm); border: 1px solid var(--border-subtle-hover); background: var(--surface); overflow: hidden; }
    .saved-sets-folder:last-child { margin-bottom: 0; }
    body.theme-light .saved-sets-folder { border-color: var(--border-subtle-hover); background: var(--bg); }
    .saved-sets-folder-header { display: flex; align-items: center; gap: 0.25rem; width: 100%; padding: 0; background: rgba(139, 92, 246, 0.08); color: var(--text); }
    .saved-sets-folder-header:hover { background: rgba(139, 92, 246, 0.14); }
    body.theme-light .saved-sets-folder-header { background: rgba(139, 92, 246, 0.06); }
    body.theme-light .saved-sets-folder-header:hover { background: rgba(139, 92, 246, 0.12); }
    .saved-sets-folder-toggle { display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 0; padding: 0.6rem 0.85rem; border: none; background: none; color: inherit; font-size: 0.9rem; font-weight: 600; text-align: left; cursor: pointer; }
    .saved-sets-folder-header .folder-icon-wrap { width: 20px; height: 20px; flex-shrink: 0; }
    .saved-sets-folder-header .folder-icon-wrap svg { width: 100%; height: 100%; fill: var(--accent); }
    .saved-sets-folder-header .saved-sets-folder-name { flex: 1; min-width: 0; }
    .saved-sets-folder-header .folder-chevron { font-size: 0.7rem; opacity: 0.8; transition: transform 0.2s; flex-shrink: 0; }
    .saved-sets-folder-collapsed .saved-sets-folder-header .folder-chevron { transform: rotate(-90deg); }
    .saved-sets-folder-header .folder-header-edit, .saved-sets-folder-header .folder-header-delete { min-width: 44px; min-height: 44px; padding: 0 0.5rem; margin-right: 0.25rem; font-size: 0.85rem; background: none; border: none; color: var(--text-muted); cursor: pointer; border-radius: 4px; flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center; }
    .saved-sets-folder-header .folder-header-edit:hover, .saved-sets-folder-header .folder-header-delete:hover { color: var(--text); }
    .saved-sets-folder-header .folder-header-delete:hover { color: #f87171; }
    .saved-sets-folder-body { border-top: 1px solid var(--border-subtle); }
    .saved-sets-folder-collapsed .saved-sets-folder-body { display: none; }
    .saved-sets-folder-body .saved-sets-list { padding: 0.5rem 0.75rem 0.75rem; gap: 0.5rem; }
    .saved-sets-folder-body .saved-sets-item { margin: 0; }
    .saved-sets-show-more-wrap { margin-top: 0.75rem; text-align: center; }
    .saved-sets-show-more { min-width: 160px; }
    .saved-sets-list-wrap {
      max-height: 320px;
      overflow-y: auto;
      overflow-x: hidden;
      margin: 0 -0.25rem 0 0;
      padding-right: 0.25rem;
    }
    .saved-sets-list-wrap::-webkit-scrollbar { width: 6px; }
    .saved-sets-list-wrap::-webkit-scrollbar-track { background: transparent; border-radius: 3px; }
    .saved-sets-list-wrap::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    body.theme-light .saved-sets-list-wrap::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); }
    .saved-sets-list { list-style: none; display: flex; flex-direction: column; gap: 0.65rem; contain: layout; }
    .saved-sets-item {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 1.15rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
      background: var(--surface);
      flex-wrap: wrap;
      transition: all 0.2s;
    }
    .saved-sets-item:hover {
      border-color: rgba(139, 92, 246, 0.35);
      background: var(--accent-soft);
      box-shadow: var(--shadow-sm);
    }
    body.theme-light .saved-sets-item { border-color: var(--border-subtle-hover); background: var(--bg); }
    body.theme-light .saved-sets-item:hover { border-color: var(--accent); background: var(--surface); }
    .saved-sets-item-content { flex: 1; min-width: 0; }
    .saved-sets-item .name {
      display: block;
      font-weight: 600;
      font-size: 1rem;
      color: var(--text);
      margin-bottom: 0.35rem;
      line-height: 1.4;
    }
    .saved-sets-item .meta {
      font-size: 0.8rem;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.35rem;
    }
    .saved-sets-item .meta span { white-space: nowrap; }
    .saved-sets-item .meta .dot { opacity: 0.5; user-select: none; }
    .saved-sets-item .actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
    .saved-sets-item .btn { padding: 0.45rem 0.9rem; font-size: 0.85rem; border-radius: 8px; }
    .saved-sets-item .btn[data-action="edit"] { color: var(--text-muted); border-color: rgba(255,255,255,0.15); }
    .saved-sets-item .btn[data-action="edit"]:hover { color: var(--accent); border-color: var(--accent); }
    .saved-sets-item .btn[data-action="delete"] { color: var(--text-muted); border-color: var(--border-strong); }
    .saved-sets-item .btn[data-action="delete"]:hover { color: #f87171; border-color: rgba(248,113,113,0.5); background: rgba(248,113,113,0.08); }
    .saved-sets-item .btn[data-action="export"] { color: var(--text-muted); border-color: var(--border-strong); }
    .saved-sets-item .btn[data-action="export"]:hover { color: var(--accent); border-color: var(--accent); }
    body.theme-light .saved-sets-item .btn[data-action="edit"] { border-color: rgba(0,0,0,0.15); }
    body.theme-light .saved-sets-item .btn[data-action="delete"] { border-color: var(--border-strong); }
    body.theme-light .saved-sets-item .btn[data-action="export"] { border-color: var(--border-strong); }
    .saved-sets-empty { font-size: 0.9rem; color: var(--text-muted); padding: 1rem 0; text-align: center; }
    .import-name-wrap { margin-top: 0.75rem; }
    .import-name-wrap label { display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .import-name-wrap input { width: 100%; max-width: 320px; padding: 0.5rem 0.75rem; font-size: 0.9rem; background: var(--surface); border: 1px solid var(--border-strong); border-radius: 8px; color: var(--text); }
    .import-folder-label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; margin-bottom: 0.35rem; }
    .import-name-wrap select { max-width: 280px; padding: 0.5rem 0.75rem; font-size: 0.9rem; background: var(--surface); border: 1px solid var(--border-strong); border-radius: 8px; color: var(--text); }
    body.theme-light .import-name-wrap input { background: var(--card); border-color: var(--border-strong); }
    body.theme-light .import-name-wrap select { background: var(--card); border-color: var(--border-strong); }
    .import-review-wrap { margin-top: 0.75rem; }
    .import-review-wrap label { display: block; font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .import-review-wrap textarea { width: 100%; max-width: 100%; padding: 0.5rem 0.75rem; font-size: 0.85rem; font-family: inherit; background: var(--surface); border: 1px solid var(--border-strong); border-radius: 8px; color: var(--text); resize: vertical; min-height: 4rem; }
    body.theme-light .import-review-wrap textarea { background: var(--card); border-color: var(--border-strong); }
    .import-dup-hint { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem; }
    .storage-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; line-height: 1.5; }
    .storage-desc code { font-size: 0.75em; padding: 0.15em 0.4em; background: var(--bg); border-radius: 4px; }
    .storage-security-hint { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; padding: 0.65rem 0.85rem; background: var(--surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); line-height: 1.5; }
    .storage-security-hint strong { color: var(--text); }
    body.theme-light .storage-security-hint { background: var(--surface); border-color: var(--border-subtle); }
    .btn-one-save {
      width: 100%;
      margin-bottom: 1rem;
      min-height: 48px;
      font-size: 1rem;
    }
    .storage-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.75rem;
    }
    @media (max-width: 600px) {
      .storage-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
    }
    @media (max-width: 420px) {
      .storage-grid { grid-template-columns: 1fr; }
    }
    .storage-card {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      text-align: left;
      padding: 1.1rem 1.2rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
      background: var(--surface);
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    body.theme-light .storage-card { border-color: var(--border-subtle-hover); background: var(--card); }
    .storage-card:hover {
      border-color: var(--accent);
      background: var(--accent-soft);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    body.theme-light .storage-card:hover { background: var(--surface); border-color: var(--accent); }
    .storage-card .title { font-weight: 600; font-size: 0.9rem; color: var(--text); }
    .storage-card .hint { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.35rem; line-height: 1.4; }
    .save-success-tip {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--surface);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: var(--radius-sm);
    }
    body.theme-light .save-success-tip { border-color: rgba(124, 58, 237, 0.35); background: var(--card); }
    .save-success-tip-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.35rem; }
    .save-success-tip-desc { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; }
    .save-success-tip-cmd-wrap { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    .save-success-tip-cmd {
      flex: 1;
      min-width: 0;
      font-size: 0.8rem;
      padding: 0.5rem 0.6rem;
      background: var(--bg);
      border-radius: 6px;
      word-break: break-all;
    }
    body.theme-light .save-success-tip-cmd { background: var(--surface); }
    .save-success-tip-extra { font-size: 0.8rem; color: var(--text-muted); }
    .import-lock-wrap { margin-top: 1rem; padding: 0.75rem 0.9rem; background: var(--surface); border: 1px solid var(--border-subtle); border-radius: var(--radius-sm); }
    .import-lock-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; line-height: 1.45; }
    .import-lock-per-device { display: inline-block; margin-top: 0.35rem; font-size: 0.75rem; opacity: 0.9; }
    .import-device-bind { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle); }
    .import-lock-status { display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
    .import-lock-status #import-lock-status-text { font-size: 0.85rem; color: var(--text-muted); }
    .import-lock-btns { display: flex; gap: 0.4rem; }
    body.theme-light .import-lock-wrap { background: var(--surface); border-color: var(--border-subtle); }
    .storage-fallback { margin-top: 0.75rem; font-size: 0.8rem; color: var(--text-muted); }
    .storage-fallback a { color: var(--accent); text-decoration: none; }
    .storage-fallback a:hover { text-decoration: underline; }
    input[type="file"]#file-import-data { display: none; }

    /* Review materials modal */
    .review-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      padding-left: max(1rem, env(safe-area-inset-left));
      padding-right: max(1rem, env(safe-area-inset-right));
      padding-bottom: max(1rem, env(safe-area-inset-bottom));
      -webkit-overflow-scrolling: touch;
      overflow-y: auto;
    }
    .review-modal-overlay.show { display: flex; }
    .review-modal {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-strong);
      padding: 1.5rem;
      max-width: 420px;
      width: 100%;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
    }
    body.theme-light .review-modal { border-color: var(--border-strong); }
    .review-modal h3 { font-size: 1rem; margin-bottom: 1rem; color: var(--text); }
    .review-modal-body { flex: 1; overflow-y: auto; margin-bottom: 1rem; display: flex; flex-direction: column; gap: 1rem; }
    .review-modal-texts-wrap { max-height: 180px; overflow-y: auto; border-radius: var(--radius-sm); border: 1px solid var(--border-subtle); background: var(--surface); padding: 0.6rem 0.75rem; }
    body.theme-light .review-modal-texts-wrap { border-color: var(--border-subtle-hover); }
    .review-modal-texts { font-size: 0.9rem; line-height: 1.6; color: var(--text); white-space: pre-wrap; word-break: break-word; }
    .review-modal-texts .review-text-block { margin-bottom: 0.75rem; }
    .review-modal-texts .review-text-block:last-child { margin-bottom: 0; }
    .review-modal-links { display: flex; flex-direction: column; gap: 0.5rem; }
    .review-modal-links a {
      display: block;
      padding: 0.6rem 0.75rem;
      background: var(--surface);
      border-radius: var(--radius-sm);
      color: var(--accent);
      text-decoration: none;
      font-size: 0.9rem;
      word-break: break-all;
      border: 1px solid var(--border-subtle);
      transition: background 0.2s, border-color 0.2s;
    }
    .review-modal-links a:hover { background: var(--accent-soft); border-color: var(--accent); }
    body.theme-light .review-modal-links a { border-color: var(--border-subtle-hover); }
    .review-modal-links .review-modal-msg {
      display: block;
      padding: 0.6rem 0.75rem;
      background: var(--surface);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      line-height: 1.5;
      word-break: break-word;
      white-space: pre-wrap;
      color: var(--text);
      border: 1px solid var(--border-subtle);
    }
    body.theme-light .review-modal-links .review-modal-msg { border-color: var(--border-subtle-hover); }
    .review-modal-actions { display: flex; gap: 0.75rem; flex-shrink: 0; }
    .review-modal-actions .btn { flex: 1; }

    /* Edit set modal */
    .edit-set-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1001;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      padding-left: max(1rem, env(safe-area-inset-left));
      padding-right: max(1rem, env(safe-area-inset-right));
      padding-bottom: max(1rem, env(safe-area-inset-bottom));
      -webkit-overflow-scrolling: touch;
      overflow-y: auto;
    }
    .edit-set-modal-overlay.show { display: flex; }
    .edit-set-modal {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-strong);
      padding: 1.5rem;
      max-width: 440px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }
    body.theme-light .edit-set-modal { border-color: var(--border-strong); }
    .edit-set-modal h3 { font-size: 1rem; margin-bottom: 1.25rem; color: var(--text); }
    .edit-set-field { margin-bottom: 1rem; }
    .edit-set-field label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .edit-set-field input,
    .edit-set-field select,
    .edit-set-field textarea {
      width: 100%;
      padding: 0.55rem 0.75rem;
      font-size: 0.9rem;
      font-family: inherit;
      background: var(--surface);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-sm);
      color: var(--text);
    }
    .edit-set-field textarea { resize: vertical; min-height: 4.5rem; }
    body.theme-light .edit-set-field input,
    body.theme-light .edit-set-field select,
    body.theme-light .edit-set-field textarea { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .edit-set-meta { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem; }
    .edit-set-append .btn { margin-top: 0.5rem; }
    .edit-set-review-label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.5rem; }
    .edit-set-review-row { margin-bottom: 0.75rem; }
    .edit-set-review-row label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; }
    .edit-set-review-row textarea { width: 100%; padding: 0.5rem 0.75rem; font-size: 0.85rem; font-family: inherit; background: var(--surface); border: 1px solid var(--border-strong); border-radius: var(--radius-sm); color: var(--text); resize: vertical; }
    body.theme-light .edit-set-review-row textarea { background: var(--card); border-color: rgba(0,0,0,0.12); }
    .edit-set-paste-images { margin-top: 0.5rem; }
    .edit-set-paste-images-hint { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .edit-set-paste-zone {
      min-height: 56px;
      padding: 0.5rem 0.75rem;
      border: 2px dashed rgba(255,255,255,0.2);
      border-radius: var(--radius-sm);
      background: var(--surface);
      color: var(--text-muted);
      font-size: 0.85rem;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .edit-set-paste-zone:hover { border-color: var(--accent); background: var(--accent-soft); color: var(--text); }
    .edit-set-paste-zone:focus { outline: none; border-color: var(--accent); }
    body.theme-light .edit-set-paste-zone { border-color: rgba(0,0,0,0.15); background: var(--card); }
    .edit-set-pasted-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
    .edit-set-pasted-item { position: relative; flex-shrink: 0; }
    .edit-set-pasted-item img { display: block; max-width: 80px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-strong); }
    .edit-set-pasted-item .edit-set-pasted-remove { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; border-radius: 50%; border: none; background: rgba(0,0,0,0.6); color: #fff; font-size: 14px; line-height: 1; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; }
    .review-modal-links .review-modal-img { max-width: 100%; max-height: 280px; display: block; border-radius: var(--radius-sm); margin-top: 0.25rem; }
    .review-modal-images { display: flex; flex-direction: column; gap: 0.5rem; }
    .review-modal-images .review-modal-msg { margin: 0; }
    .review-modal-images .review-modal-img { max-width: 100%; max-height: 240px; display: block; border-radius: var(--radius-sm); cursor: pointer; }
    .review-modal-images .review-modal-msg { cursor: pointer; }
    .image-lightbox-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 2rem; box-sizing: border-box; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; }
    .image-lightbox-overlay.show { opacity: 1; visibility: visible; }
    .image-lightbox-overlay .image-lightbox-content { position: relative; max-width: 95vw; max-height: 95vh; display: flex; align-items: center; justify-content: center; }
    .image-lightbox-overlay .image-lightbox-content img { max-width: 95vw; max-height: 95vh; width: auto; height: auto; object-fit: contain; border-radius: var(--radius-sm); box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
    .image-lightbox-overlay .image-lightbox-close { position: absolute; top: -2.5rem; right: 0; min-width: 44px; min-height: 44px; width: 2.5rem; height: 2.5rem; border: none; background: rgba(255,255,255,0.2); color: #fff; font-size: 1.25rem; line-height: 1; cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; padding: 0; }
    .image-lightbox-overlay .image-lightbox-close:hover { background: rgba(255,255,255,0.35); }
    .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); padding: 0.65rem 1.25rem; background: var(--surface); border: 1px solid var(--border-strong); border-radius: 999px; color: var(--text); font-size: 0.9rem; z-index: 10001; box-shadow: 0 4px 20px rgba(0,0,0,0.3); opacity: 0; visibility: hidden; transition: opacity 0.35s, visibility 0.35s, transform 0.35s; pointer-events: none; }
    .toast.show { opacity: 1; visibility: visible; }
    body.theme-light .toast { border-color: var(--border-strong); box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
    .edit-set-actions { display: flex; gap: 0.75rem; margin-bottom: 1rem; }
    .edit-set-actions .btn { flex: 1; }
    .edit-set-extra { padding-top: 0.75rem; border-top: 1px solid var(--border-subtle); display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .edit-set-sep { color: var(--text-muted); opacity: 0.6; font-size: 0.85rem; }
    .preview-questions-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; padding: 1.5rem; box-sizing: border-box; }
    .preview-questions-overlay.show { display: flex; }
    .preview-questions-modal { width: 100%; max-width: 560px; max-height: 85vh; display: flex; flex-direction: column; background: var(--card); border-radius: var(--radius); border: 1px solid var(--border-subtle-hover); box-shadow: var(--shadow-lg); }
    body.theme-light .preview-questions-modal { border-color: rgba(0,0,0,0.1); }
    .preview-questions-modal h3 { font-size: 1rem; margin: 0 0 0.75rem 0; padding: 0 1rem; color: var(--text); flex-shrink: 0; }
    .preview-questions-body { flex: 1; overflow-y: auto; padding: 0 1rem 1rem; display: flex; flex-direction: column; gap: 1rem; min-height: 0; }
    .preview-questions-body .preview-q { padding: 0.85rem 1rem; background: var(--surface); border-radius: var(--radius-sm); border: 1px solid var(--border-subtle); font-size: 0.9rem; }
    body.theme-light .preview-questions-body .preview-q { border-color: rgba(0,0,0,0.08); }
    .preview-questions-body .preview-q-head { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; }
    .preview-questions-body .preview-q-stem { color: var(--text); line-height: 1.55; margin-bottom: 0.5rem; }
    .preview-questions-body .preview-q-options { margin: 0.35rem 0; padding-left: 1rem; color: var(--text); }
    .preview-questions-body .preview-q-correct { font-size: 0.85rem; color: var(--correct); margin-top: 0.4rem; }
    .preview-questions-body .preview-q-explanation { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.35rem; }
    .preview-questions-actions { padding: 0 1rem 1rem; flex-shrink: 0; }
    .btn-link { background: none; border: none; color: var(--accent); font-size: 0.85rem; cursor: pointer; padding: 0.35rem 0; text-decoration: underline; }
    .btn-link:hover { color: var(--accent-hover); }
    .btn-link-danger { background: none; border: none; color: var(--text-muted); font-size: 0.85rem; cursor: pointer; padding: 0.35rem 0; text-decoration: underline; }
    .btn-link-danger:hover { color: #f87171; }

    /* Custom Dialog Modal */
    .custom-dialog-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1003;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      padding-left: max(1rem, env(safe-area-inset-left));
      padding-right: max(1rem, env(safe-area-inset-right));
      padding-bottom: max(1rem, env(safe-area-inset-bottom));
      -webkit-overflow-scrolling: touch;
      overflow-y: auto;
    }
    .custom-dialog-overlay.show { display: flex; }
    .custom-dialog {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-strong);
      padding: 1.5rem;
      max-width: 420px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }
    body.theme-light .custom-dialog { border-color: var(--border-strong); }
    .custom-dialog-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0 0 1rem 0;
      color: var(--text);
    }
    .custom-dialog-body {
      margin-bottom: 1.5rem;
      color: var(--text);
      line-height: 1.5;
    }
    .custom-dialog-body p {
      margin: 0 0 0.75rem 0;
      font-size: 0.9rem;
    }
    .custom-dialog-body input {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      font-family: inherit;
      background: var(--surface);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-sm);
      color: var(--text);
      margin-top: 0.5rem;
      min-height: 48px;
      box-sizing: border-box;
    }
    .custom-dialog-body input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    body.theme-light .custom-dialog-body input {
      background: var(--card);
      border-color: var(--border-strong);
    }
    .custom-dialog-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }
    .custom-dialog-actions .btn {
      min-width: 80px;
      min-height: 44px;
    }
    @media (max-width: 480px) {
      .custom-dialog {
        padding: 1.25rem;
        max-width: 100%;
        border-radius: var(--radius) var(--radius) 0 0;
      }
      .custom-dialog-actions {
        flex-direction: column-reverse;
      }
      .custom-dialog-actions .btn {
        width: 100%;
      }
    }

    /* Sync Text Modal */
    .sync-text-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1002;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      padding-left: max(1rem, env(safe-area-inset-left));
      padding-right: max(1rem, env(safe-area-inset-right));
      padding-bottom: max(1rem, env(safe-area-inset-bottom));
      -webkit-overflow-scrolling: touch;
      overflow-y: auto;
    }
    .sync-text-modal-overlay.show { display: flex; }
    .sync-text-modal {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border-strong);
      padding: 1.5rem;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
    }
    body.theme-light .sync-text-modal { border-color: var(--border-strong); }
    .sync-text-modal h3 { font-size: 1.1rem; margin-bottom: 1rem; color: var(--text); }
    .sync-text-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
      border-bottom: 1px solid var(--border-subtle);
    }
    .sync-text-tab {
      flex: 1;
      padding: 0.75rem 1rem;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
    }
    .sync-text-tab:hover { color: var(--text); }
    .sync-text-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    .sync-text-content { display: none; }
    .sync-text-content.active { display: block; }
    .sync-text-desc {
      font-size: 0.9rem;
      color: var(--text-muted);
      line-height: 1.5;
      margin-bottom: 1rem;
    }
    .sync-text-result { margin-top: 1rem; }
    .sync-text-hint,
    .sync-text-warning {
      font-size: 0.85rem;
      line-height: 1.5;
    }
    .sync-text-actions {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      justify-content: flex-end;
    }

    .start-mode-modal-overlay { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.65); 
      backdrop-filter: blur(4px); 
      z-index: 9998; 
      align-items: center; 
      justify-content: center; 
      padding: 1.5rem; 
      padding-left: max(1.5rem, env(safe-area-inset-left));
      padding-right: max(1.5rem, env(safe-area-inset-right));
      padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
      box-sizing: border-box; 
      -webkit-overflow-scrolling: touch;
      overflow-y: auto;
    }
    .start-mode-modal-overlay.show { display: flex !important; }
    .start-mode-modal { width: 100%; max-width: 440px; background: var(--card); border-radius: 20px; border: 1px solid var(--border-subtle); box-shadow: 0 24px 48px rgba(0,0,0,0.35); padding: 1.5rem 1.75rem; }
    body.theme-light .start-mode-modal { border-color: var(--border-subtle); box-shadow: 0 24px 48px rgba(0,0,0,0.12); }
    .start-mode-modal h3 { font-size: 1.15rem; font-weight: 700; margin: 0 0 0.75rem 0; color: var(--text); letter-spacing: -0.02em; }
    .start-mode-review-card { display: flex; align-items: center; gap: 0.85rem; background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(124, 58, 237, 0.05)); border: 1.5px solid rgba(124, 58, 237, 0.2); border-radius: 14px; padding: 1rem 1.15rem; margin-bottom: 1.25rem; transition: all 0.2s; }
    .start-mode-review-card:hover { border-color: rgba(124, 58, 237, 0.35); background: linear-gradient(135deg, rgba(124, 58, 237, 0.12), rgba(124, 58, 237, 0.07)); }
    body.theme-light .start-mode-review-card { background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(124, 58, 237, 0.04)); border-color: rgba(124, 58, 237, 0.25); }
    body.theme-light .start-mode-review-card:hover { border-color: rgba(124, 58, 237, 0.35); background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(124, 58, 237, 0.06)); }
    .start-mode-review-icon { font-size: 1.5rem; line-height: 1; flex-shrink: 0; }
    .start-mode-review-content { flex: 1; min-width: 0; }
    .start-mode-review-title { font-size: 0.95rem; font-weight: 600; color: var(--text); margin-bottom: 0.2rem; }
    .start-mode-review-desc { font-size: 0.8rem; color: var(--text-muted); line-height: 1.4; }
    .start-mode-review-toggle { display: flex; align-items: center; cursor: pointer; flex-shrink: 0; }
    .start-mode-review-toggle input { position: absolute; opacity: 0; width: 0; height: 0; }
    .start-mode-review-switch { position: relative; width: 2.75rem; height: 1.5rem; background: var(--border-strong); border-radius: 999px; transition: background 0.2s; }
    .start-mode-review-switch::before { content: ''; position: absolute; width: 1.25rem; height: 1.25rem; left: 0.125rem; top: 50%; transform: translateY(-50%); background: var(--card); border-radius: 50%; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .start-mode-review-toggle input:checked + .start-mode-review-switch { background: var(--accent); }
    .start-mode-review-toggle input:checked + .start-mode-review-switch::before { transform: translate(1.25rem, -50%); }
    .start-mode-review-toggle input:focus-visible + .start-mode-review-switch { outline: 2px solid var(--accent); outline-offset: 2px; }
    .start-mode-desc { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.25rem; line-height: 1.5; }
    .start-mode-cards { display: flex; flex-direction: column; gap: 1rem; }
    .start-mode-card { background: var(--surface); border: 1px solid var(--border-subtle); border-radius: 14px; padding: 1.1rem 1.25rem; transition: border-color 0.2s, box-shadow 0.2s; }
    .start-mode-card:hover { border-color: var(--border-subtle-hover); }
    body.theme-light .start-mode-card { background: var(--surface); }
    .start-mode-card-title { font-size: 0.95rem; font-weight: 600; color: var(--text); margin-bottom: 0.25rem; }
    .start-mode-card-hint { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem; line-height: 1.4; }
    .start-mode-check-wrap { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text); cursor: pointer; margin-bottom: 0.75rem; }
    .start-mode-check-wrap input { width: 1.1em; height: 1.1em; accent-color: var(--accent); cursor: pointer; }
    .start-mode-card-btn { width: 100%; justify-content: center; margin-top: 0.25rem; }
    .start-mode-sequential-wrap { margin-bottom: 0.75rem; }
    .start-mode-sequential-label { 
      display: block; 
      font-size: 0.9rem; 
      color: var(--text); 
      margin-bottom: 0.5rem; 
      font-weight: 500;
    }
    .start-mode-sequential-row { 
      display: flex; 
      align-items: center; 
      gap: 0.5rem; 
      flex-wrap: wrap;
    }
    .start-mode-sequential-row input[type="number"] { 
      width: 5rem; 
      padding: 0.6rem 0.75rem; 
      font-size: 0.95rem; 
      background: var(--surface); 
      border: 1px solid var(--border-strong); 
      border-radius: var(--radius-sm); 
      color: var(--text);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .start-mode-sequential-row input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }
    .start-mode-sequential-text { 
      font-size: 0.88rem; 
      color: var(--text-muted);
      line-height: 1.5;
    }
    .start-mode-finished-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .start-mode-finished-btns .btn { flex: 1; min-width: 100px; }
    .start-mode-footer { margin-top: 1.25rem; padding-top: 1rem; border-top: 1px solid var(--border-subtle); text-align: center; }
    .btn-ghost { background: none; border: none; color: var(--text-muted); font-size: 0.9rem; cursor: pointer; padding: 0.4rem 0.75rem; border-radius: 8px; }
    .btn-ghost:hover { color: var(--text); background: var(--surface); }
    body.theme-light .start-mode-sequential-row input { background: var(--card); border-color: var(--border-strong); }
    @media (max-width: 480px) {
      .start-mode-sequential-row { flex-direction: column; align-items: flex-start; }
      .start-mode-sequential-row input { width: 100%; max-width: 200px; }
    }

    /* Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
    .skip-link {
      position: absolute;
      top: -100%;
      left: 0.75rem;
      z-index: 10002;
      padding: 0.75rem 1rem;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      border-radius: var(--radius-sm);
      text-decoration: none;
      transition: top 0.2s;
    }
    .skip-link:focus {
      top: 0.75rem;
      outline: 2px solid #fff;
      outline-offset: 2px;
    }
    .screen { contain: layout style; }

    @media print {
      .skip-link, #toast, .review-modal-overlay, .start-mode-modal-overlay, .image-lightbox-overlay, .edit-set-modal-overlay, .preview-questions-overlay,
      header .theme-toggle, header .home-actions .btn,
      .result-actions, .result-shortcut-hint, .result-recent { display: none !important; }
      body { background: #fff; color: #111; }
      .container, .screen.active, .result-card, .question-card { background: #fff; color: #111; border-color: #ddd; box-shadow: none; }
      .screen { display: none !important; }
      .screen.active { display: block !important; }
      a { color: #111; }
    }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">è·³è¿‡è‡³ä¸»å†…å®¹</a>
  <div class="container" id="main" role="main">
    <header>
      <div class="brand">
        <h1>FranÃ§ais Quiz</h1>
        <p>TCF å¡«ç©º Â· æ®µè½å¡«ç©º Â· å•é€‰ Â· å¤šé€‰</p>
      </div>
          <button type="button" class="theme-toggle" id="theme-toggle" title="åˆ‡æ¢æ·±è‰²/æµ…è‰²" aria-label="åˆ‡æ¢æ·±è‰²æˆ–æµ…è‰²ä¸»é¢˜" aria-pressed="false" aria-keyshortcuts="t">ðŸŒ“</button>
    </header>

    <div id="screen-home" class="screen active">
      <div class="stats-bar" id="stats-bar" role="region" aria-label="ç»Ÿè®¡æ•°æ®">
        <span>ä»Šæ—¥å·²ç»ƒ <strong id="stat-today" aria-live="polite">0</strong> é¢˜</span>
        <span>è¿žç»­ <strong id="stat-streak" aria-live="polite">0</strong> å¤©</span>
        <span>é”™é¢˜æœ¬ <strong id="stat-wrong" aria-live="polite">0</strong> é¢˜</span>
        <span>ä¹ é¢˜é›† <strong id="stat-sets" aria-live="polite">0</strong> å¥—</span>
      </div>

      <div class="home-section">
        <h2>å¼€å§‹ç»ƒä¹ </h2>
        <div class="start-select-wrap">
          <label for="start-practice-select">é€‰æ‹©ä¹ é¢˜é›†</label>
          <select id="start-practice-select">
            <option value="default">é»˜è®¤é¢˜ç›®</option>
          </select>
        </div>
        <div class="category-filter-wrap" id="category-filter-wrap">
          <label for="filter-category">åˆ†ç±»ç­›é€‰</label>
          <select id="filter-category">
            <option value="">å…¨éƒ¨</option>
          </select>
        </div>

        <!-- Advanced Settings (collapsed by default) -->
        <button type="button" class="collapsible-toggle" aria-expanded="false" aria-controls="advanced-settings-body"><span class="collapsible-chevron">â–¶</span> é«˜çº§è®¾ç½®</button>
        <div class="collapsible-body" id="advanced-settings-body" role="region"><div class="collapsible-inner">
          <div class="timer-wrap">
            <label for="timer-seconds">æ¯é¢˜å€’è®¡æ—¶ï¼ˆç§’ï¼‰</label>
            <input type="number" id="timer-seconds" min="0" max="120" value="10" title="0 è¡¨ç¤ºä¸é™æ—¶" />
            <div class="shuffle-wrap">
              <input type="checkbox" id="shuffle-questions" />
              <label for="shuffle-questions">æ‰“ä¹±é¢˜ç›®é¡ºåº</label>
            </div>
            <div class="shuffle-wrap">
              <input type="checkbox" id="shuffle-options" />
              <label for="shuffle-options">æ‰“ä¹±é€‰é¡¹é¡ºåº</label>
            </div>
          </div>
          <div class="type-filter-wrap">
            <span class="type-filter-label">åªåšä»¥ä¸‹é¢˜åž‹ï¼ˆä¸å‹¾é€‰ = å…¨éƒ¨ï¼‰</span>
            <div class="type-filter-row">
              <label><input type="checkbox" id="filter-type-single" checked /> å•é€‰</label>
              <label><input type="checkbox" id="filter-type-multiple" checked /> å¤šé€‰</label>
              <label><input type="checkbox" id="filter-type-fill" checked /> å¡«ç©º</label>
              <label><input type="checkbox" id="filter-type-paragraph" checked /> æ®µè½å¡«ç©º</label>
            </div>
          </div>
        </div></div>

        <div class="home-actions" role="group" aria-label="ä¸»è¦æ“ä½œ">
          <button type="button" class="btn btn-primary" id="btn-start-practice" aria-label="å¼€å§‹ç»ƒä¹ ">å¼€å§‹ç»ƒä¹ </button>
          <button type="button" class="btn btn-secondary" id="btn-import-show" aria-expanded="false" aria-controls="import-section">å¯¼å…¥æˆ‘çš„é¢˜ç›®</button>
        </div>

        <!-- Wrong book merged as sub-row -->
        <div class="wrong-book-row">
          <div class="wrong-book-row-label">é”™é¢˜æœ¬</div>
          <div class="home-actions" role="group" aria-label="é”™é¢˜æœ¬æ“ä½œ">
            <button type="button" class="btn wrong-book-btn" id="btn-wrong-book">æŒ‰è®¡åˆ’å¤ä¹  (<span id="wrong-count" aria-live="polite">0</span>)</button>
            <button type="button" class="btn btn-secondary" id="btn-wrong-free">è‡ªç”±ç»ƒä¹ å…¨éƒ¨</button>
            <button type="button" class="btn btn-secondary" id="btn-clear-wrong" aria-label="æ¸…ç©ºé”™é¢˜æœ¬ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤">æ¸…ç©ºé”™é¢˜æœ¬</button>
          </div>
        </div>

        <div class="import-section" id="import-section" style="display: none;" role="region" aria-labelledby="import-section-title">
        <h3 id="import-section-title">ç²˜è´´é¢˜ç›®æ–‡æœ¬ï¼ˆæ”¯æŒä½ ç»™çš„æ ¼å¼ï¼‰</h3>
        <textarea id="import-text" placeholder="ç²˜è´´é¢˜ç›®æ–‡æœ¬ï¼ˆè§ä¸‹æ–¹è¯´æ˜Žï¼‰æˆ– JSON æ•°ç»„â€¦"></textarea>
        <div class="import-name-wrap">
          <label for="import-set-name">ä¹ é¢˜é›†åç§°ï¼ˆä¿å­˜ç”¨ï¼Œå¡«å†™åŽæœ¬æ¬¡å¯¼å…¥ä¼šåŠ å…¥ã€Œæˆ‘çš„ä¹ é¢˜é›†ã€ï¼‰</label>
          <input type="text" id="import-set-name" placeholder="ä¾‹å¦‚ï¼šavoir å›ºå®šè¡¨è¾¾" autocomplete="off" />
          <label for="import-set-folder" class="import-folder-label">ä¿å­˜åˆ°æ–‡ä»¶å¤¹</label>
          <select id="import-set-folder">
            <option value="">æœªåˆ†ç±»</option>
          </select>
        </div>
        <div class="import-review-wrap">
          <label for="import-review-urls">ç»ƒä¹ å‰å¤ä¹ èµ„æ–™ï¼ˆå¯é€‰ï¼Œæ¯è¡Œä¸€ä¸ª URLï¼Œå¼€å§‹ç»ƒä¹ å‰å¯å…ˆçœ‹ï¼‰</label>
          <textarea id="import-review-urls" rows="3" placeholder="https://â€¦&#10;https://â€¦" autocomplete="off"></textarea>
        </div>
        <p class="import-dup-hint">é‡å¤é¢˜ç›®ï¼ˆé¢˜å¹²+é€‰é¡¹+ç­”æ¡ˆç›¸åŒï¼‰å°†è‡ªåŠ¨è·³è¿‡ï¼Œä»…ä¿ç•™ä¸€é“ã€‚</p>
        <button type="button" class="btn btn-primary" id="btn-import-parse" style="margin-top: 0.75rem;">è§£æžå¹¶å¼€å§‹</button>
        </div>
      </div>

      <div class="home-section saved-sets" id="saved-sets-section">
        <h2>æˆ‘çš„ä¹ é¢˜é›†</h2>
        <div class="saved-sets-search">
          <div class="saved-sets-search-wrap">
            <input type="text" id="saved-sets-search" placeholder="æœç´¢ä¹ é¢˜é›†åç§°â€¦" autocomplete="off" aria-label="æœç´¢ä¹ é¢˜é›†åç§°" />
          </div>
        </div>
        <div class="saved-sets-folders-bar" id="saved-sets-folders-bar">
          <span class="saved-sets-folders-label">æ–‡ä»¶å¤¹</span>
          <button type="button" class="btn btn-secondary btn-sm" id="btn-add-folder">æ·»åŠ æ–‡ä»¶å¤¹</button>
          <div class="saved-sets-folder-tags" id="saved-sets-folder-tags"></div>
        </div>
        <div class="saved-sets-list-wrap">
          <div id="saved-sets-list"></div>
          <p class="saved-sets-empty" id="saved-sets-empty" style="display: none;">æš‚æ— ä¿å­˜çš„ä¹ é¢˜é›†ï¼Œå¯¼å…¥é¢˜ç›®æ—¶å¡«å†™åç§°å³å¯ä¿å­˜ã€‚</p>
        </div>
      </div>

      <div class="home-section" id="storage-section">
        <h2>æ•°æ®åŒæ­¥</h2>
        <button type="button" class="btn btn-primary btn-one-save" id="btn-one-save">ä¸€é”®ä¿å­˜ï¼ˆè¦†ç›–åˆ°é¡¹ç›®æ–‡ä»¶å¤¹ï¼‰</button>
        <button type="button" class="btn btn-primary btn-one-save" id="btn-load-cloud" style="background: linear-gradient(135deg, #059669, #0d9488);">ä»Žäº‘ç«¯åŠ è½½ï¼ˆæ‰‹æœºåŒæ­¥ä¹ é¢˜é›†ï¼‰</button>
        <button type="button" class="btn btn-primary btn-one-save" id="btn-generate-sync-text" style="background: linear-gradient(135deg, #7c3aed, #8b5cf6); margin-top: 0.75rem;">ðŸ“± ç”ŸæˆåŒæ­¥æ–‡æœ¬ï¼ˆæ‰‹æœºâ†’ç”µè„‘ï¼‰</button>
        <button type="button" class="btn btn-primary btn-one-save" id="btn-import-sync-text" style="background: linear-gradient(135deg, #0d9488, #059669); margin-top: 0.5rem;">ðŸ’» ä»ŽåŒæ­¥æ–‡æœ¬å¯¼å…¥ï¼ˆç”µè„‘ç«¯ï¼‰</button>

        <!-- More storage options (collapsed) -->
        <button type="button" class="collapsible-toggle" style="margin-top:0.75rem;" aria-expanded="false" aria-controls="storage-details-body"><span class="collapsible-chevron">â–¶</span> æ›´å¤šå­˜å‚¨é€‰é¡¹ä¸Žè¯´æ˜Ž</button>
        <div class="collapsible-body" id="storage-details-body" role="region"><div class="collapsible-inner">
          <p class="storage-desc" style="margin-top:0.5rem;">ç”µè„‘ï¼šä¸€é”®ä¿å­˜åˆ°é¡¹ç›®é‡Œçš„ <code>french_quiz_data.json</code>ã€‚æ‰‹æœºè¦çœ‹åˆ°åŒä¸€ä»½ä¹ é¢˜é›†ï¼šä¿å­˜åŽåœ¨é¡¹ç›®ç›®å½•æ‰§è¡Œä¸‹æ–¹å‘½ä»¤ï¼Œ<strong>åŒæ—¶æŽ¨é€ä¸»ä»“åº“ + Pages ç«™ç‚¹</strong>ï¼Œæ‰‹æœºæ‰“å¼€æœ¬é¡µåŽç‚¹ã€Œ<strong>ä»Žäº‘ç«¯åŠ è½½</strong>ã€å³å¯åŒæ­¥ã€‚</p>
          <p class="storage-security-hint">å®‰å…¨è¯´æ˜Žï¼šäº‘ç«¯ä¹ é¢˜é›†æ¥è‡ªå½“å‰ç½‘ç«™é‡Œçš„é™æ€æ–‡ä»¶ï¼Œç½‘é¡µ<strong>æ²¡æœ‰ä¸Šä¼ /æŽ¨é€åŠŸèƒ½</strong>ï¼Œè®¿å®¢æ— æ³•æ”¹å†™ä½ çš„æ•°æ®ã€‚åªæœ‰ä½ è‡ªå·±ï¼ˆæˆ–ä½ æŽˆäºˆå†™æƒé™çš„ GitHub åä½œè€…ï¼‰èƒ½åœ¨æœ¬æœºæ‰§è¡Œè„šæœ¬æŽ¨é€åˆ°ä»“åº“ã€‚</p>
          <div class="storage-grid">
            <button type="button" class="storage-card" id="btn-open-folder">
              <span class="title">æ‰“å¼€å¹¶åŠ è½½</span>
              <span class="hint">é€‰æ‹© french-quiz æ–‡ä»¶å¤¹ï¼Œè¯»å–æœ¬åœ° JSON</span>
            </button>
            <button type="button" class="storage-card" id="btn-save-to-folder">
              <span class="title">ä¿å­˜åˆ°é¡¹ç›®æ–‡ä»¶å¤¹</span>
              <span class="hint">è¦†ç›– french_quiz_data.json</span>
            </button>
            <button type="button" class="storage-card" id="btn-export-data">
              <span class="title">å¯¼å‡ºåˆ°é¡¹ç›®æ–‡ä»¶å¤¹ï¼ˆè¦†ç›–ï¼‰</span>
              <span class="hint">ç›´æŽ¥å†™å…¥é¡¹ç›®ç›®å½•ï¼Œè¦†ç›–åŽŸæ–‡ä»¶</span>
            </button>
            <button type="button" class="storage-card" id="btn-import-data">
              <span class="title">ä»Žæ–‡ä»¶å¯¼å…¥</span>
              <span class="hint">é€‰æ‹©æœ¬æœº JSON æ–‡ä»¶æ¢å¤æ•°æ®</span>
            </button>
          </div>
          <div class="save-success-tip" id="save-success-tip" style="display: none;">
            <p class="save-success-tip-title">å·²ä¿å­˜ã€‚è¦åŒæ­¥åˆ° GitHubï¼ˆä¸»ä»“åº“ + Pages ç«™ç‚¹ä¸€èµ·æ›´æ–°ï¼‰ï¼š</p>
            <p class="save-success-tip-desc">åœ¨é¡¹ç›®ç›®å½•æ‰“å¼€ç»ˆç«¯ï¼Œè¿è¡Œï¼ˆæˆ–ç‚¹å‡»å¤åˆ¶ï¼‰ï¼ŒæŠŠ <code>../french-quiz-pages</code> æ¢æˆä½ çš„å…¬å¼€ Pages ä»“åº“è·¯å¾„ï¼š</p>
            <div class="save-success-tip-cmd-wrap">
              <code class="save-success-tip-cmd" id="save-deploy-cmd">./scripts/sync-and-push.sh ../french-quiz-pages</code>
              <button type="button" class="btn btn-secondary btn-sm" id="btn-copy-deploy-cmd">å¤åˆ¶å‘½ä»¤</button>
            </div>
            <p class="save-success-tip-extra">åªæŽ¨å½“å‰ä»“åº“ç”¨ <code>./scripts/sync-and-push.sh</code>ï¼›åŒæ—¶æ›´æ–°ä¸»ä»“åº“+Pages ç”¨ <code>./scripts/sync-and-push.sh ../french-quiz-pages</code>ã€‚é¦–æ¬¡éœ€ <code>chmod +x scripts/sync-and-push.sh</code>ã€‚</p>
          </div>
          <div class="import-lock-wrap" id="import-lock-wrap">
            <p class="import-lock-desc">å¯¼å…¥ä¿æŠ¤ï¼šä»…ä¸»äººå¯å¾€ã€Œæˆ‘çš„ä¹ é¢˜é›†ã€é‡Œ<strong>æ–°å¢žé¢˜ç›®</strong>ã€‚PIN ç”±<strong>ä½ è‡ªå·±åœ¨ä¸‹æ–¹ç‚¹å‡»ã€Œè®¾ç½®ä¸»äºº PINã€æ—¶è®¾å®š</strong>ï¼ˆ4ï½ž12 ä½ï¼‰ï¼Œè¯·ç‰¢è®°ã€‚</p>
            <div class="import-lock-status" id="import-lock-status">
              <span id="import-lock-status-text">æœªå¯ç”¨</span>
              <span class="import-lock-btns">
                <button type="button" class="btn btn-secondary btn-sm" id="btn-import-lock-set">è®¾ç½®ä¸»äºº PIN</button>
                <button type="button" class="btn btn-secondary btn-sm" id="btn-import-lock-change" style="display:none;">ä¿®æ”¹ PIN</button>
                <button type="button" class="btn btn-secondary btn-sm" id="btn-import-lock-disable" style="display:none;">å…³é—­ä¿æŠ¤</button>
              </span>
            </div>
            <div class="import-device-bind" id="import-device-bind">
              <p class="import-lock-desc">ä»…å…è®¸æœ¬æœºå¯¼å…¥ï¼šç»‘å®šåŽ<strong>åªæœ‰å½“å‰è¿™å°ç”µè„‘</strong>èƒ½ä½¿ç”¨ã€Œå¯¼å…¥æˆ‘çš„é¢˜ç›®ã€ã€‚</p>
              <div class="import-lock-status">
                <span id="device-bind-status-text">æœªç»‘å®š</span>
                <span class="import-lock-btns">
                  <button type="button" class="btn btn-secondary btn-sm" id="btn-device-bind">ç»‘å®šæœ¬æœº</button>
                  <button type="button" class="btn btn-secondary btn-sm" id="btn-device-unbind" style="display:none;">è§£é™¤ç»‘å®š</button>
                </span>
              </div>
            </div>
          </div>
          <p class="storage-fallback">æ— æ³•é€‰æ‹©æ–‡ä»¶å¤¹ï¼Ÿ<a href="#" id="link-download-json">ä¸‹è½½ JSON åˆ°ç”µè„‘</a></p>
          <input type="file" id="file-import-data" accept=".json,application/json" />
        </div></div>
      </div>

      <div class="home-section format-doc" id="format-doc">
        <button type="button" class="collapsible-toggle" aria-expanded="false" aria-controls="format-doc-content"><span class="collapsible-chevron">â–¶</span> å„é¢˜åž‹æ ¼å¼è¯´æ˜Ž</button>
        <div class="collapsible-body" id="format-doc-content" role="region"><div class="collapsible-inner"><div class="format-doc-content">
          <p><strong>é€šç”¨ï¼š</strong>å¯ç›´æŽ¥ç²˜è´´ JSON é¢˜ç›®æ•°ç»„ï¼Œæˆ–æŒ‰ä¸‹æ–¹æ–‡æœ¬æ ¼å¼ç²˜è´´ã€‚</p>
          <p><span class="type-tag">å•é€‰é¢˜ single_choice</span></p>
          <pre>{"type":"single_choice","stem":"Nous ______ une lettre.","options":["Ã©cris","Ã©crit","Ã©crivons","Ã©crivent"],"correct":2,"explanation":"nous ç”¨ Ã©crivonsã€‚","category":"è¯­æ³•"}</pre>
          <p><span class="type-tag">å¤šé€‰é¢˜ multiple_choice</span> â€” correct ä¸ºæ­£ç¡®é€‰é¡¹ç´¢å¼•æ•°ç»„ã€‚</p>
          <pre>{"type":"multiple_choice","stem":"ä¸‹åˆ—å“ªäº›æ˜¯å¤æ•°å½¢å¼ï¼Ÿ","options":["ils","il","elles","elle"],"correct":[0,2],"explanation":"ils/elles ä¸ºå¤æ•°ã€‚"}</pre>
          <p><span class="type-tag">å¡«ç©ºé¢˜ fill_blank</span> â€” correct ä¸ºç­”æ¡ˆå­—ç¬¦ä¸²æˆ–å¯æŽ¥å—ç­”æ¡ˆæ•°ç»„ã€‚</p>
          <pre>{"type":"fill_blank","stem":"Il _____ (avoir) 20 ans.","correct":["a","a "],"explanation":"avoir ç¬¬ä¸‰äººç§°å•æ•°å˜ä½ä¸º aã€‚"}</pre>
          <p><span class="type-tag">æ®µè½å¡«ç©ºé¢˜ paragraph_fill_blank</span> â€” é¢˜å¹²ä¸­ç”¨ _____ è¡¨ç¤ºç©ºï¼Œé¡ºåºå¯¹åº” correct æ•°ç»„ã€‚</p>
          <pre>{"type":"paragraph_fill_blank","stem":"Il a _____ ans. Elle _____ (s'appeler) Marie.","correct":["15","s'appelle"],"explanation":"ä¸¤ç©ºä¾æ¬¡å¡«å†™ã€‚"}</pre>
          <p><strong>æ–‡æœ¬æ ¼å¼ï¼ˆå•é€‰é¢˜ï¼‰ï¼š</strong>å«ã€Œé¢˜åž‹ï¼šã€ã€ŒA) B) C) D)ã€ã€Œæ­£ç¡®ï¼šã€å³å¯è§£æžã€‚ä¾‹ï¼š</p>
          <pre>é¢˜åž‹ï¼šNous ______ une lettre Ã  nos parents.
A) Ã©cris  B) Ã©crit  C) Ã©crivons  D) Ã©crivent
æ­£ç¡®ï¼šC</pre>
          <p class="format-doc-hint"><strong>åˆ†ç±»ç­›é€‰ï¼š</strong>é¢˜ç›® JSON ä¸­å¯å¸¦ <code>category</code> å­—æ®µï¼ˆå¦‚ <code>"category":"è¯­æ³•"</code>ï¼‰ï¼Œé€‰ä¹ é¢˜é›†åŽå¯æŒ‰åˆ†ç±»ç­›é¢˜ï¼›æ—  <code>category</code> æ—¶ä»…æ˜¾ç¤ºã€Œå…¨éƒ¨ã€ã€‚</p>
        </div></div></div>
      </div>
    </div>

    <div id="screen-quiz" class="screen">
      <div class="progress-wrap">
        <span class="progress-estimate" id="progress-estimate"></span>
        <span class="progress-label" id="progress-label">ç¬¬ 1 / 1 é¢˜</span>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
      </div>
      <div class="question-card" role="region" aria-labelledby="question-stem" aria-describedby="question-meta" aria-live="polite">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:0.5rem;">
          <div class="question-meta" id="question-meta"></div>
          <div style="display:flex;align-items:center;gap:0.35rem;">
            <svg class="timer-ring" id="timer-ring" width="40" height="40" viewBox="0 0 40 40" style="display:none;">
              <circle cx="20" cy="20" r="17" fill="none" stroke="var(--surface)" stroke-width="3" />
              <circle class="timer-ring-fill" id="timer-ring-fill" cx="20" cy="20" r="17" fill="none" stroke="var(--accent)" stroke-width="3" stroke-dasharray="106.81" stroke-dashoffset="0" stroke-linecap="round" transform="rotate(-90 20 20)" />
            </svg>
            <span class="quiz-timer" id="quiz-timer" style="display: none;"></span>
          </div>
        </div>
        <div class="question-stem-wrap">
          <div class="question-stem" id="question-stem"></div>
          <button type="button" class="btn-read-aloud" id="btn-read-aloud" title="æœ—è¯»é¢˜å¹²ï¼ˆæ³•è¯­ï¼‰" aria-label="æœ—è¯»é¢˜å¹²ï¼ˆæ³•è¯­ï¼‰">ðŸ”Š æœ—è¯»</button>
        </div>
        <div class="options" id="options-container" role="group" aria-label="ç­”é¢˜é€‰é¡¹"></div>
        <div class="fill-input-wrap" id="fill-input-wrap" style="display: none;">
          <label for="fill-input" class="sr-only">è¾“å…¥ç­”æ¡ˆ</label>
          <input type="text" id="fill-input" placeholder="è¾“å…¥ç­”æ¡ˆ..." autocomplete="off" aria-label="è¾“å…¥ç­”æ¡ˆ" aria-required="true" />
        </div>
        <div class="paragraph-blanks" id="paragraph-blanks-wrap" style="display: none;" role="group" aria-label="æ®µè½å¡«ç©º"></div>
        <div class="answer-feedback" id="answer-feedback"></div>
        <div class="explanation-scroll-wrap" id="explanation-scroll-wrap" style="display: none;">
          <div class="explanation-wrong-count" id="explanation-wrong-count" style="display: none;" aria-live="polite"></div>
          <div class="explanation" id="explanation"></div>
          <div class="explanation-notes-section" id="explanation-notes-section">
            <div class="explanation-notes-display" id="explanation-notes-display" style="display: none;"></div>
            <button type="button" class="btn btn-secondary btn-sm explanation-notes-edit-btn" id="btn-edit-explanation-notes" aria-label="ç¼–è¾‘å¤‡æ³¨">ç¼–è¾‘å¤‡æ³¨</button>
            <div class="explanation-notes-edit" id="explanation-notes-edit" style="display: none;">
              <textarea id="explanation-notes-textarea" rows="4" placeholder="åœ¨æ­¤æ·»åŠ ä½ çš„å¤‡æ³¨ï¼ˆçº¯æ–‡æœ¬ï¼‰ï¼ŒEnter æ¢è¡Œ" class="explanation-notes-textarea"></textarea>
              <div class="explanation-notes-edit-actions">
                <button type="button" class="btn btn-primary btn-sm" id="btn-save-explanation-notes">ä¿å­˜</button>
                <button type="button" class="btn btn-secondary btn-sm" id="btn-cancel-explanation-notes">å–æ¶ˆ</button>
              </div>
            </div>
          </div>
        </div>
        <div class="wrong-book-remove-wrap" id="wrong-book-remove-wrap" style="display: none;">
          <button type="button" class="btn btn-secondary btn-sm" id="btn-remove-from-wrong">ç§»å‡ºé”™é¢˜æœ¬</button>
        </div>
        <div class="remove-from-set-wrap" id="remove-from-set-wrap" style="display: none;">
          <button type="button" class="btn btn-secondary btn-sm" id="btn-remove-from-set">ä»Žç»ƒä¹ é›†åˆ é™¤æœ¬é¢˜</button>
        </div>
      </div>
      <div class="quiz-actions">
        <span id="question-counter"></span>
        <div class="quiz-actions-right">
          <button type="button" class="btn btn-secondary" id="btn-prev-quiz" style="display: none;" aria-label="ä¸Šä¸€é¢˜">ä¸Šä¸€é¢˜</button>
          <button type="button" class="btn btn-secondary" id="btn-exit-quiz" aria-label="æå‰é€€å‡ºç»ƒä¹ ">æå‰é€€å‡º</button>
          <button type="button" class="btn btn-primary" id="btn-next" style="display: none;" aria-label="ä¸‹ä¸€é¢˜" aria-keyshortcuts="Enter">ä¸‹ä¸€é¢˜</button>
          <button type="button" class="btn btn-primary" id="btn-submit" aria-label="ç¡®è®¤ç­”æ¡ˆ" aria-keyshortcuts="Enter">ç¡®è®¤</button>
        </div>
      </div>
      <p class="quiz-shortcut-hint" aria-hidden="true">å¿«æ·é”®ï¼š1â€“4 é€‰é€‰é¡¹ï¼ŒEnter ç¡®è®¤</p>
    </div>

    <div id="screen-result" class="screen">
      <div class="result-card" id="result-card" aria-live="polite" aria-atomic="true">
        <div class="result-score" id="result-score" role="text">0/0</div>
        <p class="result-pct" id="result-pct"></p>
        <p class="result-desc" id="result-desc">å®Œæˆç»ƒä¹ </p>
        <p class="result-celebration" id="result-celebration" style="display: none;">ðŸŽ‰ å…¨å¯¹ï¼</p>
        <div class="result-confetti" id="result-confetti" aria-hidden="true"></div>
        <div class="result-actions">
          <button type="button" class="btn btn-primary" id="btn-restart" aria-label="å†ç»ƒä¸€é">å†ç»ƒä¸€é</button>
          <button type="button" class="btn wrong-book-btn" id="btn-result-wrong" aria-label="é”™é¢˜æœ¬æŒ‰è®¡åˆ’å¤ä¹ ">é”™é¢˜æœ¬Â·æŒ‰è®¡åˆ’</button>
          <button type="button" class="btn btn-secondary" id="btn-result-wrong-free" aria-label="é”™é¢˜è‡ªç”±ç»ƒä¹ ">é”™é¢˜è‡ªç”±ç»ƒä¹ </button>
          <button type="button" class="btn btn-secondary" id="btn-share-result" aria-label="åˆ†äº«æˆç»©">åˆ†äº«æˆç»©</button>
          <button type="button" class="btn btn-secondary" id="btn-back-home" aria-label="è¿”å›žé¦–é¡µ">è¿”å›žé¦–é¡µ</button>
        </div>
        <p class="result-shortcut-hint" aria-hidden="true">æç¤ºï¼šç­”é¢˜æ—¶æŒ‰ Enter å¯ä¸‹ä¸€é¢˜ï¼ŒEsc å…³é—­å¼¹çª—</p>
        <div class="result-recent" id="result-recent" style="display: none;"></div>
      </div>
    </div>
    <div id="sr-announcer" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
  </div>

  <div class="review-modal-overlay" id="review-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="review-modal-title">
    <div class="review-modal">
      <h3 id="review-modal-title">æ˜¯å¦è§‚çœ‹å¤ä¹ ææ–™ï¼Ÿ</h3>
      <div class="review-modal-body">
        <div class="review-modal-texts-wrap" id="review-modal-texts-wrap">
          <div class="review-modal-texts roll" id="review-modal-texts"></div>
        </div>
        <div class="review-modal-links" id="review-modal-links"></div>
        <div class="review-modal-images" id="review-modal-images"></div>
      </div>
      <div class="review-modal-actions">
        <button type="button" class="btn btn-primary" id="btn-review-start-quiz">ç›´æŽ¥å¼€å§‹ç»ƒä¹ </button>
      </div>
    </div>
  </div>

  <div class="start-mode-modal-overlay" id="start-mode-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="start-mode-modal-title" style="display: none;">
    <div class="start-mode-modal">
      <h3 id="start-mode-modal-title">é€‰æ‹©ç»ƒä¹ æ–¹å¼</h3>
      <div class="start-mode-review-card" id="start-mode-review-card" style="display: none;">
        <div class="start-mode-review-icon">ðŸ“š</div>
        <div class="start-mode-review-content">
          <div class="start-mode-review-title">é¢„ä¹ å†…å®¹</div>
          <div class="start-mode-review-desc">æœ¬é¢˜é›†åŒ…å«å¤ä¹ ææ–™ï¼Œå»ºè®®å…ˆé¢„ä¹ å†å¼€å§‹ç»ƒä¹ </div>
        </div>
        <label class="start-mode-review-toggle">
          <input type="checkbox" id="start-mode-review" checked />
          <span class="start-mode-review-switch"></span>
        </label>
      </div>
      <p class="start-mode-desc">æœ¬é¢˜é›†é¢˜ç›®è¾ƒå¤šï¼Œå¯é€‰æ‹©ç»ƒä¹ æ–¹å¼ä¸Žæ˜¯å¦æ‰“ä¹±é¡ºåºã€‚</p>
      <div class="start-mode-cards">
        <div class="start-mode-card start-mode-card-full">
          <div class="start-mode-card-title">ç»ƒä¹ å…¨éƒ¨</div>
          <p class="start-mode-card-hint">ä¸€æ¬¡åšå®Œæœ¬é¢˜é›†å…¨éƒ¨é¢˜ç›®ã€‚</p>
          <label class="start-mode-check-wrap">
            <input type="checkbox" id="start-mode-shuffle" />
            <span>æ‰“ä¹±é¢˜ç›®é¡ºåº</span>
          </label>
          <button type="button" class="btn btn-primary start-mode-card-btn" id="btn-start-mode-full">å¼€å§‹ç»ƒä¹ </button>
        </div>
        <div class="start-mode-card start-mode-card-sequential" id="start-mode-sequential">
          <div class="start-mode-card-title">æŒ‰é¡ºåºç»ƒä¸€éƒ¨åˆ†</div>
          <p class="start-mode-card-hint">è‡ªé€‰é¢˜æ•°ï¼ŒæŒ‰é¡ºåºåšï¼›ä¸‹æ¬¡ä»Žå‰©ä½™é¢˜ç›®ç»§ç»­ã€‚</p>
          <div class="start-mode-sequential-wrap">
            <label for="start-mode-count" class="start-mode-sequential-label">ç»ƒä¹ é¢˜ç›®æ•°</label>
            <div class="start-mode-sequential-row">
              <input type="number" id="start-mode-count" min="1" value="20" aria-label="é¢˜ç›®æ•°é‡" />
              <span class="start-mode-sequential-text">é¢˜ï¼ˆä»Žç¬¬ <span id="start-mode-from">1</span> é¢˜èµ·ï¼Œå‰©ä½™ <span id="start-mode-remain">0</span> é¢˜ï¼‰</span>
            </div>
          </div>
          <button type="button" class="btn btn-primary start-mode-card-btn" id="btn-start-mode-sequential">å¼€å§‹æŒ‰é¡ºåºç»ƒä¹ </button>
        </div>
        <div class="start-mode-card start-mode-finished" id="start-mode-finished" style="display: none;">
          <div class="start-mode-card-title">æœ¬å¥—å·²æŒ‰é¡ºåºç»ƒå®Œ</div>
          <p class="start-mode-card-hint">å¯é‡ç½®è¿›åº¦åŽé‡æ–°æŒ‰é¡ºåºç»ƒï¼Œæˆ–ç›´æŽ¥ç»ƒä¹ å…¨éƒ¨ã€‚</p>
          <div class="start-mode-finished-btns">
            <button type="button" class="btn btn-secondary" id="btn-start-mode-reset">é‡ç½®è¿›åº¦</button>
            <button type="button" class="btn btn-primary" id="btn-start-mode-full-after">ç»ƒä¹ å…¨éƒ¨</button>
          </div>
        </div>
      </div>
      <div class="start-mode-footer">
        <button type="button" class="btn btn-ghost" id="btn-start-mode-cancel" aria-keyshortcuts="Escape">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <div class="image-lightbox-overlay" id="image-lightbox-overlay" role="dialog" aria-modal="true" aria-label="æ”¾å¤§æŸ¥çœ‹å›¾ç‰‡">
    <div class="image-lightbox-content">
      <img id="image-lightbox-img" src="" alt="æ”¾å¤§å›¾" />
      <button type="button" class="image-lightbox-close" id="image-lightbox-close" aria-label="å…³é—­" aria-keyshortcuts="Escape">Ã—</button>
    </div>
  </div>

  <div id="toast" class="toast" aria-live="polite" role="status"></div>

  <div class="edit-set-modal-overlay" id="edit-set-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="edit-set-modal-title">
    <div class="edit-set-modal">
      <h3 id="edit-set-modal-title">ç¼–è¾‘ä¹ é¢˜é›†</h3>
      <div class="edit-set-field">
        <label for="edit-set-name">ä¹ é¢˜é›†åç§°</label>
        <input type="text" id="edit-set-name" placeholder="ä¾‹å¦‚ï¼šavoir å›ºå®šè¡¨è¾¾" autocomplete="off" />
      </div>
      <div class="edit-set-field">
        <label for="edit-set-folder">æ‰€å±žæ–‡ä»¶å¤¹</label>
        <select id="edit-set-folder">
          <option value="">æœªåˆ†ç±»</option>
        </select>
      </div>
      <div class="edit-set-field">
        <span class="edit-set-review-label">ç»ƒä¹ å‰å¤ä¹ èµ„æ–™ï¼ˆå¯é€‰ï¼‰</span>
        <div class="edit-set-review-row">
          <label for="edit-set-review-texts">æ–‡æœ¬ï¼ˆæ¯è¡Œä¸€æ®µï¼Œç»ƒä¹ å‰å¯æ»šåŠ¨æŸ¥çœ‹ï¼‰</label>
          <textarea id="edit-set-review-texts" rows="3" placeholder="å£è¯€ã€è¯´æ˜Žç­‰&#10;æ¯è¡Œä¸€æ®µ" autocomplete="off"></textarea>
        </div>
        <div class="edit-set-review-row">
          <label for="edit-set-review-links">é“¾æŽ¥ï¼ˆæ¯è¡Œä¸€ä¸ª URLï¼‰</label>
          <textarea id="edit-set-review-links" rows="2" placeholder="https://â€¦" autocomplete="off"></textarea>
        </div>
        <div class="edit-set-paste-images" id="edit-set-paste-images">
          <span class="edit-set-paste-images-hint">å›¾ç‰‡ï¼šç‚¹å‡»ä¸‹æ–¹åŒºåŸŸåŽ Ctrl+V / Cmd+V ç²˜è´´</span>
          <div class="edit-set-paste-zone" id="edit-set-paste-zone" tabindex="0" role="button" aria-label="ç‚¹å‡»åŽæŒ‰ Ctrl+V æˆ– Cmd+V ç²˜è´´å›¾ç‰‡">ç²˜è´´å›¾ç‰‡åˆ°æ­¤å¤„</div>
          <div class="edit-set-pasted-list" id="edit-set-pasted-list"></div>
        </div>
      </div>
      <div class="edit-set-meta" id="edit-set-meta"></div>
      <div class="edit-set-field edit-set-append">
        <label for="edit-set-append-text">è¿½åŠ é¢˜ç›®ï¼ˆç²˜è´´ JSON æ•°ç»„æˆ–æ–‡æœ¬æ ¼å¼ï¼Œä¼šè¿½åŠ åˆ°æœ¬é¢˜é›†æœ«å°¾ï¼‰</label>
        <textarea id="edit-set-append-text" rows="4" placeholder="[{&quot;type&quot;:&quot;single_choice&quot;, ...}, ...] æˆ– é¢˜åž‹ï¼š... A) B) C) D) æ­£ç¡®ï¼šC" autocomplete="off"></textarea>
        <button type="button" class="btn btn-secondary btn-sm" id="btn-edit-set-append">è§£æžå¹¶è¿½åŠ </button>
      </div>
      <div class="edit-set-actions">
        <button type="button" class="btn btn-primary" id="btn-edit-set-save">ä¿å­˜</button>
        <button type="button" class="btn btn-secondary" id="btn-edit-set-cancel" aria-keyshortcuts="Escape">å–æ¶ˆ</button>
      </div>
      <div class="edit-set-extra">
        <button type="button" class="btn btn-link" id="btn-edit-set-export">å¯¼å‡ºæœ¬é¢˜é›† (JSON)</button>
        <span class="edit-set-sep">Â·</span>
        <button type="button" class="btn btn-link" id="btn-edit-set-preview" aria-haspopup="dialog">é¢„è§ˆä¹ é¢˜</button>
        <span class="edit-set-sep">Â·</span>
        <button type="button" class="btn btn-link-danger" id="btn-edit-set-delete">åˆ é™¤æœ¬ä¹ é¢˜é›†</button>
      </div>
    </div>
  </div>

  <div class="preview-questions-overlay" id="preview-questions-overlay" role="dialog" aria-modal="true" aria-labelledby="preview-questions-title">
    <div class="preview-questions-modal">
      <h3 id="preview-questions-title">ä¹ é¢˜é¢„è§ˆ</h3>
      <div class="preview-questions-body" id="preview-questions-body"></div>
      <div class="preview-questions-actions">
        <button type="button" class="btn btn-primary" id="btn-preview-questions-close" aria-keyshortcuts="Escape">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- Custom Dialog Modal -->
  <div class="custom-dialog-overlay" id="custom-dialog-overlay" role="dialog" aria-modal="true" style="display: none;">
    <div class="custom-dialog">
      <h3 class="custom-dialog-title" id="custom-dialog-title"></h3>
      <div class="custom-dialog-body" id="custom-dialog-body"></div>
      <div class="custom-dialog-actions" id="custom-dialog-actions"></div>
    </div>
  </div>

  <!-- Sync Text Modal -->
  <div class="sync-text-modal-overlay" id="sync-text-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="sync-text-modal-title" style="display: none;">
    <div class="sync-text-modal">
      <h3 id="sync-text-modal-title">æ•°æ®åŒæ­¥</h3>
      <div class="sync-text-tabs" id="sync-text-tabs">
        <button type="button" class="sync-text-tab active" data-tab="generate">ðŸ“± ç”ŸæˆåŒæ­¥æ–‡æœ¬</button>
        <button type="button" class="sync-text-tab" data-tab="import">ðŸ’» å¯¼å…¥åŒæ­¥æ–‡æœ¬</button>
      </div>
      <div class="sync-text-content" id="sync-text-generate" style="display: block;">
        <p class="sync-text-desc">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”ŸæˆåŒ…å«æ‰€æœ‰æ•°æ®çš„åŒæ­¥æ–‡æœ¬ï¼Œå¤åˆ¶åŽå¯åœ¨ç”µè„‘ç«¯å¯¼å…¥ã€‚</p>
        <p class="sync-text-warning" style="margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-muted);">ðŸ”’ å¦‚æžœå·²å¯ç”¨å¯¼å…¥ä¿æŠ¤ï¼Œç”Ÿæˆå’Œå¯¼å…¥æ—¶éƒ½éœ€è¦è¾“å…¥ PINã€‚</p>
        <button type="button" class="btn btn-primary" id="btn-generate-sync-text-inner">ç”ŸæˆåŒæ­¥æ–‡æœ¬</button>
        <div class="sync-text-result" id="sync-text-result" style="display: none;">
          <label for="sync-text-output">åŒæ­¥æ–‡æœ¬ï¼ˆç‚¹å‡»å…¨é€‰å¤åˆ¶ï¼‰ï¼š</label>
          <textarea id="sync-text-output" readonly rows="8" style="width: 100%; margin-top: 0.5rem; padding: 0.75rem; font-family: monospace; font-size: 0.85rem; background: var(--surface); border: 1px solid var(--border-strong); border-radius: var(--radius-sm); color: var(--text); resize: vertical;"></textarea>
          <button type="button" class="btn btn-secondary" id="btn-copy-sync-text" style="margin-top: 0.5rem;">ðŸ“‹ å¤åˆ¶æ–‡æœ¬</button>
          <p class="sync-text-hint" style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-muted);">åœ¨ç”µè„‘ç«¯æ‰“å¼€æœ¬é¡µé¢ï¼Œåˆ‡æ¢åˆ°ã€Œå¯¼å…¥åŒæ­¥æ–‡æœ¬ã€æ ‡ç­¾ï¼Œç²˜è´´æ­¤æ–‡æœ¬å³å¯åŒæ­¥æ•°æ®ã€‚</p>
        </div>
      </div>
      <div class="sync-text-content" id="sync-text-import" style="display: none;">
        <p class="sync-text-desc">ç²˜è´´ä»Žæ‰‹æœºç«¯ç”Ÿæˆçš„åŒæ­¥æ–‡æœ¬ï¼Œç‚¹å‡»å¯¼å…¥å³å¯åŒæ­¥æ•°æ®åˆ°ç”µè„‘ã€‚</p>
        <p class="sync-text-warning" style="margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-muted);">ðŸ”’ å¦‚æžœå·²å¯ç”¨å¯¼å…¥ä¿æŠ¤ï¼Œéœ€è¦è¾“å…¥ PIN æ‰èƒ½å¯¼å…¥ã€‚å¦‚æžœå·²ç»‘å®šè®¾å¤‡ï¼Œåªèƒ½åœ¨ç»‘å®šçš„è®¾å¤‡ä¸Šå¯¼å…¥ã€‚</p>
        <label for="sync-text-input">åŒæ­¥æ–‡æœ¬ï¼š</label>
        <textarea id="sync-text-input" rows="8" style="width: 100%; margin-top: 0.5rem; padding: 0.75rem; font-family: monospace; font-size: 0.85rem; background: var(--surface); border: 1px solid var(--border-strong); border-radius: var(--radius-sm); color: var(--text); resize: vertical;" placeholder="ç²˜è´´åŒæ­¥æ–‡æœ¬..."></textarea>
        <button type="button" class="btn btn-primary" id="btn-import-sync-text-inner" style="margin-top: 0.75rem;">å¯¼å…¥æ•°æ®</button>
        <p class="sync-text-warning" style="margin-top: 0.75rem; font-size: 0.85rem; color: var(--wrong);">âš ï¸ å¯¼å…¥å°†è¦†ç›–å½“å‰æœ¬åœ°çš„æ‰€æœ‰æ•°æ®ï¼ˆä¹ é¢˜é›†ã€é”™é¢˜æœ¬ã€ç»Ÿè®¡æ•°æ®ç­‰ï¼‰</p>
      </div>
      <div class="sync-text-actions">
        <button type="button" class="btn btn-secondary" id="btn-sync-text-close">å…³é—­</button>
      </div>
    </div>
  </div>

  <script>
    if (typeof performance !== 'undefined' && performance.mark) performance.mark('app-start');
    const LETTERS = ['A', 'B', 'C', 'D'];
    const WRONG_BOOK_KEY = 'french_quiz_wrong';
    const SAVED_SETS_KEY = 'french_quiz_saved_sets';
    const FOLDERS_KEY = 'french_quiz_folders';
    const FOLDER_COLLAPSED_KEY = 'french_quiz_folder_collapsed';
    const TIMER_SECONDS_KEY = 'french_quiz_timer_seconds';
    const DAILY_STATS_KEY = 'french_quiz_daily_stats';
    const RECENT_SESSIONS_KEY = 'french_quiz_recent_sessions';
    const QUESTION_NOTES_KEY = 'french_quiz_question_notes';
    const THEME_KEY = 'french_quiz_theme';
    const DATA_FILE_NAME = 'french_quiz_data.json';
    const IMPORT_PIN_HASH_KEY = 'french_quiz_import_pin_hash';
    const IMPORT_ALLOWED_FINGERPRINT_KEY = 'french_quiz_import_allowed_device';
    const RECENT_SESSIONS_MAX = 10;
    const SAVED_SETS_DISPLAY_LIMIT = 30;
    const SEQUENTIAL_MODE_THRESHOLD = 16;
    const SCREEN = { HOME: 'screen-home', QUIZ: 'screen-quiz', RESULT: 'screen-result' };

    const QUIZ_PROGRESS_KEY = 'french_quiz_progress';

    let projectFolderHandle = null;
    let _savedSetsCache = null;
    let _savedSetsCacheDirty = true;
    let _wrongBookCache = null;
    let _wrongBookCacheDirty = true;
    const _escapeDiv = document.createElement('div');
    const _wrongBookIdCache = new WeakMap();
    let _modalLastFocus = null;
    let _openModalOverlay = null;
    let _savedSetsDisplayLimit = SAVED_SETS_DISPLAY_LIMIT;
    let _currentQuestionIdForNotes = null;

    /* â”€â”€ DOM Element Cache â”€â”€ */
    const _domCache = new Map();
    function $(id) {
      if (!_domCache.has(id)) {
        const el = document.getElementById(id);
        if (el) _domCache.set(id, el);
        return el;
      }
      return _domCache.get(id);
    }
    function clearDomCache() { _domCache.clear(); }

    /* â”€â”€ Error Handling â”€â”€ */
    function handleError(error, context = '') {
      const message = error instanceof Error ? error.message : String(error);
      console.error('[Error' + (context ? ' in ' + context : '') + ']', error);
      showToast('æ“ä½œå¤±è´¥ï¼š' + message);
      if (typeof performance !== 'undefined' && performance.mark) {
        try { performance.mark('error-' + (context || 'unknown')); } catch (_) {}
      }
    }
    function safeCall(fn, context = '', fallback = null) {
      try {
        return fn();
      } catch (error) {
        handleError(error, context);
        return fallback;
      }
    }

    async function hashPin(pin) {
      const enc = new TextEncoder();
      const data = enc.encode(String(pin));
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
    function isImportLockEnabled() { return !!localStorage.getItem(IMPORT_PIN_HASH_KEY); }
    async function setImportPin(pin) { localStorage.setItem(IMPORT_PIN_HASH_KEY, await hashPin(pin)); }
    async function verifyImportPin(pin) { return (await hashPin(pin)) === localStorage.getItem(IMPORT_PIN_HASH_KEY); }
    function computeFingerprint() {
      const parts = [
        navigator.userAgent || '',
        (screen && (screen.width + 'x' + screen.height)) || '',
        new Date().getTimezoneOffset(),
        navigator.language || '',
        (navigator.hardwareConcurrency || '') + ''
      ].join('|');
      let h = 0;
      for (let i = 0; i < parts.length; i++) h = ((h << 5) - h) + parts.charCodeAt(i) | 0;
      return (h >>> 0).toString(36);
    }
    function getImportAllowedFingerprint() { return localStorage.getItem(IMPORT_ALLOWED_FINGERPRINT_KEY) || ''; }
    function setImportAllowedFingerprintToThisDevice() { localStorage.setItem(IMPORT_ALLOWED_FINGERPRINT_KEY, computeFingerprint()); }
    function canImportOnThisDevice() {
      const allowed = getImportAllowedFingerprint();
      if (!allowed) return true;
      return computeFingerprint() === allowed;
    }
    // Custom Dialog Functions (replace native prompt/confirm)
    function showCustomDialog(title, bodyHtml, actions) {
      return new Promise((resolve) => {
        const overlay = document.getElementById('custom-dialog-overlay');
        const titleEl = document.getElementById('custom-dialog-title');
        const bodyEl = document.getElementById('custom-dialog-body');
        const actionsEl = document.getElementById('custom-dialog-actions');
        if (!overlay || !titleEl || !bodyEl || !actionsEl) {
          resolve(null);
          return;
        }
        titleEl.textContent = title;
        bodyEl.innerHTML = bodyHtml;
        actionsEl.innerHTML = '';
        actions.forEach(action => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = action.primary ? 'btn btn-primary' : 'btn btn-secondary';
          btn.textContent = action.label;
          btn.addEventListener('click', () => {
            overlay.classList.remove('show');
            overlay.style.display = 'none';
            clearModalFocusTrap();
            resolve(action.value);
          });
          actionsEl.appendChild(btn);
        });
        overlay.classList.add('show');
        overlay.style.display = 'flex';
        setModalFocusTrap(overlay);
        // Close on overlay click
        const closeOnOverlay = (e) => {
          if (e.target.id === 'custom-dialog-overlay') {
            overlay.removeEventListener('click', closeOnOverlay);
            overlay.classList.remove('show');
            overlay.style.display = 'none';
            clearModalFocusTrap();
            resolve(null);
          }
        };
        overlay.addEventListener('click', closeOnOverlay);
      });
    }
    function customConfirm(message) {
      return showCustomDialog('ç¡®è®¤', `<p>${message}</p>`, [
        { label: 'å–æ¶ˆ', value: false, primary: false },
        { label: 'ç¡®å®š', value: true, primary: true }
      ]);
    }
    function customPrompt(message, defaultValue = '') {
      return new Promise((resolve) => {
        const inputId = 'custom-prompt-input-' + Date.now();
        const bodyHtml = `<p>${message}</p><input type="text" id="${inputId}" value="${defaultValue.replace(/"/g, '&quot;')}" autocomplete="off" />`;
        showCustomDialog('è¾“å…¥', bodyHtml, [
          { label: 'å–æ¶ˆ', value: null, primary: false },
          { label: 'ç¡®å®š', value: true, primary: true }
        ]).then(result => {
          if (result === true) {
            const input = document.getElementById(inputId);
            resolve(input ? input.value : null);
          } else {
            resolve(null);
          }
        });
        // Focus input after modal opens
        setTimeout(() => {
          const input = document.getElementById(inputId);
          if (input) {
            input.focus();
            input.select();
            input.addEventListener('keydown', (e) => {
              if (e.key === 'Enter') {
                e.preventDefault();
                const overlay = document.getElementById('custom-dialog-overlay');
                const actionsEl = document.getElementById('custom-dialog-actions');
                const confirmBtn = actionsEl?.querySelector('.btn-primary');
                if (confirmBtn) confirmBtn.click();
              }
            });
          }
        }, 100);
      });
    }
    async function customPromptPin(message) {
      return customPrompt(message, '');
    }

    async function checkImportPin() {
      if (!canImportOnThisDevice()) {
        showToast('ä»…å…è®¸åœ¨å·²ç»‘å®šçš„ç”µè„‘ä¸Šå¯¼å…¥ï¼Œå½“å‰è®¾å¤‡æœªç»‘å®š');
        return false;
      }
      if (!isImportLockEnabled()) return true;
      const pin = await customPromptPin('è¯·è¾“å…¥ä¸»äºº PIN ä»¥ç»§ç»­å¯¼å…¥');
      if (pin === null) return false;
      const ok = await verifyImportPin(pin);
      if (!ok) showToast('PIN é”™è¯¯');
      return ok;
    }
    function updateImportLockUI() {
      const statusText = document.getElementById('import-lock-status-text');
      const setBtn = document.getElementById('btn-import-lock-set');
      const changeBtn = document.getElementById('btn-import-lock-change');
      const disableBtn = document.getElementById('btn-import-lock-disable');
      if (!statusText) return;
      if (isImportLockEnabled()) {
        statusText.textContent = 'å·²å¯ç”¨';
        if (setBtn) setBtn.style.display = 'none';
        if (changeBtn) changeBtn.style.display = 'inline-flex';
        if (disableBtn) disableBtn.style.display = 'inline-flex';
      } else {
        statusText.textContent = 'æœªå¯ç”¨';
        if (setBtn) setBtn.style.display = 'inline-flex';
        if (changeBtn) changeBtn.style.display = 'none';
        if (disableBtn) disableBtn.style.display = 'none';
      }
    }
    function updateDeviceBindUI() {
      const statusText = document.getElementById('device-bind-status-text');
      const bindBtn = document.getElementById('btn-device-bind');
      const unbindBtn = document.getElementById('btn-device-unbind');
      if (!statusText) return;
      const allowed = getImportAllowedFingerprint();
      const isThisDevice = allowed && computeFingerprint() === allowed;
      if (allowed) {
        statusText.textContent = isThisDevice ? 'å·²ç»‘å®šæœ¬æœºï¼ˆä»…æœ¬æœºå¯å¯¼å…¥ï¼‰' : 'å·²ç»‘å®šå…¶ä»–è®¾å¤‡ï¼ˆå½“å‰è®¾å¤‡ä¸å¯å¯¼å…¥ï¼‰';
        if (bindBtn) bindBtn.style.display = 'none';
        if (unbindBtn) unbindBtn.style.display = isThisDevice ? 'inline-flex' : 'none';
      } else {
        statusText.textContent = 'æœªç»‘å®š';
        if (bindBtn) bindBtn.style.display = 'inline-flex';
        if (unbindBtn) unbindBtn.style.display = 'none';
      }
    }

    function getFocusableIn(container) {
      if (!container) return [];
      const nodes = container.querySelectorAll('button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');
      return Array.prototype.filter.call(nodes, function(el) { return el.offsetParent != null; });
    }
    function setModalFocusTrap(overlayEl) {
      _openModalOverlay = overlayEl;
      _modalLastFocus = document.activeElement;
      var focusable = getFocusableIn(overlayEl);
      if (focusable.length) requestAnimationFrame(function() { focusable[0].focus(); });
    }
    function clearModalFocusTrap() {
      if (_modalLastFocus && typeof _modalLastFocus.focus === 'function') _modalLastFocus.focus();
      _modalLastFocus = null;
      _openModalOverlay = null;
    }

    function getRecentSessions() {
      try {
        const raw = localStorage.getItem(RECENT_SESSIONS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr.slice(-RECENT_SESSIONS_MAX) : [];
      } catch (_) { return []; }
    }
    function pushRecentSession(total, score) {
      const sessions = getRecentSessions();
      sessions.push({ total, score, at: new Date().toISOString() });
      localStorage.setItem(RECENT_SESSIONS_KEY, JSON.stringify(sessions.slice(-RECENT_SESSIONS_MAX)));
    }

    function saveQuizProgress() {
      try {
        sessionStorage.setItem(QUIZ_PROGRESS_KEY, JSON.stringify({
          questions: state.questions, index: state.index, score: state.score,
          timerSeconds: state.timerSeconds, practicingWrongBook: state.practicingWrongBook,
          practicedSetId: state.practicedSetId, answerResults: state.answerResults || {},
          savedAt: Date.now()
        }));
      } catch (_) {}
    }
    function clearQuizProgress() { try { sessionStorage.removeItem(QUIZ_PROGRESS_KEY); } catch (_) {} }
    function getQuizProgress() {
      try {
        const raw = sessionStorage.getItem(QUIZ_PROGRESS_KEY);
        if (!raw) return null;
        const p = JSON.parse(raw);
        if (Date.now() - p.savedAt > 2 * 60 * 60 * 1000) { clearQuizProgress(); return null; }
        return p;
      } catch (_) { return null; }
    }

    function getDailyStats() {
      try {
        const raw = localStorage.getItem(DAILY_STATS_KEY);
        const data = raw ? JSON.parse(raw) : {};
        const today = new Date().toISOString().slice(0, 10);
        const yesterday = new Date(Date.now() - 864e5).toISOString().slice(0, 10);
        if (data.date !== today) {
          return {
            date: today,
            todayCount: 0,
            lastDate: data.lastDate || data.date,
            streak: data.streak || 0
          };
        }
        return {
          date: today,
          todayCount: data.todayCount || 0,
          lastDate: data.lastDate || data.date,
          streak: data.streak || 0
        };
      } catch (_) { return { date: new Date().toISOString().slice(0, 10), todayCount: 0, lastDate: null, streak: 0 }; }
    }
    function addTodayPractice(n) {
      const raw = localStorage.getItem(DAILY_STATS_KEY);
      const data = raw ? JSON.parse(raw) : {};
      const today = new Date().toISOString().slice(0, 10);
      const yesterday = new Date(Date.now() - 864e5).toISOString().slice(0, 10);
      let streak = data.streak || 0;
      let todayCount = data.todayCount || 0;
      if (data.date === today) {
        todayCount += (n || 0);
      } else {
        todayCount = n || 0;
        const prevDate = data.lastDate || data.date;
        if (prevDate === yesterday) streak += 1;
        else if (prevDate !== today) streak = 1;
      }
      const st = { date: today, todayCount, lastDate: today, streak };
      localStorage.setItem(DAILY_STATS_KEY, JSON.stringify(st));
      updateStatsBar();
    }
    function animateStatChange(el, newValue) {
      if (!el) return;
      const oldText = el.textContent;
      el.textContent = newValue;
      if (oldText !== String(newValue)) {
        el.classList.remove('updated');
        void el.offsetWidth;
        el.classList.add('updated');
      }
    }
    function updateStatsBar() {
      const st = getDailyStats();
      const elToday = document.getElementById('stat-today');
      const elWrong = document.getElementById('stat-wrong');
      const elSets = document.getElementById('stat-sets');
      const elStreak = document.getElementById('stat-streak');
      animateStatChange(elToday, st.todayCount || 0);
      animateStatChange(elWrong, getWrongBook().length);
      animateStatChange(elSets, getSavedSets().length);
      animateStatChange(elStreak, st.streak || 0);
    }
    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function normalizeFrench(str) {
      return str
        .trim()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/\u0153/g, 'oe')
        .replace(/\u00e6/g, 'ae')
        .replace(/\s+/g, ' ');
    }
    function matchFrenchAnswer(val, acceptList) {
      return acceptList.some(c => c === val) || acceptList.some(c => normalizeFrench(c) === normalizeFrench(val));
    }

    /**
     * åˆ¤é¢˜çº¯å‡½æ•°ï¼šä¸è¯» DOMã€ä¸å†™å­˜å‚¨ï¼Œä»…æ ¹æ®é¢˜ç›®å’Œç”¨æˆ·ç­”æ¡ˆè¿”å›žå¯¹é”™ï¼ˆåŠå¡«ç©ºçš„ detailsï¼‰ã€‚
     * ç”¨äºŽå¯æµ‹è¯•æ€§ä¸ŽåŽç»­é¢˜åž‹æ‰©å±•ï¼›submitAnswer ä¸­æ”¶é›† DOM ç­”æ¡ˆåŽè°ƒç”¨æ­¤å‡½æ•°ã€‚
     */
    function evaluateAnswer(q, userAnswer) {
      if (q.type === 'single_choice') {
        const correctIndex = Array.isArray(q.correct) ? q.correct[0] : q.correct;
        return { correct: userAnswer.single === correctIndex };
      }
      if (q.type === 'multiple_choice') {
        const correctSet = new Set(Array.isArray(q.correct) ? q.correct : [q.correct]);
        const selected = new Set(Array.isArray(userAnswer.multiple) ? userAnswer.multiple : []);
        const correct = selected.size === correctSet.size && [...selected].every(i => correctSet.has(i));
        return { correct };
      }
      if (q.type === 'fill_blank') {
        const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
        const blankCount = (q.stem.match(/_____/g) || []).length;
        if (blankCount >= 2 && (userAnswer.paragraph || []).length >= 2) {
          const answers = userAnswer.paragraph.slice(0, correctArr.length);
          const details = answers.map((val, i) => {
            const accept = (Array.isArray(correctArr[i]) ? correctArr[i] : [correctArr[i]]).map(c => String(c).toLowerCase().trim());
            return { ok: matchFrenchAnswer(val.trim().toLowerCase(), accept), val, accept };
          });
          return { correct: details.every(d => d.ok), details };
        }
        const val = (userAnswer.fill || '').trim().toLowerCase();
        const accept = correctArr.map(c => String(c).toLowerCase().trim());
        return { correct: matchFrenchAnswer(val, accept) };
      }
      if (q.type === 'paragraph_fill_blank') {
        const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
        const inputs = userAnswer.paragraph || [];
        const len = Math.min(correctArr.length, inputs.length);
        const details = [];
        let correct = true;
        for (let i = 0; i < len; i++) {
          const val = (inputs[i] || '').trim().toLowerCase();
          const accept = (Array.isArray(correctArr[i]) ? correctArr[i] : [correctArr[i]]).map(c => String(c).toLowerCase().trim());
          const ok = matchFrenchAnswer(val, accept);
          details.push({ ok, val, accept });
          if (!ok) correct = false;
        }
        for (let i = len; i < correctArr.length; i++) details.push({ ok: false, val: '', accept: [] });
        return { correct, details };
      }
      return { correct: false };
    }

    const QUESTION_TYPES = { single_choice: 'å•é€‰', multiple_choice: 'å¤šé€‰', fill_blank: 'å¡«ç©º', paragraph_fill_blank: 'æ®µè½å¡«ç©º' };
    function getSelectedTypeFilter() {
      const single = document.getElementById('filter-type-single');
      const multiple = document.getElementById('filter-type-multiple');
      const fill = document.getElementById('filter-type-fill');
      const paragraph = document.getElementById('filter-type-paragraph');
      const types = [];
      if (single && single.checked) types.push('single_choice');
      if (multiple && multiple.checked) types.push('multiple_choice');
      if (fill && fill.checked) types.push('fill_blank');
      if (paragraph && paragraph.checked) types.push('paragraph_fill_blank');
      return types.length === 0 ? null : types;
    }
    function filterQuestionsByType(questions, typeFilter) {
      if (!questions || !typeFilter || typeFilter.length === 0) return questions || [];
      return questions.filter(q => q && typeFilter.includes(q.type));
    }
    function shuffleQuestionOptions(q) {
      if (!q || (q.type !== 'single_choice' && q.type !== 'multiple_choice') || !q.options || !q.options.length) return q;
      const perm = shuffleArray(q.options.map((_, i) => i));
      const newOptions = perm.map(i => q.options[i]);
      const oldCorrect = Array.isArray(q.correct) ? q.correct : [q.correct];
      const newCorrect = q.type === 'single_choice'
        ? perm.indexOf(oldCorrect[0])
        : oldCorrect.map(c => perm.indexOf(c)).sort((a, b) => a - b);
      return Object.assign({}, q, { options: newOptions, correct: newCorrect });
    }

    function getDataForExport() {
      const timerEl = document.getElementById('timer-seconds');
      let questionNotes = {};
      try {
        const raw = localStorage.getItem(QUESTION_NOTES_KEY);
        if (raw) questionNotes = JSON.parse(raw);
      } catch (_) {}
      const out = {
        savedSets: getSavedSets(),
        folders: getFolders(),
        wrongBook: getWrongBook(),
        questionNotes: questionNotes,
        timerSeconds: timerEl ? Math.max(0, parseInt(timerEl.value, 10) || 10) : 10,
        dailyStats: getDailyStats(),
        exportedAt: new Date().toISOString()
      };
      const fp = getImportAllowedFingerprint();
      if (fp) out.importAllowedDeviceFingerprint = fp;
      return out;
    }
    function sanitizeImportedData(data) {
      if (!data || typeof data !== 'object') return {};
      const DANGEROUS_KEYS = ['__proto__', 'constructor', 'prototype'];
      function stripDangerousKeys(val) {
        if (val === null || typeof val !== 'object') return val;
        if (Array.isArray(val)) return val.map(stripDangerousKeys);
        const out = {};
        for (const k of Object.keys(val)) {
          if (DANGEROUS_KEYS.includes(k)) continue;
          out[k] = stripDangerousKeys(val[k]);
        }
        return out;
      }
      return stripDangerousKeys(data);
    }
    function loadDataFromObject(data) {
      const safe = sanitizeImportedData(data);
      if (safe.savedSets != null) setSavedSets(Array.isArray(safe.savedSets) ? safe.savedSets : []);
      if (safe.folders != null) setFolders(Array.isArray(safe.folders) ? safe.folders : []);
      if (safe.wrongBook != null) setWrongBook(Array.isArray(safe.wrongBook) ? safe.wrongBook : []);
      if (safe.questionNotes != null && typeof safe.questionNotes === 'object') {
        try {
          localStorage.setItem(QUESTION_NOTES_KEY, JSON.stringify(safe.questionNotes));
        } catch (_) {}
      }
      if (safe.timerSeconds != null) {
        const n = Math.max(0, Math.min(120, parseInt(safe.timerSeconds, 10) || 10));
        const el = document.getElementById('timer-seconds');
        if (el) { el.value = n; localStorage.setItem(TIMER_SECONDS_KEY, String(n)); }
      }
      if (safe.dailyStats != null && safe.dailyStats && safe.dailyStats.date) {
        try {
          localStorage.setItem(DAILY_STATS_KEY, JSON.stringify({
            date: safe.dailyStats.date,
            todayCount: safe.dailyStats.todayCount || 0,
            lastDate: safe.dailyStats.lastDate || safe.dailyStats.date,
            streak: safe.dailyStats.streak || 0
          }));
        } catch (_) {}
        updateStatsBar();
      }
      if (safe.importAllowedDeviceFingerprint != null && String(safe.importAllowedDeviceFingerprint)) {
        localStorage.setItem(IMPORT_ALLOWED_FINGERPRINT_KEY, String(safe.importAllowedDeviceFingerprint));
      } else {
        localStorage.removeItem(IMPORT_ALLOWED_FINGERPRINT_KEY);
      }
      updateImportLockUI();
      updateDeviceBindUI();
      updateWrongCount();
      renderSavedSets();
      updateStartPracticeSelect();
    }
    async function loadFromCloud() {
      let url = DATA_FILE_NAME;
      if (typeof location !== 'undefined' && location.origin) {
        const dir = location.pathname.replace(/\/[^/]*$/, '') || '/';
        const base = dir.endsWith('/') ? dir : dir + '/';
        url = location.origin + base + DATA_FILE_NAME;
      }
      const btn = $('btn-load-cloud') || document.getElementById('btn-load-cloud');
      if (btn) { btn.disabled = true; btn.textContent = 'åŠ è½½ä¸­â€¦'; }
      try {
        const res = await fetch(url + '?t=' + Date.now());
        if (!res.ok) throw new Error(res.status === 404 ? 'æœªæ‰¾åˆ°äº‘ç«¯æ•°æ®' : 'è¯·æ±‚å¤±è´¥');
        const data = await res.json();
        if (!data || (data.savedSets == null && data.wrongBook == null)) throw new Error('æ•°æ®æ ¼å¼æ— æ•ˆ');
        const confirmed = await customConfirm('äº‘ç«¯æ•°æ®å°†è¦†ç›–å½“å‰æœ¬åœ°çš„ä¹ é¢˜é›†ã€æ–‡ä»¶å¤¹å’Œé”™é¢˜æœ¬ã€‚ç¡®å®šè¦åŠ è½½å¹¶è¦†ç›–å—ï¼Ÿ');
        if (!confirmed) return;
        loadDataFromObject(data);
        const setCount = data.savedSets && data.savedSets.length ? data.savedSets.length : 0;
        const wrongCount = data.wrongBook && data.wrongBook.length ? data.wrongBook.length : 0;
        showToast('å·²åŠ è½½' + (setCount ? ' ' + setCount + ' å¥—ä¹ é¢˜é›†' : '') + (wrongCount ? 'ï¼Œ' + wrongCount + ' é“é”™é¢˜' : ''));
      } catch (e) {
        showToast('åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åŽå†è¯•ã€‚è‹¥ä»å¤±è´¥å¯å°è¯•ã€Œä»Žæ–‡ä»¶å¯¼å…¥ã€');
      }
      if (btn) { btn.disabled = false; btn.textContent = 'ä»Žäº‘ç«¯åŠ è½½ï¼ˆæ‰‹æœºåŒæ­¥ä¹ é¢˜é›†ï¼‰'; }
    }
    async function pickFolderAndLoad() {
      if (!('showDirectoryPicker' in window)) {
        alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒé€‰æ‹©æ–‡ä»¶å¤¹ï¼Œè¯·ç”¨ Chrome æˆ– Edgeï¼Œæˆ–ä½¿ç”¨ä¸‹æ–¹ã€Œä»Žæ–‡ä»¶å¯¼å…¥æ•°æ®ã€é€‰æ‹© JSON æ–‡ä»¶ã€‚');
        return;
      }
      const btn = document.getElementById('btn-open-folder');
      const titleEl = btn && btn.querySelector('.title');
      const origTitle = titleEl ? titleEl.textContent : '';
      try {
        const handle = await window.showDirectoryPicker();
        projectFolderHandle = handle;
        let fileHandle = await handle.getFileHandle(DATA_FILE_NAME, { create: false }).catch(() => null);
        if (!fileHandle) {
          fileHandle = await handle.getFileHandle(DATA_FILE_NAME, { create: true });
          const writable = await fileHandle.createWritable();
          const empty = { savedSets: [], folders: [], wrongBook: [], timerSeconds: 10 };
          await writable.write(JSON.stringify(empty, null, 2));
          await writable.close();
          loadDataFromObject(empty);
          showToast('å·²åˆ›å»ºå¹¶åŠ è½½ç©ºæ•°æ®');
          return;
        }
        if (btn) { btn.disabled = true; if (titleEl) titleEl.textContent = 'åŠ è½½ä¸­â€¦'; }
        const file = await fileHandle.getFile();
        const text = await file.text();
        const data = JSON.parse(text);
        loadDataFromObject(data);
        showToast('å·²ä»Žé¡¹ç›®æ–‡ä»¶å¤¹åŠ è½½æ•°æ®');
      } catch (e) {
        if (e.name === 'AbortError') return;
        console.error(e);
        showToast('åŠ è½½å¤±è´¥ï¼š' + (e.message || String(e)));
      } finally {
        if (btn) { btn.disabled = false; if (titleEl) titleEl.textContent = origTitle; }
      }
    }
    async function saveToProjectFolder() {
      if (!projectFolderHandle) {
        if (!('showDirectoryPicker' in window)) {
          alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒã€‚è¯·ç”¨ Chrome/Edge é€‰æ‹©æ–‡ä»¶å¤¹ï¼Œæˆ–ä½¿ç”¨ã€Œå¯¼å‡ºæ•°æ®ã€ä¸‹è½½ JSON åŽæ‰‹åŠ¨æ”¾åˆ° french-quiz æ–‡ä»¶å¤¹ã€‚');
          return;
        }
        try {
          projectFolderHandle = await window.showDirectoryPicker();
        } catch (e) {
          if (e.name === 'AbortError') return;
          throw e;
        }
      }
      const btn = document.getElementById('btn-one-save');
      if (btn) { btn.disabled = true; btn.textContent = 'ä¿å­˜ä¸­â€¦'; }
      if (typeof performance !== 'undefined' && performance.mark) performance.mark('save-start');
      try {
        const fileHandle = await projectFolderHandle.getFileHandle(DATA_FILE_NAME, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(getDataForExport(), null, 2));
        await writable.close();
        if (typeof performance !== 'undefined' && performance.mark) {
          performance.mark('save-end');
          try { performance.measure('save-to-folder', 'save-start', 'save-end'); } catch (_) {}
        }
        const tipEl = document.getElementById('save-success-tip');
        if (tipEl) {
          tipEl.style.display = 'block';
          /* Auto-expand storage details so the tip is visible */
          const storageBody = document.getElementById('storage-details-body');
          if (storageBody && !storageBody.classList.contains('open')) {
            storageBody.classList.add('open');
            const storageToggle = document.querySelector('[aria-controls="storage-details-body"]');
            if (storageToggle) storageToggle.setAttribute('aria-expanded', 'true');
          }
          tipEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        showToast('å·²ä¿å­˜');
      } catch (e) {
        console.error(e);
        showToast('ä¿å­˜å¤±è´¥ï¼š' + (e.message || String(e)));
        projectFolderHandle = null;
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = 'ä¸€é”®ä¿å­˜ï¼ˆè¦†ç›–åˆ°é¡¹ç›®æ–‡ä»¶å¤¹ï¼‰'; }
      }
    }
    function exportDataDownload() {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([JSON.stringify(getDataForExport(), null, 2)], { type: 'application/json' }));
      a.download = DATA_FILE_NAME;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function importDataFromFile(file) {
      const btn = document.getElementById('btn-import-data');
      const titleEl = btn && btn.querySelector('.title');
      const origTitle = titleEl ? titleEl.textContent : '';
      if (btn) { btn.disabled = true; if (titleEl) titleEl.textContent = 'å¯¼å…¥ä¸­â€¦'; }
      const fr = new FileReader();
      fr.onload = () => {
        try {
          const data = JSON.parse(fr.result);
          loadDataFromObject(data);
          showToast('å·²ä»Žæ–‡ä»¶å¯¼å…¥æ•°æ®');
        } catch (e) {
          showToast('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®è®¤æ˜¯æœ‰æ•ˆçš„ JSONï¼š' + (e.message || String(e)));
        } finally {
          if (btn) { btn.disabled = false; if (titleEl) titleEl.textContent = origTitle; }
        }
      };
      fr.onerror = () => {
        showToast('æ–‡ä»¶è¯»å–å¤±è´¥');
        if (btn) { btn.disabled = false; if (titleEl) titleEl.textContent = origTitle; }
      };
      fr.readAsText(file);
    }

    function getSavedSets() {
      if (!_savedSetsCacheDirty && _savedSetsCache !== null) return _savedSetsCache;
      try {
        const raw = localStorage.getItem(SAVED_SETS_KEY);
        _savedSetsCache = raw ? JSON.parse(raw) : [];
        _savedSetsCacheDirty = false;
        return _savedSetsCache;
      } catch (_) { return []; }
    }
    function setSavedSets(arr) {
      _savedSetsCache = arr;
      _savedSetsCacheDirty = false;
      localStorage.setItem(SAVED_SETS_KEY, JSON.stringify(arr));
      renderSavedSets();
      updateStatsBar();
      updateStartPracticeSelect();
    }
    function getFolders() {
      try {
        const raw = localStorage.getItem(FOLDERS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch (_) { return []; }
    }
    function setFolders(arr) {
      const list = Array.isArray(arr) ? arr : [];
      localStorage.setItem(FOLDERS_KEY, JSON.stringify(list));
      renderSavedSets();
      updateStartPracticeSelect();
      renderFolderSelects();
    }
    function renderFolderSelects() {
      const folders = getFolders();
      const opts = '<option value="">æœªåˆ†ç±»</option>' + folders.map(f => '<option value="' + escapeAttr(String(f.id)) + '">' + escapeHtml(f.name) + '</option>').join('');
      const editSel = document.getElementById('edit-set-folder');
      if (editSel) { editSel.innerHTML = opts; }
      const importSel = document.getElementById('import-set-folder');
      if (importSel) { importSel.innerHTML = opts; }
    }
    function removeCurrentQuestionFromSet() {
      if (!state.practicedSetId) return;
      const q = state.questions[state.index];
      if (!q) return;
      const sets = getSavedSets();
      const setId = String(state.practicedSetId);
      const set = sets.find(s => String(s.id) === setId);
      if (!set || !set.questions) return;
      const currentId = wrongBookItemId(q);
      const newQuestions = set.questions.filter(qq => wrongBookItemId(qq) !== currentId);
      if (newQuestions.length === set.questions.length) return;
      const updated = sets.map(s => String(s.id) === setId ? Object.assign({}, s, { questions: newQuestions }) : s);
      setSavedSets(updated);
      const removedIndex = state.index;
      state.questions.splice(state.index, 1);
      /* Update answerResults: shift all entries after removed index */
      const newAnswerResults = {};
      Object.keys(state.answerResults || {}).forEach(key => {
        const idx = parseInt(key, 10);
        if (idx < removedIndex) {
          newAnswerResults[idx] = state.answerResults[idx];
        } else if (idx > removedIndex) {
          newAnswerResults[idx - 1] = state.answerResults[idx];
        }
      });
      state.answerResults = newAnswerResults;
      if (state.questions.length === 0) {
        showResult();
        return;
      }
      if (state.index >= state.questions.length) state.index = state.questions.length - 1;
      renderQuestion();
    }
    function updateStartPracticeSelect() {
      const sel = $('start-practice-select');
      if (!sel) return;
      const saved = getSavedSets();
      const folders = getFolders();
      const folderIds = new Set(folders.map(f => String(f.id)));
      let html = '<option value="default">é»˜è®¤é¢˜ç›®</option>';
      folders.forEach(f => {
        const inFolder = saved.filter(s => String(s.folderId || '') === String(f.id));
        if (inFolder.length === 0) return;
        html += '<optgroup label="' + escapeHtml(f.name) + '">' +
          inFolder.map(s => '<option value="' + escapeAttr(String(s.id)) + '">' + escapeHtml(s.name) + ' (' + s.questions.length + ' é¢˜)</option>').join('') + '</optgroup>';
      });
      const uncategorized = saved.filter(s => !s.folderId || !folderIds.has(String(s.folderId)));
      if (uncategorized.length > 0) {
        html += '<optgroup label="æœªåˆ†ç±»">' +
          uncategorized.map(s => '<option value="' + escapeAttr(String(s.id)) + '">' + escapeHtml(s.name) + ' (' + s.questions.length + ' é¢˜)</option>').join('') + '</optgroup>';
      }
      const currentVal = sel.value;
      sel.innerHTML = html;
      if (currentVal && (currentVal === 'default' || saved.some(s => String(s.id) === currentVal))) sel.value = currentVal;
    }
    function formatSavedSetDate(iso) {
      const d = new Date(iso);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const h = String(d.getHours()).padStart(2, '0');
      const min = String(d.getMinutes()).padStart(2, '0');
      return y + '-' + m + '-' + day + ' ' + h + ':' + min;
    }
    function renderSavedSets() {
      const sets = getSavedSets();
      const folders = getFolders();
      const folderIds = new Set(folders.map(f => String(f.id)));
      const searchEl = $('saved-sets-search');
      const query = (searchEl && searchEl.value ? searchEl.value : '').trim().toLowerCase();
      const filtered = query ? sets.filter(s => (s.name || '').toLowerCase().includes(query)) : sets;
      const listEl = $('saved-sets-list');
      const emptyEl = $('saved-sets-empty');
      const tagsEl = $('saved-sets-folder-tags');
      if (!listEl || !emptyEl) return;
      renderFolderTags();
      function itemHtml(s) {
        const count = s.practiceCount || 0;
        const lastStr = s.lastPracticedAt ? 'æœ€è¿‘ ' + formatSavedSetDate(s.lastPracticedAt) : 'æœªç»ƒä¹ ';
        return '<li class="saved-sets-item" data-id="' + escapeAttr(String(s.id)) + '">' +
          '<div class="saved-sets-item-content">' +
          '<span class="name">' + escapeHtml(s.name) + '</span>' +
          '<div class="meta">' +
          '<span>' + escapeHtml(formatSavedSetDate(s.createdAt)) + '</span><span class="dot">Â·</span><span>' + s.questions.length + ' é¢˜</span><span class="dot">Â·</span><span>ç»ƒä¹  ' + count + ' æ¬¡</span><span class="dot">Â·</span><span>' + lastStr + '</span>' +
          '</div></div>' +
          '<div class="actions"><button type="button" class="btn btn-primary" data-action="start" aria-haspopup="dialog">å¼€å§‹</button><button type="button" class="btn btn-secondary" data-action="edit" aria-haspopup="dialog">ç¼–è¾‘</button></div>' +
          '</li>';
      }
      if (filtered.length === 0) {
        listEl.innerHTML = '';
        emptyEl.style.display = 'block';
        emptyEl.textContent = query ? 'æ²¡æœ‰åŒ¹é…çš„ä¹ é¢˜é›†' : 'è¿˜æ²¡æœ‰ä¹ é¢˜é›†ï¼ŒåŽ»ã€Œå¼€å§‹ç»ƒä¹ ã€é‡Œç²˜è´´é¢˜ç›®å¹¶å¡«å†™åç§°ï¼Œå³å¯ä¿å­˜åˆ°è¿™é‡Œã€‚';
        return;
      }
      emptyEl.style.display = 'none';
      if (query) _savedSetsDisplayLimit = SAVED_SETS_DISPLAY_LIMIT;
      const orderedSets = [];
      folders.forEach(f => {
        orderedSets.push(...filtered.filter(s => String(s.folderId || '') === String(f.id)));
      });
      orderedSets.push(...filtered.filter(s => !s.folderId || !folderIds.has(String(s.folderId))));
      const limit = _savedSetsDisplayLimit;
      const toShow = orderedSets.slice(0, limit);
      const toShowSet = new Set(toShow.map(s => String(s.id)));
      const hasMore = orderedSets.length > limit;
      let collapsedState = {};
      try {
        const raw = localStorage.getItem(FOLDER_COLLAPSED_KEY);
        if (raw) collapsedState = JSON.parse(raw) || {};
      } catch (_) {}
      const folderIconSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>';
      let html = '';
      folders.forEach(f => {
        const inFolder = filtered.filter(s => String(s.folderId || '') === String(f.id));
        const inFolderShow = inFolder.filter(s => toShowSet.has(String(s.id)));
        if (inFolderShow.length === 0) return;
        const fid = String(f.id);
        const collapsed = collapsedState[fid];
        const collapsedClass = collapsed ? ' saved-sets-folder-collapsed' : '';
        html += '<div class="saved-sets-folder' + collapsedClass + '" data-folder-id="' + escapeAttr(fid) + '" data-is-uncategorized="false">' +
          '<div class="saved-sets-folder-header">' +
          '<button type="button" class="saved-sets-folder-toggle">' +
          '<span class="folder-icon-wrap">' + folderIconSvg + '</span>' +
          '<span class="saved-sets-folder-name">' + escapeHtml(f.name) + '</span>' +
          '<span class="folder-chevron" aria-hidden="true">â–¼</span>' +
          '</button>' +
          '<button type="button" class="folder-header-edit" aria-label="é‡å‘½å">âœŽ</button>' +
          '<button type="button" class="folder-header-delete" aria-label="åˆ é™¤">Ã—</button>' +
          '</div>' +
          '<div class="saved-sets-folder-body"><ul class="saved-sets-list">' + inFolderShow.map(itemHtml).join('') + '</ul></div></div>';
      });
      const uncategorized = filtered.filter(s => !s.folderId || !folderIds.has(String(s.folderId)));
      const uncategorizedShow = uncategorized.filter(s => toShowSet.has(String(s.id)));
      if (uncategorizedShow.length > 0) {
        const collapsed = collapsedState['__uncategorized__'];
        const collapsedClass = collapsed ? ' saved-sets-folder-collapsed' : '';
        html += '<div class="saved-sets-folder' + collapsedClass + '" data-folder-id="__uncategorized__" data-is-uncategorized="true">' +
          '<div class="saved-sets-folder-header">' +
          '<button type="button" class="saved-sets-folder-toggle">' +
          '<span class="folder-icon-wrap">' + folderIconSvg + '</span>' +
          '<span class="saved-sets-folder-name">æœªåˆ†ç±»</span>' +
          '<span class="folder-chevron" aria-hidden="true">â–¼</span>' +
          '</button>' +
          '</div>' +
          '<div class="saved-sets-folder-body"><ul class="saved-sets-list">' + uncategorizedShow.map(itemHtml).join('') + '</ul></div></div>';
      }
      if (hasMore) {
        html += '<div class="saved-sets-show-more-wrap"><button type="button" class="btn btn-secondary saved-sets-show-more" id="btn-saved-sets-show-more">æ˜¾ç¤ºæ›´å¤šï¼ˆå…± ' + orderedSets.length + ' å¥—ï¼‰</button></div>';
      }
      requestAnimationFrame(() => {
      listEl.innerHTML = html;
      listEl.querySelectorAll('.saved-sets-folder-toggle').forEach(toggleBtn => {
        toggleBtn.addEventListener('click', function() {
          const block = this.closest('.saved-sets-folder');
          const fid = block.dataset.folderId;
          block.classList.toggle('saved-sets-folder-collapsed');
          const collapsed = block.classList.contains('saved-sets-folder-collapsed');
          try {
            const raw = localStorage.getItem(FOLDER_COLLAPSED_KEY);
            const state = raw ? JSON.parse(raw) : {};
            state[fid] = collapsed;
            localStorage.setItem(FOLDER_COLLAPSED_KEY, JSON.stringify(state));
          } catch (_) {}
        });
      });
      listEl.querySelectorAll('.folder-header-edit').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const block = this.closest('.saved-sets-folder');
          const id = block.dataset.folderId;
          if (id === '__uncategorized__') return;
          const folders = getFolders();
          const folder = folders.find(f => String(f.id) === id);
          if (!folder) return;
          customPrompt('é‡å‘½åæ–‡ä»¶å¤¹', folder.name || '').then(name => {
            if (name === null || !name.trim()) return;
            setFolders(folders.map(f => String(f.id) === id ? Object.assign({}, f, { name: name.trim() }) : f));
          });
        });
      });
      listEl.querySelectorAll('.folder-header-delete').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          const block = this.closest('.saved-sets-folder');
          const id = block.dataset.folderId;
          if (id === '__uncategorized__') return;
          customConfirm('åˆ é™¤è¯¥æ–‡ä»¶å¤¹ï¼Ÿå…¶ä¸‹ä¹ é¢˜é›†ä¼šç§»åˆ°ã€Œæœªåˆ†ç±»ã€ã€‚').then(confirmed => {
            if (!confirmed) return;
            setFolders(getFolders().filter(f => String(f.id) !== id));
            const sets = getSavedSets();
            const updated = sets.map(s => String(s.folderId || '') === id ? Object.assign({}, s, { folderId: undefined }) : s);
            setSavedSets(updated);
          });
        });
      });
      var showMoreBtn = listEl.querySelector('#btn-saved-sets-show-more');
      if (showMoreBtn) showMoreBtn.addEventListener('click', function() {
        _savedSetsDisplayLimit = Infinity;
        renderSavedSets();
      });
      });
    }
    function renderFolderTags() {
      const tagsEl = document.getElementById('saved-sets-folder-tags');
      if (!tagsEl) return;
      const folders = getFolders();
      const folderIconSvg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>';
      tagsEl.innerHTML = folders.map(f => {
        return '<span class="folder-tag" data-folder-id="' + escapeAttr(String(f.id)) + '">' +
          '<span class="folder-tag-icon">' + folderIconSvg + '</span>' +
          '<span class="folder-tag-name" title="' + escapeAttr(f.name) + '">' + escapeHtml(f.name) + '</span>' +
          '<button type="button" class="folder-tag-edit" aria-label="é‡å‘½å">âœŽ</button>' +
          '<button type="button" class="folder-tag-delete" aria-label="åˆ é™¤">Ã—</button>' +
          '</span>';
      }).join('');
      tagsEl.querySelectorAll('.folder-tag-edit').forEach(btn => {
        btn.addEventListener('click', function() {
          const tag = this.closest('.folder-tag');
          const id = tag.dataset.folderId;
          const folders = getFolders();
          const folder = folders.find(f => String(f.id) === id);
          if (!folder) return;
          customPrompt('é‡å‘½åæ–‡ä»¶å¤¹', folder.name || '').then(name => {
            if (name === null || !name.trim()) return;
            const trimmed = name.trim();
            if (!trimmed) return;
            setFolders(folders.map(f => String(f.id) === id ? Object.assign({}, f, { name: trimmed }) : f));
          });
        });
      });
      tagsEl.querySelectorAll('.folder-tag-delete').forEach(btn => {
        btn.addEventListener('click', function() {
          const tag = this.closest('.folder-tag');
          const id = tag.dataset.folderId;
          customConfirm('åˆ é™¤è¯¥æ–‡ä»¶å¤¹ï¼Ÿå…¶ä¸‹ä¹ é¢˜é›†ä¼šç§»åˆ°ã€Œæœªåˆ†ç±»ã€ã€‚').then(confirmed => {
            if (!confirmed) return;
            const folders = getFolders().filter(f => String(f.id) !== id);
            setFolders(folders);
            const sets = getSavedSets();
            const updated = sets.map(s => String(s.folderId || '') === id ? Object.assign({}, s, { folderId: undefined }) : s);
            setSavedSets(updated);
          });
        });
      });
    }
    function handleSavedSetsAction(e) {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;
      const item = btn.closest('.saved-sets-item');
      if (!item) return;
      const id = item.dataset.id;
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === id);
      switch (btn.dataset.action) {
        case 'start':
          if (set && set.questions && set.questions.length) {
            if (set.questions.length > SEQUENTIAL_MODE_THRESHOLD) openStartModeModal(set);
            else if (hasReviewMaterial(set)) showReviewModal(set, set.questions, false, set.id);
            else startQuiz(set.questions, false, set.id);
          }
          break;
        case 'edit':
          if (set) openEditSetModal(id);
          break;
      }
    }
    let _editingSetId = null;
    let _editModalPastedImages = [];
    function isDataImageUrl(s) { return typeof s === 'string' && /^data:image\//i.test(s.trim()); }
    function isLikelyUrl(str) {
      const s = (str || '').trim();
      if (!s) return false;
      if (/^data:image\//i.test(s)) return false;
      let toTry = /^https?:\/\//i.test(s) ? s : ('https://' + s);
      try {
        const u = new URL(toTry);
        const host = (u.hostname || '').toLowerCase();
        return host.length > 0 && (host.includes('.') || host === 'localhost');
      } catch (_) { return false; }
    }
    function getReviewMaterials(set) {
      if (!set) return { texts: [], links: [], images: [] };
      const hasNew = (set.reviewTexts && set.reviewTexts.length) || (set.reviewLinks && set.reviewLinks.length) || (set.reviewImages && set.reviewImages.length);
      if (hasNew) {
        return {
          texts: Array.isArray(set.reviewTexts) ? set.reviewTexts : [],
          links: Array.isArray(set.reviewLinks) ? set.reviewLinks : [],
          images: Array.isArray(set.reviewImages) ? set.reviewImages : []
        };
      }
      const urls = Array.isArray(set.reviewUrls) ? set.reviewUrls : [];
      const texts = [], links = [], images = [];
      urls.forEach(u => {
        const s = (u || '').trim();
        if (!s) return;
        if (isDataImageUrl(s)) images.push(s);
        else if (isLikelyUrl(s)) links.push(/^https?:\/\//i.test(s) ? s : 'https://' + s);
        else texts.push(s);
      });
      return { texts, links, images };
    }
    function hasReviewMaterial(set) {
      const m = getReviewMaterials(set);
      return m.texts.length > 0 || m.links.length > 0 || m.images.length > 0;
    }
    let _toastTimer = null;
    function showToast(msg) {
      const el = document.getElementById('toast');
      if (!el) return;
      if (_toastTimer) clearTimeout(_toastTimer);
      el.textContent = msg;
      el.classList.add('show');
      _toastTimer = setTimeout(() => {
        el.classList.remove('show');
        _toastTimer = null;
      }, 2200);
    }
    function renderEditModalPastedImages() {
      const listEl = document.getElementById('edit-set-pasted-list');
      if (!listEl) return;
      listEl.innerHTML = _editModalPastedImages.map((dataUrl, i) =>
        '<div class="edit-set-pasted-item" data-index="' + i + '">' +
        '<img src="' + safeImageSrc(dataUrl) + '" alt="" loading="lazy" />' +
        '<button type="button" class="edit-set-pasted-remove" aria-label="åˆ é™¤è¯¥å›¾ç‰‡">Ã—</button></div>'
      ).join('');
      listEl.querySelectorAll('.edit-set-pasted-remove').forEach(btn => {
        btn.addEventListener('click', function() {
          const i = parseInt(this.closest('.edit-set-pasted-item').dataset.index, 10);
          _editModalPastedImages.splice(i, 1);
          renderEditModalPastedImages();
        });
      });
    }
    function openEditSetModal(setId) {
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === setId);
      if (!set) return;
      _editingSetId = setId;
      const nameEl = document.getElementById('edit-set-name');
      const textsEl = document.getElementById('edit-set-review-texts');
      const linksEl = document.getElementById('edit-set-review-links');
      const metaEl = document.getElementById('edit-set-meta');
      if (nameEl) nameEl.value = set.name || '';
      const folderEl = document.getElementById('edit-set-folder');
      if (folderEl) folderEl.value = set.folderId != null ? String(set.folderId) : '';
      const m = getReviewMaterials(set);
      if (textsEl) textsEl.value = m.texts.join('\n');
      if (linksEl) linksEl.value = m.links.join('\n');
      _editModalPastedImages = m.images.slice();
      if (metaEl) metaEl.textContent = set.questions ? set.questions.length + ' é¢˜ Â· ç»ƒä¹  ' + (set.practiceCount || 0) + ' æ¬¡' : '';
      renderEditModalPastedImages();
      const appendEl = document.getElementById('edit-set-append-text');
      if (appendEl) appendEl.value = '';
      const editOverlay = document.getElementById('edit-set-modal-overlay');
      editOverlay.classList.add('show');
      setModalFocusTrap(editOverlay);
    }
    function closeEditSetModal() {
      _editingSetId = null;
      clearModalFocusTrap();
      document.getElementById('edit-set-modal-overlay').classList.remove('show');
    }
    function formatQuestionForPreview(q, index) {
      const typeLabel = QUESTION_TYPES[q.type] || q.type || 'é¢˜ç›®';
      const head = 'ç¬¬ ' + (index + 1) + ' é¢˜ Â· ' + typeLabel + (q.category ? ' Â· ' + escapeHtml(q.category) : '');
      const stem = '<div class="preview-q-stem">' + escapeHtml(q.stem || '') + '</div>';
      let options = '';
      if (q.options && q.options.length) {
        const opts = q.options.map((opt, i) => LETTERS[i] + ') ' + escapeHtml(opt)).join('<br/>');
        options = '<div class="preview-q-options">' + opts + '</div>';
      }
      let correctStr = '';
      if (q.type === 'single_choice' && q.options && q.options.length) {
        const idx = Array.isArray(q.correct) ? q.correct[0] : q.correct;
        if (idx >= 0 && idx < q.options.length) correctStr = 'æ­£ç¡®ç­”æ¡ˆï¼š' + LETTERS[idx] + ') ' + escapeHtml(q.options[idx]);
      } else if (q.type === 'multiple_choice' && q.options && Array.isArray(q.correct)) {
        const labels = q.correct.map(i => LETTERS[i] + ') ' + (q.options[i] ? escapeHtml(q.options[i]) : '')).filter(Boolean);
        correctStr = 'æ­£ç¡®ç­”æ¡ˆï¼š' + (labels.length ? labels.join('ï¼›') : escapeHtml(String(q.correct)));
      } else if ((q.type === 'fill_blank' || q.type === 'paragraph_fill_blank') && q.correct != null) {
        const arr = Array.isArray(q.correct) ? q.correct : [q.correct];
        correctStr = 'æ­£ç¡®ç­”æ¡ˆï¼š' + arr.map(c => Array.isArray(c) ? c.join(' / ') : escapeHtml(String(c))).join('ï¼›');
      }
      const correct = correctStr ? '<div class="preview-q-correct">' + correctStr + '</div>' : '';
      const explanation = (q.explanation && q.explanation.trim()) ? '<div class="preview-q-explanation">è§£æžï¼š' + escapeHtml(q.explanation.trim()) + '</div>' : '';
      return '<div class="preview-q"><div class="preview-q-head">' + head + '</div>' + stem + options + correct + explanation + '</div>';
    }
    function showPreviewQuestions(set) {
      if (!set || !set.questions || !set.questions.length) {
        showToast('æœ¬é¢˜é›†æš‚æ— é¢˜ç›®ï¼Œæ— æ³•é¢„è§ˆ');
        return;
      }
      const titleEl = document.getElementById('preview-questions-title');
      const bodyEl = document.getElementById('preview-questions-body');
      if (titleEl) titleEl.textContent = 'ä¹ é¢˜é¢„è§ˆï¼š' + (set.name || 'æœªå‘½å');
      if (bodyEl) bodyEl.innerHTML = set.questions.map((q, i) => formatQuestionForPreview(q, i)).join('');
      const prevOverlay = document.getElementById('preview-questions-overlay');
      prevOverlay.classList.add('show');
      setModalFocusTrap(prevOverlay);
    }
    function closePreviewQuestions() {
      clearModalFocusTrap();
      document.getElementById('preview-questions-overlay').classList.remove('show');
    }
    function saveEditSetModal() {
      if (_editingSetId == null) return;
      const nameEl = document.getElementById('edit-set-name');
      const textsEl = document.getElementById('edit-set-review-texts');
      const linksEl = document.getElementById('edit-set-review-links');
      const name = nameEl ? String(nameEl.value).trim() : '';
      if (!name) {
        showToast('è¯·å¡«å†™ä¹ é¢˜é›†åç§°');
        if (nameEl) nameEl.focus();
        return;
      }
      const reviewTexts = (textsEl && textsEl.value ? textsEl.value.trim().split(/\n/) : []).map(s => s.trim()).filter(s => s.length > 0);
      const linkLines = (linksEl && linksEl.value ? linksEl.value.trim().split(/\n/) : []).map(s => s.trim()).filter(s => s.length > 0);
      const reviewLinks = linkLines.map(s => (/^https?:\/\//i.test(s) || isLikelyUrl(s)) ? (/^https?:\/\//i.test(s) ? s : 'https://' + s) : s);
      const reviewImages = _editModalPastedImages.slice();
      const sets = getSavedSets();
      const folderEl = document.getElementById('edit-set-folder');
      const folderId = (folderEl && folderEl.value) ? folderEl.value : null;
      const updated = sets.map(s => String(s.id) === String(_editingSetId) ? Object.assign({}, s, { name: name, folderId: folderId || undefined, reviewTexts: reviewTexts, reviewLinks: reviewLinks, reviewImages: reviewImages }) : s);
      setSavedSets(updated);
      closeEditSetModal();
    }
    function exportFromEditModal() {
      if (_editingSetId == null) return;
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === String(_editingSetId));
      if (!set || !set.questions) return;
      const name = (set.name || 'ä¹ é¢˜é›†').replace(/[\\/:*?"<>|]/g, '_').slice(0, 50);
      const blob = new Blob([JSON.stringify(set.questions, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = (name || 'export') + '.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function appendToEditSetModal() {
      if (_editingSetId == null) return;
      const textEl = document.getElementById('edit-set-append-text');
      let text = textEl ? textEl.value.trim() : '';
      if (!text) {
        showToast('è¯·å…ˆç²˜è´´è¦è¿½åŠ çš„é¢˜ç›®ï¼ˆJSON æˆ–å«é¢˜åž‹/é€‰é¡¹çš„æ–‡æœ¬ï¼‰');
        if (textEl) textEl.focus();
        return;
      }
      text = normalizeJsonPaste(text);
      const appendBtn = document.getElementById('btn-edit-set-append');
      const origAppendText = appendBtn ? appendBtn.textContent : '';
      if (appendBtn) { appendBtn.disabled = true; appendBtn.textContent = 'è§£æžä¸­â€¦'; }
      let parsed = [];
      let appendParseError = '';
      if (/^\s*[\[{]/.test(text)) {
        try {
          const data = JSON.parse(text);
          parsed = Array.isArray(data) ? data : (data.questions || []);
        } catch (e) {
          appendParseError = (e && (e.message || String(e))) || '';
        }
      }
      if (parsed.length === 0) parsed = parsePastedText(text);
      if (appendBtn) { appendBtn.disabled = false; appendBtn.textContent = origAppendText; }
      if (parsed.length === 0) {
        showToast(appendParseError ? 'JSON è§£æžå¤±è´¥ï¼š' + appendParseError : 'æœªèƒ½è§£æžå‡ºé¢˜ç›®ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
        return;
      }
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === String(_editingSetId));
      if (!set || !Array.isArray(set.questions)) return;
      const existingFps = new Set(set.questions.map(q => wrongBookItemId(q)));
      const toAdd = [];
      let dupCount = 0;
      for (let i = 0; i < parsed.length; i++) {
        const fp = wrongBookItemId(parsed[i]);
        if (existingFps.has(fp)) dupCount++; else { existingFps.add(fp); toAdd.push(parsed[i]); }
      }
      const newQuestions = set.questions.concat(toAdd);
      const updated = sets.map(s => String(s.id) === String(_editingSetId) ? Object.assign({}, s, { questions: newQuestions }) : s);
      setSavedSets(updated);
      const metaEl = document.getElementById('edit-set-meta');
      if (metaEl) metaEl.textContent = newQuestions.length + ' é¢˜ Â· ç»ƒä¹  ' + (set.practiceCount || 0) + ' æ¬¡';
      if (textEl) textEl.value = '';
      showToast('å·²è¿½åŠ  ' + toAdd.length + ' é¢˜' + (dupCount ? 'ï¼Œè·³è¿‡ ' + dupCount + ' é“é‡å¤' : '') + 'ï¼Œå½“å‰å…± ' + newQuestions.length + ' é¢˜');
    }
    function deleteFromEditModal() {
      if (_editingSetId == null) return;
      customConfirm('ç¡®å®šåˆ é™¤è¯¥ä¹ é¢˜é›†ï¼Ÿåˆ é™¤åŽæ— æ³•æ¢å¤ã€‚').then(confirmed => {
        if (!confirmed) return;
        const sets = getSavedSets().filter(s => String(s.id) !== String(_editingSetId));
        setSavedSets(sets);
        closeEditSetModal();
        renderSavedSets();
        updateStartPracticeSelect();
      });
    }

    const EBINGHAUS_INTERVALS = [1, 3, 7, 14, 30];
    function todayString() {
      const d = new Date();
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }
    function addDays(dayStr, days) {
      const d = new Date(dayStr + 'T12:00:00');
      d.setDate(d.getDate() + days);
      return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }
    function wrongBookItemId(item) {
      if (_wrongBookIdCache.has(item)) return _wrongBookIdCache.get(item);
      const id = (item.stem || '') + '|' + (item.options ? item.options.join('|') : '') + '|' + String(item.correct != null ? item.correct : '');
      _wrongBookIdCache.set(item, id);
      return id;
    }
    function getQuestionNotes(questionId) {
      try {
        const raw = localStorage.getItem(QUESTION_NOTES_KEY);
        const obj = raw ? JSON.parse(raw) : {};
        return (obj && obj[questionId] != null) ? String(obj[questionId]) : '';
      } catch (_) { return ''; }
    }
    function setQuestionNotes(questionId, text) {
      try {
        const raw = localStorage.getItem(QUESTION_NOTES_KEY);
        const obj = raw ? JSON.parse(raw) : {};
        obj[questionId] = (text || '').trim();
        if (!obj[questionId]) delete obj[questionId];
        localStorage.setItem(QUESTION_NOTES_KEY, JSON.stringify(obj));
      } catch (_) {}
    }
    function getWrongBook() {
      if (!_wrongBookCacheDirty && _wrongBookCache !== null) return _wrongBookCache;
      try {
        const raw = localStorage.getItem(WRONG_BOOK_KEY);
        _wrongBookCache = raw ? JSON.parse(raw) : [];
        _wrongBookCacheDirty = false;
        return _wrongBookCache;
      } catch (_) { return []; }
    }
    function setWrongBook(arr) {
      _wrongBookCache = arr;
      _wrongBookCacheDirty = false;
      localStorage.setItem(WRONG_BOOK_KEY, JSON.stringify(arr));
      updateWrongCount();
      updateStatsBar();
    }
    function removeFromWrongBook(q) {
      const book = getWrongBook();
      const id = wrongBookItemId(q);
      const next = book.filter(item => wrongBookItemId(item) !== id);
      if (next.length < book.length) setWrongBook(next);
    }
    function getWrongBookDue() {
      const book = getWrongBook();
      const today = todayString();
      return book
        .filter(item => {
          const next = item.nextReview;
          if (!next) return true;
          return next <= today;
        })
        .sort((a, b) => (a.nextReview || '').localeCompare(b.nextReview || ''));
    }
    function addToWrongBook(q) {
      const book = getWrongBook();
      const id = wrongBookItemId(q);
      const idx = book.findIndex(item => wrongBookItemId(item) === id);
      if (idx >= 0) {
        book[idx] = Object.assign({}, book[idx], { wrongCount: (book[idx].wrongCount || 0) + 1 });
      } else {
        const nextReview = addDays(todayString(), 1);
        book.push(Object.assign({}, q, { nextReview: nextReview, interval: 1, repetitions: 0, wrongCount: 1 }));
      }
      setWrongBook(book);
    }
    function addToWrongBookDirect(item) {
      const book = getWrongBook();
      const id = wrongBookItemId(item);
      if (book.some(i => wrongBookItemId(i) === id)) return;
      book.push(item);
      setWrongBook(book);
    }
    function updateWrongBookAfterAnswer(item, correct) {
      const book = getWrongBook();
      const id = wrongBookItemId(item);
      const idx = book.findIndex(i => wrongBookItemId(i) === id);
      if (idx === -1) return;
      const today = todayString();
      if (correct) {
        const rep = (book[idx].repetitions || 0) + 1;
        if (rep >= 5) {
          book.splice(idx, 1);
        } else {
          const intervalDays = EBINGHAUS_INTERVALS[Math.min(rep, EBINGHAUS_INTERVALS.length - 1)];
          book[idx] = Object.assign({}, book[idx], {
            repetitions: rep,
            interval: intervalDays,
            nextReview: addDays(today, intervalDays)
          });
        }
      } else {
        book[idx] = Object.assign({}, book[idx], {
          nextReview: addDays(today, 1),
          repetitions: 0,
          interval: 1
        });
      }
      setWrongBook(book);
    }
    function getWrongCountForQuestion(q) {
      if (!q) return 0;
      const book = getWrongBook();
      const id = wrongBookItemId(q);
      const item = book.find(i => wrongBookItemId(i) === id);
      return (item && item.wrongCount != null) ? item.wrongCount : 0;
    }
    function updateWrongCount() {
      const el = document.getElementById('wrong-count');
      if (el) el.textContent = getWrongBook().length;
    }

    const DEFAULT_QUESTIONS = [
      { type: 'single_choice', stem: 'En ce moment, nous ______ un film intÃ©ressant.', options: ['voions', 'voyons', 'voyez', 'voient'], correct: 1, explanation: 'ã€A2 æ‹¼å†™é™·é˜±ã€‘Nous/Vous å˜ä½æ—¶ï¼Œè¯æ ¹ i å¿…é¡»å˜ä¸º yã€‚Nous voyons æ˜¯å”¯ä¸€æ­£ç¡®å½¢å¼ã€‚', category: 'ç›´é™ˆå¼çŽ°åœ¨æ—¶' },
      { type: 'single_choice', stem: 'Hier, est-ce que tu ______ tes amis ?', options: ['a vu', 'as vu', 'as vus', 'es vu'], correct: 1, explanation: 'ã€A1 å¤åˆè¿‡åŽ»æ—¶ã€‘Tu æ­é…åŠ©åŠ¨è¯ avoir (as) + è¿‡åŽ»åˆ†è¯ vuã€‚æ­¤æ—¶æ²¡æœ‰å®¾è¯­æå‰ï¼Œvu ä¸é…åˆï¼Œä¸ç”¨åŠ  sã€‚', category: 'å¤åˆè¿‡åŽ»æ—¶' },
      { type: 'single_choice', stem: 'Les fleurs ? Oui, je les ai ______.', options: ['vu', 'vue', 'vus', 'vues'], correct: 3, explanation: 'ã€B2 è¿‡åŽ»åˆ†è¯é…åˆã€‘æ ¸å¿ƒè€ƒç‚¹ï¼les æŒ‡ä»£ les fleurs (é˜´æ€§å¤æ•°)ï¼Œä¸”æ”¾åœ¨äº†åŠ©åŠ¨è¯ ai ä¹‹å‰ã€‚è¿‡åŽ»åˆ†è¯ vu å¿…é¡»é…åˆï¼ŒåŠ  es â†’ vuesã€‚', category: 'å¤åˆè¿‡åŽ»æ—¶' },
      { type: 'single_choice', stem: 'Demain, je ______ le mÃ©decin.', options: ['vais voir', 'vais vois', 'va voir', 'aller voir'], correct: 0, explanation: 'ã€A1 æœ€è¿‘å°†æ¥æ—¶ã€‘ç»“æž„ï¼šAller (å˜ä½) +åŠ¨è¯åŽŸå½¢ã€‚Je vais + voirã€‚', category: 'æœ€è¿‘å°†æ¥æ—¶' },
      { type: 'single_choice', stem: 'Non, je ne ______ pas le voir ce soir.', options: ['vais', 'va', 'vois', 'ai'], correct: 0, explanation: 'ã€A2 å¦å®šå¥ç»“æž„ã€‘æœ€è¿‘å°†æ¥æ—¶çš„å¦å®šæ˜¯ Ne + Aller + Pas + åŽŸå½¢ã€‚Je ne *vais* pas le voirã€‚', category: 'æœ€è¿‘å°†æ¥æ—¶' },
      { type: 'multiple_choice', stem: 'ä¸‹åˆ—å“ªäº›å¥å­çš„å˜ä½å½¢å¼åœ¨å‘éŸ³ä¸Šå®Œå…¨ç›¸åŒï¼ˆå³ TCF å¬åŠ›ä¸­çš„åŒéŸ³é™·é˜±ï¼‰ï¼Ÿ', options: ['Je vois', 'Tu vois', 'Il voit', 'Ils voient'], correct: [0, 1, 2, 3], explanation: 'ã€A1 è¯­éŸ³è¾¨æžã€‘TCF å¬åŠ›éš¾ç‚¹ã€‚vois, voit, voient å‘éŸ³å‡ä¸º /vwa/ã€‚åªæœ‰ä¸Šä¸‹æ–‡çš„ä¸»è¯­èƒ½åŒºåˆ†å®ƒä»¬ã€‚', category: 'ç›´é™ˆå¼çŽ°åœ¨æ—¶' },
      { type: 'multiple_choice', stem: 'å…³äºŽå¤åˆè¿‡åŽ»æ—¶ \'J\'ai vu\'ï¼Œä¸‹åˆ—å“ªäº›è¯´æ³•æ˜¯æ­£ç¡®çš„ï¼Ÿ', options: ['åŠ©åŠ¨è¯æ˜¯ Ãªtre', 'åŠ©åŠ¨è¯æ˜¯ avoir', 'è¿‡åŽ»åˆ†è¯æ˜¯ vu', 'è¿‡åŽ»åˆ†è¯æ˜¯ voirÃ©'], correct: [1, 2], explanation: 'ã€A1 åŸºç¡€æž„æˆã€‘Voir çš„å¤åˆè¿‡åŽ»æ—¶ç”± Avoir + Vu æž„æˆã€‚', category: 'å¤åˆè¿‡åŽ»æ—¶' },
      { type: 'multiple_choice', stem: 'åœ¨æœ€è¿‘å°†æ¥æ—¶ä¸­ï¼Œä»£è¯çš„ä½ç½®å“ªé‡Œæ˜¯æ­£ç¡®çš„ï¼Ÿ', options: ['Je vais le voir.', 'Je le vais voir.', 'Nous allons les voir.', 'Nous les allons voir.'], correct: [0, 2], explanation: 'ã€B1 ä»£è¯ä½ç½®ã€‘åœ¨æœ€è¿‘å°†æ¥æ—¶ä¸­ï¼Œå®¾è¯­ä»£è¯ï¼ˆle, la, les, lui...ï¼‰å¿…é¡»æ”¾åœ¨åŽŸå½¢åŠ¨è¯ï¼ˆvoirï¼‰ä¹‹å‰ï¼Œä¸èƒ½æ”¾åœ¨ aller ä¹‹å‰ã€‚', category: 'æœ€è¿‘å°†æ¥æ—¶' },
      { type: 'multiple_choice', stem: 'é€‰å‡ºä¸‹åˆ—å¥å­ä¸­è¯­æ³•**é”™è¯¯**çš„é€‰é¡¹ï¼š', options: ['Ils voyent la mer.', 'Nous voions la montagne.', 'Vous voyez le problÃ¨me.', 'Elles voient le chat.'], correct: [0, 1], explanation: 'ã€A2 æ‹¼å†™è§„åˆ™ã€‘Ils åŽé¢åº”ä¸º voient (i ä¸å˜ y)ï¼›Nous åŽé¢åº”ä¸º voyons (i å¿…é¡»å˜ y)ã€‚', category: 'ç›´é™ˆå¼çŽ°åœ¨æ—¶' },
      { type: 'multiple_choice', stem: 'å“ªäº›æ—¶é—´æ ‡å¿—è¯é€šå¸¸è§¦å‘\'å¤åˆè¿‡åŽ»æ—¶\'ï¼Ÿ', options: ['Hier', 'La semaine derniÃ¨re', 'Demain', 'Maintenant'], correct: [0, 1], explanation: 'ã€A2 æ—¶é—´çŠ¶è¯­ã€‘Hier (æ˜¨å¤©) å’Œ La semaine derniÃ¨re (ä¸Šå‘¨) æ˜¯è¿‡åŽ»æ—¶çš„å…¸åž‹æ ‡å¿—ã€‚', category: 'å¤åˆè¿‡åŽ»æ—¶' },
      { type: 'fill_blank', stem: 'Regarde ! Ils ______ (voir) un arc-en-ciel.', options: ['voient'], correct: ['voient'], explanation: 'ã€A1 å˜ä½ã€‘Ils (å¤æ•°ç¬¬ä¸‰äººç§°) å˜ä½ä¸º voientã€‚', category: 'ç›´é™ˆå¼çŽ°åœ¨æ—¶' },
      { type: 'fill_blank', stem: 'C\'est la lettre que j\'ai ______ (voir).', options: ['vue'], correct: ['vue'], explanation: 'ã€B2 é…åˆã€‘Que æŒ‡ä»£ la lettre (é˜´æ€§å•æ•°)ï¼Œä¸”åœ¨åŠ¨è¯å‰ï¼Œvu éœ€å˜æˆ vueã€‚', category: 'å¤åˆè¿‡åŽ»æ—¶' },
      { type: 'fill_blank', stem: 'Nous ______ (voir) que tu es fatiguÃ©.', options: ['voyons'], correct: ['voyons'], explanation: 'ã€A2 æ‹¼å†™ã€‘Nous + voir = voyons (æ³¨æ„ y)ã€‚', category: 'ç›´é™ˆå¼çŽ°åœ¨æ—¶' },
      { type: 'fill_blank', stem: 'BientÃ´t, on ______ (aller) voir le rÃ©sultat.', options: ['va'], correct: ['va'], explanation: 'ã€A1 æœ€è¿‘å°†æ¥æ—¶ã€‘On va voirã€‚æ³¨æ„ On çš„å˜ä½ç­‰åŒäºŽ Il/Elleã€‚', category: 'æœ€è¿‘å°†æ¥æ—¶' },
      { type: 'fill_blank', stem: 'OÃ¹ sont mes lunettes ? Je ne les ai pas ______ (voir).', options: ['vues'], correct: ['vues'], explanation: 'ã€B2 é…åˆ+å¦å®šã€‘Les æŒ‡ä»£ lunettes (é˜´æ€§å¤æ•°)ï¼Œæ”¾åœ¨ ai ä¹‹å‰ï¼Œè¿‡åŽ»åˆ†è¯å¿…é¡»é…åˆä¸º vuesã€‚å¦å®šè¯ ne...pas ä¸å½±å“é…åˆè§„åˆ™ã€‚', category: 'å¤åˆè¿‡åŽ»æ—¶' },
      { type: 'paragraph_fill_blank', stem: 'Hier, j\'ai _____ un accident. Aujourd\'hui, je _____ que la police est lÃ .', correct: ['vu', 'vois'], explanation: 'ã€æ—¶æ€å¯¹æ¯”ã€‘ç¬¬ä¸€ç©º Hier è§¦å‘å¤åˆè¿‡åŽ»æ—¶ (ai vu)ï¼›ç¬¬äºŒç©º Aujourd\'hui è§¦å‘çŽ°åœ¨æ—¶ (vois)ã€‚', category: 'æ—¶æ€ç»¼åˆ' },
      { type: 'paragraph_fill_blank', stem: 'Tu _____ voir ce film demain ? Non, je l\'ai dÃ©jÃ  _____.', correct: ['vas', 'vu'], explanation: 'ã€è¯­å¢ƒè¾¨æžã€‘ç¬¬ä¸€ç©º Demain è§¦å‘æœ€è¿‘å°†æ¥æ—¶ (vas voir)ï¼›ç¬¬äºŒç©º dÃ©jÃ  è§¦å‘å¤åˆè¿‡åŽ»æ—¶ã€‚æ³¨æ„è¿™é‡Œ le æŒ‡ä»£ film (é˜³æ€§)ï¼Œæ‰€ä»¥ vu ä¸å˜ã€‚', category: 'æ—¶æ€ç»¼åˆ' },
      { type: 'paragraph_fill_blank', stem: 'Les photos ? Nous les _____ vues. Elles sont belles, vous _____ ?', correct: ['avons', 'voyez'], explanation: 'ã€B2 åŠ©åŠ¨è¯ä¸Žå˜ä½ã€‘ç¬¬ä¸€ç©ºï¼šå¤åˆè¿‡åŽ»æ—¶åŠ©åŠ¨è¯ nous avons (vues å·²é…åˆ)ï¼›ç¬¬äºŒç©ºï¼šçŽ°åœ¨æ—¶ vous voyez (æ³¨æ„ y)ã€‚', category: 'å¤åˆè¿‡åŽ»æ—¶ & çŽ°åœ¨æ—¶' },
      { type: 'paragraph_fill_blank', stem: 'Elles _____ (voir) mal sans lunettes. Elles vont _____ (voir) le docteur.', correct: ['voient', 'voir'], explanation: 'ã€å½¢ä¼¼è¯è¾¨æžã€‘ç¬¬ä¸€ç©ºæ˜¯çŽ°åœ¨æ—¶å˜ä½ voientï¼›ç¬¬äºŒç©ºæ˜¯æœ€è¿‘å°†æ¥æ—¶ï¼ŒAller åŽé¢å¿…é¡»è·ŸåŽŸå½¢ voirã€‚', category: 'ç›´é™ˆå¼çŽ°åœ¨æ—¶ & æœ€è¿‘å°†æ¥æ—¶' },
      { type: 'paragraph_fill_blank', stem: 'C\'est la fille que tu as _____ ? Oui, je vais la _____ demain.', correct: ['vue', 'voir'], explanation: 'ã€B2 ç»¼åˆéš¾ç‚¹ã€‘ç¬¬ä¸€ç©ºï¼šQue æŒ‡ä»£ la fille (é˜´æ€§)ï¼Œas vue éœ€é…åˆã€‚ç¬¬äºŒç©ºï¼šæœ€è¿‘å°†æ¥æ—¶ la æ”¾åœ¨åŽŸå½¢ voir ä¹‹å‰ã€‚', category: 'å¤åˆè¿‡åŽ»æ—¶ & æœ€è¿‘å°†æ¥æ—¶' }
    ];

    function getCurrentSetQuestions() {
      const sel = $('start-practice-select');
      const val = sel ? sel.value : 'default';
      if (val === 'default') return DEFAULT_QUESTIONS;
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === val);
      return (set && set.questions) ? set.questions : [];
    }
    function updateCategoryFilter() {
      const questions = getCurrentSetQuestions();
      const categories = [...new Set(questions.map(q => q.category).filter(Boolean))].sort();
      const wrap = $('category-filter-wrap');
      const sel = $('filter-category');
      if (!wrap || !sel) return;
      const currentVal = sel.value;
      sel.innerHTML = '<option value="">å…¨éƒ¨</option>' + categories.map(c => '<option value="' + escapeHtml(c) + '">' + escapeHtml(c) + '</option>').join('');
      if (categories.indexOf(currentVal) !== -1) sel.value = currentVal;
      else sel.value = '';
      wrap.style.display = categories.length > 0 ? 'block' : 'none';
    }

    let state = {
      questions: [],
      index: 0,
      score: 0,
      answered: false,
      timerSeconds: 10,
      practicingWrongBook: false,
      practicedSetId: null,
      sequentialBatch: null
    };
    let timerId = null;
    let _pendingTimers = [];  // Track pending setTimeout/setInterval for cleanup

    const TIMER_CIRCUMFERENCE = 2 * Math.PI * 17; // ~106.81
    function clearTimer() {
      if (timerId) clearInterval(timerId);
      timerId = null;
      const el = document.getElementById('quiz-timer');
      if (el) { el.style.display = 'none'; el.textContent = ''; el.classList.remove('low'); }
      const ring = document.getElementById('timer-ring');
      const ringFill = document.getElementById('timer-ring-fill');
      if (ring) ring.style.display = 'none';
      if (ringFill) { ringFill.style.strokeDashoffset = '0'; ringFill.classList.remove('low'); }
    }
    function startTimer(extraSeconds) {
      clearTimer();
      const base = state.timerSeconds || 0;
      const seconds = base + (extraSeconds || 0);
      if (!seconds) return;
      let remain = seconds;
      const el = document.getElementById('quiz-timer');
      const ring = document.getElementById('timer-ring');
      const ringFill = document.getElementById('timer-ring-fill');
      if (!el) return;
      el.style.display = 'inline';
      el.textContent = remain;
      el.classList.remove('low');
      if (ring) ring.style.display = 'block';
      if (ringFill) { ringFill.style.strokeDashoffset = '0'; ringFill.classList.remove('low'); }
      timerId = setInterval(() => {
        remain--;
        el.textContent = remain;
        if (ringFill) {
          const offset = TIMER_CIRCUMFERENCE * (1 - remain / seconds);
          ringFill.style.strokeDashoffset = offset;
        }
        if (remain <= 3) {
          el.classList.add('low');
          if (ringFill) ringFill.classList.add('low');
          if (remain > 0 && navigator.vibrate) navigator.vibrate(200);
        }
        if (remain <= 0) {
          clearTimer();
          submitAnswer();
        }
      }, 1000);
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const screen = document.getElementById(id);
      screen.classList.add('active');
      requestAnimationFrame(() => {
        if (id === SCREEN.QUIZ) {
          const first = screen.querySelector('.option, input[type="text"], .btn-primary');
          if (first) first.focus();
        } else if (id === SCREEN.RESULT) {
          const scoreEl = screen.querySelector('.result-score');
          if (scoreEl) { scoreEl.setAttribute('tabindex', '-1'); scoreEl.focus(); }
        }
      });
    }

    function normalizeJsonPaste(str) {
      if (typeof str !== 'string') return str;
      return str
        .replace(/\uFEFF/g, '')
        .replace(/\u00A0/g, ' ')
        .replace(/\u200B|\u200C|\u200D|\u2060/g, '')
        .replace(/\u201C/g, '"')
        .replace(/\u201D/g, '"')
        .replace(/\u2018/g, "'")
        .replace(/\u2019/g, "'")
        .replace(/\uFF3B/g, '[')
        .replace(/\uFF3D/g, ']')
        .replace(/\uFF5B/g, '{')
        .replace(/\uFF5D/g, '}')
        .replace(/,(\s*[\]}])/g, '$1')
        .trim();
    }
    function parsePastedText(text) {
      const questions = [];
      // æŒ‰ã€Œå¥—è·¯ Nã€æˆ–ã€Œé¢˜åž‹ï¼šã€åˆ†å—ï¼Œä¿è¯æ¯å—é‡Œæœ‰ä¸€é“é¢˜
      const chunks = text.split(/(?=å¥—è·¯\s*\d|é¢˜åž‹[ï¼š:])/i).filter(b => b.trim());
      for (const chunk of chunks) {
        // é¢˜åž‹ï¼šåŽé¢åˆ° A) ä¹‹å‰ä¸ºé¢˜å¹²ï¼ˆå¯å¤šè¡Œï¼‰
        const stemMatch = chunk.match(/é¢˜åž‹[ï¼š:]\s*([\s\S]*?)(?=A\)\s)/i);
        if (!stemMatch) continue;
        const stem = stemMatch[1].replace(/\s+/g, ' ').trim();
        // A) ... B) ... C) ... D) ...ï¼ˆå…è®¸åŒä¸€è¡Œæˆ–æ¢è¡Œï¼‰
        const optMatch = chunk.match(/A\)\s*([\s\S]*?)\s*B\)\s*([\s\S]*?)\s*C\)\s*([\s\S]*?)\s*D\)\s*([\s\S]*?)(?=\n|æ­£ç¡®|$)/);
        if (!optMatch) continue;
        const options = [optMatch[1], optMatch[2], optMatch[3], optMatch[4]].map(s => s.trim());
        const correctMatch = chunk.match(/æ­£ç¡®[ï¼š:]\s*([A-D])/i);
        if (!correctMatch) continue;
        const correct = LETTERS.indexOf(correctMatch[1].toUpperCase());
        if (correct === -1) continue;
        let category = '';
        const catMatch = chunk.match(/å¥—è·¯\s*\d+[ï¼š:]\s*([^\nï¼ˆ(]+)/);
        if (catMatch) category = catMatch[1].trim();
        let explanation = '';
        const expMatch = chunk.match(/(?:å¹²æ‰°é¡¹åˆ†æž|è§£é‡Š|å‡ºé¢˜äººæƒ³è€ƒ|è®°å¿†å£è¯€)[ï¼š:]\s*([\s\S]+?)(?=å¥—è·¯\s*\d|é¢˜åž‹[ï¼š:]|$)/i);
        if (expMatch) explanation = expMatch[1].trim().split(/\n/).slice(0, 8).join('\n');
        questions.push({
          type: 'single_choice',
          category,
          stem,
          options,
          correct,
          explanation: explanation || `æ­£ç¡®ç­”æ¡ˆï¼š${LETTERS[correct]}`
        });
      }
      return questions;
    }

    function startQuiz(questions, fromWrongBook, setId, opts) {
      if (!questions || questions.length === 0) {
        showToast(fromWrongBook ? 'æ²¡æœ‰åˆ°æœŸéœ€è¦å¤ä¹ çš„é”™é¢˜ï¼Œæ˜Žå¤©å†æ¥' : 'æ²¡æœ‰å¯ç”¨çš„é¢˜ç›®ï¼Œè¯·æ£€æŸ¥å¯¼å…¥æˆ–ä½¿ç”¨é»˜è®¤é¢˜ç›®');
        return;
      }
      opts = opts || {};
      if (typeof performance !== 'undefined' && performance.mark) performance.mark('quiz-start');
      const timerInput = document.getElementById('timer-seconds');
      state.timerSeconds = timerInput ? Math.max(0, parseInt(timerInput.value, 10) || 10) : 10;
      const noShuffle = !!opts.noShuffle;
      let list = (noShuffle || !(document.getElementById('shuffle-questions') && document.getElementById('shuffle-questions').checked))
        ? questions.slice()
        : shuffleArray(questions);
      if (!noShuffle && document.getElementById('shuffle-options') && document.getElementById('shuffle-options').checked) {
        list = list.map(shuffleQuestionOptions);
      }
      state.questions = list;
      state.index = 0;
      state.score = 0;
      state.answered = false;
      state.answerResults = {};
      state.practicingWrongBook = !!fromWrongBook;
      state.practicedSetId = setId || null;
      state.sequentialBatch = opts.sequentialBatch || null;
      showScreen(SCREEN.QUIZ);
      if (typeof performance !== 'undefined' && performance.mark) performance.mark('quiz-first-render-start');
      renderQuestion();
      if (typeof performance !== 'undefined' && performance.mark) {
        performance.mark('quiz-first-render-end');
        try { performance.measure('quiz-first-render', 'quiz-first-render-start', 'quiz-first-render-end'); } catch (_) {}
      }
    }
    let _pendingReviewStart = null;
    let _pendingStartSet = null;
    function openStartModeModal(set) {
      _pendingStartSet = set;
      const total = set.questions.length;
      const nextIdx = Math.max(0, parseInt(set.sequentialNextIndex, 10) || 0);
      const remain = total - nextIdx;
      const overlay = document.getElementById('start-mode-modal-overlay');
      const seqBlock = document.getElementById('start-mode-sequential');
      const finishedBlock = document.getElementById('start-mode-finished');
      const fromEl = document.getElementById('start-mode-from');
      const remainEl = document.getElementById('start-mode-remain');
      const countInput = document.getElementById('start-mode-count');
      const reviewCard = document.getElementById('start-mode-review-card');
      const reviewCheck = document.getElementById('start-mode-review');
      if (remain <= 0) {
        if (seqBlock) seqBlock.style.display = 'none';
        if (finishedBlock) finishedBlock.style.display = 'flex';
        if (fromEl) fromEl.textContent = '1';
        if (remainEl) remainEl.textContent = total;
      } else {
        if (seqBlock) seqBlock.style.display = 'flex';
        if (finishedBlock) finishedBlock.style.display = 'none';
        if (fromEl) fromEl.textContent = nextIdx + 1;
        if (remainEl) remainEl.textContent = remain;
        if (countInput) {
          countInput.max = remain;
          countInput.value = Math.min(20, remain);
        }
      }
      const hasReview = hasReviewMaterial(set);
      if (reviewCard) reviewCard.style.display = hasReview ? 'flex' : 'none';
      if (reviewCheck) reviewCheck.checked = hasReview;
      if (overlay) { overlay.classList.add('show'); overlay.style.display = 'flex'; setModalFocusTrap(overlay); }
    }
    function closeStartModeModal() {
      _pendingStartSet = null;
      const overlay = document.getElementById('start-mode-modal-overlay');
      if (overlay) { overlay.classList.remove('show'); overlay.style.display = 'none'; clearModalFocusTrap(); }
    }
    function showReviewModal(set, questions, fromWrongBook, setId, startOpts) {
      const m = getReviewMaterials(set);
      const total = m.texts.length + m.links.length + m.images.length;
      if (total === 0) {
        startQuiz(questions, fromWrongBook, setId, startOpts);
        return;
      }
      _pendingReviewStart = { questions, fromWrongBook, setId, noShuffle: startOpts && startOpts.noShuffle };
      const textsWrap = document.getElementById('review-modal-texts');
      const linksEl = document.getElementById('review-modal-links');
      const imagesEl = document.getElementById('review-modal-images');
      const textsWrapParent = document.getElementById('review-modal-texts-wrap');
      if (textsWrap) {
        textsWrap.innerHTML = m.texts.length ? m.texts.map(t => '<div class="review-text-block">' + escapeHtml(t) + '</div>').join('') : '';
        if (textsWrapParent) textsWrapParent.style.display = m.texts.length ? 'block' : 'none';
      }
      if (linksEl) {
        linksEl.innerHTML = m.links.map(href => {
          const label = href.length > 80 ? href.slice(0, 77) + 'â€¦' : href;
          return '<a href="' + safeHref(href) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(label) + '</a>';
        }).join('');
        linksEl.style.display = m.links.length ? 'flex' : 'none';
      }
      if (imagesEl) {
        imagesEl.innerHTML = m.images.map(dataUrl => {
          const safeSrc = safeImageSrc(dataUrl);
          if (!safeSrc) return '';
          return '<div class="review-modal-msg"><img src="' + safeSrc + '" alt="å¤ä¹ å›¾ç‰‡" class="review-modal-img" title="ç‚¹å‡»æ”¾å¤§" loading="lazy" /></div>';
        }).join('');
        imagesEl.style.display = m.images.length ? 'flex' : 'none';
      }
      const overlay = document.getElementById('review-modal-overlay');
      if (overlay) { overlay.classList.add('show'); setModalFocusTrap(overlay); }
    }
    function hideReviewModal() {
      clearModalFocusTrap();
      const overlay = document.getElementById('review-modal-overlay');
      if (overlay) overlay.classList.remove('show');
      _pendingReviewStart = null;
    }
    function openImageLightbox(src) {
      const el = document.getElementById('image-lightbox-overlay');
      const img = document.getElementById('image-lightbox-img');
      if (el && img && src) { img.src = src; el.classList.add('show'); setModalFocusTrap(el); }
    }
    function closeImageLightbox() {
      clearModalFocusTrap();
      const el = document.getElementById('image-lightbox-overlay');
      if (el) el.classList.remove('show');
    }
    function recordSavedSetPractice(setId) {
      if (!setId) return;
      const sets = getSavedSets();
      const idx = sets.findIndex(s => String(s.id) === String(setId));
      if (idx === -1) return;
      sets[idx] = Object.assign({}, sets[idx], {
        practiceCount: (sets[idx].practiceCount || 0) + 1,
        lastPracticedAt: new Date().toISOString()
      });
      setSavedSets(sets);
    }

    function renderParagraphBlanks(q, correctArr) {
      const parts = q.stem.split('_____');
      let stemHtml = '';
      for (let i = 0; i < parts.length; i++) {
        stemHtml += escapeHtml(parts[i]);
        if (i < parts.length - 1) stemHtml += '<span class="blank" data-blank="' + i + '">( ' + (i + 1) + ' )</span>';
      }
      const stemEl = document.getElementById('question-stem');
      if (stemEl) stemEl.innerHTML = stemHtml;
      const wrap = document.getElementById('paragraph-blanks-wrap');
      if (!wrap) return; // å¦‚æžœå®¹å™¨ä¸å­˜åœ¨ï¼Œç›´æŽ¥è¿”å›ž
      // å…ˆæ¸…ç©ºå¹¶é‡ç½®å®¹å™¨ï¼Œç¡®ä¿æ—§çŠ¶æ€ä¸ä¼šå½±å“æ–°é¢˜ç›®
      wrap.innerHTML = '';
      wrap.style.display = 'block';
      // åˆ›å»ºæ–°çš„è¾“å…¥æ¡†ï¼ˆæ³¨æ„ï¼šä¸è¦è®¾ç½® disabled å±žæ€§ï¼Œå› ä¸ºå®ƒæ˜¯å¸ƒå°”å±žæ€§ï¼Œå­˜åœ¨å³ç¦ç”¨ï¼‰
      wrap.innerHTML = correctArr.map((_, i) =>
        '<label style="display:flex;align-items:center;gap:0.5rem;"><span style="min-width:2.5rem;">ç¬¬' + (i + 1) + 'ç©º:</span><input type="text" data-blank="' + i + '" placeholder="..." autocomplete="off" aria-label="ç¬¬' + (i + 1) + 'ç©ºç­”æ¡ˆ" /></label>'
      ).join('');
      // æ˜¾å¼å¯ç”¨æ‰€æœ‰è¾“å…¥æ¡†å¹¶é‡ç½®çŠ¶æ€
      wrap.querySelectorAll('input').forEach(inp => {
        inp.disabled = false;
        inp.removeAttribute('disabled'); // ç¡®ä¿ç§»é™¤ disabled å±žæ€§
        inp.classList.remove('correct-blank', 'wrong-blank');
        inp.value = '';
        inp.addEventListener('keydown', e => { if (e.key === 'Enter') submitAnswer(); });
      });
    }

    function renderQuestion() {
      /* Clear any pending timers from previous question */
      _pendingTimers.forEach(timer => clearTimeout(timer));
      _pendingTimers = [];

      /* Clear paragraph blanks container to ensure clean state for new question */
      const paragraphWrap = document.getElementById('paragraph-blanks-wrap');
      if (paragraphWrap) {
        paragraphWrap.innerHTML = '';
        paragraphWrap.style.display = 'none';
        // ç¡®ä¿æ‰€æœ‰æ—§çš„è¾“å…¥æ¡†éƒ½è¢«ç§»é™¤å’Œæ¸…ç†
        paragraphWrap.querySelectorAll('input').forEach(inp => {
          inp.disabled = false;
          inp.removeAttribute('disabled');
        });
      }

      const q = state.questions[state.index];
      if (!q) {
        showResult();
        return;
      }

      state.answered = !!state.answerResults[state.index];
      const idx = state.index + 1;
      const total = state.questions.length;
      const progressFillEl = document.getElementById('progress-fill');
      if (progressFillEl) progressFillEl.style.width = (idx / total) * 100 + '%';
      const questionCounterEl = document.getElementById('question-counter');
      if (questionCounterEl) questionCounterEl.textContent = `${idx} / ${total}`;
      const labelEl = document.getElementById('progress-label');
      if (labelEl) labelEl.textContent = 'ç¬¬ ' + idx + ' / ' + total + ' é¢˜';
      const estimateEl = document.getElementById('progress-estimate');
      if (estimateEl && idx === 1) {
        estimateEl.textContent = 'å…± ' + total + ' é¢˜' + (state.timerSeconds ? 'ï¼Œçº¦ ' + Math.ceil(total * state.timerSeconds / 60) + ' åˆ†é’Ÿ' : 'ï¼Œä¸é™æ—¶');
      }
      const questionMetaEl = document.getElementById('question-meta');
      if (questionMetaEl) questionMetaEl.textContent = q.category ? `å¥—è·¯ Â· ${q.category}` : '';
      const questionStemEl = document.getElementById('question-stem');
      if (questionStemEl) questionStemEl.innerHTML = escapeHtml(q.stem);
      var explanationScrollWrap = document.getElementById('explanation-scroll-wrap');
      if (explanationScrollWrap) explanationScrollWrap.style.display = 'none';
      var wrongCountEl = document.getElementById('explanation-wrong-count');
      if (wrongCountEl) { wrongCountEl.textContent = ''; wrongCountEl.style.display = 'none'; }
      const explanationEl = document.getElementById('explanation');
      if (explanationEl) explanationEl.textContent = q.explanation || '';
      var notesDisplay = document.getElementById('explanation-notes-display');
      if (notesDisplay) { notesDisplay.textContent = ''; notesDisplay.style.display = 'none'; }
      var notesEdit = document.getElementById('explanation-notes-edit');
      if (notesEdit) notesEdit.style.display = 'none';
      var notesTextarea = document.getElementById('explanation-notes-textarea');
      if (notesTextarea) notesTextarea.value = '';
      const removeWrapEl = document.getElementById('wrong-book-remove-wrap');
      if (removeWrapEl) removeWrapEl.style.display = 'none';
      const removeFromSetWrap = document.getElementById('remove-from-set-wrap');
      if (removeFromSetWrap) removeFromSetWrap.style.display = state.practicedSetId ? 'block' : 'none';
      const answerFeedbackEl = document.getElementById('answer-feedback');
      if (answerFeedbackEl) {
        answerFeedbackEl.className = 'answer-feedback';
        answerFeedbackEl.textContent = '';
      }

      const optionsEl = document.getElementById('options-container');
      const fillWrap = document.getElementById('fill-input-wrap');
      const fillInput = document.getElementById('fill-input');

      if (q.type === 'fill_blank') {
        optionsEl.innerHTML = '';
        const blankCount = (q.stem.match(/_____/g) || []).length;
        const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
        const isMultiBlank = blankCount >= 2 && correctArr.length >= 2;
        if (isMultiBlank) {
          fillWrap.style.display = 'none';
          renderParagraphBlanks(q, correctArr.slice(0, blankCount));
        } else {
          fillWrap.style.display = 'block';
          fillInput.value = '';
          fillInput.placeholder = 'è¾“å…¥ç­”æ¡ˆ...';
          fillInput.setAttribute('aria-label', 'è¾“å…¥ç­”æ¡ˆ');
          fillInput.disabled = false;
          fillInput.classList.remove('correct-blank', 'wrong-blank');
          document.getElementById('paragraph-blanks-wrap').style.display = 'none';
          document.getElementById('paragraph-blanks-wrap').innerHTML = '';
        }
        if (state.answerResults[state.index]) {
          applyAnsweredState(q, state.answerResults[state.index]);
          return;
        }
        const btnSubmit0 = document.getElementById('btn-submit');
        if (btnSubmit0) btnSubmit0.style.display = 'inline-flex';
        const btnNext0 = document.getElementById('btn-next');
        if (btnNext0) btnNext0.style.display = 'none';
        var btnPrev0 = document.getElementById('btn-prev-quiz');
        if (btnPrev0) btnPrev0.style.display = state.index > 0 ? 'inline-flex' : 'none';
        var fillExtra = (q.type === 'fill_blank' && isMultiBlank) ? blankCount * 5 : 0;
        startTimer(fillExtra);
        return;
      }

      if (q.type === 'paragraph_fill_blank') {
        optionsEl.innerHTML = '';
        fillWrap.style.display = 'none';
        const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
        renderParagraphBlanks(q, correctArr);
        if (state.answerResults[state.index]) {
          applyAnsweredState(q, state.answerResults[state.index]);
          return;
        }
        const btnSubmit1 = document.getElementById('btn-submit');
        if (btnSubmit1) btnSubmit1.style.display = 'inline-flex';
        const btnNext1 = document.getElementById('btn-next');
        if (btnNext1) btnNext1.style.display = 'none';
        var btnPrev1 = document.getElementById('btn-prev-quiz');
        if (btnPrev1) btnPrev1.style.display = state.index > 0 ? 'inline-flex' : 'none';
        var paraBlanks = (correctArr && correctArr.length) ? correctArr.length : 1;
        startTimer(paraBlanks * 5);
        return;
      }

      fillWrap.style.display = 'none';
      if (fillInput) {
        fillInput.disabled = false;
        fillInput.classList.remove('correct-blank', 'wrong-blank');
      }
      // paragraphWrap å·²åœ¨å‡½æ•°å¼€å¤´å£°æ˜Žï¼Œè¿™é‡Œç›´æŽ¥ä½¿ç”¨
      if (paragraphWrap) {
        paragraphWrap.style.display = 'none';
        paragraphWrap.innerHTML = '';
      }
      const isMulti = q.type === 'multiple_choice';
      const correctSet = Array.isArray(q.correct) ? new Set(q.correct) : new Set([q.correct]);
      optionsEl.setAttribute('role', isMulti ? 'group' : 'radiogroup');
      optionsEl.setAttribute('aria-label', isMulti ? 'å¤šé€‰é€‰é¡¹' : 'å•é€‰é€‰é¡¹');

      optionsEl.innerHTML = q.options.map((opt, i) => {
        const letter = LETTERS[i];
        const inputType = isMulti ? 'checkbox' : 'radio';
        const name = isMulti ? `opt-${state.index}` : 'option';
        return `
          <label class="option" data-index="${i}">
            <input type="${inputType}" name="${name}" value="${i}" />
            <span class="option-letter">${letter}</span>
            <span class="option-label">${escapeHtml(opt)}</span>
          </label>
        `;
      }).join('');

      optionsEl.querySelectorAll('.option').forEach(label => {
        label.addEventListener('click', () => {
          if (state.answered) return;
          const input = label.querySelector('input');
          if (isMulti) {
            input.checked = !input.checked;
          } else {
            optionsEl.querySelectorAll('.option').forEach(l => l.classList.remove('selected'));
            optionsEl.querySelectorAll('input').forEach(inp => { inp.checked = false; });
            input.checked = true;
            label.classList.add('selected');
          }
          label.classList.remove('just-selected');
          void label.offsetWidth;
          label.classList.add('just-selected');
        });
      });

      if (state.answerResults[state.index]) {
        applyAnsweredState(q, state.answerResults[state.index]);
        return;
      }
      const btnSubmit2 = document.getElementById('btn-submit');
      if (btnSubmit2) btnSubmit2.style.display = 'inline-flex';
      const btnNext2 = document.getElementById('btn-next');
      if (btnNext2) btnNext2.style.display = 'none';
      var btnPrev2 = document.getElementById('btn-prev-quiz');
      if (btnPrev2) btnPrev2.style.display = state.index > 0 ? 'inline-flex' : 'none';
      startTimer();
    }

    function escapeHtml(s) {
      if (s == null) return '';
      _escapeDiv.textContent = s;
      return _escapeDiv.innerHTML;
    }
    function escapeAttr(s) {
      if (s == null) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    function safeHref(href) {
      const u = (href || '').trim();
      if (!/^https?:\/\//i.test(u) && !/^\/[^/]/.test(u) && u !== '#') return '#';
      return escapeAttr(u);
    }
    function safeImageSrc(url) {
      const u = (url || '').trim();
      if (!/^data:image\//i.test(u)) return '';
      return escapeAttr(u);
    }

    function submitAnswer() {
      clearTimer();
      if (state.answered) return;
      const q = state.questions[state.index];
      const optionsEl = document.getElementById('options-container');
      const fillWrap = document.getElementById('fill-input-wrap');
      const fillInput = document.getElementById('fill-input');

      let correct = false;
      if (q.type === 'fill_blank') {
        const paragraphWrap = document.getElementById('paragraph-blanks-wrap');
        const multiInputs = paragraphWrap && paragraphWrap.style.display !== 'none' ? paragraphWrap.querySelectorAll('input') : [];
        if (multiInputs.length >= 2) {
          const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
          let allRight = true;
          const answers = [];
          for (let i = 0; i < correctArr.length && i < multiInputs.length; i++) {
            const val = (multiInputs[i].value || '').trim().toLowerCase();
            const accept = Array.isArray(correctArr[i]) ? correctArr[i].map(c => String(c).toLowerCase().trim()) : [String(correctArr[i]).toLowerCase().trim()];
            const ok = matchFrenchAnswer(val, accept);
            answers.push({ val, ok, accept });
            if (!ok) allRight = false;
          }
          state.answered = true;
          if (allRight) state.score++;
          else addToWrongBook(q);
          correct = allRight;
          multiInputs.forEach((inp, i) => {
            inp.disabled = true;
            inp.classList.add(answers[i].ok ? 'correct-blank' : 'wrong-blank');
          });
          const stemEl = document.getElementById('question-stem');
          stemEl.querySelectorAll('.blank').forEach((span, i) => {
            if (answers[i]) {
              span.classList.add(answers[i].ok ? 'filled' : 'wrong');
              span.textContent = answers[i].ok ? answers[i].val : (answers[i].val || '?') + ' â†’ ' + (Array.isArray(q.correct[i]) ? q.correct[i][0] : q.correct[i]);
            }
          });
        } else {
          const answer = (fillInput.value || '').trim().toLowerCase();
          const accept = (Array.isArray(q.correct) ? q.correct : [q.correct]).map(c => String(c).toLowerCase().trim());
          correct = matchFrenchAnswer(answer, accept);
          state.answered = true;
          if (correct) state.score++;
          else addToWrongBook(q);
          fillInput.disabled = true;
          fillInput.classList.add(correct ? 'correct-blank' : 'wrong-blank');
        }
      } else if (q.type === 'paragraph_fill_blank') {
        const correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
        const inputs = document.querySelectorAll('#paragraph-blanks-wrap input');
        const len = Math.min(correctArr.length, inputs.length);
        let allRight = true;
        const answers = [];
        for (let i = 0; i < len; i++) {
          const val = (inputs[i] && inputs[i].value ? inputs[i].value : '').trim().toLowerCase();
          const accept = Array.isArray(correctArr[i]) ? correctArr[i].map(c => String(c).toLowerCase().trim()) : [String(correctArr[i]).toLowerCase().trim()];
          const ok = matchFrenchAnswer(val, accept);
          answers.push({ val, ok, accept });
          if (!ok) allRight = false;
        }
        for (let i = len; i < correctArr.length; i++) { allRight = false; answers.push({ val: '', ok: false, accept: [] }); }
        state.answered = true;
        if (allRight) state.score++;
        else addToWrongBook(q);
        inputs.forEach((inp, i) => {
          inp.disabled = true;
          if (answers[i]) inp.classList.add(answers[i].ok ? 'correct-blank' : 'wrong-blank');
        });
        const stemEl = document.getElementById('question-stem');
        stemEl.querySelectorAll('.blank').forEach((span, i) => {
          if (answers[i]) {
            span.classList.add(answers[i].ok ? 'filled' : 'wrong');
            span.textContent = answers[i].ok ? answers[i].val : (answers[i].val || '?') + ' â†’ ' + (Array.isArray(q.correct[i]) ? q.correct[i][0] : q.correct[i]);
          }
        });
        correct = allRight;
      } else {
        const isMulti = q.type === 'multiple_choice';
        const selected = Array.from(optionsEl.querySelectorAll('input:checked')).map(inp => parseInt(inp.value, 10));
        const userAnswer = isMulti ? { multiple: selected } : { single: selected.length === 1 ? selected[0] : undefined };
        const result = evaluateAnswer(q, userAnswer);
        correct = result.correct;
        state.answered = true;
        if (correct) state.score++;
        else addToWrongBook(q);

        const correctSet = Array.isArray(q.correct) ? new Set(q.correct) : new Set([q.correct]);
        optionsEl.querySelectorAll('.option').forEach((label, i) => {
          label.classList.add('disabled');
          const inCorrect = correctSet.has(i);
          const wasSelected = label.querySelector('input').checked;
          if (inCorrect) label.classList.add('correct');
          else if (wasSelected) label.classList.add('wrong');
        });
      }

      if (state.practicingWrongBook) updateWrongBookAfterAnswer(q, correct);

      /* Add card feedback animation */
      const questionCard = document.querySelector('.question-card');
      if (questionCard) {
        const currentIndex = state.index;  // Capture current index
        const currentQuestion = q;  // Capture current question reference
        questionCard.classList.remove('answer-correct', 'answer-wrong');
        const timer1 = setTimeout(() => {
          if (state.index === currentIndex && state.questions[state.index] === currentQuestion) {
            questionCard.classList.add(correct ? 'answer-correct' : 'answer-wrong');
            const timer2 = setTimeout(() => {
              if (state.index === currentIndex && state.questions[state.index] === currentQuestion) {
                questionCard.classList.remove('answer-correct', 'answer-wrong');
              }
              _pendingTimers = _pendingTimers.filter(t => t !== timer2);
            }, 600);
            _pendingTimers.push(timer2);
          }
          _pendingTimers = _pendingTimers.filter(t => t !== timer1);
        }, 50);
        _pendingTimers.push(timer1);
      }

      const feedbackEl = document.getElementById('answer-feedback');
      if (feedbackEl) {
        feedbackEl.textContent = correct ? 'æ­£ç¡®ï¼' : 'é”™è¯¯';
        feedbackEl.className = 'answer-feedback ' + (correct ? 'correct-msg' : 'wrong-msg');
      }

      const explanationEl = document.getElementById('explanation');
      if (!explanationEl) return;  // å¦‚æžœå…³é”®å…ƒç´ ä¸å­˜åœ¨ï¼Œæå‰è¿”å›ž
      let explanationText = q.explanation || '';
      if (!explanationText && !correct) {
        if (q.type === 'fill_blank') {
          const ans = Array.isArray(q.correct) ? q.correct : [q.correct];
          explanationText = 'æ­£ç¡®ç­”æ¡ˆï¼š' + ans.map(a => String(a).trim()).join(' æˆ– ');
        } else if (q.type === 'single_choice') {
          explanationText = 'æ­£ç¡®ç­”æ¡ˆï¼š' + (q.options ? LETTERS[q.correct] + ') ' + q.options[q.correct] : LETTERS[q.correct]);
        } else if (q.type === 'multiple_choice' && q.options) {
          const indices = Array.isArray(q.correct) ? q.correct : [q.correct];
          explanationText = 'æ­£ç¡®ç­”æ¡ˆï¼š' + indices.map(i => LETTERS[i] + ') ' + q.options[i]).join('ï¼›');
        } else if (q.type === 'paragraph_fill_blank') {
          const arr = Array.isArray(q.correct) ? q.correct : [q.correct];
          explanationText = 'æ­£ç¡®ç­”æ¡ˆï¼š' + arr.map((c, i) => 'ç¬¬' + (i + 1) + 'ç©º ' + (Array.isArray(c) ? c[0] : c)).join('ï¼›');
        }
      }
      if (explanationEl) explanationEl.textContent = explanationText;
      var scrollWrap = document.getElementById('explanation-scroll-wrap');
      if (scrollWrap) {
        scrollWrap.style.display = 'block';
        var wrongCountEl = document.getElementById('explanation-wrong-count');
        var wrongCount = getWrongCountForQuestion(q);
        if (wrongCountEl) {
          if (wrongCount > 0) {
            wrongCountEl.textContent = 'æœ¬é¢˜å·²é”™ ' + wrongCount + ' æ¬¡';
            wrongCountEl.style.display = 'block';
          } else {
            wrongCountEl.textContent = '';
            wrongCountEl.style.display = 'none';
          }
        }
        var qid = wrongBookItemId(q);
        _currentQuestionIdForNotes = qid;
        var notes = getQuestionNotes(qid);
        var notesDisplayEl = document.getElementById('explanation-notes-display');
        var notesEditEl = document.getElementById('explanation-notes-edit');
        var btnEditNotes = document.getElementById('btn-edit-explanation-notes');
        if (notesDisplayEl) {
          if (notes) { notesDisplayEl.textContent = notes; notesDisplayEl.style.display = 'block'; } else { notesDisplayEl.style.display = 'none'; }
        }
        if (notesEditEl) notesEditEl.style.display = 'none';
        if (btnEditNotes) btnEditNotes.style.display = 'inline-flex';
      }

      const announcer = document.getElementById('sr-announcer');
      if (announcer) announcer.textContent = correct ? 'å›žç­”æ­£ç¡®' : 'å›žç­”é”™è¯¯ã€‚' + (explanationText || '');

      const removeWrap = document.getElementById('wrong-book-remove-wrap');
      const btnRemove = document.getElementById('btn-remove-from-wrong');
      if (removeWrap && btnRemove) {
        if (state.practicingWrongBook) {
          removeWrap.style.display = 'block';
          btnRemove.textContent = 'ç§»å‡ºé”™é¢˜æœ¬';
          btnRemove.disabled = false;
          btnRemove.onclick = () => {
            const removedItem = JSON.parse(JSON.stringify(q));
            removeFromWrongBook(q);
            btnRemove.textContent = 'å·²ç§»å‡ºï¼ˆ5ç§’å†…å¯æ’¤é”€ï¼‰';
            btnRemove.disabled = false;
            const undoTimer = setTimeout(() => {
              if (state.index < state.questions.length && state.questions[state.index] === q) {
                btnRemove.textContent = 'å·²ç§»å‡º';
                btnRemove.disabled = true;
              }
              _pendingTimers = _pendingTimers.filter(t => t !== undoTimer);
            }, 5000);
            _pendingTimers.push(undoTimer);
            btnRemove.onclick = () => {
              clearTimeout(undoTimer);
              _pendingTimers = _pendingTimers.filter(t => t !== undoTimer);
              addToWrongBookDirect(removedItem);
              btnRemove.textContent = 'å·²æ’¤é”€ï¼Œä»åœ¨é”™é¢˜æœ¬';
              btnRemove.disabled = true;
            };
          };
        } else {
          removeWrap.style.display = 'none';
        }
      }

      var saved = { correct: correct, explanationText: explanationText };
      if (q.type === 'single_choice') {
        var sel = Array.from(optionsEl.querySelectorAll('input:checked')).map(function(inp) { return parseInt(inp.value, 10); });
        saved.selectedSingle = sel.length === 1 ? sel[0] : undefined;
      }
      if (q.type === 'multiple_choice') saved.selectedMultiple = Array.from(optionsEl.querySelectorAll('input:checked')).map(function(inp) { return parseInt(inp.value, 10); });
      state.answerResults[state.index] = saved;

      document.getElementById('btn-submit').style.display = 'none';
      const btnNext = document.getElementById('btn-next');
      btnNext.style.display = 'inline-flex';
      btnNext.textContent = state.index >= state.questions.length - 1 ? 'æŸ¥çœ‹ç»“æžœ' : 'ä¸‹ä¸€é¢˜';
      btnNext.setAttribute('aria-label', state.index >= state.questions.length - 1 ? 'æŸ¥çœ‹ç»“æžœ' : 'ä¸‹ä¸€é¢˜');
      var btnPrev = document.getElementById('btn-prev-quiz');
      if (btnPrev) btnPrev.style.display = state.index > 0 ? 'inline-flex' : 'none';
      saveQuizProgress();
    }

    function applyAnsweredState(q, saved) {
      state.answered = true;
      clearTimer();
      var feedbackEl = document.getElementById('answer-feedback');
      feedbackEl.textContent = saved.correct ? 'æ­£ç¡®ï¼' : 'é”™è¯¯';
      feedbackEl.className = 'answer-feedback ' + (saved.correct ? 'correct-msg' : 'wrong-msg');
      feedbackEl.style.display = 'block';
      var explanationEl = document.getElementById('explanation');
      explanationEl.textContent = saved.explanationText || '';
      var scrollWrap = document.getElementById('explanation-scroll-wrap');
      if (scrollWrap) {
        scrollWrap.style.display = 'block';
        var wrongCountEl = document.getElementById('explanation-wrong-count');
        var wrongCount = getWrongCountForQuestion(q);
        if (wrongCountEl) {
          if (wrongCount > 0) {
            wrongCountEl.textContent = 'æœ¬é¢˜å·²é”™ ' + wrongCount + ' æ¬¡';
            wrongCountEl.style.display = 'block';
          } else {
            wrongCountEl.textContent = '';
            wrongCountEl.style.display = 'none';
          }
        }
        var qid = wrongBookItemId(q);
        _currentQuestionIdForNotes = qid;
        var notes = getQuestionNotes(qid);
        var notesDisplayEl = document.getElementById('explanation-notes-display');
        var notesEditEl = document.getElementById('explanation-notes-edit');
        var btnEditNotes = document.getElementById('btn-edit-explanation-notes');
        if (notesDisplayEl) {
          if (notes) { notesDisplayEl.textContent = notes; notesDisplayEl.style.display = 'block'; } else { notesDisplayEl.style.display = 'none'; }
        }
        if (notesEditEl) notesEditEl.style.display = 'none';
        if (btnEditNotes) btnEditNotes.style.display = 'inline-flex';
      }
      var optionsEl = document.getElementById('options-container');
      if (optionsEl && (q.type === 'single_choice' || q.type === 'multiple_choice') && q.options) {
        var correctSet = Array.isArray(q.correct) ? new Set(q.correct) : new Set([q.correct]);
        optionsEl.querySelectorAll('.option').forEach(function(label, i) {
          label.classList.add('disabled');
          var inCorrect = correctSet.has(i);
          var wasSelected = (q.type === 'single_choice' && saved.selectedSingle === i) || (q.type === 'multiple_choice' && saved.selectedMultiple && saved.selectedMultiple.indexOf(i) !== -1);
          if (inCorrect) label.classList.add('correct');
          else if (wasSelected) label.classList.add('wrong');
          var input = label.querySelector('input');
          if (input) { input.checked = wasSelected; input.disabled = true; }
        });
      }
      var fillWrap = document.getElementById('fill-input-wrap');
      var paragraphWrap = document.getElementById('paragraph-blanks-wrap');
      if (fillWrap) fillWrap.querySelectorAll('input').forEach(function(inp) { inp.disabled = true; });
      if (paragraphWrap) paragraphWrap.querySelectorAll('input').forEach(function(inp) { inp.disabled = true; });
      const btnSubmit = document.getElementById('btn-submit');
      if (btnSubmit) btnSubmit.style.display = 'none';
      var btnNext = document.getElementById('btn-next');
      if (btnNext) {
        btnNext.style.display = 'inline-flex';
        btnNext.textContent = state.index >= state.questions.length - 1 ? 'æŸ¥çœ‹ç»“æžœ' : 'ä¸‹ä¸€é¢˜';
        btnNext.setAttribute('aria-label', state.index >= state.questions.length - 1 ? 'æŸ¥çœ‹ç»“æžœ' : 'ä¸‹ä¸€é¢˜');
      }
      var btnPrev = document.getElementById('btn-prev-quiz');
      if (btnPrev) btnPrev.style.display = state.index > 0 ? 'inline-flex' : 'none';
    }

    function prevQuestion() {
      if (state.index <= 0) return;
      state.index--;
      state.answered = true;
      renderQuestion();
    }

    function nextQuestion() {
      if (state.answered !== true) return;  // Prevent rapid clicking
      state.index++;
      if (state.index >= state.questions.length) {
        showResult();
      } else {
        const card = document.querySelector('.question-card');
        if (card) {
          card.classList.add('animate-out');
          const animTimer = setTimeout(() => {
            const currentIndex = state.index;  // Capture current index
            if (typeof performance !== 'undefined' && performance.mark) performance.mark('next-question-start');
            card.classList.remove('animate-out');
            renderQuestion();
            if (typeof performance !== 'undefined' && performance.mark) {
              performance.mark('next-question-end');
              try { performance.measure('next-question', 'next-question-start', 'next-question-end'); } catch (_) {}
            }
            if (state.index === currentIndex) {  // Verify still on same question
              card.classList.add('animate-in');
              card.style.willChange = 'transform';
              card.addEventListener('animationend', () => {
                card.classList.remove('animate-in');
                card.style.willChange = '';
              }, { once: true });
            }
            _pendingTimers = _pendingTimers.filter(t => t !== animTimer);
          }, 200);
          _pendingTimers.push(animTimer);
        } else {
          renderQuestion();
        }
      }
    }

    function showResult() {
      clearQuizProgress();
      if (state.practicedSetId) {
        recordSavedSetPractice(state.practicedSetId);
        state.practicedSetId = null;
      }
      addTodayPractice(state.questions.length);
      const resultScoreEl = document.getElementById('result-score');
      if (resultScoreEl) resultScoreEl.textContent = `${state.score} / ${state.questions.length}`;
      const pct = state.questions.length ? Math.round((state.score / state.questions.length) * 100) : 0;
      const pctEl = document.getElementById('result-pct');
      if (pctEl) pctEl.textContent = 'æ­£ç¡®çŽ‡ ' + pct + '%';
      const resultDescEl = document.getElementById('result-desc');
      if (resultDescEl) resultDescEl.textContent = pct >= 80 ? 'TrÃ¨s bien !' : pct >= 60 ? 'Pas mal !' : 'Continuez Ã  pratiquer !';
      const celebrationEl = document.getElementById('result-celebration');
      const isFull = state.score === state.questions.length && state.questions.length > 0;
      if (celebrationEl) celebrationEl.style.display = isFull ? 'block' : 'none';
      const confettiEl = document.getElementById('result-confetti');
      if (confettiEl) {
        confettiEl.innerHTML = '';
        if (isFull) {
          const colors = ['#8b5cf6', '#34d399', '#fbbf24', '#60a5fa', '#f87171'];
          for (let i = 0; i < 14; i++) {
            const s = document.createElement('span');
            s.style.left = (10 + Math.random() * 80) + '%';
            s.style.top = (60 + Math.random() * 35) + '%';
            s.style.background = colors[i % colors.length];
            s.style.animationDelay = (Math.random() * 0.6) + 's';
            s.style.animationDuration = (2 + Math.random() * 1.2) + 's';
            confettiEl.appendChild(s);
          }
        }
      }
      pushRecentSession(state.questions.length, state.score);
      if (state.sequentialBatch && state.practicedSetId) {
        const sets = getSavedSets();
        const nextIdx = state.sequentialBatch.startIndex + state.sequentialBatch.count;
        const updated = sets.map(s => String(s.id) === String(state.practicedSetId)
          ? Object.assign({}, s, { sequentialNextIndex: nextIdx })
          : s);
        setSavedSets(updated);
        state.sequentialBatch = null;
      }
      const recentEl = document.getElementById('result-recent');
      if (recentEl) {
        const sessions = getRecentSessions();
        const toShow = sessions.slice(-5).reverse();
        if (toShow.length <= 1) {
          recentEl.style.display = 'none';
        } else {
          recentEl.style.display = 'block';
          recentEl.innerHTML = '<div class="result-recent-title">æœ€è¿‘ç»ƒä¹ </div><ul>' +
            toShow.map((s, i) => '<li>' + s.score + '/' + s.total + (i === 0 ? 'ï¼ˆæœ¬æ¬¡ï¼‰' : '') + '</li>').join('') + '</ul>';
        }
      }
      const announcer = document.getElementById('sr-announcer');
      if (announcer) announcer.textContent = 'ç»ƒä¹ å®Œæˆï¼Œå¾—åˆ† ' + state.score + ' / ' + state.questions.length + 'ï¼Œæ­£ç¡®çŽ‡ ' + pct + '%';
      showScreen(SCREEN.RESULT);
      var firstBtn = document.getElementById('btn-restart');
      if (firstBtn) setTimeout(function () { firstBtn.focus(); }, 100);
    }
    function readAloudStem() {
      const q = state.questions[state.index];
      if (!q || !q.stem) return;
      const text = (q.stem || '').replace(/_____/g, ' ').trim();
      if (!text) return;
      if (typeof speechSynthesis === 'undefined') return;
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'fr-FR';
      u.rate = 0.9;
      speechSynthesis.speak(u);
    }
    function onQuizKeydown(e) {
      if (!document.getElementById('screen-quiz').classList.contains('active')) return;
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : '';
      if (tag === 'INPUT' || tag === 'TEXTAREA') {
        if (e.key === 'Enter' && (e.target.id === 'explanation-notes-textarea' || e.target.closest('#explanation-notes-edit'))) return;
        if (e.key === 'Enter') { e.preventDefault(); if (state.answered) nextQuestion(); else submitAnswer(); }
        return;
      }
      if (e.key === 'Enter') {
        e.preventDefault();
        if (state.answered) nextQuestion();
        else submitAnswer();
        return;
      }
      if (['1','2','3','4'].includes(e.key)) {
        const q = state.questions[state.index];
        if (!q || state.answered) return;
        if ((q.type === 'single_choice' || q.type === 'multiple_choice') && q.options && q.options.length > 0) {
          const idx = parseInt(e.key, 10) - 1;
          if (idx < 0 || idx >= q.options.length) return;
          const opts = document.querySelectorAll('#options-container .option');
          if (opts[idx]) opts[idx].click();
        }
      }
    }

    ($('btn-start-practice') || document.getElementById('btn-start-practice')).addEventListener('click', () => {
      const typeFilter = getSelectedTypeFilter();
      const sel = $('start-practice-select');
      const val = sel ? sel.value : 'default';
      let questions = [];
      if (val === 'default') {
        questions = DEFAULT_QUESTIONS;
      } else {
        const sets = getSavedSets();
        const set = sets.find(s => String(s.id) === val);
        if (!set || !set.questions || !set.questions.length) {
          showToast('æœªæ‰¾åˆ°è¯¥ä¹ é¢˜é›†ï¼Œè¯·é‡æ–°é€‰æ‹©');
          return;
        }
        questions = set.questions;
      }
      let filtered = filterQuestionsByType(questions, typeFilter);
      const categoryEl = $('filter-category');
      const categoryVal = categoryEl && categoryEl.value ? categoryEl.value.trim() : '';
      if (categoryVal) {
        filtered = filtered.filter(q => q && q.category === categoryVal);
      }
      if (filtered.length === 0) {
        const typeNames = typeFilter ? typeFilter.map(t => QUESTION_TYPES[t] || t).join('ã€') : '';
        showToast('å½“å‰é€‰é¢˜åž‹æˆ–åˆ†ç±»ä¸‹æ²¡æœ‰é¢˜ç›®ï¼Œè¯·å‹¾é€‰æ›´å¤šé¢˜åž‹æˆ–æ¢ä¹ é¢˜é›†');
        return;
      }
      if (val !== 'default') {
        const sets = getSavedSets();
        const set = sets.find(s => String(s.id) === val);
        if (set) {
          // ç»Ÿä¸€é€»è¾‘ï¼šå¦‚æžœé¢˜ç›®æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œæ˜¾ç¤º"é€‰æ‹©ç»ƒä¹ æ–¹å¼"æ¨¡æ€æ¡†
          // å¦åˆ™å¦‚æžœæœ‰å¤ä¹ ææ–™ï¼Œæ˜¾ç¤ºå¤ä¹ ææ–™æ¨¡æ€æ¡†
          // å¦åˆ™ç›´æŽ¥å¼€å§‹
          if (filtered.length > SEQUENTIAL_MODE_THRESHOLD) {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ set å¯¹è±¡ï¼ŒåŒ…å«ç­›é€‰åŽçš„é¢˜ç›®ï¼Œç”¨äºŽä¼ é€’ç»™æ¨¡æ€æ¡†
            // é‡ç½® sequentialNextIndex ä¸º 0ï¼Œå› ä¸ºè¿™æ˜¯ç­›é€‰åŽçš„é¢˜ç›®åˆ—è¡¨ï¼Œåº”è¯¥ä»Žç¬¬ä¸€é¢˜å¼€å§‹
            const tempSet = { ...set, questions: filtered, sequentialNextIndex: 0 };
            openStartModeModal(tempSet);
          } else if (hasReviewMaterial(set)) {
            showReviewModal(set, filtered, false, set.id);
          } else {
            startQuiz(filtered, false, set.id);
          }
        } else {
          startQuiz(filtered);
        }
      } else {
        startQuiz(filtered);
      }
    });

    ($('btn-import-show') || document.getElementById('btn-import-show')).addEventListener('click', async () => {
      if (!(await checkImportPin())) return;
      const sec = $('import-section');
      const btn = $('btn-import-show');
      const isExpanded = sec.style.display !== 'none';
      sec.style.display = isExpanded ? 'none' : 'block';
      if (btn) btn.setAttribute('aria-expanded', String(!isExpanded));
    });

    document.getElementById('btn-import-parse').addEventListener('click', () => {
      const parseBtn = document.getElementById('btn-import-parse');
      const origText = parseBtn ? parseBtn.textContent : '';
      if (parseBtn) { parseBtn.disabled = true; parseBtn.textContent = 'è§£æžä¸­â€¦'; }
      const importTextEl = document.getElementById('import-text');
      if (!importTextEl) return;
      let text = importTextEl.value.trim();
      text = normalizeJsonPaste(text);
      let parsed = [];
      let parseError = '';
      if (/^\s*[\[{]/.test(text)) {
        try {
          const data = JSON.parse(text);
          parsed = Array.isArray(data) ? data : (data.questions || []);
        } catch (e) {
          parseError = (e && (e.message || String(e))) || '';
        }
      }
      if (parsed.length === 0) parsed = parsePastedText(text);
      if (parsed.length === 0 && parseError) showToast('JSON è§£æžå¤±è´¥ï¼š' + parseError);
      if (parseBtn) { parseBtn.disabled = false; parseBtn.textContent = origText; }
      if (parsed.length > 0) {
        const seen = new Set();
        const deduped = [];
        let dupCount = 0;
        for (let i = 0; i < parsed.length; i++) {
          const fp = wrongBookItemId(parsed[i]);
          if (seen.has(fp)) dupCount++; else { seen.add(fp); deduped.push(parsed[i]); }
        }
        const nameInput = document.getElementById('import-set-name');
        const reviewInput = document.getElementById('import-review-urls');
        const name = (nameInput && nameInput.value ? nameInput.value.trim() : '') || ('æœªå‘½å ' + formatSavedSetDate(new Date().toISOString()));
        const rawLines = (reviewInput && reviewInput.value ? reviewInput.value.trim().split(/\n/) : [])
          .map(s => s.trim())
          .filter(s => s.length > 0);
        const reviewTexts = [];
        const reviewLinks = [];
        const reviewImages = [];
        rawLines.forEach(s => {
          if (/^data:image\//i.test(s)) reviewImages.push(s);
          else if (isLikelyUrl(s)) reviewLinks.push(/^https?:\/\//i.test(s) ? s : 'https://' + s);
          else reviewTexts.push(s);
        });
        const folderSel = document.getElementById('import-set-folder');
        const folderId = (folderSel && folderSel.value) ? folderSel.value : null;
        const saved = {
          id: Date.now(),
          name: name,
          folderId: folderId || undefined,
          createdAt: new Date().toISOString(),
          questions: deduped,
          practiceCount: 0,
          lastPracticedAt: null,
          reviewTexts,
          reviewLinks,
          reviewImages
        };
        const all = getSavedSets();
        all.unshift(saved);
        setSavedSets(all);
        startQuiz(deduped);
        showToast('å·²åŠ å…¥ ' + deduped.length + ' é“æ–°é¢˜' + (dupCount ? 'ï¼Œè·³è¿‡ ' + dupCount + ' é“é‡å¤' : ''));
        const importSec = $('import-section');
        if (importSec) importSec.style.display = 'none';
        const importText = $('import-text');
        if (importText) importText.value = '';
        if (nameInput) nameInput.value = '';
        if (reviewInput) reviewInput.value = '';
      } else {
        showToast('æœªèƒ½è§£æžå‡ºé¢˜ç›®ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
      }
    });

    document.getElementById('btn-submit').addEventListener('click', submitAnswer);
    document.getElementById('btn-next').addEventListener('click', nextQuestion);
    document.getElementById('btn-prev-quiz').addEventListener('click', prevQuestion);
    document.getElementById('btn-remove-from-set').addEventListener('click', () => {
      if (!state.practicedSetId) return;
      customConfirm('ç¡®å®šä»Žæœ¬ç»ƒä¹ é›†ä¸­åˆ é™¤è¿™é“é¢˜ï¼Ÿåˆ é™¤åŽæœ¬é¢˜å°†ä¸å†å‡ºçŽ°åœ¨è¯¥ç»ƒä¹ é›†ä¸­ã€‚').then(confirmed => {
        if (confirmed) removeCurrentQuestionFromSet();
      });
    });
    document.getElementById('btn-exit-quiz').addEventListener('click', () => {
      customConfirm('ç¡®å®šè¦æå‰é€€å‡ºå—ï¼Ÿ').then(confirmed => {
        if (confirmed) {
          clearTimer();
          clearQuizProgress();
          showScreen(SCREEN.HOME);
          updateWrongCount();
          renderSavedSets();
        }
      });
    });
    document.getElementById('fill-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        if (state.answered) nextQuestion();
        else submitAnswer();
      }
    });
    (function initExplanationNotesEdit() {
      var btnEdit = document.getElementById('btn-edit-explanation-notes');
      var btnSave = document.getElementById('btn-save-explanation-notes');
      var btnCancel = document.getElementById('btn-cancel-explanation-notes');
      var notesDisplay = document.getElementById('explanation-notes-display');
      var notesEdit = document.getElementById('explanation-notes-edit');
      var notesTextarea = document.getElementById('explanation-notes-textarea');
      if (!btnEdit || !notesEdit || !notesTextarea) return;
      btnEdit.addEventListener('click', function() {
        notesTextarea.value = _currentQuestionIdForNotes ? getQuestionNotes(_currentQuestionIdForNotes) : '';
        notesDisplay.style.display = 'none';
        btnEdit.style.display = 'none';
        notesEdit.style.display = 'block';
        notesTextarea.focus();
      });
      function closeNotesEdit() {
        notesEdit.style.display = 'none';
        btnEdit.style.display = 'inline-flex';
        if (_currentQuestionIdForNotes) {
          var notes = getQuestionNotes(_currentQuestionIdForNotes);
          if (notes) { notesDisplay.textContent = notes; notesDisplay.style.display = 'block'; } else { notesDisplay.style.display = 'none'; }
        }
      }
      if (btnSave) btnSave.addEventListener('click', function() {
        if (_currentQuestionIdForNotes != null) {
          setQuestionNotes(_currentQuestionIdForNotes, notesTextarea.value);
          var notes = getQuestionNotes(_currentQuestionIdForNotes);
          if (notes) { notesDisplay.textContent = notes; notesDisplay.style.display = 'block'; } else { notesDisplay.style.display = 'none'; }
          showToast('å¤‡æ³¨å·²ä¿å­˜');
        }
        closeNotesEdit();
      });
      if (btnCancel) btnCancel.addEventListener('click', closeNotesEdit);
    })();
    document.getElementById('btn-restart').addEventListener('click', () => {
      showScreen(SCREEN.HOME);
      updateWrongCount();
      renderSavedSets();
      updateStatsBar();
      updateStartPracticeSelect();
    });
    document.getElementById('btn-back-home').addEventListener('click', () => {
      showScreen(SCREEN.HOME);
      updateWrongCount();
      renderSavedSets();
      updateStatsBar();
      updateStartPracticeSelect();
    });
    document.getElementById('btn-share-result').addEventListener('click', () => {
      const scoreEl = document.getElementById('result-score');
      const scoreText = scoreEl ? scoreEl.textContent.trim() : '0/0';
      const st = getDailyStats();
      const streak = st.streak || 0;
      const text = 'FranÃ§ais Quiz ' + scoreText + 'ï¼Œè¿žç»­ ' + streak + ' å¤© âœ¨';
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')).catch(() => showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶'));
      } else {
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.opacity = '0';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        } catch (_) { showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶'); }
      }
    });
    /* â”€â”€ Unified collapsible accordion helper â”€â”€ */
    function initCollapsible(toggleEl) {
      if (!toggleEl) return;
      const bodyId = toggleEl.getAttribute('aria-controls');
      const bodyEl = bodyId ? document.getElementById(bodyId) : null;
      if (!bodyEl) return;
      function toggle() {
        const isOpen = bodyEl.classList.contains('open');
        bodyEl.classList.toggle('open');
        toggleEl.setAttribute('aria-expanded', String(!isOpen));
      }
      toggleEl.addEventListener('click', toggle);
      toggleEl.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); }
      });
    }
    document.querySelectorAll('.collapsible-toggle').forEach(initCollapsible);
    const readAloudBtn = document.getElementById('btn-read-aloud');
    if (readAloudBtn) readAloudBtn.addEventListener('click', readAloudStem);
    document.addEventListener('keydown', onQuizKeydown);
    function debounce(fn, ms) {
      let t = null;
      return function() {
        if (t) clearTimeout(t);
        t = setTimeout(fn, ms);
      };
    }
    const searchInput = $('saved-sets-search') || document.getElementById('saved-sets-search');
    if (searchInput) searchInput.addEventListener('input', debounce(renderSavedSets, 180));
    const savedSetsList = $('saved-sets-list') || document.getElementById('saved-sets-list');
    if (savedSetsList) savedSetsList.addEventListener('click', handleSavedSetsAction);
    document.getElementById('btn-add-folder').addEventListener('click', () => {
      customPrompt('è¾“å…¥æ–‡ä»¶å¤¹åç§°', '').then(name => {
        if (name === null || !name.trim()) return;
        const trimmed = name.trim();
        setFolders(getFolders().concat([{ id: String(Date.now()), name: trimmed }]));
      });
    });
    function startWrongBookDuePractice() {
      const due = getWrongBookDue();
      if (due.length === 0) {
        const total = getWrongBook().length;
        if (total === 0) showToast('é”™é¢˜æœ¬è¿˜æ˜¯ç©ºçš„ï¼Œå¤šåšå‡ é“é¢˜ä¼šè‡ªåŠ¨åŠ å…¥');
        else showToast('æ²¡æœ‰åˆ°æœŸéœ€è¦å¤ä¹ çš„é”™é¢˜ï¼Œé”™é¢˜æœ¬å…± ' + total + ' é¢˜');
        return;
      }
      const typeFilter = getSelectedTypeFilter();
      const filtered = filterQuestionsByType(due, typeFilter);
      if (filtered.length === 0) { showToast('å½“å‰é€‰é¢˜åž‹ä¸‹æ²¡æœ‰åˆ°æœŸçš„é”™é¢˜ï¼Œæ”¹å¤©å†è¯•'); return; }
      startQuiz(filtered, true);
    }
    function startWrongBookFreePractice() {
      const book = getWrongBook();
      if (book.length === 0) { showToast('é”™é¢˜æœ¬è¿˜æ˜¯ç©ºçš„ï¼Œåšé”™é¢˜åŽä¼šè‡ªåŠ¨åŠ å…¥'); return; }
      const typeFilter = getSelectedTypeFilter();
      const filtered = filterQuestionsByType(book, typeFilter);
      if (filtered.length === 0) { showToast('å½“å‰é€‰é¢˜åž‹ä¸‹æ²¡æœ‰é”™é¢˜ï¼Œè¯·å‹¾é€‰æ›´å¤šé¢˜åž‹'); return; }
      startQuiz(filtered, true);
    }
    document.getElementById('btn-wrong-book').addEventListener('click', startWrongBookDuePractice);
    document.getElementById('btn-result-wrong').addEventListener('click', startWrongBookDuePractice);
    document.getElementById('btn-wrong-free').addEventListener('click', startWrongBookFreePractice);
    document.getElementById('btn-result-wrong-free').addEventListener('click', startWrongBookFreePractice);
    document.getElementById('btn-clear-wrong').addEventListener('click', () => {
      if (getWrongBook().length === 0) {
        showToast('é”™é¢˜æœ¬å·²ç»æ˜¯ç©ºçš„äº†');
        return;
      }
      customConfirm('ç¡®å®šè¦æ¸…ç©ºé”™é¢˜æœ¬å—ï¼Ÿæ¸…ç©ºåŽæ— æ³•æ¢å¤ã€‚').then(confirmed => {
        if (confirmed) {
          setWrongBook([]);
        }
      });
    });
    (function initTimerInput() {
      const el = document.getElementById('timer-seconds');
      if (el) {
        const saved = localStorage.getItem(TIMER_SECONDS_KEY);
        if (saved !== null) { const n = parseInt(saved, 10); if (!isNaN(n) && n >= 0) el.value = n; }
        el.addEventListener('change', () => {
          const n = Math.max(0, Math.min(120, parseInt(el.value, 10) || 0));
          el.value = n;
          localStorage.setItem(TIMER_SECONDS_KEY, n);
        });
      }
    })();

    document.getElementById('btn-one-save').addEventListener('click', saveToProjectFolder);
    document.getElementById('btn-copy-deploy-cmd').addEventListener('click', () => {
      const cmd = document.getElementById('save-deploy-cmd');
      const text = cmd ? cmd.textContent.trim() : './scripts/sync-and-push.sh ../french-quiz-pages';
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => showToast('å¤åˆ¶æˆåŠŸ')).catch(() => showToast('å¤åˆ¶å¤±è´¥'));
      } else {
        try {
          const ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.opacity = '0';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          showToast('å¤åˆ¶æˆåŠŸ');
        } catch (_) { showToast('å¤åˆ¶å¤±è´¥'); }
      }
    });
    function confirmReviewStartQuiz() {
      if (_pendingReviewStart) {
        const p = _pendingReviewStart;
        hideReviewModal();
        startQuiz(p.questions, p.fromWrongBook, p.setId, p.noShuffle ? { noShuffle: true } : {});
      }
    }
    document.getElementById('btn-review-start-quiz').addEventListener('click', confirmReviewStartQuiz);
    document.getElementById('review-modal-overlay').addEventListener('click', (e) => {
      if (e.target.closest('#review-modal-images') && e.target.classList.contains('review-modal-img')) {
        e.preventDefault();
        e.stopPropagation();
        openImageLightbox(e.target.src);
        return;
      }
      if (e.target.id === 'review-modal-overlay') confirmReviewStartQuiz();
    });
    (function initStartModeModal() {
      const overlay = document.getElementById('start-mode-modal-overlay');
      const btnFull = document.getElementById('btn-start-mode-full');
      const btnSequential = document.getElementById('btn-start-mode-sequential');
      const countInput = document.getElementById('start-mode-count');
      const btnCancel = document.getElementById('btn-start-mode-cancel');
      const btnReset = document.getElementById('btn-start-mode-reset');
      const btnFullAfter = document.getElementById('btn-start-mode-full-after');
      function doStartFull() {
        if (!_pendingStartSet) return;
        const set = _pendingStartSet;
        const shuffleEl = document.getElementById('start-mode-shuffle');
        const shuffle = shuffleEl ? shuffleEl.checked : false;
        const reviewCheck = document.getElementById('start-mode-review');
        const shouldReview = reviewCheck ? reviewCheck.checked : false;
        const opts = shuffle ? {} : { noShuffle: true };
        closeStartModeModal();
        if (shouldReview && hasReviewMaterial(set)) showReviewModal(set, set.questions, false, set.id, opts);
        else startQuiz(set.questions, false, set.id, opts);
      }
      function doStartSequential() {
        if (!_pendingStartSet || !countInput) return;
        const set = _pendingStartSet;
        const nextIdx = Math.max(0, parseInt(set.sequentialNextIndex, 10) || 0);
        const remain = set.questions.length - nextIdx;
        let n = Math.max(1, Math.min(remain, parseInt(countInput.value, 10) || 20));
        if (n > remain) n = remain;
        const slice = set.questions.slice(nextIdx, nextIdx + n);
        const reviewCheck = document.getElementById('start-mode-review');
        const shouldReview = reviewCheck ? reviewCheck.checked : false;
        closeStartModeModal();
        const opts = { noShuffle: true, sequentialBatch: { startIndex: nextIdx, count: slice.length } };
        if (shouldReview && hasReviewMaterial(set)) showReviewModal(set, slice, false, set.id, opts);
        else startQuiz(slice, false, set.id, opts);
      }
      function doResetProgress() {
        if (!_pendingStartSet) return;
        const set = _pendingStartSet;
        const sets = getSavedSets();
        const updated = sets.map(s => String(s.id) === String(set.id) ? Object.assign({}, s, { sequentialNextIndex: 0 }) : s);
        setSavedSets(updated);
        closeStartModeModal();
        showToast('å·²é‡ç½®è¿›åº¦ï¼Œä¸‹æ¬¡å¯ä»Žç¬¬ 1 é¢˜èµ·æŒ‰é¡ºåºç»ƒä¹ ');
      }
      if (btnFull) btnFull.addEventListener('click', doStartFull);
      if (btnSequential) btnSequential.addEventListener('click', doStartSequential);
      if (btnCancel) btnCancel.addEventListener('click', closeStartModeModal);
      if (btnReset) btnReset.addEventListener('click', doResetProgress);
      if (btnFullAfter) btnFullAfter.addEventListener('click', function() {
        if (!_pendingStartSet) return;
        const set = _pendingStartSet;
        const shuffleEl = document.getElementById('start-mode-shuffle');
        const shuffle = shuffleEl ? shuffleEl.checked : false;
        const reviewCheck = document.getElementById('start-mode-review');
        const shouldReview = reviewCheck ? reviewCheck.checked : false;
        const opts = shuffle ? {} : { noShuffle: true };
        closeStartModeModal();
        if (shouldReview && hasReviewMaterial(set)) showReviewModal(set, set.questions, false, set.id, opts);
        else startQuiz(set.questions, false, set.id, opts);
      });
      if (overlay) overlay.addEventListener('click', function(e) {
        if (e.target.id === 'start-mode-modal-overlay') closeStartModeModal();
      });
    })();
    document.getElementById('image-lightbox-close').addEventListener('click', closeImageLightbox);
    document.getElementById('image-lightbox-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'image-lightbox-overlay') closeImageLightbox();
    });
    document.querySelector('.image-lightbox-content').addEventListener('click', (e) => e.stopPropagation());
    document.getElementById('btn-edit-set-save').addEventListener('click', saveEditSetModal);
    document.getElementById('btn-edit-set-cancel').addEventListener('click', closeEditSetModal);
    document.getElementById('btn-edit-set-export').addEventListener('click', exportFromEditModal);
    document.getElementById('btn-edit-set-append').addEventListener('click', async () => {
      if (!(await checkImportPin())) return;
      appendToEditSetModal();
    });
    document.getElementById('btn-edit-set-preview').addEventListener('click', () => {
      if (_editingSetId == null) return;
      const sets = getSavedSets();
      const set = sets.find(s => String(s.id) === String(_editingSetId));
      if (set) showPreviewQuestions(set);
    });
    document.getElementById('btn-edit-set-delete').addEventListener('click', deleteFromEditModal);
    document.getElementById('btn-preview-questions-close').addEventListener('click', closePreviewQuestions);
    document.getElementById('preview-questions-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'preview-questions-overlay') closePreviewQuestions();
    });
    document.getElementById('edit-set-modal-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'edit-set-modal-overlay') closeEditSetModal();
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && _openModalOverlay) {
        var id = _openModalOverlay.id;
        if (id === 'review-modal-overlay') confirmReviewStartQuiz();
        else if (id === 'start-mode-modal-overlay') closeStartModeModal();
        else if (id === 'edit-set-modal-overlay') closeEditSetModal();
        else if (id === 'preview-questions-overlay') closePreviewQuestions();
        else if (id === 'image-lightbox-overlay') closeImageLightbox();
        e.preventDefault();
        return;
      }
      if (e.key !== 'Tab' || !_openModalOverlay) return;
      var focusable = getFocusableIn(_openModalOverlay);
      if (focusable.length === 0) return;
      var first = focusable[0], last = focusable[focusable.length - 1];
      if (e.shiftKey) {
        if (document.activeElement === first) { e.preventDefault(); last.focus(); }
      } else {
        if (document.activeElement === last) { e.preventDefault(); first.focus(); }
      }
    });
    (function initEditSetPasteZone() {
      const zone = document.getElementById('edit-set-paste-zone');
      if (!zone) return;
      zone.addEventListener('paste', function(e) {
        const items = e.clipboardData && e.clipboardData.items;
        if (!items) return;
        for (let i = 0; i < items.length; i++) {
          if (items[i].type.indexOf('image') !== -1) {
            e.preventDefault();
            const file = items[i].getAsFile();
            if (!file) continue;
            const reader = new FileReader();
            reader.onload = function() {
              const dataUrl = reader.result;
              if (dataUrl && typeof dataUrl === 'string') {
                _editModalPastedImages.push(dataUrl);
                renderEditModalPastedImages();
              }
            };
            reader.readAsDataURL(file);
            break;
          }
        }
      });
    })();
    document.getElementById('btn-load-cloud').addEventListener('click', loadFromCloud);
    document.getElementById('btn-open-folder').addEventListener('click', pickFolderAndLoad);
    document.getElementById('btn-save-to-folder').addEventListener('click', saveToProjectFolder);
    document.getElementById('btn-export-data').addEventListener('click', saveToProjectFolder);
    document.getElementById('btn-import-data').addEventListener('click', () => document.getElementById('file-import-data').click());
    document.getElementById('link-download-json').addEventListener('click', (e) => { e.preventDefault(); exportDataDownload(); });
    
    // Sync Text Modal Functions
    function openSyncTextModal(tab = 'generate') {
      const overlay = document.getElementById('sync-text-modal-overlay');
      if (!overlay) return;
      overlay.classList.add('show');
      overlay.style.display = 'flex';
      setModalFocusTrap(overlay);
      switchSyncTextTab(tab);
    }
    function closeSyncTextModal() {
      const overlay = document.getElementById('sync-text-modal-overlay');
      if (!overlay) return;
      overlay.classList.remove('show');
      overlay.style.display = 'none';
      clearModalFocusTrap();
    }
    function switchSyncTextTab(tab) {
      const tabs = document.querySelectorAll('.sync-text-tab');
      const contents = document.querySelectorAll('.sync-text-content');
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
      contents.forEach(c => {
        const isActive = (tab === 'generate' && c.id === 'sync-text-generate') || 
                         (tab === 'import' && c.id === 'sync-text-import');
        c.style.display = isActive ? 'block' : 'none';
        c.classList.toggle('active', isActive);
      });
    }
    async function generateSyncText() {
      // æ£€æŸ¥ PIN ä¿æŠ¤
      if (isImportLockEnabled()) {
        const pin = await customPromptPin('è¯·è¾“å…¥ä¸»äºº PIN ä»¥ç”ŸæˆåŒæ­¥æ–‡æœ¬');
        if (pin === null) return;
        const ok = await verifyImportPin(pin);
        if (!ok) {
          showToast('PIN é”™è¯¯');
          return;
        }
      }
      try {
        const data = getDataForExport();
        const jsonStr = JSON.stringify(data);
        const base64 = btoa(unescape(encodeURIComponent(jsonStr)));
        const resultDiv = document.getElementById('sync-text-result');
        const outputTextarea = document.getElementById('sync-text-output');
        if (resultDiv && outputTextarea) {
          outputTextarea.value = base64;
          resultDiv.style.display = 'block';
          outputTextarea.select();
          showToast('åŒæ­¥æ–‡æœ¬å·²ç”Ÿæˆï¼Œè¯·å¤åˆ¶');
        }
      } catch (e) {
        showToast('ç”Ÿæˆå¤±è´¥ï¼š' + (e.message || String(e)));
      }
    }
    async function importSyncText() {
      const inputTextarea = document.getElementById('sync-text-input');
      if (!inputTextarea) return;
      const text = inputTextarea.value.trim();
      if (!text) {
        showToast('è¯·è¾“å…¥åŒæ­¥æ–‡æœ¬');
        return;
      }
      
      // æ£€æŸ¥è®¾å¤‡ç»‘å®š
      if (!canImportOnThisDevice()) {
        showToast('ä»…å…è®¸åœ¨å·²ç»‘å®šçš„è®¾å¤‡ä¸Šå¯¼å…¥åŒæ­¥æ•°æ®ï¼Œå½“å‰è®¾å¤‡æœªç»‘å®š');
        return;
      }
      
      // æ£€æŸ¥ PIN ä¿æŠ¤
      if (isImportLockEnabled()) {
        const pin = await customPromptPin('è¯·è¾“å…¥ä¸»äºº PIN ä»¥å¯¼å…¥åŒæ­¥æ•°æ®');
        if (pin === null) return;
        const ok = await verifyImportPin(pin);
        if (!ok) {
          showToast('PIN é”™è¯¯');
          return;
        }
      }
      
      const confirmed = await customConfirm('å¯¼å…¥å°†è¦†ç›–å½“å‰æœ¬åœ°çš„æ‰€æœ‰æ•°æ®ï¼ˆä¹ é¢˜é›†ã€é”™é¢˜æœ¬ã€ç»Ÿè®¡æ•°æ®ç­‰ï¼‰ã€‚ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ');
      if (!confirmed) {
        return;
      }
      try {
        const jsonStr = decodeURIComponent(escape(atob(text)));
        const data = JSON.parse(jsonStr);
        if (!data || (data.savedSets == null && data.wrongBook == null)) {
          throw new Error('æ•°æ®æ ¼å¼æ— æ•ˆ');
        }
        loadDataFromObject(data);
        const setCount = data.savedSets && data.savedSets.length ? data.savedSets.length : 0;
        const wrongCount = data.wrongBook && data.wrongBook.length ? data.wrongBook.length : 0;
        showToast('å·²å¯¼å…¥' + (setCount ? ' ' + setCount + ' å¥—ä¹ é¢˜é›†' : '') + (wrongCount ? 'ï¼Œ' + wrongCount + ' é“é”™é¢˜' : ''));
        inputTextarea.value = '';
        closeSyncTextModal();
      } catch (e) {
        showToast('å¯¼å…¥å¤±è´¥ï¼š' + (e.message || String(e)) + 'ã€‚è¯·ç¡®è®¤åŒæ­¥æ–‡æœ¬æ˜¯å¦æ­£ç¡®ã€‚');
      }
    }
    function copySyncText() {
      const outputTextarea = document.getElementById('sync-text-output');
      if (!outputTextarea) return;
      outputTextarea.select();
      try {
        document.execCommand('copy');
        showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      } catch (e) {
        // Fallback for modern browsers
        navigator.clipboard.writeText(outputTextarea.value).then(() => {
          showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }).catch(() => {
          showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶');
        });
      }
    }
    
    // Sync Text Modal Event Listeners
    document.getElementById('btn-generate-sync-text').addEventListener('click', () => openSyncTextModal('generate'));
    document.getElementById('btn-import-sync-text').addEventListener('click', () => openSyncTextModal('import'));
    document.getElementById('btn-sync-text-close').addEventListener('click', closeSyncTextModal);
    document.getElementById('sync-text-modal-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'sync-text-modal-overlay') closeSyncTextModal();
    });
    document.querySelectorAll('.sync-text-tab').forEach(tab => {
      tab.addEventListener('click', () => switchSyncTextTab(tab.dataset.tab));
    });
    document.getElementById('btn-generate-sync-text-inner').addEventListener('click', generateSyncText);
    document.getElementById('btn-import-sync-text-inner').addEventListener('click', importSyncText);
    document.getElementById('btn-copy-sync-text').addEventListener('click', copySyncText);
    document.getElementById('file-import-data').addEventListener('change', function() {
      const file = this.files && this.files[0];
      if (file) importDataFromFile(file);
      this.value = '';
    });

    (function initImportLock() {
      updateImportLockUI();
      updateDeviceBindUI();
      const setBtn = document.getElementById('btn-import-lock-set');
      const changeBtn = document.getElementById('btn-import-lock-change');
      const disableBtn = document.getElementById('btn-import-lock-disable');
      if (setBtn) setBtn.addEventListener('click', async function() {
        if (!(window.crypto && crypto.subtle)) { showToast('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè®¾ç½® PIN'); return; }
        customPromptPin('è¯·è®¾å®š 4ï½ž12 ä½ä¸»äºº PINï¼ˆç”±ä½ è‡ªå®šï¼Œä¾‹å¦‚æ•°å­—æˆ–å­—æ¯ï¼Œè¯·ç‰¢è®°ï¼›ä»…æœ¬æœºä¿å­˜ï¼‰').then(pin1 => {
          if (pin1 === null) return;
          if (pin1.length < 4 || pin1.length > 12) { showToast('è¯·è®¾ç½® 4ï½ž12 ä½'); return; }
          customPromptPin('å†æ¬¡è¾“å…¥ç¡®è®¤').then(pin2 => {
            if (pin1 !== pin2) { showToast('ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´'); return; }
            setImportPin(pin1).then(() => {
              updateImportLockUI();
              showToast('å·²å¯ç”¨å¯¼å…¥ä¿æŠ¤');
            });
          });
        });
      });
      if (changeBtn) changeBtn.addEventListener('click', async function() {
        if (!(window.crypto && crypto.subtle)) { showToast('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ'); return; }
        const cur = await customPromptPin('è¾“å…¥å½“å‰ PIN');
        if (cur === null) return;
        if (!(await verifyImportPin(cur))) { showToast('å½“å‰ PIN é”™è¯¯'); return; }
        const pin1 = await customPromptPin('è¾“å…¥æ–° PINï¼ˆ4ï½ž12 ä½ï¼‰');
        if (pin1 === null) return;
        const pin2 = await customPromptPin('å†æ¬¡è¾“å…¥æ–° PIN');
        if (pin1 !== pin2) { showToast('ä¸¤æ¬¡è¾“å…¥ä¸ä¸€è‡´'); return; }
        if (pin1.length < 4 || pin1.length > 12) { showToast('è¯·è®¾ç½® 4ï½ž12 ä½'); return; }
        await setImportPin(pin1);
        updateImportLockUI();
        showToast('å·²ä¿®æ”¹ PIN');
      });
      if (disableBtn) disableBtn.addEventListener('click', async function() {
        const cur = await customPromptPin('è¾“å…¥å½“å‰ PIN ä»¥å…³é—­å¯¼å…¥ä¿æŠ¤');
        if (cur === null) return;
        if (!(await verifyImportPin(cur))) { showToast('PIN é”™è¯¯'); return; }
        localStorage.removeItem(IMPORT_PIN_HASH_KEY);
        updateImportLockUI();
        showToast('å·²å…³é—­å¯¼å…¥ä¿æŠ¤');
      });
      const bindBtn = document.getElementById('btn-device-bind');
      const unbindBtn = document.getElementById('btn-device-unbind');
      if (bindBtn) bindBtn.addEventListener('click', function() {
        setImportAllowedFingerprintToThisDevice();
        updateDeviceBindUI();
        showToast('å·²ç»‘å®šæœ¬æœºã€‚è¯·ã€Œä¸€é”®ä¿å­˜ã€å¹¶æŽ¨é€åˆ°äº‘ç«¯ï¼Œå…¶ä»–è®¾å¤‡å°†æ— æ³•å¯¼å…¥');
      });
      if (unbindBtn) unbindBtn.addEventListener('click', function() {
        localStorage.removeItem(IMPORT_ALLOWED_FINGERPRINT_KEY);
        updateDeviceBindUI();
        showToast('å·²è§£é™¤ç»‘å®šã€‚è¯·ã€Œä¸€é”®ä¿å­˜ã€å¹¶æŽ¨é€åŽï¼Œæ‰€æœ‰è®¾å¤‡å‡å¯å¯¼å…¥');
      });
    })();

    (function initTheme() {
      const theme = localStorage.getItem(THEME_KEY) || 'dark';
      if (theme === 'light') document.body.classList.add('theme-light');
      function setThemeColorMeta() {
        var meta = document.querySelector('meta[name="theme-color"]');
        if (meta) meta.content = document.body.classList.contains('theme-light') ? '#f8f7fc' : '#0c0a14';
      }
      setThemeColorMeta();
      const btn = $('theme-toggle');
      if (btn) {
        btn.setAttribute('aria-pressed', theme === 'light' ? 'true' : 'false');
        btn.addEventListener('click', () => {
          document.body.classList.toggle('theme-light');
          const isLight = document.body.classList.contains('theme-light');
          localStorage.setItem(THEME_KEY, isLight ? 'light' : 'dark');
          btn.setAttribute('aria-pressed', isLight ? 'true' : 'false');
          setThemeColorMeta();
        });
      }
    })();
    updateWrongCount();
    renderSavedSets();
    updateStatsBar();
    updateStartPracticeSelect();
    renderFolderSelects();
    updateCategoryFilter();
    if (typeof performance !== 'undefined' && performance.mark) {
      performance.mark('app-ready');
      try { performance.measure('app-init', 'app-start', 'app-ready'); } catch (_) {}
    }
    if (typeof PerformanceObserver !== 'undefined') {
      try {
        var lcpObserver = new PerformanceObserver(function (list) {
          var entries = list.getEntries();
          if (entries.length > 0 && typeof performance !== 'undefined' && performance.mark) performance.mark('lcp');
        });
        lcpObserver.observe({ type: 'largest-contentful-paint', buffered: true });
      } catch (_) {}
    }
    const startSel = $('start-practice-select') || document.getElementById('start-practice-select');
    if (startSel) startSel.addEventListener('change', updateCategoryFilter);

    // Restore in-progress quiz
    (function checkSavedProgress() {
      const saved = getQuizProgress();
      if (saved && saved.questions && saved.questions.length > 0 && saved.index < saved.questions.length) {
        customConfirm('æ£€æµ‹åˆ°ä¸Šæ¬¡æœªå®Œæˆçš„ç»ƒä¹ ï¼ˆç¬¬ ' + (saved.index + 1) + '/' + saved.questions.length + ' é¢˜ï¼‰ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ').then(confirmed => {
          if (confirmed) {
            state.questions = saved.questions;
            state.index = saved.index;
            state.score = saved.score;
            state.answered = false;
            state.timerSeconds = saved.timerSeconds;
            state.practicingWrongBook = saved.practicingWrongBook;
            state.practicedSetId = saved.practicedSetId;
            state.answerResults = saved.answerResults || {};  // Restore answer results if available
            showScreen(SCREEN.QUIZ);
            renderQuestion();
          } else {
            clearQuizProgress();
          }
        });
      }
    })();
  </script>
</body>
</html>
